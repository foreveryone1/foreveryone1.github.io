"use strict";if("undefined"!=typeof module){const a=require("./filter");Object.assign(global,a)}class PageFilterSpells extends PageFilter{static sortSpells(c,a,b){switch(b.sortBy){case"name":return SortUtil.compareListNames(c,a);case"source":return SortUtil.ascSort(c.values.source,a.values.source)||SortUtil.compareListNames(c,a);case"level":return SortUtil.ascSort(c.values.level,a.values.level)||SortUtil.compareListNames(c,a);case"school":return SortUtil.ascSort(c.values.school,a.values.school)||SortUtil.compareListNames(c,a);case"concentration":return SortUtil.ascSort(c.values.concentration,a.values.concentration)||SortUtil.compareListNames(c,a);case"time":return SortUtil.ascSort(c.values.normalisedTime,a.values.normalisedTime)||SortUtil.compareListNames(c,a);case"range":return SortUtil.ascSort(c.values.normalisedRange,a.values.normalisedRange)||SortUtil.compareListNames(c,a);}}static sortMetaFilter(c,a){const b=PageFilterSpells._META_FILTER_BASE_ITEMS.indexOf(c.item),d=PageFilterSpells._META_FILTER_BASE_ITEMS.indexOf(a.item);return~b&&~d?b-d:~b?-1:~d?1:"SRD"===c.item?1:"SRD"===a.item?-1:SortUtil.ascSortLower(c,a)}static getFilterAbilitySave(a){return`${a.uppercaseFirst().substring(0,3)}. Save`}static getFilterAbilityCheck(a){return`${a.uppercaseFirst().substring(0,3)}. Check`}static getMetaFilterObj(a){const b=[];return a.meta&&Object.entries(a.meta).filter(([a,b])=>b).sort(SortUtil.ascSort).forEach(([a])=>b.push(a.toTitleCase())),a.duration.filter(a=>a.concentration).length?(b.push(PageFilterSpells._META_ADD_CONC),a._isConc=!0):a._isConc=!1,a.components&&a.components.v&&b.push(PageFilterSpells._META_ADD_V),a.components&&a.components.s&&b.push(PageFilterSpells._META_ADD_S),a.components&&a.components.m&&b.push(PageFilterSpells._META_ADD_M),a.components&&a.components.r&&b.push(PageFilterSpells._META_ADD_R),a.components&&a.components.m&&a.components.m.cost&&b.push(PageFilterSpells._META_ADD_M_COST),a.components&&a.components.m&&a.components.m.consume&&b.push(PageFilterSpells._META_ADD_M_CONSUMED),(a.miscTags&&a.miscTags.includes("PRM")||a.duration.filter(a=>"permanent"===a.type).length)&&b.push(Parser.spMiscTagToFull("PRM")),(a.miscTags&&a.miscTags.includes("SCL")||a.entriesHigherLevel)&&b.push(Parser.spMiscTagToFull("SCL")),a.miscTags&&a.miscTags.includes("HL")&&b.push(Parser.spMiscTagToFull("HL")),a.miscTags&&a.miscTags.includes("SMN")&&b.push(Parser.spMiscTagToFull("SMN")),a.miscTags&&a.miscTags.includes("SGT")&&b.push(Parser.spMiscTagToFull("SGT")),a.srd&&b.push("SRD"),b}static getFilterDuration(a){const b=a.duration[0]||{type:"special"};switch(b.type){case"instant":return"Instant";case"timed":{if(!b.duration)return"Special";switch(b.duration.type){case"turn":case"round":return"1 Round";case"minute":{const a=b.duration.amount||0;return 1>=a?"1 Minute":10>=a?"10 Minutes":60>=a?"1 Hour":480>=a?"8 Hours":"24+ Hours"}case"hour":{const a=b.duration.amount||0;return 1>=a?"1 Hour":8>=a?"8 Hours":"24+ Hours"}case"week":case"day":case"year":return"24+ Hours";default:return"Special";}}case"permanent":return"Permanent";case"special":default:return"Special";}}static getNormalisedTime(a){const b=a[0];let c=1,d=0;switch(b.unit){case Parser.SP_TM_B_ACTION:d=1;break;case Parser.SP_TM_REACTION:d=2;break;case Parser.SP_TM_ROUND:c=6;break;case Parser.SP_TM_MINS:c=60;break;case Parser.SP_TM_HRS:c=3600;}return 1<a.length&&(d+=.5),c*b.number+d}static getNormalisedRange(a){function b(){const b=a.distance;switch(b.type){case UNT_FEET:c=PageFilterSpells.INCHES_PER_FOOT,d=b.amount;break;case UNT_MILES:c=PageFilterSpells.INCHES_PER_FOOT*PageFilterSpells.FEET_PER_MILE,d=b.amount;break;case RNG_SELF:d=0;break;case RNG_TOUCH:d=1;break;case RNG_SIGHT:c=PageFilterSpells.INCHES_PER_FOOT*PageFilterSpells.FEET_PER_MILE,d=12;break;case RNG_UNLIMITED_SAME_PLANE:d=9e8;break;case RNG_UNLIMITED:d=900000001;break;default:{const a=MiscUtil.get(BrewUtil.homebrewMeta,"spellDistanceUnits",b.type);if(a){const e=a.feetPerUnit;null==e?d=91e7:(c=PageFilterSpells.INCHES_PER_FOOT*e,d=b.amount)}break}}}let c=1,d=0,e=0;switch(a.type){case RNG_SPECIAL:return 1e9;case RNG_POINT:b();break;case RNG_LINE:e=1,b();break;case RNG_CONE:e=2,b();break;case RNG_RADIUS:e=3,b();break;case RNG_HEMISPHERE:e=4,b();break;case RNG_SPHERE:e=5,b();break;case RNG_CYLINDER:e=6,b();break;case RNG_CUBE:e=7,b();}return c*d+e}static getFltrSpellLevelStr(a){return 0===a?Parser.spLevelToFull(a):`${Parser.spLevelToFull(a)} level`}static getRangeType(a){switch(a.type){case RNG_SPECIAL:return PageFilterSpells.F_RNG_SPECIAL;case RNG_POINT:switch(a.distance.type){case RNG_SELF:return PageFilterSpells.F_RNG_SELF;case RNG_TOUCH:return PageFilterSpells.F_RNG_TOUCH;default:return PageFilterSpells.F_RNG_POINT;}case RNG_LINE:case RNG_CONE:case RNG_RADIUS:case RNG_HEMISPHERE:case RNG_SPHERE:case RNG_CYLINDER:case RNG_CUBE:return PageFilterSpells.F_RNG_SELF_AREA;}}static getTblTimeStr(a){return 1===a.number&&Parser.SP_TIME_SINGLETONS.includes(a.unit)?`${a.unit.uppercaseFirst()}${a.unit===Parser.SP_TM_B_ACTION?" acn.":""}`:`${a.number} ${a.unit===Parser.SP_TM_B_ACTION?"Bonus acn.":a.unit.uppercaseFirst()}${1<a.number?"s":""}`}static getClassFilterItem(a){const b=a.name.split("(")[0].trim(),c=SourceUtil.isNonstandardSource(a.source||SRC_PHB)||BrewUtil.hasSourceJson(a.source||SRC_PHB),d=`${b}${c?` (${Parser.sourceJsonToAbv(a.source)})`:""}`;return new FilterItem({item:d,userData:SourceUtil.getFilterGroup(a.source||SRC_PHB)})}constructor(){super(),this._brewSpellClasses={};const a=new Filter({header:"Level",items:[0,1,2,3,4,5,6,7,8,9],displayFn:PageFilterSpells.getFltrSpellLevelStr}),b=new Filter({header:"Class",groupFn:a=>a.userData}),c=new Filter({header:"Subclass",nests:{},groupFn:a=>SourceUtil.isSubclassReprinted(a.userData.class.name,a.userData.class.source,a.userData.subClass.name,a.userData.subClass.source)||Parser.sourceJsonToFull(a.userData.subClass.source).startsWith(UA_PREFIX)||Parser.sourceJsonToFull(a.userData.subClass.source).startsWith(PS_PREFIX)}),d=new Filter({header:"Variant Class"}),e=new MultiFilter({header:"Classes",filters:[b,c,d]}),f=new Filter({header:"Race"}),g=new Filter({header:"Background"}),h=new Filter({header:"Components & Miscellaneous",items:[...PageFilterSpells._META_FILTER_BASE_ITEMS,"Ritual","Technomagic","SRD"],itemSortFn:PageFilterSpells.sortMetaFilter}),i=new Filter({header:"School",items:[...Parser.SKL_ABVS],displayFn:Parser.spSchoolAbvToFull,itemSortFn:(c,a)=>SortUtil.ascSortLower(Parser.spSchoolAbvToFull(c.item),Parser.spSchoolAbvToFull(a.item))}),j=new Filter({header:"Subschool",items:[],displayFn:Parser.spSchoolAbvToFull}),k=new Filter({header:"Damage Type",items:MiscUtil.copy(Parser.DMG_TYPES),displayFn:StrUtil.uppercaseFirst}),l=new Filter({header:"Conditions Inflicted",items:MiscUtil.copy(Parser.CONDITIONS),displayFn:StrUtil.uppercaseFirst}),m=new Filter({header:"Spell Attack",items:["M","R","O"],displayFn:Parser.spAttackTypeToFull,itemSortFn:null}),n=new Filter({header:"Saving Throw",items:["strength","dexterity","constitution","intelligence","wisdom","charisma"],displayFn:PageFilterSpells.getFilterAbilitySave,itemSortFn:null}),o=new Filter({header:"Opposed Ability Check",items:["strength","dexterity","constitution","intelligence","wisdom","charisma"],displayFn:PageFilterSpells.getFilterAbilityCheck,itemSortFn:null}),p=new Filter({header:"Cast Time",items:[Parser.SP_TM_ACTION,Parser.SP_TM_B_ACTION,Parser.SP_TM_REACTION,Parser.SP_TM_ROUND,Parser.SP_TM_MINS,Parser.SP_TM_HRS],displayFn:Parser.spTimeUnitToFull,itemSortFn:null}),q=new RangeFilter({header:"Duration",isLabelled:!0,labelSortFn:null,labels:["Instant","1 Round","1 Minute","10 Minutes","1 Hour","8 Hours","24+ Hours","Permanent","Special"]}),r=new Filter({header:"Range",items:[PageFilterSpells.F_RNG_SELF,PageFilterSpells.F_RNG_TOUCH,PageFilterSpells.F_RNG_POINT,PageFilterSpells.F_RNG_SELF_AREA,PageFilterSpells.F_RNG_SPECIAL],itemSortFn:null}),s=new Filter({header:"Area Style",items:["ST","MT","R","N","C","Y","H","L","S","Q","W"],displayFn:Parser.spAreaTypeToFull,itemSortFn:null});this._classFilter=b,this._subclassFilter=c,this._levelFilter=a,this._variantClassFilter=d,this._classAndSubclassFilter=e,this._raceFilter=f,this._backgroundFilter=g,this._metaFilter=h,this._schoolFilter=i,this._subSchoolFilter=j,this._damageFilter=k,this._conditionFilter=l,this._spellAttackFilter=m,this._saveFilter=n,this._checkFilter=o,this._timeFilter=p,this._durationFilter=q,this._rangeFilter=r,this._areaTypeFilter=s}populateHomebrewClassLookup(a){const b=(a,b,c,d,e,f)=>{const g=a=>{if(d){const g={class:{name:b,source:c},subclass:{name:d,source:e}};f&&(g.subclass.subSubclass=f),a.fromSubclass=a.fromSubclass||[],a.fromSubclass.push(g)}else{a.fromClassList=a.fromClassList||[],a.fromClassList.push({name:b,source:c})}};if(a.class){if(!a.class)return;this._brewSpellClasses.class=this._brewSpellClasses.class||{};const b=a.class.toLowerCase(),c=a.source||SRC_PHB;this._brewSpellClasses.class[c]=this._brewSpellClasses.class[c]||{},this._brewSpellClasses.class[c][b]=this._brewSpellClasses.class[c][b]||{},g(this._brewSpellClasses.class[c][b])}else{this._brewSpellClasses.spell=this._brewSpellClasses.spell||{};const b=("string"==typeof a?a:a.name).toLowerCase(),c="string"==typeof a?"PHB":a.source;this._brewSpellClasses.spell[c]=this._brewSpellClasses.spell[c]||{},this._brewSpellClasses.spell[c][b]=this._brewSpellClasses.spell[c][b]||{fromClassList:[],fromSubclass:[]},g(this._brewSpellClasses.spell[c][b])}};a.class&&a.class.forEach(a=>{a.source=a.source||SRC_PHB,a.classSpells&&a.classSpells.forEach(c=>b(c,a.name,a.source)),a.subclasses&&a.subclasses.forEach(c=>{c.shortName=c.shortName||c.name,c.source=c.source||a.source,c.subclassSpells&&c.subclassSpells.forEach(d=>b(d,a.name,a.source,c.shortName,c.source)),c.subSubclassSpells&&Object.entries(c.subSubclassSpells).forEach(([d,e])=>e.forEach(e=>b(e,a.name,a.source,c.shortName,c.source,d)))})}),a.subclass&&a.subclass.forEach(a=>{a.classSource=a.classSource||SRC_PHB,a.shortName=a.shortName||a.name,a.source=a.source||a.classSource,a.subclassSpells&&a.subclassSpells.forEach(c=>b(c,a.class,a.classSource,a.shortName,a.source)),a.subSubclassSpells&&Object.entries(a.subSubclassSpells).forEach(([c,d])=>d.forEach(d=>b(d,a.class,a.classSource,a.shortName,a.source,c)))})}mutateForFilters(a){Renderer.spell.initClasses(a,this._brewSpellClasses),a._normalisedTime=PageFilterSpells.getNormalisedTime(a.time),a._normalisedRange=PageFilterSpells.getNormalisedRange(a.range),a._fSources=ListUtil.getCompleteFilterSources(a),a._fMeta=PageFilterSpells.getMetaFilterObj(a),a._fClasses=a.classes&&a.classes.fromClassList?a.classes.fromClassList.map(PageFilterSpells.getClassFilterItem):[],a._fSubclasses=a.classes&&a.classes.fromSubclass?a.classes.fromSubclass.map(a=>new FilterItem({item:`${a.class.name}: ${PageFilterSpells.getClassFilterItem(a.subclass).item}`,nest:a.class.name,userData:{subClass:{name:a.subclass.name,source:a.subclass.source},class:{name:a.class.name,source:a.class.source}}})):[],a._fVariantClasses=a.classes&&a.classes.fromClassListVariant?a.classes.fromClassListVariant.map(PageFilterSpells.getClassFilterItem):[],a._fRaces=a.races?a.races.map(a=>a.baseName||a.name):[],a._fBackgrounds=a.backgrounds?a.backgrounds.map(a=>a.name):[],a._fTimeType=a.time.map(a=>a.unit),a._fDurationType=PageFilterSpells.getFilterDuration(a),a._fRangeType=PageFilterSpells.getRangeType(a.range)}addToFilters(a,b){b||(9<a.level&&this._levelFilter.addItem(a.level),this._schoolFilter.addItem(a.school),this._sourceFilter.addItem(a._fSources),this._metaFilter.addItem(a._fMeta),this._raceFilter.addItem(a._fRaces),this._backgroundFilter.addItem(a._fBackgrounds),a._fClasses.forEach(a=>this._classFilter.addItem(a)),a._fSubclasses.forEach(a=>{this._subclassFilter.addNest(a.userData.class.name,{isHidden:!0}),this._subclassFilter.addItem(a)}),a._fVariantClasses.forEach(a=>this._variantClassFilter.addItem(a)),this._subSchoolFilter.addItem(a.subschools))}async _pPopulateBoxOptions(a){await SourceUtil.pInitSubclassReprintLookup(),a.filters=[this._sourceFilter,this._levelFilter,this._classAndSubclassFilter,this._raceFilter,this._backgroundFilter,this._metaFilter,this._schoolFilter,this._subSchoolFilter,this._damageFilter,this._conditionFilter,this._spellAttackFilter,this._saveFilter,this._checkFilter,this._timeFilter,this._durationFilter,this._rangeFilter,this._areaTypeFilter]}toDisplay(a,b){return this._filterBox.toDisplay(a,b._fSources,b.level,[b._fClasses,b._fSubclasses,b._fVariantClasses],b._fRaces,b._fBackgrounds,b._fMeta,b.school,b.subschools,b.damageInflict,b.conditionInflict,b.spellAttack,b.savingThrow,b.opposedCheck,b._fTimeType,b._fDurationType,b._fRangeType,b.areaTags)}}PageFilterSpells._META_ADD_CONC="Concentration",PageFilterSpells._META_ADD_V="Verbal",PageFilterSpells._META_ADD_S="Somatic",PageFilterSpells._META_ADD_M="Material",PageFilterSpells._META_ADD_R="Royalty",PageFilterSpells._META_ADD_M_COST="Material with Cost",PageFilterSpells._META_ADD_M_CONSUMED="Material is Consumed",PageFilterSpells.F_RNG_POINT="Point",PageFilterSpells.F_RNG_SELF_AREA="Self (Area)",PageFilterSpells.F_RNG_SELF="Self",PageFilterSpells.F_RNG_TOUCH="Touch",PageFilterSpells.F_RNG_SPECIAL="Special",PageFilterSpells._META_FILTER_BASE_ITEMS=[PageFilterSpells._META_ADD_CONC,PageFilterSpells._META_ADD_V,PageFilterSpells._META_ADD_S,PageFilterSpells._META_ADD_M,PageFilterSpells._META_ADD_R,PageFilterSpells._META_ADD_M_COST,PageFilterSpells._META_ADD_M_CONSUMED,...Object.values(Parser.SP_MISC_TAG_TO_FULL)],PageFilterSpells.INCHES_PER_FOOT=12,PageFilterSpells.FEET_PER_MILE=5280;class ModalFilterSpells extends ModalFilter{constructor(a){super({modalTitle:"Spells",pageFilter:new PageFilterSpells,fnSort:PageFilterSpells.sortSpells,namespace:a})}_$getColumnHeaders(){return ModalFilter._$getFilterColumnHeaders([{sort:"name",text:"Name",width:"3"},{sort:"level",text:"Level",width:"1-5"},{sort:"time",text:"Time",width:"2"},{sort:"school",text:"School",width:"1"},{sort:"concentration",text:"C.",title:"Concentration",width:"0-5"},{sort:"range",text:"Range",width:"2"},{sort:"source",text:"Source",width:"1"}])}async _pInit(){this._pageFilter.populateHomebrewClassLookup(BrewUtil.homebrew)}async _pLoadAllData(){const a=await BrewUtil.pAddBrewData(),b=await DataUtil.spell.pLoadAll(),c=a.spell||[];return[...b,...c]}_getListItem(a,b,c){const d=document.createElement("li");d.className="row";const e=UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_SPELLS](b),f=Parser.sourceJsonToAbv(b.source),g=`${Parser.spLevelToFull(b.level)}${b.meta&&b.meta.ritual?" (rit.)":""}${b.meta&&b.meta.technomagic?" (tec.)":""}`,h=PageFilterSpells.getTblTimeStr(b.time[0]),i=Parser.spSchoolAndSubschoolsAbvsShort(b.school,b.subschools),j=b._isConc?"\xD7":"",k=Parser.spRangeToFull(b.range);return d.innerHTML=`<label class="lst--border unselectable">
			<div class="lst__wrp-cells">
				<div class="col-1 pl-0 flex-vh-center"><input type="checkbox" class="no-events"></div>
				<div class="bold col-3">${b.name}</div>
				<div class="col-1-5 text-center">${g}</div>
				<div class="col-2 text-center">${h}</div>
				<div class="col-1 school_${b.school} text-center" title="${Parser.spSchoolAndSubschoolsAbvsToFull(b.school,b.subschools)}" ${Parser.spSchoolAbvToStyle(b.school)}>${i}</div>
				<div class="col-0-5 text-center" title="Concentration">${j}</div>
				<div class="col-2 text-right">${k}</div>
				<div class="col-1 pr-0 text-center ${Parser.sourceJsonToColor(b.source)}" title="${Parser.sourceJsonToFull(b.source)}" ${BrewUtil.sourceJsonToStyle(b.source)}>${f}</div>
			</div>
		</label>`,new ListItem(c,d,b.name,{hash:e,source:f,sourceJson:b.source,level:b.level,time:h,school:Parser.spSchoolAbvToFull(b.school),classes:Parser.spClassesToFull(b.classes,!0),concentration:j,normalisedTime:b._normalisedTime,normalisedRange:b._normalisedRange},{cbSel:d.firstElementChild.firstElementChild.firstElementChild.firstElementChild})}}"undefined"!=typeof module&&(module.exports=PageFilterSpells);
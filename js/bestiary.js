"use strict";const JSON_DIR="data/bestiary/",FLUFF_INDEX="fluff-index.json",ECGEN_BASE_PLAYERS=4,renderer=Renderer.get();window.PROF_MODE_BONUS="bonus",window.PROF_MODE_DICE="dice",window.PROF_DICE_MODE=PROF_MODE_BONUS;const meta={},languages={};let ixFluff={};class BestiaryPage{static addLegendaryGroups(a){a&&a.length&&a.forEach(a=>{meta[a.source]=meta[a.source]||{},meta[a.source][a.name]=a})}constructor(){this._pageFilter=new PageFilterBestiary,this._multiSource=new MultiSource({fnHandleData:addMonsters,prop:"monster"})}getListItem(a,b){const c=UrlUtil.autoEncodeHash(a);if(!a.uniqueId&&_addedHashes.has(c))return null;_addedHashes.add(c),Renderer.monster.updateParsed(a);const d=ExcludeUtil.isExcluded(a.name,"monster",a.source);this._pageFilter.mutateAndAddToFilters(a,d);const e=document.createElement("li");e.className=`row ${d?"row--blacklisted":""}`,e.addEventListener("click",a=>handleBestiaryLiClick(a,i)),e.addEventListener("contextmenu",a=>handleBestiaryLiContext(a,i));const f=Parser.sourceJsonToAbv(a.source),g=a._pTypes.asText.uppercaseFirst(),h=a._pCr||"\u2014";e.innerHTML+=`<a href="#${c}" onclick="handleBestiaryLinkClick(event)" class="lst--border">
			${EncounterBuilder.getButtons(b)}
			<span class="ecgen__name bold col-4-2 pl-0">${a.name}</span>
			<span class="type col-4-1">${g}</span>
			<span class="col-1-7 text-center">${h}</span>
			<span title="${Parser.sourceJsonToFull(a.source)}${Renderer.utils.getSourceSubText(a)}" class="col-2 text-center ${Parser.sourceJsonToColor(a.source)} pr-0" ${BrewUtil.sourceJsonToStyle(a.source)}>${f}</span>
		</a>`;const i=new ListItem(b,e,a.name,{hash:c,source:f,type:g,cr:h,group:a.group||"",alias:(a.alias||[]).map(a=>`"${a}"`).join(",")},{uniqueId:a.uniqueId?a.uniqueId:b,isExcluded:d});return i}handleFilterChange(){if(Hist.initialLoad)return;const a=this._pageFilter.filterBox.getValues();list.filter(b=>{const c=monsters[b.ix];return this._pageFilter.toDisplay(a,c)}),MultiSource.onFilterChangeMulti(monsters),encounterBuilder.resetCache()}async pGetSublistItem(a,b,c,d={}){const e=await(d.scaled?ScaleCreature.scale(a,d.scaled):a);Renderer.monster.updateParsed(e);const f=d.scaled?`${HASH_PART_SEP}${MON_HASH_SCALED}${HASH_SUB_KV_SEP}${d.scaled}`:"",g=e._displayName||e.name,h=`${UrlUtil.autoEncodeHash(e)}${f}`,i=e._pTypes.asText.uppercaseFirst(),j=c||1,k=e._pCr||"Unknown",l=$(`<span class="col-1-4 help--hover ecgen__visible">Statblock</span>`).mouseover(a=>EncounterBuilder.doStatblockMouseOver(a,l[0],b,e._isScaledCr)).mousemove(a=>Renderer.hover.handleLinkMouseMove(a,l[0])).mouseleave(a=>Renderer.hover.handleLinkMouseLeave(a,l[0])),m=EncounterBuilder.getTokenHoverMeta(e),n=$(`<span class="col-1-2 ecgen__visible help--hover">Token</span>`).mouseover(a=>m.mouseOver(a,n[0])).mousemove(a=>m.mouseMove(a,n[0])).mouseleave(a=>m.mouseLeave(a,n[0])),o=$(`<span class="col-1-2 ecgen__visible help--hover">Image</span>`).mouseover(a=>EncounterBuilder.handleImageMouseOver(a,o,b)),p=(()=>{if("Unknown"===k)return $(`<span class="col-1-2 text-center">${k}</span>`);const a=$(`<input value="${k}" class="ecgen__cr_input form-control form-control--minimal input-xs">`).change(()=>encounterBuilder.pDoCrChange(a,b,e._isScaledCr));return $$`<span class="col-1-2 text-center">${a}</span>`})(),q=$(`<span class="col-2 text-center">${j}</span>`),r=$(`<span class="col-2 pr-0 text-center">${j}</span>`),s=$$`<li class="row row--bestiary_sublist">
			<a href="#${h}" draggable="false" class="ecgen__hidden lst--border">
				<span class="bold col-5 pl-0">${g}</span>
				<span class="col-3-8">${i}</span>
				<span class="col-1-2 text-center">${k}</span>
				${q}
			</a>

			<div class="lst__wrp-cells ecgen__visible--flex lst--border">
				${EncounterBuilder.$getSublistButtons(b,getMonCustomHashId(e))}
				<span class="ecgen__name--sub col-3-5">${g}</span>
				${l}
				${n}
				${o}
				${p}
				${r}
			</div>
		</li>`.contextmenu(a=>ListUtil.openSubContextMenu(a,t)),t=new ListItem(b,s,g,{hash:h,source:Parser.sourceJsonToAbv(e.source),type:i,cr:k,count:j},{uniqueId:d.uniqueId||"",customHashId:getMonCustomHashId(e),$elesCount:[q,r]});return t}doLoadHash(a){const b=monsters[a];renderStatblock(b),loadSubHash([]),ListUtil.updateSelected()}async pDoLoadSubHash(a){a=this._pageFilter.filterBox.setFromSubHashes(a),await ListUtil.pSetFromSubHashes(a,pPreloadSublistSources),printBookView.handleSub(a);const b=a.find(a=>a.startsWith(MON_HASH_SCALED));if(b){const a=+UrlUtil.unpackSubHash(b)[MON_HASH_SCALED][0],c=Parser.numberToCr(a),d=monsters[Hist.lastLoadedId];Parser.isValidCr(c)&&a!==Parser.crToNumber(lastRendered.mon.cr)&&ScaleCreature.scale(d,a).then(a=>renderStatblock(a,!0))}encounterBuilder.handleSubhash(a)}async pOnLoad(){window.loadHash=this.doLoadHash.bind(this),window.loadSubHash=this.pDoLoadSubHash.bind(this),await this._pageFilter.pInitFilterBox({$iptSearch:$(`#lst__search`),$wrpFormTop:$(`#filter-search-input-group`).title("Hotkey: f"),$btnReset:$(`#reset`)}),encounterBuilder=new EncounterBuilder,encounterBuilder.initUi(),await Promise.all([ExcludeUtil.pInitialise(),Renderer.monster.pPopulateMetaAndLanguages(meta,languages),(async()=>ixFluff=await DataUtil.loadJSON(JSON_DIR+FLUFF_INDEX))()]),await bestiaryPage._multiSource.pMultisourceLoad(JSON_DIR,this._pageFilter.filterBox,pPageInit,addMonsters,pPostLoad),null==Hist.lastLoadedId&&Hist._freshLoad(),ExcludeUtil.checkShowAllExcluded(monsters,$(`#pagecontent`)),bestiaryPage.handleFilterChange(),encounterBuilder.initState(),window.dispatchEvent(new Event("toolsLoaded"))}}function handleBrew(a){return BestiaryPage.addLegendaryGroups(a.legendaryGroup),addMonsters(a.monster),Promise.resolve()}function pPostLoad(){return new Promise(a=>{BrewUtil.pAddBrewData().then(handleBrew).then(()=>BrewUtil.bind({list})).then(()=>BrewUtil.pAddLocalBrewData()).then(async()=>{BrewUtil.makeBrewButton("manage-brew"),BrewUtil.bind({filterBox:bestiaryPage._pageFilter.filterBox,sourceFilter:bestiaryPage._pageFilter.sourceFilter}),await ListUtil.pLoadState(),a()})})}let encounterBuilder,list,subList,printBookView;async function pPageInit(a){Object.keys(a).map(a=>new FilterItem({item:a,pFnChange:bestiaryPage._multiSource.pLoadSource.bind(bestiaryPage._multiSource)})).forEach(a=>bestiaryPage._pageFilter.sourceFilter.addItem(a)),list=ListUtil.initList({listClass:"monsters",fnSort:PageFilterBestiary.sortMonsters}),ListUtil.setOptions({primaryLists:[list]}),SortUtil.initBtnSortHandlers($(`#filtertools`),list);const b=$(`.lst__wrp-search-visible`);list.on("updated",()=>{b.html(`${list.visibleItems.length}/${list.items.length}`)}),$(bestiaryPage._pageFilter.filterBox).on(FilterBox.EVNT_VALCHANGE,bestiaryPage.handleFilterChange.bind(bestiaryPage)),subList=ListUtil.initSublist({listClass:"submonsters",fnSort:PageFilterBestiary.sortMonsters,onUpdate:onSublistChange,customHashHandler:(a,b)=>ScaleCreature.scale(a,+b.split("_").last()),customHashUnpacker:getUnpackedCustomHashId}),SortUtil.initBtnSortHandlers($("#sublistsort"),subList);const c={shiftCount:5};ListUtil.bindAddButton(function(){return(a,b)=>{a=b||a,lastRendered.isScaled?a.shiftKey?ListUtil.pDoSublistAdd(Hist.lastLoadedId,!0,5,getScaledData()):ListUtil.pDoSublistAdd(Hist.lastLoadedId,!0,1,getScaledData()):ListUtil.genericAddButtonHandler(a,c)}},c),ListUtil.bindSubtractButton(function(){return(a,b)=>{a=b||a,lastRendered.isScaled?a.shiftKey?ListUtil.pDoSublistSubtract(Hist.lastLoadedId,5,getScaledData()):ListUtil.pDoSublistSubtract(Hist.lastLoadedId,1,getScaledData()):ListUtil.genericSubtractButtonHandler(a,c)}},c),ListUtil.initGenericAddable(),printBookView=new BookModeView({hashKey:"bookview",$openBtn:$(`#btn-printbook`),noneVisibleMsg:"If you wish to view multiple creatures, please first make a list",pageTitle:"Bestiary Printer View",popTblGetNumShown:async a=>{const b=await Promise.all(ListUtil.genericPinKeyMapper());b.sort((c,a)=>SortUtil.ascSort(c._displayName||c.name,a._displayName||a.name));let c=0;const d=[],e=a=>{if(d.push(`<div class="bkmv__wrp-item"><table class="stats stats--book stats--bkmv"><tbody>`),d.push(Renderer.monster.getCompactRenderedString(a,renderer)),a.legendaryGroup){const b=(meta[a.legendaryGroup.source]||{})[a.legendaryGroup.name];b&&(d.push(Renderer.monster.getCompactRenderedStringSection(b,renderer,"Lair Actions","lairActions",0)),d.push(Renderer.monster.getCompactRenderedStringSection(b,renderer,"Regional Effects","regionalEffects",0)))}d.push(`</tbody></table></div>`)};return d.push(`<div class="w-100 h-100">`),b.forEach(a=>e(a)),b.length||null==Hist.lastLoadedId||e(monsters[Hist.lastLoadedId]),d.push(`</div>`),c+=b.length,a.append(d.join("")),c},hasPrintColumns:!0});const d=$("button#profbonusdice");d.click(function(){window.PROF_DICE_MODE===PROF_MODE_DICE?(window.PROF_DICE_MODE=PROF_MODE_BONUS,this.innerHTML="Use Proficiency Dice",$("#pagecontent").find(`span.render-roller, span.dc-roller`).each(function(){const a=$(this);a.attr("mode",""),a.html(a.attr("data-roll-prof-bonus"))})):(window.PROF_DICE_MODE=PROF_MODE_DICE,this.innerHTML="Use Proficiency Bonus",$("#pagecontent").find(`span.render-roller, span.dc-roller`).each(function(){const a=$(this);a.attr("mode","dice"),a.html(a.attr("data-roll-prof-dice"))}))})}class EncounterBuilderUtils{static getSublistedEncounter(){return ListUtil.sublist.items.map(a=>{const b=monsters[a.ix];if(b.cr){const c=a.data.customHashId?+getUnpackedCustomHashId(a.data.customHashId).scaled:null;return{cr:a.values.cr,count:+a.values.count,crScaled:c,customHashId:a.data.customHashId,hash:UrlUtil.autoEncodeHash(b)}}}).filter(a=>a&&100!==a.cr).sort((c,a)=>SortUtil.ascSort(a.cr,c.cr))}static calculateListEncounterXp(a){return EncounterBuilderUtils.calculateEncounterXp(EncounterBuilderUtils.getSublistedEncounter(),a)}static getCrCutoff(a){return a=a.filter(a=>100!==getCr(a)).sort((c,a)=>SortUtil.ascSort(getCr(a),getCr(c))),2>=getCr(a[0])?0:getCr(a[0])/2}static calculateEncounterXp(a,b=ECGEN_BASE_PLAYERS){a=a.filter(a=>100!==getCr(a)).sort((c,a)=>SortUtil.ascSort(getCr(a),getCr(c)));let c=0,d=0;if(!a.length)return{baseXp:0,relevantCount:0,adjustedXp:0};const e=EncounterBuilderUtils.getCrCutoff(a);a.forEach(a=>{getCr(a)>=e&&(d+=a.count),c+=(Parser.crToXpNumber(Parser.numberToCr(getCr(a)))||0)*a.count});const f=Parser.numMonstersToXpMult(d,b),g=f*c;return{baseXp:c,relevantCount:d,adjustedXp:g,meta:{crCutoff:e,playerCount:b,playerAdjustedXpMult:f}}}}let _$totalCr;function onSublistChange(){_$totalCr=_$totalCr||$(`#totalcr`);const a=EncounterBuilderUtils.calculateListEncounterXp(encounterBuilder.lastPlayerCount);_$totalCr.html(`${a.baseXp.toLocaleString()} XP (<span class="help" title="Adjusted Encounter XP">Enc</span>: ${a.adjustedXp.toLocaleString()} XP)`),encounterBuilder.isActive()?encounterBuilder.updateDifficulty():encounterBuilder.doSaveState()}let monsters=[],mI=0;const lastRendered={mon:null,isScaled:!1};function getScaledData(){const a=lastRendered.mon;return{scaled:a._isScaledCr,customHashId:getMonCustomHashId(a)}}function getCustomHashId(a,b,c){return`${a}_${b}_${c}`.toLowerCase()}function getMonCustomHashId(a){return null==a._isScaledCr?null:getCustomHashId(a.name,a.source,a._isScaledCr)}function handleBestiaryLiClick(a,b){encounterBuilder.isActive()?Renderer.hover.doPopoutCurPage(a,monsters,b.ix):list.doSelect(b,a)}function handleBestiaryLiContext(a,b){encounterBuilder.isActive()||ListUtil.openContextMenu(a,list,b)}function handleBestiaryLinkClick(a){encounterBuilder.isActive()&&a.preventDefault()}const _addedHashes=new Set;function addMonsters(a){function b(a){return b=>{const c=a[Hist.lastLoadedId];if(b.shiftKey){const a=Renderer.hover.$getHoverContent_statsCode(c);Renderer.hover.getShowWindow(a,Renderer.hover.getWindowPositionFromEvent(b),{title:`${c.name} \u2014 Source Data`,isPermanent:!0,isBookContent:!0})}else if(null!=lastRendered.mon&&lastRendered.isScaled){const a=Renderer.hover._pageToRenderFn(UrlUtil.getCurrentPage()),c=$$`<table class="stats">${a(lastRendered.mon)}</table>`;Renderer.hover.getShowWindow(c,Renderer.hover.getWindowPositionFromEvent(b),{pageUrl:`#${UrlUtil.autoEncodeHash(lastRendered.mon)}`,title:lastRendered.mon._displayName||lastRendered.mon.name,isPermanent:!0})}else Renderer.hover.doPopoutCurPage(b,a,Hist.lastLoadedId)}}if(a&&a.length){for(monsters.push(...a);mI<monsters.length;mI++){const a=monsters[mI],b=bestiaryPage.getListItem(a,mI);b&&list.addItem(b)}list.update(),bestiaryPage._pageFilter.filterBox.render(),bestiaryPage.handleFilterChange(),ListUtil.setOptions({itemList:monsters,getSublistRow:bestiaryPage.pGetSublistItem.bind(bestiaryPage),primaryLists:[list]}),Renderer.hover.bindPopoutButton(monsters,b),UrlUtil.bindLinkExportButton(bestiaryPage._pageFilter.filterBox),ListUtil.bindDownloadButton(),ListUtil.bindUploadButton(pPreloadSublistSources),Renderer.utils.bindPronounceButtons()}}async function pPreloadSublistSources(a){a.l&&a.l.items&&a.l.sources&&(a.items=a.l.items,a.sources=a.l.sources);const b=Object.keys(bestiaryPage._multiSource.loadedSources).filter(a=>bestiaryPage._multiSource.loadedSources[a].loaded),c=a.sources.map(a=>a.toLowerCase()),d=Object.keys(bestiaryPage._multiSource.loadedSources).filter(a=>!b.includes(a)).filter(a=>c.includes(a.toLowerCase())),e=d.length;e&&(await Promise.all(d.map(a=>bestiaryPage._multiSource.pLoadSource(a,"yes"))))}let $btnProf=null;function renderStatblock(a,b){function c(b){return Renderer.utils.pBuildFluffTab(b,d,a,Renderer.monster.getFluff.bind(null,a,meta),`${JSON_DIR}${ixFluff[a.source]}`,()=>ixFluff[a.source])}lastRendered.mon=a,lastRendered.isScaled=b,renderer.setFirstSection(!0);const d=$("#pagecontent").empty(),e=$(`#wrp-profbonusdice`);null!==$btnProf&&(e.append($btnProf),$btnProf=null);const f=Renderer.utils.tabButton("Statblock",()=>{e.append($btnProf),$(`#float-token`).show()},function(){function c(a){return a.replace(/([^0-9d])/gi," $1 ").replace(/\s+/g," ")}const e=null==a.cr?null:$(`
			<button id="btn-scale-cr" title="Scale Creature By CR (Highly Experimental)" class="mon__btn-scale-cr btn btn-xs btn-default">
				<span class="glyphicon glyphicon-signal"/>
			</button>`).off("click").click(a=>{a.stopPropagation();const b=monsters[Hist.lastLoadedId],c=lastRendered.mon?lastRendered.mon.cr.cr||lastRendered.mon.cr:b.cr.cr||b.cr;Renderer.monster.getCrScaleTarget(e,c,a=>{a===Parser.crToNumber(b.cr)?renderStatblock(b):Hist.setSubhash(MON_HASH_SCALED,a)})}).toggle(100!==Parser.crToNumber(a.cr.cr||a.cr)),f=null==a.cr?null:$(`
			<button id="btn-reset-cr" title="Reset CR Scaling" class="mon__btn-reset-cr btn btn-xs btn-default">
				<span class="glyphicon glyphicon-refresh"></span>
			</button>`).click(()=>Hist.setSubhash(MON_HASH_SCALED,null)).toggle(b);d.append(RenderBestiary.$getRenderedCreature(a,meta,{$btnScaleCr:e,$btnResetScaleCr:f})),(()=>{function b(a){a&&$(a).parent().remove(),$(`#pagecontent th.name`).css("padding-right","0.3em"),$(`.mon__wrp-size-type-align`).css("max-width","none"),$(`.mon__wrp-avoid-token`).css("max-width","none")}const c=[];$(`#wrp-pagecontent`).off("scroll").on("scroll",function(){c.forEach(a=>{a.toggle(32>this.scrollTop).css({opacity:(32-this.scrollTop)/32,top:-this.scrollTop})})});const d=$(`#float-token`).empty();if(a.tokenUrl||!a.uniqueId){const e=Renderer.monster.getTokenUrl(a),f=$(`<img src="${e}" class="mon__token" alt="${a.name}">`).on("error",()=>b(f));c.push(f);const g=$$`<a href="${e}" class="mon__wrp-token" target="_blank" rel="noopener noreferrer">${f}</a>`.appendTo(d),h=[];if(a.altArt&&h.push(...MiscUtil.copy(a.altArt)),a.variant){const b=a.variant.filter(a=>a.token).map(a=>a.token);b.length&&h.push(...MiscUtil.copy(b).map(a=>({...a,displayName:`Variant; ${a.name}`})))}if(h.length){h.unshift({$ele:g});h.forEach(a=>{if(!a.$ele){const b=Renderer.monster.getTokenUrl({name:a.name,source:a.source}),e=$(`<img src="${b}" class="mon__token" alt="${a.displayName||a.name}">`).on("error",()=>{e.attr("src",`data:image/svg+xml,${encodeURIComponent(`
											<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400">
												<circle cx="200" cy="200" r="175" fill="#b00"/>
												<rect x="190" y="40" height="320" width="20" fill="#ddd" transform="rotate(45 200 200)"/>
												<rect x="190" y="40" height="320" width="20" fill="#ddd" transform="rotate(135 200 200)"/>
											</svg>`)}`)});c.push(e),a.$ele=$$`<a href="${b}" class="mon__wrp-token" target="_blank" rel="noopener noreferrer">${e}</a>`.hide().css("max-width","100%").appendTo(d)}});let a=0;const b=(b,c)=>{if(b.stopPropagation(),b.preventDefault(),0===a&&!~c)return;if(a===h.length-1&&~c)return;a+=c,~c?(i.show(),f.show(),a===h.length-1&&j.hide()):(0===a&&(i.hide(),f.hide()),j.show()),h.filter(a=>a.$ele).forEach(a=>a.$ele.hide());const d=h[a];d.$ele.show(),setTimeout(()=>d.$ele.css("max-width",""),10),d.name&&d.source?e.html(`<div>${d.displayName||d.name}; <span title="${Parser.sourceJsonToFull(d.source)}">${Parser.sourceJsonToAbv(d.source)}${0<d.page?` p${d.page}`:""}</span></div>`):e.html(""),f.detach().appendTo(d.$ele),i.detach().appendTo(d.$ele),j.detach().appendTo(d.$ele)},e=$(`<div class="mon__token-footer"/>`),f=$$`<div class="mon__wrp-token-footer">${e}</div>`.hide().appendTo(g),i=$$`<div class="mon__btn-token-cycle mon__btn-token-cycle--left"><span class="glyphicon glyphicon-chevron-left"/></div>`.click(a=>b(a,-1)).appendTo(g).hide(),j=$$`<div class="mon__btn-token-cycle mon__btn-token-cycle--right"><span class="glyphicon glyphicon-chevron-right"/></div>`.click(a=>b(a,1)).appendTo(g)}}else b()})();const g=PROF_DICE_MODE===PROF_MODE_DICE;d.find(".render-roller").filter(function(){return $(this).text().match(/^([-+])?\d+$/)}).each(function(){const b=+$(this).text(),d=Parser.crToPb(a.cr);let e,f,h=1,i=d;if($(this).parent().attr("data-mon-save")){const c=$(this).title();f=c.split(" ")[0].trim().toLowerCase().substring(0,3),e=Parser.getAbilityModNumber(a[f]),i=b-e,h=i===2*d?2:1}else if($(this).parent().attr("data-mon-skill")){const c=$(this).title();f=Parser.skillToAbilityAbv(c.toLowerCase().trim()),e=Parser.getAbilityModNumber(a[f]),i=b-e,h=i===2*d?2:1}const j=b-i;try{if(0<d){const a=c(`${h}d${i*(3-h)}${0<=j?"+":""}${j}`);$(this).attr("data-roll-prof-bonus",$(this).text()),$(this).attr("data-roll-prof-dice",a);const b=$(this).attr("onclick"),d=`
							(function(it) {
								if (PROF_DICE_MODE === PROF_MODE_DICE) {
									Renderer.dice.rollerClick(event, it, '{"type":"dice","rollable":true,"toRoll":"1d20 + ${a}"}'${$(this).prop("title")?`, '${$(this).prop("title")}'`:""})
								} else {
									${b.replace(/this/g,"it")}
								}
							})(this)`;$(this).attr("onclick",d),g&&$(this).html(a)}}catch(a){setTimeout(()=>{throw new Error(`Invalid save or skill roller! Bonus was ${0<=b?"+":""}${b}, but creature's PB was +${d} and relevant ability score (${f}) was ${0<=e?"+":""}${e} (should have been ${0<=d+e?"+":""}${d+e} total)`)},0)}}),d.find("p").each(function(){$(this).find(`.rd__dc`).each((b,d)=>{const e=$(d),f=+e.html(),h=Parser.crToPb(a.cr);if(0<h){const a=f-h,b=c(`1d${2*h}${0<=a?"+":""}${a}`);e.addClass("dc-roller").attr("mode",g?"dice":"").mousedown(a=>window.PROF_DICE_MODE===window.PROF_MODE_DICE&&a.preventDefault()).attr("onclick",`dcRollerClick(event, this, '${b}')`).attr("data-roll-prof-bonus",`${f}`).attr("data-roll-prof-dice",b).html(g?b:f)}})}),$(`#wrp-pagecontent`).scroll()}),g=Renderer.utils.tabButton("Info",()=>{$btnProf=e.children().length?e.children().detach():$btnProf,$(`#float-token`).hide()},c),h=Renderer.utils.tabButton("Images",()=>{$btnProf=e.children().length?e.children().detach():$btnProf,$(`#float-token`).hide()},()=>c(!0));Renderer.utils.bindTabButtons(f,g,h)}function handleUnknownHash(a){const b=Object.keys(bestiaryPage._multiSource.loadedSources).find(b=>b.toLowerCase()===decodeURIComponent(a.split(HASH_LIST_SEP)[1]).toLowerCase());b&&bestiaryPage._multiSource.pLoadSource(b,"yes").then(()=>Hist.hashChange())}function dcRollerClick(a,b,c){if(window.PROF_DICE_MODE!==PROF_MODE_BONUS){Renderer.dice.rollerClick(a,b,JSON.stringify({type:"dice",rollable:!0,toRoll:c}))}}function getUnpackedCustomHashId(a){return{scaled:+a.split("_").last(),customHashId:a}}function getCr(a){return null==a.crScaled?null==a.cr?null:"string"==typeof a.cr?a.cr.includes("/")?Parser.crToNumber(a.cr):+a.cr:a.cr:a.crScaled}const bestiaryPage=new BestiaryPage;window.addEventListener("load",()=>bestiaryPage.pOnLoad());
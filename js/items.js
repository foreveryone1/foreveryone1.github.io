"use strict";let mundaneList,magicList,subList;class ItemsPage{constructor(){this._pageFilter=new PageFilterItems,this._sublistCurrencyConversion=null,this._sublistCurrencyDisplayMode=null,this._$totalWeight=null,this._$totalValue=null}getListItem(a,b,c){if(ExcludeUtil.isExcluded(a.name,"item",a.source))return null;if(a.noDisplay)return null;Renderer.item.enhanceItem(a),this._pageFilter.mutateAndAddToFilters(a,c);const d=document.createElement("li");d.className=`row ${c?"row--blacklisted":""}`;const e=UrlUtil.autoEncodeHash(a),f=Parser.sourceJsonToAbv(a.source),g=a._typeListText.join(", ");if(a._fIsMundane){d.innerHTML=`<a href="#${e}" class="lst--border">
				<span class="col-3-5 pl-0 bold">${a.name}</span>
				<span class="col-4-5">${g}</span>
				<span class="col-1-5 text-center">${a.value||a.valueMult?Parser.itemValueToFull(a,!0).replace(/ +/g,"\xA0"):"\u2014"}</span>
				<span class="col-1-5 text-center">${Parser.itemWeightToFull(a,!0)||"\u2014"}</span>
				<span class="col-1 text-center ${Parser.sourceJsonToColor(a.source)} pr-0" title="${Parser.sourceJsonToFull(a.source)}" ${BrewUtil.sourceJsonToStyle(a.source)}>${f}</span>
			</a>`;const h=new ListItem(b,d,a.name,{hash:e,source:f,type:g,cost:a.value||0,weight:Parser.weightValueToNumber(a.weight)},{uniqueId:a.uniqueId?a.uniqueId:b,isExcluded:c});return d.addEventListener("click",a=>mundaneList.doSelect(h,a)),d.addEventListener("contextmenu",a=>ListUtil.openContextMenu(a,mundaneList,h)),{mundane:h}}else{d.innerHTML+=`<a href="#${e}" class="lst--border">
				<span class="col-3-5 pl-0 bold">${a.name}</span>
				<span class="col-4">${g}</span>
				<span class="col-1-5 text-center">${Parser.itemWeightToFull(a,!0)||"\u2014"}</span>
				<span class="attunement col-0-6 text-center">${"No"===a._attunementCategory?"":"\xD7"}</span>
				<span class="rarity col-1-4">${a.rarity}</span>
				<span class="source col-1 text-center ${Parser.sourceJsonToColor(a.source)} pr-0" title="${Parser.sourceJsonToFull(a.source)}" ${BrewUtil.sourceJsonToStyle(a.source)}>${f}</span>
			</a>`;const c=new ListItem(b,d,a.name,{source:f,hash:e,type:g,rarity:a.rarity,attunement:"No"!==a._attunementCategory,weight:Parser.weightValueToNumber(a.weight)},{uniqueId:a.uniqueId?a.uniqueId:b});return d.addEventListener("click",a=>magicList.doSelect(c,a)),d.addEventListener("contextmenu",a=>ListUtil.openContextMenu(a,magicList,c)),{magic:c}}}handleFilterChange(){function a(a){const c=itemList[a.ix];return this._pageFilter.toDisplay(b,c)}const b=this._pageFilter.filterBox.getValues();mundaneList.filter(a.bind(this)),magicList.filter(a.bind(this)),FilterBox.selectFirstVisible(itemList)}getSublistItem(a,b,c){const d=UrlUtil.autoEncodeHash(a),e=c||1,f=$(`<span class="text-center col-2 pr-0">${e}</span>`),g=$$`<li class="row">
			<a href="#${d}" class="lst--border">
				<span class="bold col-6 pl-0">${a.name}</span>
				<span class="text-center col-2">${a.weight?`${a.weight} lb${1<a.weight?"s":""}.`:"\u2014"}</span>
				<span class="text-center col-2">${a.value||a.valueMult?Parser.itemValueToFull(a,!0).replace(/ +/g,"\xA0"):"\u2014"}</span>
				${f}
			</a>
		</li>`.contextmenu(a=>ListUtil.openSubContextMenu(a,h)),h=new ListItem(b,g,a.name,{hash:d,source:Parser.sourceJsonToAbv(a.source),weight:Parser.weightValueToNumber(a.weight),cost:a.value||0,count:e},{$elesCount:[f]});return h}doLoadHash(a){function b(a){return Renderer.utils.pBuildFluffTab(a,c,d,a=>d.fluff||a.itemFluff.find(a=>a.name===d.name&&a.source===d.source),`data/fluff-items.json`,()=>!0)}Renderer.get().setFirstSection(!0);const c=$(`#pagecontent`).empty(),d=itemList[a],e=Renderer.utils.tabButton("Item",()=>{},function(){c.append(RenderItems.$getRenderedItem(d))}),f=Renderer.utils.tabButton("Info",()=>{},b),g=Renderer.utils.tabButton("Images",()=>{},b.bind(null,!0));d.fluff&&d.fluff.entries?Renderer.utils.bindTabButtons(e,f,g):Renderer.utils.bindTabButtons(e,g),ListUtil.updateSelected()}async pDoLoadSubHash(a){a=this._pageFilter.filterBox.setFromSubHashes(a),await ListUtil.pSetFromSubHashes(a)}onSublistChange(){this._$totalwWeight=this._$totalWeight||$(`#totalweight`),this._$totalValue=this._$totalValue||$(`#totalvalue`);let a=0,b=0;const c=new Set;if(ListUtil.sublist.items.forEach(d=>{const e=itemList[d.ix];e.currencyConversion&&c.add(e.currencyConversion);const f=d.values.count;e.weight&&(a+=+e.weight*f),e.value&&(b+=e.value*f)}),this._$totalwWeight.text(`${a.toLocaleString()} lb${1==a?"":"s"}.`),c.size)this._$totalValue.text(Parser.itemValueToFull({value:b,currencyConversion:this._sublistCurrencyConversion})).off("click").click(async()=>{const a=["(Default)",...[...c].sort(SortUtil.ascSortLower)],b=a.indexOf(this._sublistCurrencyConversion),d=await InputUiUtil.pGetUserEnum({values:a,isResolveItem:!0,default:~b?b:0,title:"Select Currency Conversion Table",fnDisplay:b=>null===b?a[0]:b});null==d||(this._sublistCurrencyConversion=d===a[0]?null:d,await StorageUtil.pSetForPage("sublistCurrencyConversion",this._sublistCurrencyConversion),this.onSublistChange())});else{const a=["Exact Coinage","Lowest Common Currency","Gold"],c=(()=>{switch(this._sublistCurrencyDisplayMode){case a[1]:return Parser.itemValueToFull({value:b});case a[2]:return b?`${Parser._DEFAULT_CURRENCY_CONVERSION_TABLE.find(a=>"gp"===a.coin).mult*b} gp`:"";default:case a[0]:{const a=["gp","sp","cp"],c={cp:b};return CurrencyUtil.doSimplifyCoins(c,a),a.filter(a=>c[a]).map(a=>`${c[a]} ${a}`).join(", ")}}})();this._$totalValue.text(c||"\u2014").off("click").click(async()=>{const b=a.indexOf(this._sublistCurrencyDisplayMode),c=await InputUiUtil.pGetUserEnum({values:a,isResolveItem:!0,default:~b?b:0,title:"Select Display Mode",fnDisplay:b=>null===b?a[0]:b});null==c||(this._sublistCurrencyDisplayMode=c===a[0]?null:c,await StorageUtil.pSetForPage("sublistCurrencyDisplayMode",this._sublistCurrencyDisplayMode),this.onSublistChange())})}}async pOnLoad(){return window.loadHash=this.doLoadHash.bind(this),window.loadSubHash=this.pDoLoadSubHash.bind(this),[this._sublistCurrencyConversion,this._sublistCurrencyDisplayMode]=await Promise.all([StorageUtil.pGetForPage("sublistCurrencyConversion"),StorageUtil.pGetForPage("sublistCurrencyDisplayMode")]),await ExcludeUtil.pInitialise(),await this._pageFilter.pInitFilterBox({$iptSearch:$(`#lst__search`),$wrpFormTop:$(`#filter-search-input-group`).title("Hotkey: f"),$btnReset:$(`#reset`)}),pPopulateTablesAndFilters({item:await Renderer.item.pBuildList({isAddGroups:!0,isBlacklistVariants:!0})})}}async function pPopulateTablesAndFilters(a){mundaneList=ListUtil.initList({listClass:"mundane",fnSort:PageFilterItems.sortItems}),magicList=ListUtil.initList({listClass:"magic",fnSort:PageFilterItems.sortItems}),mundaneList.nextList=magicList,magicList.prevList=mundaneList,ListUtil.setOptions({primaryLists:[mundaneList,magicList]});const b=$(`.ele-mundane-and-magic`);$(`.side-label--mundane`).click(()=>{itemsPage._pageFilter.filterBox.setFromValues({Miscellaneous:{Mundane:1}}),itemsPage.handleFilterChange()}),$(`.side-label--magic`).click(()=>{itemsPage._pageFilter.filterBox.setFromValues({Miscellaneous:{Magic:1}}),itemsPage.handleFilterChange()});const c=$(`.lst__wrp-search-visible`);mundaneList.on("updated",()=>{const a=$(`.ele-mundane`);magicList.visibleItems.length?a.toggle(!!mundaneList.visibleItems.length):a.show(),b.toggle(!!(mundaneList.visibleItems.length&&magicList.visibleItems.length));const d=mundaneList.visibleItems.length+magicList.visibleItems.length,e=mundaneList.items.length+magicList.items.length;c.html(`${d}/${e}`)}),magicList.on("updated",()=>{const a=$(`.ele-mundane`),d=$(`.ele-magic`);d.toggle(!!magicList.visibleItems.length),magicList.visibleItems.length?a.toggle(!!mundaneList.visibleItems.length):a.show(),b.toggle(!!(mundaneList.visibleItems.length&&magicList.visibleItems.length));const e=mundaneList.visibleItems.length+magicList.visibleItems.length,f=mundaneList.items.length+magicList.items.length;c.html(`${e}/${f}`)}),$(itemsPage._pageFilter.filterBox).on(FilterBox.EVNT_VALCHANGE,itemsPage.handleFilterChange.bind(itemsPage)),SortUtil.initBtnSortHandlers($("#filtertools-mundane"),mundaneList),SortUtil.initBtnSortHandlers($("#filtertools-magic"),magicList),subList=ListUtil.initSublist({listClass:"subitems",fnSort:PageFilterItems.sortItems,getSublistRow:itemsPage.getSublistItem.bind(itemsPage),onUpdate:itemsPage.onSublistChange.bind(itemsPage)}),SortUtil.initBtnSortHandlers($("#sublistsort"),subList),ListUtil.initGenericAddable(),addItems(a),BrewUtil.pAddBrewData().then(handleBrew).then(()=>BrewUtil.bind({lists:[mundaneList,magicList]})).then(()=>BrewUtil.pAddLocalBrewData()).then(async()=>{BrewUtil.makeBrewButton("manage-brew"),BrewUtil.bind({lists:[mundaneList,magicList],filterBox:itemsPage._pageFilter.filterBox,sourceFilter:itemsPage._pageFilter.sourceFilter}),await ListUtil.pLoadState(),RollerUtil.addListRollButton(),ListUtil.addListShowHide(),ListUtil.bindShowTableButton("btn-show-table","Items",itemList,{name:{name:"Name",transform:!0},source:{name:"Source",transform:a=>`<span class="${Parser.sourceJsonToColor(a)}" title="${Parser.sourceJsonToFull(a)}" ${BrewUtil.sourceJsonToStyle(a.source)}>${Parser.sourceJsonToAbv(a)}</span>`},rarity:{name:"Rarity",transform:!0},_type:{name:"Type",transform:a=>a._typeHtml},_attunement:{name:"Attunement",transform:a=>a._attunement?a._attunement.slice(1,a._attunement.length-1):""},_properties:{name:"Properties",transform:a=>Renderer.item.getDamageAndPropertiesText(a).filter(Boolean).join(", ")},_weight:{name:"Weight",transform:a=>Parser.itemWeightToFull(a)},_value:{name:"Value",transform:a=>Parser.itemValueToFull(a)},_entries:{name:"Text",transform:a=>Renderer.item.getRenderedEntries(a,!0),flex:3}},{generator:ListUtil.basicFilterGenerator},(c,a)=>SortUtil.ascSort(c.name,a.name)||SortUtil.ascSort(c.source,a.source)),mundaneList.init(),magicList.init(),subList.init(),Hist.init(!0),ExcludeUtil.checkShowAllExcluded(itemList,$(`#pagecontent`)),window.dispatchEvent(new Event("toolsLoaded"))})}async function handleBrew(a){const b=await Renderer.item.getItemsFromHomebrew(a);addItems({item:b})}let itemList=[],itI=0;function addItems(a){if(a.item&&a.item.length){for(itemList.push(...a.item);itI<itemList.length;itI++){const a=itemList[itI],b=itemsPage.getListItem(a,itI);b&&(b.mundane&&mundaneList.addItem(b.mundane),b.magic&&magicList.addItem(b.magic))}$(`h3.ele-mundane span.side-label`).text("Mundane"),$(`h3.ele-magic span.side-label`).text("Magic"),mundaneList.update(),magicList.update(),itemsPage._pageFilter.filterBox.render(),itemsPage.handleFilterChange(),ListUtil.setOptions({itemList:itemList,getSublistRow:itemsPage.getSublistItem.bind(itemsPage),primaryLists:[mundaneList,magicList]}),ListUtil.bindAddButton(),ListUtil.bindSubtractButton(),Renderer.hover.bindPopoutButton(itemList),UrlUtil.bindLinkExportButton(itemsPage._pageFilter.filterBox),ListUtil.bindDownloadButton(),ListUtil.bindUploadButton()}}const itemsPage=new ItemsPage;window.addEventListener("load",()=>itemsPage.pOnLoad());
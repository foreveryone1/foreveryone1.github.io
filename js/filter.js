"use strict";class FilterUtil{}FilterUtil.SUB_HASH_PREFIX_LENGTH=4;class PageFilter{static defaultSourceSelFn(e){return!SourceUtil.isNonstandardSource(e)}constructor(){this._sourceFilter=SourceFilter.getInstance(),this._filterBox=null}get filterBox(){return this._filterBox}get sourceFilter(){return this._sourceFilter}mutateAndAddToFilters(e,t){this.mutateForFilters(e),this.addToFilters(e,t)}mutateForFilters(e){throw new Error("Unimplemented!")}addToFilters(e,t){throw new Error("Unimplemented!")}toDisplay(e,t){throw new Error("Unimplemented!")}async _pPopulateBoxOptions(){throw new Error("Unimplemented!")}async pInitFilterBox(e){return await this._pPopulateBoxOptions(e),this._filterBox=new FilterBox(e),await this._filterBox.pDoLoadState(),this._filterBox}}class ModalFilter{static _$getFilterColumnHeaders(e){return e.map((t,s)=>$(`<button class="col-${t.width} ${0===s?"pl-0":s===e.length?"pr-0":""} sort btn btn-default btn-xs" data-sort="${t.sort}" ${t.title?`title="${t.title}"`:""}>${t.text} <span class="caret_wrp"></span></button>`))}static handleSelectClick(e,t,i,s){if(s=s||{},i.preventDefault(),i.stopPropagation(),i&&i.shiftKey&&e.__firstListSelection&&e.__firstListSelection!==t){const n=e.__lastListSelection?!!t.data.cbSel&&!t.data.cbSel.checked:!!e.__firstListSelection.data.cbSel&&e.__firstListSelection.data.cbSel.checked,a=e.visibleItems.indexOf(e.__firstListSelection),d=e.visibleItems.indexOf(t),[_,l]=[a,d].sort(SortUtil.ascSort);for(let t=_;t<=l;++t){const i=e.visibleItems[t];e.__lastListSelection&&i===e.__firstListSelection||(i.data.cbSel&&(i.data.cbSel.checked=n,s.fnOnSelectionChange&&s.fnOnSelectionChange(i,n)),!s.isNoHighlightSelection&&(n?i.ele.classList.add("list-multi-selected"):i.ele.classList.remove("list-multi-selected")))}e.__lastListSelection=t}else t.data.cbSel?(t.data.cbSel.checked=!t.data.cbSel.checked,s.fnOnSelectionChange&&s.fnOnSelectionChange(t,t.data.cbSel.checked),!s.isNoHighlightSelection&&(t.data.cbSel.checked?t.ele.classList.add("list-multi-selected"):t.ele.classList.remove("list-multi-selected"))):!s.isNoHighlightSelection&&t.ele.classList.remove("list-multi-selected"),e.__firstListSelection=t,e.__lastListSelection=null}static bindSelectAllCheckbox(e,t){e.change(()=>{const i=e.prop("checked");t.visibleItems.forEach(e=>{e.data.cbSel&&(e.data.cbSel.checked=i),i?e.ele.classList.add("list-multi-selected"):e.ele.classList.remove("list-multi-selected")})})}constructor(e){this._modalTitle=e.modalTitle,this._fnSort=e.fnSort,this._pageFilter=e.pageFilter,this._namespace=e.namespace,this._filterCache=null}async pGetUserSelection(){return new Promise(async e=>{let t;const{$modalInner:i,doClose:s}=UiUtil.getShowModal({fullHeight:!0,title:`Filter/Search for ${this._modalTitle}`,cbClose:i=>{t.detach(),i||e([])},isLarge:!0,zIndex:999});if(this._filterCache)t=this._filterCache.$wrpModalInner.appendTo(i);else{await this._pInit();const e=$(`<div class="w-100 h-100 flex-vh-center"><i class="dnd-font text-muted">Loading...</i></div>`).appendTo(i),s=$(`<input class="form-control" type="search" placeholder="Search...">`),n=$(`<button class="btn btn-default">Reset</button>`),a=$$`<div class="flex input-group btn-group w-100 lst__form-top">${s}${n}</div>`,d=$(`<div class="w-100"/>`),_=$(`<div class="sortlabel lst__form-bottom"/>`),l=$(`<input type="checkbox">`);$$`<label class="btn btn-default col-1 flex-vh-center">${l}</label>`.appendTo(_),this._$getColumnHeaders().forEach(e=>_.append(e));const r=$$`<div class="flex-col w-100 mb-2">${a}${d}${_}</div>`,o=$(`<ul class="list mb-2 h-100"/>`),m=$(`<button class="btn btn-default">Confirm</button>`),u=new List({$iptSearch:s,$wrpList:o,fnSort:this._fnSort});ModalFilter.bindSelectAllCheckbox(l,u),SortUtil.initBtnSortHandlers(_,u);const c=await this._pLoadAllData(),p=this._pageFilter;await p.pInitFilterBox({$wrpFormTop:a,$btnReset:n,$wrpMiniPills:d,namespace:this._namespace}),c.forEach((e,t)=>{p.mutateAndAddToFilters(e);const i=this._getListItem(p,e,t);u.addItem(i),i.ele.addEventListener("click",e=>ModalFilter.handleSelectClick(u,i,e))}),u.init(),u.update();const h=()=>{const e=p.filterBox.getValues();u.filter(t=>{const i=c[t.ix];return p.toDisplay(e,i)})};$(p.filterBox).on(FilterBox.EVNT_VALCHANGE,h),p.filterBox.render(),h(),e.remove(),t=$$`<div class="flex-col h-100">
					${r}
					${o}
					<div class="flex-vh-center">${m}</div>
				</div>`.appendTo(i),this._filterCache={$wrpModalInner:t,$btnConfirm:m,pageFilter:p,list:u,$cbSelAll:l}}this._filterCache.$btnConfirm.off("click").click(async()=>{const t=this._filterCache.list.visibleItems.filter(e=>e.data.cbSel.checked);e(t),s(!0),this._filterCache.$cbSelAll.prop("checked",!1),this._filterCache.list.items.forEach(e=>{e.data.cbSel&&(e.data.cbSel.checked=!1),e.ele.classList.remove("list-multi-selected")})})})}_$getColumnHeaders(){throw new Error(`Unimplemented!`)}async _pInit(){}async _pLoadAllData(){throw new Error(`Unimplemented!`)}async _getListItem(){throw new Error(`Unimplemented!`)}}class FilterBox extends ProxyBase{static selectFirstVisible(e){null!=Hist.lastLoadedId||Hist.initialLoad||Hist._freshLoad()}constructor(e){super(),this._$iptSearch=e.$iptSearch,this._$wrpFormTop=e.$wrpFormTop,this._$btnReset=e.$btnReset,this._$btnOpen=e.$btnOpen,this._$wrpMiniPills=e.$wrpMiniPills,this._filters=e.filters,this._isCompact=e.isCompact,this._namespace=e.namespace,this._doSaveStateDebounced=MiscUtil.debounce(()=>this._pDoSaveState(),50),this.__meta=this._getDefaultMeta(),this._isCompact&&(this.__meta.isSummaryHidden=!0),this._meta=this._getProxy("meta",this.__meta),this.__minisHidden={},this._minisHidden=this._getProxy("minisHidden",this.__minisHidden),this.__combineAs={},this._combineAs=this._getProxy("combineAs",this.__combineAs),this._$body=$(`body`),this._$overlay=null,this._cachedState=null,this._filters.forEach(e=>e.filterBox=this)}_getNamespacedStorageKey(){return`${FilterBox._STORAGE_KEY}${this._namespace?`.${this._namespace}`:""}`}getNamespacedHashKey(e){return`${e||"_".repeat(FilterUtil.SUB_HASH_PREFIX_LENGTH)}${this._namespace?`.${this._namespace}`:""}`}async pGetStoredActiveSources(){const e=await StorageUtil.pGetForPage(this._getNamespacedStorageKey());if(e){const t=e.filters[FilterBox.SOURCE_HEADER];if(t){const e=t.state,i=[],s=[];return Object.entries(e).forEach(([e,t])=>{1===t?i.push(e):-1!==t&&s.push(e)}),i.length?i:s}}return null}registerMinisHiddenHook(e,t){this._addHook("minisHidden",e,t)}isMinisHidden(e){return!!this._minisHidden[e]}async pDoLoadState(){const e=await StorageUtil.pGetForPage(this._getNamespacedStorageKey());null!=e&&this._setStateFromLoaded(e)}_setStateFromLoaded(e){e.box=e.box||{},this._proxyAssign("meta","_meta","__meta",e.box.meta||{},!0),this._proxyAssign("minisHidden","_minisHidden","__minisHidden",e.box.minisHidden||{},!0),this._proxyAssign("combineAs","_combineAs","__combineAs",e.box.combineAs||{},!0),this._filters.forEach(t=>t.setStateFromLoaded(e.filters))}_getSaveableState(){const e={};return this._filters.forEach(t=>Object.assign(e,t.getSaveableState())),{box:{meta:{...this.__meta},minisHidden:{...this.__minisHidden},combineAs:{...this.__combineAs}},filters:e}}async _pDoSaveState(){await StorageUtil.pSetForPage(this._getNamespacedStorageKey(),this._getSaveableState())}render(){if(this._$overlay)this._filters.map(e=>e.update());else{this._$overlay=this._render_$getOverlay(),this._$wrpMiniPills?this._$wrpMiniPills.addClass("fltr__mini-view"):this._$wrpMiniPills=$(`<div class="fltr__mini-view btn-group"/>`).insertAfter(this._$wrpFormTop);const e=this._filters.map((e,t)=>e.$render({filterBox:this,isFirst:0===t,$wrpMini:this._$wrpMiniPills})),t=$(`<button class="btn btn-xs btn-default">Show All</button>`).click(()=>this.showAllFilters()),i=$(`<button class="btn btn-xs btn-default">Hide All</button>`).click(()=>this.hideAllFilters()),s=$(`<button class="btn btn-xs btn-default mr-3" title="Reset filters. SHIFT to reset everything.">Reset</button>`).click(e=>this.reset(e.shiftKey)),n=$(`<button class="btn btn-xs btn-default mr-3"><span class="glyphicon glyphicon-cog"/></button>`).click(()=>this._openSettingsModal()),a=$(`<button class="btn btn-xs btn-primary" title="Save"><span class="glyphicon glyphicon-ok"/></button>`).click(()=>this.pHide()),d=$(`<div class="btn-group mr-3"></div>`),_=$(`<button class="btn btn-xs btn-default"><span class="glyphicon glyphicon-cog"/></button>`).click(()=>this._openCombineAsModal()),l=$(`<button class="btn btn-xs btn-default"/>`).appendTo(d).click(()=>this._meta.modeCombineFilters=FilterBox._COMBINE_MODES.getNext(this._meta.modeCombineFilters)),r=()=>{l.text("custom"===this._meta.modeCombineFilters?this._meta.modeCombineFilters.uppercaseFirst():this._meta.modeCombineFilters.toUpperCase()),"custom"===this._meta.modeCombineFilters?d.append(_):_.detach(),this._doSaveStateDebounced()};this._addHook("meta","modeCombineFilters",r),r();const o=$(`<button class="btn btn-primary fltr__btn-close mr-2">Save</button>`).click(()=>this.pHide()),m=$(`<button class="btn btn-default fltr__btn-close">Cancel</button>`).click(()=>this.pHide(!0));$$`<div class="ui-modal__inner flex-col ui-modal__inner--large dropdown-menu">
			<div class="split mb-2 mt-2 flex-v-center mobile__flex-col">
				<h4 class="m-0 mobile__mb-2">Filters</h4>
				<div class="flex-v-center mobile__flex-col">
					<div class="flex-v-center mobile__m-1">
						<div class="mr-2">Combine as</div>
						${d}
					</div>
					<div class="flex-v-center mobile__m-1">
						<div class="btn-group mr-2">
							${t}
							${i}
						</div>
						${s}
						${n}
						${a}
					</div>
				</div>
			</div>
			<hr class="w-100 m-0 mb-2">

			<hr class="mt-1 mb-1">
			<div class="ui-modal__scroller smooth-scroll px-1">
				${e}
			</div>
			<hr class="my-1 w-100">
			<div class="w-100 flex-vh-center my-1">${o}${m}</div>
			</div>`.click(e=>e.stopPropagation()).appendTo(this._$overlay),this._$btnReset&&this._$btnReset.title("Reset filters. SHIFT to reset everything.").click(e=>this.reset(e.shiftKey));const u=$(`<button class="btn btn-default ${this._isCompact?"p-2":""}" title="Toggle Filter Summary Display"><span class="glyphicon glyphicon-resize-small"/></button>`).click(()=>{this._meta.isSummaryHidden=!this._meta.isSummaryHidden,this._doSaveStateDebounced()}).prependTo(this._$wrpFormTop),f=()=>{u.toggleClass("active",!!this._meta.isSummaryHidden),this._$wrpMiniPills.toggleClass("ve-hidden",!!this._meta.isSummaryHidden)};this._addHook("meta","isSummaryHidden",f),f(),this._$btnOpen?this._$btnOpen.click(()=>this.show()):$(`<button class="btn btn-default ${this._isCompact?"px-2":""}">Filter</button>`).click(()=>this.show()).prependTo(this._$wrpFormTop);const c=this._filters.find(e=>e.header===FilterBox.SOURCE_HEADER);if(c){const e=e=>!SourceUtil.isNonstandardSource(e)&&!BrewUtil.hasSourceJson(e),t=()=>{this._meta.isBrewDefaultHidden?c.setTempFnSel(e):c.setTempFnSel(null),c.updateMiniPillClasses()};this._addHook("meta","isBrewDefaultHidden",t),t()}}}_render_$getOverlay(){return $(`<div class="modal__wrp modal__wrp--no-centre"/>`).hide().appendTo(this._$body).click(()=>this.pHide(!0))}_openSettingsModal(){const{$modalInner:e}=UiUtil.getShowModal({title:"Settings"});UiUtil.$getAddModalRowCb(e,"Deselect Homebrew Sources by Default",this._meta,"isBrewDefaultHidden"),UiUtil.addModalSep(e),UiUtil.$getAddModalRowHeader(e,"Hide summary for filter...",{helpText:"The summary is the small red and blue button panel which appear below the search bar."}),this._filters.forEach(t=>UiUtil.$getAddModalRowCb(e,t.header,this._minisHidden,t.header))}_openCombineAsModal(){const{$modalInner:e}=UiUtil.getShowModal({title:"Filter Combination Logic"}),t=$(`<button class="btn btn-xs btn-default">Reset</button>`).click(()=>{Object.keys(this._combineAs).forEach(e=>this._combineAs[e]="and"),i.forEach(e=>e.val("0"))});UiUtil.$getAddModalRowHeader(e,"Combine filters as...",{$eleRhs:t});const i=this._filters.map(t=>UiUtil.$getAddModalRowSel(e,t.header,this._combineAs,t.header,["and","or"],{fnDisplay:e=>e.toUpperCase()}))}getValues(){const e={};return this._filters.forEach(t=>Object.assign(e,t.getValues())),e}addEventListener(e,t){(this._$wrpFormTop?this._$wrpFormTop[0]:this._$btnOpen[0]).addEventListener(e,t)}_reset_meta(){Object.assign(this._meta,this._getDefaultMeta())}_reset_minisHidden(){Object.keys(this._minisHidden).forEach(e=>this._minisHidden[e]=!1)}_reset_combineAs(){Object.keys(this._combineAs).forEach(e=>this._combineAs[e]="and")}reset(e){this._filters.forEach(t=>t.reset(e)),e&&(this._reset_meta(),this._reset_minisHidden(),this._reset_combineAs()),this.render(),this.fireChangeEvent()}show(){this._cachedState=this._getSaveableState(),this._$body.css("overflow","hidden"),this._$overlay.show()}async pHide(e=!1){if(this._cachedState&&e){const e=this._getSaveableState(),t=!CollectionUtil.deepEquals(e,this._cachedState);if(this._$body.css("overflow",""),this._$overlay.hide(),t){const e=await InputUiUtil.pGetUserBoolean({title:"Unsaved Changes",textYes:"Save",textNo:"Discard"});if(e)return this._cachedState=null,void this.fireChangeEvent();this._setStateFromLoaded(this._cachedState)}}else this._$body.css("overflow",""),this._$overlay.hide(),this.fireChangeEvent();this._cachedState=null}showAllFilters(){this._filters.forEach(e=>e.show())}hideAllFilters(){this._filters.forEach(e=>e.hide())}setFromSubHashes(e,t=!1){const i={};e.forEach(e=>{const t=UrlUtil.unpackSubHash(e,!0);if(1<Object.keys(t).length)throw new Error(`Multiple keys in subhash!`);const s=Object.keys(t)[0];t[s]={clean:t[s],raw:e},Object.assign(i,t)});const s={};this._filters.forEach(e=>{const t=e.getChildFilters();t.length&&t.forEach(e=>s[e.header.toLowerCase()]=e),s[e.header.toLowerCase()]=e});const n=new Set,a=new Set;let d;const _={},l={},r=this.getNamespacedHashKey().length;if(Object.entries(i).forEach(([e,t])=>{const i=e.substring(0,r),o=i.substring(0,FilterUtil.SUB_HASH_PREFIX_LENGTH),m=e.substring(r);if("search"===m)return d=t.clean[0],void a.add(t.raw);if(FilterUtil.SUB_HASH_PREFIXES.has(o)&&s[m])(l[m]=l[m]||{})[o]=t.clean,n.add(m),a.add(t.raw);else if(Object.values(FilterBox._SUB_HASH_PREFIXES).includes(o))_[o]=t.clean,a.add(t.raw);else if(FilterUtil.SUB_HASH_PREFIXES.has(o))throw new Error(`Could not find filter with header ${m} for subhash ${t.raw}`)}),a.size||t){this._setFromSubHashState(s,_),Object.entries(l).forEach(([e,t])=>{const i=s[e];i.setFromSubHashState(t)}),Object.keys(s).filter(e=>!n.has(e)).forEach(e=>{const t=s[e];t.resetShallow(!0)});const[e]=Hist.getHashParts(),t=[];return Object.values(i).filter(e=>!a.has(e.raw)).forEach(e=>t.push(e.raw)),Hist.setSuppressHistory(!0),window.history.replaceState({},document.title,`${location.origin}${location.pathname}#${e}${t.length?`${HASH_PART_SEP}${t.join(HASH_PART_SEP)}`:""}`),d&&this._$iptSearch&&this._$iptSearch.val(d).change().keydown().keyup(),this.fireChangeEvent(),Hist.hashChange(),t}return e}_setFromSubHashState(e,t){let i=!1,s=!1,n=!1;Object.entries(t).forEach(([t,a])=>{const d=this.getNamespacedHashKey(Parser._parse_bToA(FilterBox._SUB_HASH_PREFIXES,t));switch(d){case"meta":{i=!0;const e=a.map(e=>UrlUtil.mini.decompress(e));Object.keys(this._getDefaultMeta()).forEach((t,s)=>this._meta[t]=e[s]);break}case"minisHidden":{s=!0,Object.keys(this._minisHidden).forEach(e=>this._minisHidden[e]=!1),a.forEach(t=>{const[i,s]=t.split("="),n=e[i];if(!n)throw new Error(`Could not find filter with name "${i}"`);this._minisHidden[n.header]=!!+s});break}case"combineAs":{n=!0,Object.keys(this._combineAs).forEach(e=>this._combineAs[e]="and"),a.forEach(t=>{const[i,s]=t.split("="),n=e[i];if(!n)throw new Error(`Could not find filter with name "${i}"`);this._combineAs[n.header]=FilterBox._COMBINE_MODES[s]||FilterBox._COMBINE_MODES[0]});break}}}),i||this._reset_meta(),s||this._reset_minisHidden(),n||this._reset_combineAs()}getSubHashes(){const e=[],t=this.getBoxSubHashes();return t&&e.push(t),e.push(...this._filters.map(e=>e.getSubHashes()).filter(Boolean)),e.flat()}getBoxSubHashes(){const e=[],t=this._getDefaultMeta(),i=Object.keys(t).find(e=>this._meta[e]!==t[e]);if(i){const i=Object.keys(t).map(e=>UrlUtil.mini.compress(void 0===this._meta[e]?t[e]:this._meta[e]));e.push(UrlUtil.packSubHash(this._getSubhashPrefix("meta"),i))}const s=Object.entries(this._minisHidden).filter(([e,t])=>!!t).map(([e])=>`${e.toUrlified()}=1`);s.length&&e.push(UrlUtil.packSubHash(this._getSubhashPrefix("minisHidden"),s));const n=Object.entries(this._combineAs).filter(([e,t])=>t!==FilterBox._COMBINE_MODES[0]).map(([e,t])=>`${e.toUrlified()}=${FilterBox._COMBINE_MODES.indexOf(t)}`);return n.length&&e.push(UrlUtil.packSubHash(this._getSubhashPrefix("combineAs"),n)),e.length?e:null}setFromValues(e){this._filters.forEach(t=>t.setFromValues(e))}toDisplay(e,...t){const i=(i,s=t)=>i.map((t,n)=>t.toDisplay(e,s[n])).every(e=>e),s=(i,s=t)=>{const n=i.map((t,n)=>t.isActive(e)?t.toDisplay(e,s[n]):null).filter(e=>null!=e);return 0===n.length||n.find(e=>e)};switch(this._meta.modeCombineFilters){case"and":return i(this._filters);case"or":return s(this._filters);case"custom":{const e=[],n=[],a=[],d=[];if(t.length!==this._filters.length)throw new Error(`Number of filters and number of values did not match!`);for(let s=0;s<this._filters.length;++s){const i=this._filters[s];this._combineAs[i.header]&&"and"!==this._combineAs[i.header]?(a.push(i),d.push(t[s])):(e.push(i),n.push(t[s]))}return i(e,n)&&s(a,d)}default:throw new Error(`Unhandled combining mode "${this._meta.modeCombineFilters}"`);}}fireChangeEvent(){this._doSaveStateDebounced();const e=new Event(FilterBox.EVNT_VALCHANGE);(this._$wrpFormTop?this._$wrpFormTop[0]:this._$btnOpen[0]).dispatchEvent(e)}_getSubhashPrefix(e){if(FilterBox._SUB_HASH_PREFIXES[e])return this.getNamespacedHashKey(FilterBox._SUB_HASH_PREFIXES[e]);throw new Error(`Unknown property "${e}"`)}_getDefaultMeta(){const e=MiscUtil.copy(FilterBox._DEFAULT_META);return this._isCompact&&(e.isSummaryHidden=!0),e}}FilterBox.EVNT_VALCHANGE="valchange",FilterBox.SOURCE_HEADER="Source",FilterBox._PILL_STATES=["ignore","yes","no"],FilterBox._COMBINE_MODES=["and","or","custom"],FilterBox._STORAGE_KEY="filterBoxState",FilterBox._DEFAULT_META={modeCombineFilters:"and",isSummaryHidden:!1,isBrewDefaultHidden:!1},FilterBox._SUB_HASH_BOX_META_PREFIX="fbmt",FilterBox._SUB_HASH_BOX_MINIS_HIDDEN_PREFIX="fbmh",FilterBox._SUB_HASH_BOX_COMBINE_AS_PREFIX="fbca",FilterBox._SUB_HASH_PREFIXES={meta:FilterBox._SUB_HASH_BOX_META_PREFIX,minisHidden:FilterBox._SUB_HASH_BOX_MINIS_HIDDEN_PREFIX,combineAs:FilterBox._SUB_HASH_BOX_COMBINE_AS_PREFIX};class FilterItem{constructor(e){this.item=e.item,this.pFnChange=e.pFnChange,this.group=e.group,this.nest=e.nest,this.nestHidden=e.nestHidden,this.isIgnoreRed=e.isIgnoreRed,this.userData=e.userData,this.$rendered=null}}class FilterBase extends BaseComponent{constructor(e){super(),this._filterBox=null,this.header=e.header,this.__meta={...this.getDefaultMeta()},this._meta=this._getProxy("meta",this.__meta)}set filterBox(e){this._filterBox=e}show(){this._meta.isHidden=!1}hide(){this._meta.isHidden=!0}getBaseSaveableState(){return{meta:{...this.__meta}}}resetBase(){Object.assign(this._meta,MiscUtil.copy(this.getDefaultMeta()))}getMetaSubHashes(){const e=Object.keys(FilterBase._DEFAULT_META).find(e=>this._meta[e]!==FilterBase._DEFAULT_META[e]);if(e){const e=Object.keys(FilterBase._DEFAULT_META).map(e=>UrlUtil.mini.compress(this._meta[e]===void 0?FilterBase._DEFAULT_META[e]:this._meta[e]));return[UrlUtil.packSubHash(this.getSubHashPrefix("meta",this.header),e)]}return null}setMetaFromSubHashState(e){const t=this._doApplyMeta(e,this.getDefaultMeta());t||this.resetBase()}_doApplyMeta(e,t){let i=!1;return Object.entries(e).forEach(([e,s])=>{const n=FilterBase.getProp(e);if("meta"===n){i=!0;const e=s.map(e=>UrlUtil.mini.decompress(e));Object.keys(t).forEach((s,n)=>{this._meta[s]=void 0===e[n]?t[s]:e[n]})}}),i}setBaseStateFromLoaded(e){Object.assign(this._meta,e.meta)}getSubHashPrefix(e,t){if(FilterBase._SUB_HASH_PREFIXES[e]){const i=this._filterBox.getNamespacedHashKey(FilterBase._SUB_HASH_PREFIXES[e]);return`${i}${t.toUrlified()}`}throw new Error(`Unknown property "${e}"`)}static getProp(e){return Parser._parse_bToA(FilterBase._SUB_HASH_PREFIXES,e)}_$getBtnMobToggleControls(e){const t=$(`<button class="btn btn-xs btn-default mobile__visible ml-2 px-3"><span class="glyphicon glyphicon-option-vertical"/></button>`).click(()=>this._meta.isMobileHeaderHidden=!this._meta.isMobileHeaderHidden),i=()=>{t.toggleClass("active",!this._meta.isMobileHeaderHidden),e.toggleClass("mobile__hidden",!!this._meta.isMobileHeaderHidden)};return this._addHook("meta","isMobileHeaderHidden",i),i(),t}getChildFilters(){return[]}getDefaultMeta(){return{...FilterBase._DEFAULT_META}}isActive(e){return e=e||this.getValues(),e[this.header]._isActive}$render(){throw new Error(`Unimplemented!`)}getValues(){throw new Error(`Unimplemented!`)}reset(){throw new Error(`Unimplemented!`)}resetShallow(){throw new Error(`Unimplemented!`)}update(){throw new Error(`Unimplemented!`)}toDisplay(){throw new Error(`Unimplemented!`)}addItem(){throw new Error(`Unimplemented!`)}getSaveableState(){throw new Error(`Unimplemented!`)}setStateFromLoaded(){throw new Error(`Unimplemented!`)}getSubHashes(){throw new Error(`Unimplemented!`)}setFromSubHashState(){throw new Error(`Unimplemented!`)}setFromValues(){throw new Error(`Unimplemented!`)}}FilterBase._DEFAULT_META={isHidden:!1,isMobileHeaderHidden:!0},FilterBase._SUB_HASH_STATE_PREFIX="flst",FilterBase._SUB_HASH_META_PREFIX="flmt",FilterBase._SUB_HASH_NESTS_HIDDEN_PREFIX="flnh",FilterBase._SUB_HASH_PREFIXES={state:FilterBase._SUB_HASH_STATE_PREFIX,meta:FilterBase._SUB_HASH_META_PREFIX,nestsHidden:FilterBase._SUB_HASH_NESTS_HIDDEN_PREFIX};class Filter extends FilterBase{static _getAsFilterItems(e){return e?e.map(e=>e instanceof FilterItem?e:new FilterItem({item:e})):null}static _validateItemNests(e,t){if(t){const i=e.find(e=>!t[e.nest]);if(i)throw new Error(`Did not have a nest: "${i.item}"`);const s=e.find(e=>!e.nest||!t[e.nest]);if(s)throw new Error(`Invalid nest: "${s.item}"`)}}constructor(e){super(e),this._items=Filter._getAsFilterItems(e.items||[]),this._nests=e.nests,this._displayFn=e.displayFn,this._displayFnMini=e.displayFnMini,this._displayFnTitle=e.displayFnTitle,this._selFn=e.selFn,this._selFnCache=null,this._deselFn=e.deselFn,this._itemSortFn=e.itemSortFn===void 0?SortUtil.ascSort:e.itemSortFn,this._itemSortFnMini=e.itemSortFnMini,this._groupFn=e.groupFn,this._minimalUi=e.minimalUi,this._umbrellaItems=Filter._getAsFilterItems(e.umbrellaItems),this._umbrellaExcludes=Filter._getAsFilterItems(e.umbrellaExcludes),Filter._validateItemNests(this._items,this._nests),this._filterBox=null,this._items.forEach(e=>this._defaultItemState(e)),this.__$wrpFilter=null,this.__$wrpPills=null,this.__$wrpMini=null,this.__$wrpNestHeadInner=null,this._updateNestSummary=null,this.__nestsHidden={},this._nestsHidden=this._getProxy("nestsHidden",this.__nestsHidden),this._isNestsDirty=!1,this._isItemsDirty=!1,this._pillGroupsMeta={}}getSaveableState(){return{[this.header]:{...this.getBaseSaveableState(),state:{...this.__state},nestsHidden:{...this.__nestsHidden}}}}setStateFromLoaded(e){if(e&&e[this.header]){const t=e[this.header];this.setBaseStateFromLoaded(t),Object.assign(this._state,t.state),Object.assign(this._nestsHidden,t.nestsHidden)}}getSubHashes(){const e=[],t=this.getMetaSubHashes();t&&e.push(...t);const i=Object.entries(this._state).filter(([e,t])=>{const i=this._getDefaultState(e);return i!==t});if(i.length){const t=i.map(([e,t])=>`${e.toUrlified()}=${t}`);e.push(UrlUtil.packSubHash(this.getSubHashPrefix("state",this.header),t))}const s=Object.entries(this._nestsHidden).filter(([e,t])=>this._nests[e]&&this._nests[e].isHidden!==t);if(s.length){const t=s.map(([e])=>`${e.toUrlified()}=1`);e.push(UrlUtil.packSubHash(this.getSubHashPrefix("nestsHidden",this.header),t))}return e.length?e:null}setFromSubHashState(e){this.setMetaFromSubHashState(e);let t=!1,i=!1;Object.entries(e).forEach(([e,s])=>{const n=FilterBase.getProp(e);switch(n){case"state":{t=!0;const e={};Object.keys(this._state).forEach(t=>e[t]=this._getDefaultState(t)),s.forEach(t=>{const[i,s]=t.split("="),n=Object.keys(this._state).find(e=>e.toLowerCase()===i);n&&(e[n]=+s)}),this._setState(e);break}case"nestsHidden":{i=!0;const e={};Object.keys(this._nestsHidden).forEach(t=>{const i=Object.keys(this._nests).find(e=>t.toLowerCase()===e.toLowerCase());e[t]=this._nests[i]&&this._nests[i].isHidden}),s.forEach(t=>{const[i,s]=t.split("="),n=Object.keys(this._nestsHidden).find(e=>e.toLowerCase()===i);n&&(e[n]=!!+s)}),this._proxyAssign("nestsHidden","_nestsHidden","__nestsHidden",e,!0);break}}}),t||this.reset(),i||this._resetNestsHidden()}setFromValues(e){e[this.header]&&(Object.keys(this._state).forEach(e=>this._state[e]=0),Object.assign(this._state,e[this.header]))}setValue(e,t){this._state[e]=t}_resetNestsHidden(){this._nests&&Object.entries(this._nests).forEach(([e,t])=>this._nestsHidden[e]=!!t.isHidden)}_defaultItemState(e){this._state[e.item]=this._getDefaultState(e.item)}_getDefaultState(e){return this._deselFn&&this._deselFn(e)?2:this._selFn&&this._selFn(e)?1:0}_$getPill(e){const t=$(`<div class="fltr__pill">${this._displayFn?this._displayFn(e.item):e.item}</div>`).click(()=>{2<++this._state[e.item]&&(this._state[e.item]=0)}).contextmenu(t=>{t.preventDefault(),0>--this._state[e.item]&&(this._state[e.item]=2)}),i=()=>{const i=FilterBox._PILL_STATES[this._state[e.item]];t.attr("state",i),e.pFnChange&&e.pFnChange(e.item,i)};return this._addHook("state",e.item,i),i(),t}setTempFnSel(e){this._selFnCache=this._selFnCache||this._selFn,this._selFn=e?e:this._selFnCache}updateMiniPillClasses(){this._items.filter(e=>e.$mini).forEach(e=>{const t=this._deselFn&&this._deselFn(e.item),i=this._selFn&&this._selFn(e.item);e.$mini.toggleClass("fltr__mini-pill--default-desel",t).toggleClass("fltr__mini-pill--default-sel",i)})}_$getMini(e){const t=this._displayFnMini?this._displayFnMini(e.item):this._displayFn?this._displayFn(e.item):e.item,i=$(`<div class="fltr__mini-pill ${this._filterBox.isMinisHidden(this.header)?"ve-hidden":""} ${this._deselFn&&this._deselFn(e.item)?"fltr__mini-pill--default-desel":""} ${this._selFn&&this._selFn(e.item)?"fltr__mini-pill--default-sel":""}" state="${FilterBox._PILL_STATES[this._state[e.item]]}">${t}</div>`).title(`${this._displayFnTitle?`${this._displayFnTitle(e.item)} (`:""}Filter: ${this.header}${this._displayFnTitle?")":""}`).click(()=>{this._state[e.item]=0,this._filterBox.fireChangeEvent()});this._addHook("state",e.item,()=>i.attr("state",FilterBox._PILL_STATES[this._state[e.item]]));return this._filterBox.registerMinisHiddenHook(this.header,()=>i.toggleClass("ve-hidden",this._filterBox.isMinisHidden(this.header))),i}_doSetPillsAll(){Object.keys(this._state).forEach(e=>this._state[e]=1)}_doSetPillsClear(){Object.keys(this._state).forEach(e=>this._state[e]=0)}_doSetPillsNone(){Object.keys(this._state).forEach(e=>this._state[e]=2)}_doSetPinsDefault(){this.reset()}_$getHeaderControls(e){const t=$(`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn--all w-100">All</button>`).click(()=>this._doSetPillsAll()),i=$(`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn--clear w-100">Clear</button>`).click(()=>this._doSetPillsClear()),s=$(`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn--none w-100">None</button>`).click(()=>this._doSetPillsNone()),n=$(`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} w-100">Default</button>`).click(()=>this._doSetPinsDefault()),a=$$`<div class="btn-group flex-v-center w-100">${t}${i}${s}${n}</div>`,d=$$`<div class="flex-v-center fltr__h-wrp-state-btns-outer">${a}</div>`;this._$getHeaderControls_addExtraStateBtns(e,d);const _=$(`<div class="flex-vh-center"/>`).hide(),l=$$`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn-logic--blue fltr__h-btn-logic w-100" title="Positive matches mode for this filter. AND requires all blues to match, OR requires at least one blue to match."/>`.click(()=>this._meta.combineBlue="or"===this._meta.combineBlue?"and":"or"),r=()=>l.text(this._meta.combineBlue.toUpperCase());this._addHook("meta","combineBlue",r),r();const o=$$`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} fltr__h-btn-logic--red fltr__h-btn-logic w-100" title="Negative match mode for this filter. AND requires all reds to match, OR requires at least one red to match."/>`.click(()=>this._meta.combineRed="or"===this._meta.combineRed?"and":"or"),m=()=>o.text(this._meta.combineRed.toUpperCase());this._addHook("meta","combineRed",m),m();const u=$(`<button class="btn btn-default ${e.isMulti?"btn-xxs":"btn-xs"} ml-2">Hide</button>`).click(()=>this._meta.isHidden=!this._meta.isHidden),f=()=>{u.toggleClass("active",this._meta.isHidden),d.toggle(!this._meta.isHidden),_.toggleClass("ve-hidden",!this._meta.isHidden).empty();const e=this.getValues()[this.header];$(`<span class="fltr__summary_item fltr__summary_item--include"/>`).title(`${e._totals.yes} hidden "required" tags`).text(e._totals.yes).toggle(!!e._totals.yes).appendTo(_),$(`<span class="fltr__summary_item_spacer"/>`).toggle(!!(e._totals.yes&&e._totals.no)).appendTo(_),$(`<span class="fltr__summary_item fltr__summary_item--exclude"/>`).title(`${e._totals.no} hidden "excluded" tags`).text(e._totals.no).toggle(!!e._totals.no).appendTo(_)};return this._addHook("meta","isHidden",f),f(),$$`
		<div class="flex-v-center fltr__h-wrp-btns-outer">
			${_}
			${d}
			<span class="btn-group ml-2 flex-v-center">
				${l}
				${o}
			</span>
			${u}
		</div>`}_$getHeaderControls_addExtraStateBtns(){}$render(e){this._filterBox=e.filterBox,this.__$wrpMini=e.$wrpMini;const t=this._$getHeaderControls(e);this.__$wrpPills=$$`<div class="fltr__wrp-pills ${this._groupFn?"fltr__wrp-subs":""}"/>`;const i=()=>this.__$wrpPills.toggle(!this._meta.isHidden);if(this._addHook("meta","isHidden",i),i(),this._nests){const e=$(`<div class="fltr__wrp-pills--sub"/>`).appendTo(this.__$wrpPills);this.__$wrpNestHeadInner=$(`<div class="flex flex-wrap"/>`).appendTo(e);const t=$(`<div class="fltr__summary_nest"/>`).appendTo(e);this._updateNestSummary=()=>{const e={high:0,low:0};this._items.filter(e=>this._state[e.item]&&this._nestsHidden[e.nest]).forEach(t=>{const i=1===this._state[t.item]?"high":"low";e[i]++}),t.empty(),e.high&&$(`<span class="fltr__summary_item fltr__summary_item--include">${e.high}</span>`).title(`${e.high} hidden "required" tag${1===e.high?"":"s"}`).appendTo(t),e.high&&e.low&&$(`<span class="fltr__summary_item_spacer"/>`).appendTo(t),e.low&&$(`<span class="fltr__summary_item fltr__summary_item--exclude">${e.low}</span>`).title(`${e.low} hidden "excluded" tag${1===e.low?"":"s"}`).appendTo(t)},this._doRenderNests()}this._doRenderPills(),this._doRenderMiniPills();const s=this._$getBtnMobToggleControls(t);return this.__$wrpFilter=$$`<div>
			${e.isFirst?"":`<div class="fltr__dropdown-divider ${e.isMulti?"fltr__dropdown-divider--indented":""} mb-1"/>`}
			<div class="split fltr__h ${this._minimalUi?"fltr__minimal-hide":""} mb-1">
				<div class="ml-2 fltr__h-text flex-h-center">${e.isMulti?`<span class="mr-2">\u2012</span>`:""}${this.header}${s}</div>
				${t}
			</div>
			${this.__$wrpPills}
		</div>`,this._doToggleDisplay(),this.__$wrpFilter}getValues(){const e=MiscUtil.copy(this._state);Object.keys(e).filter(e=>!this._items.some(t=>`${t.item}`===e)).forEach(t=>delete e[t]);const t={...e};return t._isActive=Object.values(e).some(Boolean),t._totals={yes:0,no:0,ignored:0},Object.values(e).forEach(e=>{const i=0===e?"ignored":1===e?"yes":"no";t._totals[i]++}),t._andOr={blue:this._meta.combineBlue,red:this._meta.combineRed},{[this.header]:t}}reset(e){e&&(this.resetBase(),this._resetNestsHidden()),Object.keys(this._state).forEach(e=>delete this._state[e]),this._items.forEach(e=>this._defaultItemState(e))}resetShallow(){return this.reset()}_doRenderPills(){this._itemSortFn&&this._items.sort(this._itemSortFn),this._items.forEach(e=>{if(!e.$rendered&&(e.$rendered=this._$getPill(e),e.nest)){const t=()=>e.$rendered.toggle(!this._nestsHidden[e.nest]);this._addHook("nestsHidden",e.nest,t),t()}if(this._groupFn){const t=this._groupFn(e);this._pillGroupsMeta[t]||(this._pillGroupsMeta[t]={$hrDivider:$(`<hr class="fltr__dropdown-divider--sub">`).appendTo(this.__$wrpPills),$wrpPills:$(`<div class="fltr__wrp-pills--sub"/>`).appendTo(this.__$wrpPills)},Object.entries(this._pillGroupsMeta).sort((e,t)=>SortUtil.ascSortLower(e[0],t[0])).forEach(([e,t],s)=>{t.$hrDivider.appendTo(this.__$wrpPills),t.$hrDivider.toggle(0!==s||null!=this._nests),t.$wrpPills.appendTo(this.__$wrpPills)}),this._nests&&(this._pillGroupsMeta[t].toggleDividerFromNestVisibility=()=>{const e=this._items.filter(e=>this._groupFn(e)===t),i=e.filter(e=>this._nestsHidden[e.nest]);this._pillGroupsMeta[t].$hrDivider.toggle(e.length!==i.length)},Object.keys(this._nests).forEach(e=>{const i=()=>this._pillGroupsMeta[t].toggleDividerFromNestVisibility();this._addHook("nestsHidden",e,i),i(),this._pillGroupsMeta[t].toggleDividerFromNestVisibility()}))),this._pillGroupsMeta[t].$wrpPills.append(e.$rendered)}else this.__$wrpPills.append(e.$rendered)})}_doRenderMiniPills(){const e=this._items.slice(0);(this._itemSortFnMini||this._itemSortFn)&&e.sort(this._itemSortFnMini||this._itemSortFn),e.forEach(e=>{(e.$mini=e.$mini||this._$getMini(e)).appendTo(this.__$wrpMini)})}_doToggleDisplay(){this.__$wrpFilter.toggleClass("fltr__no-items",!this._items.length)}_doRenderNests(){Object.entries(this._nests).sort((e,t)=>SortUtil.ascSort(e[0],t[0])).forEach(([e,t])=>{if(null==t._$btnNest){null==this._nestsHidden[e]&&(this._nestsHidden[e]=!!t.isHidden);const i=$(`<span>${e} [${this._nestsHidden[e]?"+":"\u2212"}]</span>`);t._$btnNest=$$`<div class="fltr__btn_nest">${i}</div>`.click(()=>this._nestsHidden[e]=!this._nestsHidden[e]);const s=()=>{i.text(`${e} [${this._nestsHidden[e]?"+":"\u2212"}]`);const s={high:0,low:0,total:0};this._items.filter(t=>t.nest===e).find(e=>{const t=1===this._state[e.item]?"high":this._state[e.item]?"low":"ignored";s[t]++,s.total++});const n=s.total===s.high,a=s.total===s.low;t._$btnNest.toggleClass("fltr__btn_nest--include-all",this._nestsHidden[e]&&n).toggleClass("fltr__btn_nest--exclude-all",this._nestsHidden[e]&&a).toggleClass("fltr__btn_nest--include",this._nestsHidden[e]&&!(n||a||!s.high||s.low)).toggleClass("fltr__btn_nest--exclude",this._nestsHidden[e]&&!(n||a||s.high||!s.low)).toggleClass("fltr__btn_nest--both",this._nestsHidden[e]&&!(n||a||!s.high||!s.low)),this._updateNestSummary()};this._items.filter(t=>t.nest===e).find(e=>{this._addHook("state",e.item,s)}),this._addHook("nestsHidden",e,s),s()}t._$btnNest.appendTo(this.__$wrpNestHeadInner)}),this._updateNestSummary()}update(){this._isNestsDirty&&(this._isNestsDirty=!1,this._doRenderNests()),this._isItemsDirty&&(this._isItemsDirty=!1,this._doRenderPills()),this._doRenderMiniPills(),this._doToggleDisplay()}addItem(e){null==e||(e instanceof Array?e.forEach(e=>this.addItem(e)):!this._items.find(t=>Filter._isItemsEqual(t,e))&&(e=e instanceof FilterItem?e:new FilterItem({item:e}),Filter._validateItemNests([e],this._nests),this._isItemsDirty=!0,this._items.push(e),null==this._state[e.item]&&this._defaultItemState(e)))}static _isItemsEqual(e,t){return(e instanceof FilterItem?e.item:e)===(t instanceof FilterItem?t.item:t)}removeItem(e){const t=this._items.findIndex(t=>Filter._isItemsEqual(t,e));if(~t){const e=this._items[t];this._isItemsDirty=!0,e.$rendered.detach(),e.$mini.detach(),this._items.splice(t,1)}}addNest(e,t){if(!this._nests)throw new Error(`Filter was not nested!`);this._nests[e]||(this._isNestsDirty=!0,this._nests[e]=t,this._groupFn&&Object.keys(this._pillGroupsMeta).forEach(t=>{const i=()=>this._pillGroupsMeta[t].toggleDividerFromNestVisibility();this._addHook("nestsHidden",e,i),i(),this._pillGroupsMeta[t].toggleDividerFromNestVisibility()}))}toDisplay(e,t){const i=e[this.header];if(!i)return!0;const s=i._totals;t instanceof Array||(t=[t]),t=t.map(e=>e instanceof FilterItem?e:new FilterItem({item:e}));const n=()=>{if(this._umbrellaItems)return!!t&&!(this._umbrellaExcludes&&this._umbrellaExcludes.some(e=>i[e.item]))&&this._umbrellaItems.some(e=>t.includes(e.item))&&(this._umbrellaItems.some(e=>0===i[e.item])||this._umbrellaItems.some(e=>1===i[e.item]))};let a=!1,d=!1;if("or"===i._andOr.blue)0===s.yes&&(d=!0),d=d||t.some(e=>1===i[e.item]||n());else{const e=t.filter(e=>1===i[e.item]).length;d=!s.yes||s.yes===e}if("or"===i._andOr.red)a=a||t.filter(e=>!e.isIgnoreRed).some(e=>2===i[e.item]);else{const e=t.filter(e=>!e.isIgnoreRed).filter(e=>2===i[e.item]).length;a=s.no&&s.no===e}return d&&!a}getDefaultMeta(){return{...Filter._DEFAULT_META,...super.getDefaultMeta()}}}Filter._DEFAULT_META={combineBlue:"or",combineRed:"or"};class SourceFilter extends Filter{constructor(e){super(e),this.__tmpState={ixAdded:0},this._tmpState=this._getProxy("tmpState",this.__tmpState)}doSetPillsClear(){return this._doSetPillsClear()}addItem(e){const t=super.addItem(e);return this._tmpState.ixAdded++,t}removeItem(e){const t=super.removeItem(e);return this._tmpState.ixAdded--,t}_$getHeaderControls_addExtraStateBtns(e,t){const i=$(`<button class="btn btn-default w-100 ${e.isMulti?"btn-xxs":"btn-xs"}" title="SHIFT to include UA/etc.">Core/Supplements</button>`).click(e=>this._doSetPinsSupplements(e.shiftKey)),s=$(`<button class="btn btn-default w-100 ${e.isMulti?"btn-xxs":"btn-xs"}" title="SHIFT to include UA/etc.">Adventures</button>`).click(e=>this._doSetPinsAdventures(e.shiftKey)),n=$(`<button class="btn btn-default w-100 ${e.isMulti?"btn-xxs":"btn-xs"}">Homebrew</button>`).click(()=>this._doSetPinsHomebrew()),a=()=>{const e=Object.keys(this.__state).some(e=>2===SourceUtil.getFilterGroup(e));n.toggleClass("ve-hidden",!e)};this._addHook("tmpState","ixAdded",a),a(),$$`<div class="btn-group mr-2 w-100 flex-v-center mobile__m-1 mobile__mb-2">${i}${s}${n}</div>`.prependTo(t)}_doSetPinsSupplements(e){Object.keys(this._state).forEach(t=>this._state[t]=SourceUtil.isCoreOrSupplement(t)&&(e||!SourceUtil.isNonstandardSource(t))?1:0)}_doSetPinsAdventures(e){Object.keys(this._state).forEach(t=>this._state[t]=SourceUtil.isAdventure(t)&&(e||!SourceUtil.isNonstandardSource(t))?1:0)}_doSetPinsHomebrew(){Object.keys(this._state).forEach(e=>this._state[e]=2===SourceUtil.getFilterGroup(e)?1:0)}static getInstance(e){e||(e={});const t={header:FilterBox.SOURCE_HEADER,displayFn:e=>Parser.sourceJsonToFullCompactPrefix(e.item||e),selFn:PageFilter.defaultSourceSelFn,groupFn:SourceUtil.getFilterGroup};return Object.assign(t,e),new SourceFilter(t)}}class RangeFilter extends FilterBase{constructor(e){super(e),e.labels&&null==e.min&&(e.min=0),e.labels&&null==e.max&&(e.max=e.labels.length-1),this._min=+(e.min||0),this._max=+(e.max||0),this._labels=e.isLabelled?e.labels:null,this._isAllowGreater=!!e.isAllowGreater,this._suffix=e.suffix,this._labelSortFn=e.labelSortFn===void 0?SortUtil.ascSort:e.labelSortFn,this._filterBox=null,Object.assign(this.__state,{min:this._min,max:this._max,curMin:this._min,curMax:this._max}),this.__$wrpMini=null,this._$btnsMini=[],this._$slider=null}set isUseDropdowns(e){this._meta.isUseDropdowns=!!e}getSaveableState(){return{[this.header]:{...this.getBaseSaveableState(),state:{...this.__state}}}}setStateFromLoaded(e){if(e&&e[this.header]){const t=e[this.header];this.setBaseStateFromLoaded(t),t.state&&!this._labels&&(null!=t.state.curMax&&null!=t.state.max&&t.state.curMax+1<t.state.max&&(t.state.max=t.state.curMax+1),null!=t.state.curMin&&null!=t.state.min&&t.state.curMin-1>t.state.min&&(t.state.min=t.state.curMin-1)),Object.assign(this._state,t.state)}}getSubHashes(){const e=[],t=this.getMetaSubHashes();t&&e.push(...t);const i=[this._state.min===this._state.curMin?null:`min=${this._state.curMin}`,this._state.max===this._state.curMax?null:`max=${this._state.curMax}`].filter(Boolean);return i.length&&e.push(UrlUtil.packSubHash(this.getSubHashPrefix("state",this.header),i)),e.length?e:null}setFromSubHashState(e){this.setMetaFromSubHashState(e);let t=!1;Object.entries(e).forEach(([e,i])=>{const s=FilterBase.getProp(e);"state"===s&&(t=!0,i.forEach(e=>{const[t,i]=e.split("=");if(i.startsWith("&")&&!this._labels)throw new Error(`Could not dereference label: "${i}"`);let s;if(i.startsWith("&")){const e=i.replace("&","").toLowerCase();if(s=this._labels.findIndex(t=>(t+"").toLowerCase()===e),!~s)throw new Error(`Could not find index for label "${e}"`)}else s=+i;switch(t){case"min":s<this._state.min&&(this._state.min=s),this._state.curMin=Math.max(this._state.min,s);break;case"max":s>this._state.max&&(this._state.max=s),this._state.curMax=Math.min(this._state.max,s);break;default:throw new Error(`Unknown prop "${t}"`);}}))}),t||this.reset()}setFromValues(e){var t=Math.max;if(e[this.header]){const i=e[this.header];this._state.curMin=null==i.min?this._state.min:t(this._state.min,i.min),this._state.curMax=null==i.max?this._state.max:t(this._state.max,i.max)}}_$getHeaderControls(){const e=ComponentUiUtil.$getBtnBool(this,"isUseDropdowns",{$ele:$(`<button class="btn btn-default btn-xs mr-2">Show as Dropdowns</button>`),stateName:"meta",stateProp:"_meta"}),t=$(`<button class="btn btn-default btn-xs">Reset</button>`).click(()=>this.reset()),i=$$`<div>${e}${t}</div>`,s=$(`<div class="flex-v-center fltr__summary_item fltr__summary_item--include"/>`).hide(),n=$(`<button class="btn btn-default btn-xs ml-2 ${this._meta.isHidden?"active":""}">Hide</button>`).click(()=>this._meta.isHidden=!this._meta.isHidden),a=()=>{n.toggleClass("active",this._meta.isHidden),i.toggle(!this._meta.isHidden),s.toggle(this._meta.isHidden);const e=this.getValues()[this.header],t=!e.isMinVal&&!e.isMaxVal,a=!e.isMinVal||!e.isMaxVal;s.title(t?`Hidden range`:a?`Hidden limit`:"").text(t?`${e.min}-${e.max}`:e.isMinVal?e.isMaxVal?"":`≤ ${e.max}`:`≥ ${e.min}`)};return this._addHook("meta","isHidden",a),a(),$$`
		<div class="flex-v-center">
			${i}
			${s}
			${n}
		</div>`}$render(e){this._filterBox=e.filterBox,this.__$wrpMini=e.$wrpMini;const t=e.isMulti?null:this._$getHeaderControls(),i=$$`<div class="fltr__wrp-pills fltr__wrp-pills--flex"/>`,s=$$`<div class="fltr__wrp-pills fltr__wrp-pills--flex"/>`,n=()=>{i.toggle(!this._meta.isHidden&&!this._meta.isUseDropdowns),s.toggle(!this._meta.isHidden&&!!this._meta.isUseDropdowns)};this._addHook("meta","isHidden",n),this._addHook("meta","isUseDropdowns",n),n();const a=()=>{const e={};return this._labels?this._labelSortFn?e.labels=this._labels.sort(this._labelSortFn):e.labels=this._labels:this._isAllowGreater&&(e.labels={last:`${this._state.max}+`}),this._suffix&&(e.suffix=this._suffix),e},d=a();this._$slider=$(`<div class="fltr__slider"/>`).appendTo(i),this._$slider.slider({min:this._min,max:this._max,range:!0,values:[this._min,this._max]}).slider("pips",d).slider("float",d).slider().on("slidestop",()=>{const[e,t]=this._$slider.slider("values");this._state.curMin=e,this._state.curMax=t});const _=$(`<select class="form-control mr-2"/>`).change(()=>{const e=+_.val(),[t,i]=[e,this._state.curMax].sort(SortUtil.ascSort);this._state.curMin=t,this._state.curMax=i}),l=$(`<select class="form-control"/>`).change(()=>{const e=+l.val(),[t,i]=[this._state.curMin,e].sort(SortUtil.ascSort);this._state.curMin=t,this._state.curMax=i});$$`<div class="flex-v-center w-100 px-3 py-1">${_}${l}</div>`.appendTo(s);const r=$(`<div class="fltr__mini-pill" state="ignore"/>`).click(()=>{this._state.curMin=this._state.min,this._filterBox.fireChangeEvent()}).appendTo(this.__$wrpMini),o=$(`<div class="fltr__mini-pill" state="ignore"/>`).click(()=>{this._state.curMax=this._state.max,this._filterBox.fireChangeEvent()}).appendTo(this.__$wrpMini),m=$(`<div class="fltr__mini-pill" state="ignore"/>`).click(()=>{this._state.curMin=this._state.min,this._state.curMax=this._state.max,this._filterBox.fireChangeEvent()}).appendTo(this.__$wrpMini);this._$btnsMini.push(r,o,m);const u=()=>{const e=this._filterBox.isMinisHidden(this.header);r.toggleClass("ve-hidden",e),o.toggleClass("ve-hidden",e),m.toggleClass("ve-hidden",e)};this._filterBox.registerMinisHiddenHook(this.header,u),u();const f=()=>{this._state.curMin===this._state.curMax?(r.attr("state",FilterBox._PILL_STATES[0]),o.attr("state",FilterBox._PILL_STATES[0]),m.attr("state",FilterBox._PILL_STATES[1]).text(`${this.header} = ${this._labels?this._labels[this._state.curMin]:this._state.curMin}`)):(this._state.min===this._state.curMin?r.attr("state",FilterBox._PILL_STATES[0]):r.attr("state",FilterBox._PILL_STATES[1]).text(`${this.header} ≥ ${this._labels?this._labels[this._state.curMin]:this._state.curMin}`),this._state.max===this._state.curMax?o.attr("state",FilterBox._PILL_STATES[0]):o.attr("state",FilterBox._PILL_STATES[1]).text(`${this.header} ≤ ${this._labels?this._labels[this._state.curMax]:this._state.curMax}`),m.attr("state",FilterBox._PILL_STATES[0]))},c=e=>(e.empty(),[...Array(this._state.max-this._state.min+1)].forEach((t,s)=>{const i=s+this._state.min,n=this._labels?this._labels[s]:null;$(`<option/>`,{value:i,text:n||i}).appendTo(e)}),e),p=()=>{setTimeout(()=>this._$slider.slider("values",[this._state.curMin,this._state.curMax]),5),_.val(`${this._state.curMin}`),l.val(`${this._state.curMax}`),f()},h=()=>{const e=a();this._$slider.slider("option",{min:this._state.min,max:this._state.max}).slider("pips",e).slider("float",e),c(_).val(`${this._state.curMin}`),c(l).val(`${this._state.curMax}`),f()};if(this._addHook("state","min",h),this._addHook("state","max",h),this._addHook("state","curMin",p),this._addHook("state","curMax",p),p(),h(),e.isMulti)return this._$slider.addClass("ve-grow"),i.addClass("ve-grow"),s.addClass("ve-grow"),$$`<div class="flex">
				<div class="fltr__range-inline-label">${this.header}</div>
				${i}
				${s}
			</div>`;else{const n=this._$getBtnMobToggleControls(t);return $$`<div class="flex-col">
				${e.isFirst?"":`<div class="fltr__dropdown-divider mb-1"/>`}
				<div class="split fltr__h ${this._minimalUi?"fltr__minimal-hide":""} mb-1">
					<div class="fltr__h-text flex-h-center">${this.header}${n}</div>
					${t}
				</div>
				${i}
				${s}
			</div>`}}getValues(){const e={isMaxVal:this._state.max===this._state.curMax,isMinVal:this._state.min===this._state.curMin,max:this._state.curMax,min:this._state.curMin};return e._isActive=!(e.isMinVal&&e.isMaxVal),{[this.header]:e}}reset(e){e&&this.resetBase(),this._state.curMin=this._state.min,this._state.curMax=this._state.max}resetShallow(e){return this.reset()}update(){this._$btnsMini.forEach(e=>this.__$wrpMini.append(e))}toDisplay(e,t){var i=Math.min,s=Math.max;const n=e[this.header];if(!n)return!0;if(null==t)return n.min===this._state.min&&n.max===this._state.max;if(this._labels){const e=this._labels.slice(n.min,n.max+1);return t instanceof Array?!!t.find(t=>e.includes(t)):e.includes(t)}else{const e=t instanceof Array?n.min<=i(...t):n.min<=t,a=t instanceof Array?n.max>=s(...t):n.max>=t;return this._isAllowGreater?e&&(a||n.max===this._state.max):e&&a}}addItem(e){if(this._labels){if(null==e)return;e instanceof Array?e.forEach(e=>this.addItem(e)):!this._labels.some(t=>t===e)&&this._labels.push(e),this._addItem_addNumber(this._labels.length-1)}else this._addItem_addNumber(e)}_addItem_addNumber(e){if(!(null==e||isNaN(e))&&!(e>=this._state.min&&e<=this._state.max))if(null==this._state.min&&null==this._state.max)this._state.min=this._state.max=e;else{const t={...this.__state};e<t.min&&(this._state.min=e),e>t.max&&(this._state.max=e),t.curMin===t.min&&(this._state.curMin=this._state.min),t.curMax===t.max&&(this._state.curMax=this._state.max)}}getDefaultMeta(){const e={...RangeFilter._DEFAULT_META,...super.getDefaultMeta()};return Renderer.hover.isSmallScreen()&&(e.isUseDropdowns=!0),e}}RangeFilter._DEFAULT_META={isUseDropdowns:!1};class MultiFilter extends FilterBase{constructor(e){super(e),this._filters=e.filters,this._isAddDropdownToggle=!!e.isAddDropdownToggle,Object.assign(this.__state,{...MultiFilter._DETAULT_STATE,mode:e.mode||MultiFilter._DETAULT_STATE.mode}),this._baseState=MiscUtil.copy(this.__state),this._state=this._getProxy("state",this.__state)}getChildFilters(){return[...this._filters,...this._filters.map(e=>e.getChildFilters())].flat()}getSaveableState(){const e={[this.header]:{...this.getBaseSaveableState(),state:{...this.__state}}};return this._filters.forEach(t=>Object.assign(e,t.getSaveableState())),e}setStateFromLoaded(e){if(e&&e[this.header]){const t=e[this.header];this.setBaseStateFromLoaded(t),Object.assign(this._state,t.state),this._filters.forEach(t=>t.setStateFromLoaded(e))}}getSubHashes(){const e=[],t=this.getMetaSubHashes();t&&e.push(...t);const i=Object.keys(MultiFilter._DETAULT_STATE).find(e=>this._state[e]!==MultiFilter._DETAULT_STATE[e]);if(i){const t=Object.keys(MultiFilter._DETAULT_STATE).map(e=>UrlUtil.mini.compress(void 0===this._state[e]?MultiFilter._DEFAULT_META[e]:this._state[e]));e.push(UrlUtil.packSubHash(this.getSubHashPrefix("state",this.header),t))}return this._filters.map(e=>e.getSubHashes()).filter(Boolean).forEach(t=>e.push(...t)),e.length?e:null}setFromSubHashState(e){this.setMetaFromSubHashState(e);let t=!1;Object.entries(e).forEach(([e,i])=>{const s=FilterBase.getProp(e);if("state"===s){t=!0;const e=i.map(e=>UrlUtil.mini.decompress(e));Object.keys(MultiFilter._DETAULT_STATE).forEach((t,s)=>this._state[t]=e[s])}}),t||this._reset()}setFromValues(e){this._filters.forEach(t=>t.setFromValues(e))}$render(e){const t=$(`<div class="fltr__group-comb-toggle text-muted"/>`).click(()=>this._state.mode="and"===this._state.mode?"or":"and"),i=()=>t.text(`(group ${this._state.mode.toUpperCase()})`);this._addHook("state","mode",i),i();const s=this._filters.map((t,s)=>t.$render({...e,isMulti:!0,isFirst:0===s})),n=$$`<div>${s}</div>`,a=$(`<div class="fltr__summary_item"/>`).hide(),d=this._isAddDropdownToggle?ComponentUiUtil.$getBtnBool(this,"isUseDropdowns",{$ele:$(`<button class="btn btn-default btn-xs ml-2">Show as Dropdowns</button>`),stateName:"meta",stateProp:"_meta"}):null,_=()=>{this._filters.filter(e=>e instanceof RangeFilter).forEach(e=>e.isUseDropdowns=this._meta.isUseDropdowns)};this._addHook("meta","isUseDropdowns",_),_();const l=$(`<button class="btn btn-default btn-xs ml-2">Reset All</button>`).click(()=>this._filters.forEach(e=>e.reset())),r=$$`<div>${d}${l}</div>`,o=$(`<button class="btn btn-default btn-xs ml-2 ${this._meta.isHidden?"active":""}">Hide</button>`).click(()=>this._meta.isHidden=!this._meta.isHidden),m=$$`<div class="flex-v-center">
			${a}${r}${o}
		</div>`,u=()=>{r.toggle(!this._meta.isHidden),o.toggleClass("active",this._meta.isHidden),n.toggle(!this._meta.isHidden),a.toggle(this._meta.isHidden);const e=this._filters.map(e=>e.getValues()[e.header]._isActive).filter(Boolean).length;e&&a.title(`${e} hidden active filter${1===e?"":"s"}`).text(`(${e})`)};return this._addHook("meta","isHidden",u),u(),$$`<div class="flex-col">
			${e.isFirst?"":`<div class="fltr__dropdown-divider mb-1"/>`}
			<div class="split fltr__h fltr__h--multi ${this._minimalUi?"fltr__minimal-hide":""} mb-1">
				<div class="flex-v-center">
					<div class="mr-2">${this.header}</div>
					${t}
				</div>
				${m}
			</div>
			${n}
		</div>`}isActive(e){return e=e||this.getValues(),this._filters.some(t=>t.isActive(e))}getValues(){const e={};return this._filters.forEach(t=>Object.assign(e,t.getValues())),e}_reset(){Object.assign(this._state,this._baseState)}reset(e){e&&this.resetBase(),this._reset(),this._filters.forEach(t=>t.reset(e))}resetShallow(e){e&&this.resetBase(),this._reset()}update(){this._filters.forEach(e=>e.update())}toDisplay(e,t){if(this._filters.length!==t.length)throw new Error("Number of filters and number of values did not match");const s=[];for(let n=this._filters.length-1;0<=n;--n){const i=this._filters[n];if(i instanceof RangeFilter)s.push(i.toDisplay(e,t[n]));else{const a=e[i.header]._totals;0===a.yes&&0===a.no?s.push(null):s.push(i.toDisplay(e,t[n]))}}const n=s.filter(e=>null!==e);return"or"===this._state.mode?!n.length||n.find(e=>e):n.filter(e=>e).length===n.length}addItem(){throw new Error(`Cannot add item to MultiFilter! Add the item to a child filter instead.`)}}MultiFilter._DETAULT_STATE={mode:"or"},(()=>{const e=Object.values(FilterBox._SUB_HASH_PREFIXES).filter(e=>e.length!==FilterUtil.SUB_HASH_PREFIX_LENGTH),t=Object.values(FilterBase._SUB_HASH_PREFIXES).filter(e=>e.length!==FilterUtil.SUB_HASH_PREFIX_LENGTH),i=e.concat(t);if(i.length)throw new Error(`Invalid prefixes! ${i.map(e=>`"${e}"`).join(", ")} ${1===i.length?`is`:`was`} not of length ${FilterUtil.SUB_HASH_PREFIX_LENGTH}`)})(),FilterUtil.SUB_HASH_PREFIXES=new Set([...Object.values(FilterBox._SUB_HASH_PREFIXES),...Object.values(FilterBase._SUB_HASH_PREFIXES)]),"undefined"!=typeof module&&(module.exports={FilterUtil,PageFilter,FilterBox,FilterItem,FilterBase,Filter,SourceFilter,RangeFilter,MultiFilter});
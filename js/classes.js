"use strict";class ClassesPage extends BaseComponent{static _ascSortSubclasses(a,b){return SortUtil.ascSortLower(a.name,b.name)}static _fnSortSubclassFilterItems(c,a){return c.values.isAlwaysVisible?1:a.values.isAlwaysVisible?-1:SortUtil.listSort(c,a,{sortBy:"shortName"})}static getBtnTitleSubclass(a){const b=a.isReprinted?" (this subclass has been reprinted in a more recent source)":"";return`${a.name}; Source: ${Parser.sourceJsonToFull(a.source)}${b}`}static getBaseShortName(a){const b=new RegExp(`\\((UA|${a.source})\\)$`);return a.shortName.trim().replace(b,"").trim()}static _enhanceSubclassData(a,b){b.source=b.source||a.source,b.shortName=b.shortName||b.name,b._fMisc=[],b.srd&&b._fMisc.push("SRD"),b.isReprinted&&b._fMisc.push("Reprinted")}constructor(){super(),this.__classId={_:0},this._classId=this._getProxy("classId",this.__classId),this._filterBox=null,this._list=null,this._ixData=0,this._dataList=[],this._lastScrollFeature=null,this._outlineData={},this._sourceFilter=SourceFilter.getInstance({displayFnMini:a=>Parser.sourceJsonToAbv(a),displayFnTitle:a=>Parser.sourceJsonToFull(a),itemSortFnMini:(c,a)=>SortUtil.ascSort(Parser.sourceJsonToAbv(c.item),Parser.sourceJsonToAbv(a.item))}),this._miscFilter=new Filter({header:"Miscellaneous",items:["Reprinted","SRD"],deselFn:a=>"Reprinted"===a,displayFnMini:a=>"Reprinted"===a?"Repr.":a,displayFnTitle:a=>"Reprinted"===a?a:""}),this._filters=[this._sourceFilter,this._miscFilter],this._listSubclass=null,this._ixDataSubclass=0,this._fnTableHandleFilterChange=null,this._$wrpOutline=null,this._fnOutlineHandleFilterChange=null,this._$trsContent=[],this._$trNoContent=null,this._subclassComparisonView=null,this._classBookView=null,this._sourceWalker=MiscUtil.getWalker(new Set(["type","data"])).walk,this._sourcePrimitiveHandlers={string:(a,b,c)=>("source"===c&&this._sourceFilter.addItem(b),b)}}_addEntrySourcesToFilter(a){this._sourceWalker("sourceWalker",a,this._sourcePrimitiveHandlers)}get activeClass(){return this._dataList[this._classId._]}get filterBox(){return this._filterBox}async pOnLoad(){await ExcludeUtil.pInitialise(),Omnisearch.addScrollTopFloat();const a=await DataUtil.class.loadJSON();this._list=ListUtil.initList({listClass:"classes",isUseJquery:!0}),ListUtil.setOptions({primaryLists:[this._list]}),SortUtil.initBtnSortHandlers($("#filtertools"),this._list),this._filterBox=await pInitFilterBox({filters:this._filters,isCompact:!0}),this._addData(a),BrewUtil.bind({filterBox:this._filterBox,sourceFilter:this._filterSource,list:this._list,pHandleBrew:async a=>this._addData(a)});const b=await BrewUtil.pAddBrewData();await this._pHandleBrew(b),await BrewUtil.pAddLocalBrewData(),BrewUtil.makeBrewButton("manage-brew"),await ListUtil.pLoadState(),RollerUtil.addListRollButton(!0),window.onhashchange=this._handleHashChange.bind(this),this._list.init(),this._setClassFromHash(Hist.initialLoad),this._setStateFromHash(Hist.initialLoad),await this._pRender(),ExcludeUtil.checkShowAllExcluded(this._dataList,$(`#pagecontent`)),this._initLinkGrabbers(),UrlUtil.bindLinkExportButton(this._filterBox,$(`#btn-link-export`)),Hist.initialLoad=!1,this._setHashFromState(),window.dispatchEvent(new Event("toolsLoaded"))}async _pHandleBrew(a){this._addData(a)}_addData(a){let b=!1;a.class&&a.class.length&&(b=!0)&&this._addData_addClassData(a.class),a.subclass&&a.subclass.length&&(b=!0)&&this._addData_addSubclassData(a.subclass),b&&(this._list.update(),this._filterBox.render(),this._handleFilterChange(),ListUtil.setOptions({itemList:this._dataList,primaryLists:[this._list]}))}_addData_addClassData(a){a.forEach(a=>{a.source=a.source||SRC_PHB,a.subclasses=a.subclasses||[];const b=ExcludeUtil.isExcluded(a.name,"class",a.source);b||(this._sourceFilter.addItem(a.source),a.fluff&&a.fluff.forEach(a=>this._addEntrySourcesToFilter(a)),a.classFeatures.forEach(a=>a.forEach(a=>this._addEntrySourcesToFilter(a)))),a.subclasses.forEach(c=>{if(ClassesPage._enhanceSubclassData(a,c),!b){const a=ExcludeUtil.isExcluded(c.name,"subclass",c.source);a||(this._sourceFilter.addItem(c.source),c.subclassFeatures.forEach(a=>a.forEach(a=>this._addEntrySourcesToFilter(a))))}})}),a.filter(a=>SourceUtil.isNonstandardSource(a.source)||BrewUtil.hasSourceJson(a.source)).forEach(a=>{a.fluff&&a.fluff.filter(b=>b.source===a.source).forEach(a=>a._isStandardSource=!0),a.subclasses.filter(b=>b.source===a.source).forEach(a=>a._isStandardSource=!0)}),a.filter(a=>a.subclasses).forEach(a=>a.subclasses.sort(ClassesPage._ascSortSubclasses)),this._dataList.push(...a);for(const b=this._dataList.length;this._ixData<b;this._ixData++){const a=this._dataList[this._ixData],b=ExcludeUtil.isExcluded(a.name,"class",a.source);this._list.addItem(this.getListItem(a,this._ixData,b))}}_addData_addSubclassData(a){a.forEach(a=>{const b=this._dataList.find(b=>b.name.toLowerCase()===a.class.toLowerCase()&&b.source.toLowerCase()===(a.classSource||SRC_PHB).toLowerCase());return b?void(ClassesPage._enhanceSubclassData(b,a),this._sourceFilter.addItem(a.source),a.subclassFeatures.forEach(a=>a.forEach(a=>this._addEntrySourcesToFilter(a))),b.subclasses.push(a),b.subclasses.sort(ClassesPage._ascSortSubclasses)):void JqueryUtil.doToast({content:`Could not add subclass; could not find class with name: ${b.class} and source ${a.source||SRC_PHB}`,type:"danger"})})}_initHashAndStateSync(){this._resetHooks("state"),this._resetHooksAll("state"),this._resetHooks("classId"),this._addHookAll("state",()=>this._setHashFromState())}_setHashFromState(){const a=this._getHashState(),b=window.location.hash,c="#"===b[0]?b.slice(1):b;a!==c&&(window.location.hash=a)}_handleHashChange(){return Hist.isHistorySuppressed?Hist.setSuppressHistory(!1):void(this._setClassFromHash(),this._setStateFromHash())}_setClassFromHash(a){const[b]=Hist.getHashParts();let c;if(b===HASH_BLANK)c=-1;else{const a=Hist.getActiveListItem(b);if(null==a)c=-1;else{const b=a.ix;c=null==b?-1:a.ix}}if(!~c&&this._list.visibleItems.length&&(c=this._list.visibleItems[0].ix),~c){const b=a?this.__classId:this._classId;if(b._!==c){Hist.lastLoadedId=c;const a=this._dataList[c];document.title=`${a?a.name:"Classes"} - 5etools`,b._=c}}else $(`#pagecontent`).empty().append(ClassesPage._render_$getTrNoContent()),JqueryUtil.doToast({content:"Could not find the class to load!",type:"error"})}_setStateFromHash(a){let[b,...c]=Hist.getHashParts();c=this._filterBox.setFromSubHashes(c);const d=a?this.__state:this._state;if(c.length||(this.__state.feature=null),this._getHashState()===c.join(HASH_PART_SEP))return;const e=this.activeClass,f={};e.subclasses.forEach(a=>f[UrlUtil.getStateKeySubclass(a)]=a);const g=new Set,h=new Set;c.forEach(a=>{const b=UrlUtil.unpackSubHash(a);b.state&&b.state.map(a=>{let[b,c]=a.split("=");if(b=b.toLowerCase(),c=UrlUtil.mini.decompress(c),b.startsWith("sub"))f[b]&&(d[b]!==c&&(d[b]=c),g.add(f[b].source),h.add(b));else{const a=Object.keys(ClassesPage._DEFAULT_STATE).find(a=>a.toLowerCase()===b);a&&(d[a]!==c&&(d[a]=c),h.add(a))}})}),Object.entries(ClassesPage._DEFAULT_STATE).forEach(([a,b])=>{h.has(a)||b===d[a]||(d[a]=b)}),g.size&&this._sourceFilter.getValues().Source._isActive&&g.forEach(a=>this._sourceFilter.setValue(a,1)),Object.keys(f).forEach(a=>{!h.has(a)&&d[a]&&(d[a]=!1)}),a||this._setHashFromState()}_getHashState(a){a=a||{};let b=a.state||MiscUtil.copy(this.__state),c=a.class||this.activeClass,d=c?UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](c):null;if(!d){const a=this._list.items[0];d=a?a.values.hash:HASH_BLANK}const e=c.subclasses.map(a=>UrlUtil.getStateKeySubclass(a)),f=Object.entries(b).filter(([a,b])=>ClassesPage._DEFAULT_STATE[a]!==b).filter(([a,b])=>ClassesPage._DEFAULT_STATE[a]!==void 0||b).filter(([a])=>!a.startsWith("sub")||e.includes(a)).map(([a,b])=>`${a}=${UrlUtil.mini.compress(b)}`),g=f.length?UrlUtil.packSubHash("state",f):"",h=[d,g].filter(Boolean);return Hist.util.getCleanHash(h.join(HASH_PART_SEP))}_initLinkGrabbers(){const a=$(document.body);a.on(`mousedown`,`.cls-main__linked-titles > td > * > .rd__h .entry-title-inner`,a=>a.preventDefault()),a.on(`click`,`.cls-main__linked-titles > td > * > .rd__h .entry-title-inner`,async a=>{const b=$(a.target);if(a.shiftKey)await MiscUtil.pCopyTextToClipboard(b.text().replace(/\.$/,"")),JqueryUtil.showCopiedEffect(b);else{const a=b.closest(`tr`).attr("data-scroll-id"),c=MiscUtil.copy(this.__state);c.feature=a;const d=`${window.location.href.split("#")[0]}#${this._getHashState({state:c})}`;await MiscUtil.pCopyTextToClipboard(d),JqueryUtil.showCopiedEffect(b,"Copied link!")}})}getListItem(a,b,c){a._fMisc=[],a.isReprinted&&a._fMisc.push("Reprinted"),a.srd&&a._fMisc.push("SRD"),this._sourceFilter.addItem(a.source);const d=UrlUtil.autoEncodeHash(a),e=Parser.sourceJsonToAbv(a.source),f=$(`<a href="#${d}" class="lst--border">
			<span class="bold col-8 pl-0">${a.name}</span>
			<span class="col-4 text-center ${Parser.sourceJsonToColor(a.source)}" title="${Parser.sourceJsonToFull(a.source)} pr-0" ${BrewUtil.sourceJsonToStyle(a.source)}>${e}</span>
		</a>`),g=$$`<li class="row ${c?"row--blacklisted":""}">${f}</li>`;return new ListItem(b,g,a.name,{hash:d,source:e},{$lnk:f,class:a,uniqueId:a.uniqueId?a.uniqueId:b,isExcluded:c})}_handleFilterChange(){const a=this._filterBox.getValues();this._list.filter(b=>{const c=this._dataList[b.ix];return this._filterBox.toDisplay(a,c.source,c._fMisc)}),this._$trsContent.forEach(b=>{b.find(`[data-source]`).each((b,c)=>{const d=c.dataset.source;$(c).toggleClass("hidden",!this._filterBox.toDisplay(a,d,[]))})}),this._fnOutlineHandleFilterChange&&this._fnOutlineHandleFilterChange(),this._fnTableHandleFilterChange&&this._fnTableHandleFilterChange(a),this._proxyAssign("state","_state","__state",this.activeClass.subclasses.filter(b=>!this._filterBox.toDisplay(a,b.source,b._fMisc)).map(a=>UrlUtil.getStateKeySubclass(a)).filter(a=>this._state[a]).mergeMap(a=>({[a]:!1})))}async _pRender(){this._$wrpOutline=$(`#sticky-nav`);const a=async()=>{this._initHashAndStateSync(),$(this._filterBox).off(FilterBox.EVNT_VALCHANGE).on(FilterBox.EVNT_VALCHANGE,this._handleFilterChange.bind(this));const a=()=>{setTimeout(()=>{this._list.items.filter(a=>a.data.$lnk).forEach(a=>{const b=`#${this._getHashState({class:a.data.class})}`;a.data.$lnk.attr("href",b)})},5)};this._addHook("classId","_",a),this._addHookAll("state",a),a(),this._render_renderClassTable(),this._render_renderSidebar(),await this._render_pRenderSubclassTabs(),this._render_renderClassContent(),this._render_renderOutline(),this._render_renderAltViews();const b=()=>{if(this._state.feature){if(this._lastScrollFeature===this._state.feature)return;this._lastScrollFeature=this._state.feature;const a=$(`[data-scroll-id="${this._state.feature}"]`);a[0]?setTimeout(()=>a[0].scrollIntoView(),100):(this._state.feature=null,this._lastScrollFeature=null)}};this._addHookBase("feature",b),b();const c=()=>$(`.cls-main__cls-fluff`).toggleClass("hidden",!this._state.isShowFluff);this._addHookBase("isShowFluff",c),MiscUtil.pDefer(c);const d=()=>{const a=$(`[data-feature-type="class"]`),b=$(`[data-feature-type="gain-subclass"]`);this._state.isHideFeatures?this._isAnySubclassActive()?(this._$wrpOutline.toggleClass("hidden",!1),this._$trNoContent.toggleClass("hidden",!0),a.toggleClass("hidden",!0),b.toggleClass("hidden",!1)):(this._$wrpOutline.toggleClass("hidden",!0),this._$trNoContent.toggleClass("hidden",!1),a.toggleClass("hidden",!0),b.toggleClass("hidden",!0)):(this._$wrpOutline.toggleClass("hidden",!1),this._$trNoContent.toggleClass("hidden",!0),a.toggleClass("hidden",!1),b.toggleClass("hidden",!1))};this._addHookBase("isHideFeatures",d),MiscUtil.pDefer(d);const e=this.activeClass;e.subclasses.forEach(a=>{const b=UrlUtil.getStateKeySubclass(a),c=()=>{const a=this._state[b];$(`[data-subclass-id="${b}"]`).toggleClass("hidden",!a)};this._addHookBase(b,c),this._addHookBase(b,d),MiscUtil.pDefer(c)}),this._handleFilterChange()};this._addHookAll("classId",async()=>{await this._pLock("render");try{await a()}finally{this._unlock("render")}}),await a()}_isAnySubclassActive(){return!!this._getActiveSubclasses().length}_getActiveSubclasses(a){const b=this.activeClass;return b.subclasses.filter(a=>this._state[UrlUtil.getStateKeySubclass(a)]).map(b=>a?UrlUtil.getStateKeySubclass(b):b)}_render_renderClassTable(){const a=$(`#classtable`).empty(),b=this.activeClass;Renderer.get().resetHeaderIndex();const c=[],d=[],e=(a,b)=>{let e;e=a.title?$(`<th class="cls-tbl__col-group" colspan="${a.colLabels.length}">${a.title}</th>`):$(`<th colspan="${a.colLabels.length}"/>`),c.push(e);const f=[];if(a.colLabels.forEach(a=>{const b=$(`<th class="cls-tbl__col-generic-center"><div class="cls__squash_header"/></th>`).fastSetHtml(Renderer.get().render(a));f.push(b),d.push(b)}),!!b){const a=()=>{e.toggleClass("hidden",!this._state[b]),f.forEach(a=>a.toggleClass("hidden",!this._state[b]))};this._addHookBase(b,a),MiscUtil.pDefer(a)}};b.classTableGroups&&b.classTableGroups.forEach(a=>e(a)),b.subclasses.forEach(a=>{if(!a.subclassTableGroups)return;const b=UrlUtil.getStateKeySubclass(a);a.subclassTableGroups.forEach(a=>e(a,b))});const f=b.classFeatures.map((a,c)=>{var d=Math.ceil;const e=d((c+1)/4)+1,f=a.filter(a=>a.name&&"inset"!==a.type),g=f.map((a,b)=>{const d=`${c}-${b}`,e=$(`<a>${a.name}</a>`).click(()=>{this._lastScrollFeature=null,this._state.feature=null,this._state.feature=d}),g=()=>{setTimeout(()=>{const a=MiscUtil.copy(this.__state);a.feature=d;const b=`#${this._getHashState({state:a})}`;e.attr("href",b)},5)};this._addHookAll("state",g),g();const h=b===f.length-1?$(`<span/>`):$(`<span class="mr-1">,</span>`);return{$wrpLink:$$`<div class="inline-block">${e}${h}</div>`,$dispComma:h,source:a.source,isHidden:!1}}),h=[],i=(a,b)=>{const d=a.rows[c]||[],e=d.map(a=>$(`<td class="cls-tbl__col-generic-center"/>`).fastSetHtml(0===a?"\u2014":Renderer.get().render(a)));if(h.push(...e),!!b){const a=()=>e.forEach(a=>a.toggleClass("hidden",!this._state[b]));this._addHookBase(b,a),MiscUtil.pDefer(a)}};return b.classTableGroups&&b.classTableGroups.forEach(a=>i(a)),b.subclasses.forEach(a=>{if(!a.subclassTableGroups)return;const b=UrlUtil.getStateKeySubclass(a);a.subclassTableGroups.forEach(a=>i(a,b))}),{$row:$$`<tr class="cls-tbl__stripe-odd">
					<td class="cls-tbl__col-level">${Parser.getOrdinalForm(c+1)}</td>
					<td class="cls-tbl__col-prof-bonus">+${e}</td>
					<td>${g.length?g.map(a=>a.$wrpLink):`\u2014`}</td>
					${h}
				</tr>`,metasFeatureLinks:g}});this._fnTableHandleFilterChange=a=>{f.forEach(b=>{b.metasFeatureLinks.forEach(b=>{if(b.source){const c=!this._filterBox.toDisplay(a,b.source,[]);b.isHidden=c,b.$wrpLink.toggleClass("hidden",c)}}),b.metasFeatureLinks.forEach(a=>a.$dispComma.toggleClass("hidden",!1));const c=b.metasFeatureLinks.filter(a=>!a.isHidden).last();c&&c.$dispComma.addClass("hidden")})},$$`<table class="cls-tbl shadow-big w-100 mb-2">
			<tbody>
			<tr><th class="border" colspan="15"></th></tr>
			<tr><th class="cls-tbl__disp-name" colspan="15">${b.name}</th></tr>
			<tr>
				<th colspan="3"/> <!-- spacer to match the 3 default cols (level, prof, features) -->
				${c}
			</tr>
			<tr>
				<th class="cls-tbl__col-level">Level</th>
				<th class="cls-tbl__col-prof-bonus">Proficiency Bonus</th>
				<th>Features</th>
				${d}
			</tr>
			${f.map(a=>a.$row)}
			<tr><th class="border" colspan="15"></th></tr>
			</tbody>
		</table>`.appendTo(a),a.show()}_render_renderSidebar(){const a=$(`#statsprof`).empty(),b=this.activeClass,c=$(`<div class="cls-side__btn-toggle">[\u2012]</div>`).click(()=>this._state.isHideSidebar=!this._state.isHideSidebar),d=()=>{c.text(this._state.isHideSidebar?`[+]`:`[\u2012]`),$(`.cls-side__show-hide`).toggle(!this._state.isHideSidebar)};this._addHookBase("isHideSidebar",d);let e=null;if(b.hd){const a={toRoll:`${b.hd.number}d${b.hd.faces}`,rollable:!0};e=`<tr class="cls-side__show-hide">
				<td colspan="6" class="cls-side__section">
					<h5 class="cls-side__section-head">Hit Points</h5>
					<div><strong>Hit Dice:</strong> ${Renderer.getEntryDice(a,"Hit die")}</div>
					<div><strong>Hit Points at 1st Level:</strong> ${b.hd.faces} + your Constitution modifier</div>
					<div><strong>Hit Points at Higher Levels:</strong> ${Renderer.getEntryDice(a,"Hit die")} (or ${b.hd.faces/2+1}) + your Constitution modifier per ${b.name} level after 1st</div>
				</td>
			</tr>`}const f=a=>a.map(b=>b.full?b.full:"light"===b||"medium"===b||"heavy"===b?`${b} armor`:b).join(", "),g=a=>a.map(a=>"simple"===a||"martial"===a?`${a} weapons`:a).join(", "),h=a=>`${Parser.skillProficienciesToFull(a).uppercaseFirst()}.`,i=b.startingProficiencies||{};let j=null;if(b.startingEquipment){const a=b.startingEquipment,c=[a.additionalFromBackground?"<p>You start with the following items, plus anything provided by your background.</p>":"",a.default&&a.default.length?`<ul class="pl-4"><li>${a.default.map(a=>Renderer.get().render(a)).join("</li><li>")}</ul>`:"",null==a.goldAlternative?"":`<p>Alternatively, you may start with ${Renderer.get().render(a.goldAlternative)} gp to buy your own equipment.</p>`].filter(Boolean).join(""),d=$(`<div/>`);j=$$`<tr class="cls-side__show-hide">
				<td class="cls-side__section" colspan="6">
					<h5 class="cls-side__section-head">Starting Equipment</h5>
					<div>${d}</div>
				</td>
			</tr>`,d.fastSetHtml(c)}let k=null;if(b.multiclassing){const a=b.multiclassing;let c=null;if(a.requirements){const b=(a,b=", ")=>Object.keys(a).filter(a=>"or"!==a).sort(SortUtil.ascSortAtts).map(b=>`${Parser.attAbvToFull(b)} ${a[b]}`).join(b),d=a.requirements.or?a.requirements.or.map(a=>b(a," or ")).join("; "):"",e=b(a.requirements);c=$$`<div>
					<div>To qualify for a new class, you must meet the ability score prerequisites for both your current class and your new one.</div>
					<b>Ability Score Minimum:</b> ${[d,e].filter(Boolean).join("; ")}
				</div>`}let d=null,e=null,i=null,j=null,l=null;a.proficienciesGained&&(d=$(`<div ${a.requirements?`class="cls-side__mc-prof-intro--requirements"`:""}>When you gain a level in a class other than your first, you gain only some of that class's starting proficiencies.</div>`),a.proficienciesGained.armor&&(e=$(`<div><b>Armor:</b> ${f(a.proficienciesGained.armor)}</div>`)),a.proficienciesGained.weapons&&(i=$(`<div><b>Weapons:</b> ${g(a.proficienciesGained.weapons)}</div>`)),a.proficienciesGained.tools&&(j=$(`<div><b>Tools:</b> ${a.proficienciesGained.tools.join(", ")}</div>`)),a.proficienciesGained.skills&&(l=$(`<div><b>Skills:</b> ${h(a.proficienciesGained.skills)}</div>`))),k=$$`<tr class="cls-side__show-hide">
				<td class="cls-side__section" colspan="6">
					<h5 class="cls-side__section-head">Multiclassing</h5>
					${c}
					${d}
					${e}
					${i}
					${j}
					${l}
				</td>
			</tr>`}$$`<table class="stats shadow-big">
			<tr><th class="border" colspan="6"></th></tr>
			<tr><th colspan="6"><div class="split-v-center pr-1"><div class="cls-side__name">${b.name}</div>${c}</div></th></tr>
			${b.authors?`<tr><th colspan="6">By ${b.authors.join(", ")}</th></tr>`:""}

			<tr class="cls-side__show-hide"><td class="divider" colspan="6"><div class="my-0"/></td></tr>

			${e}

			<tr class="cls-side__show-hide">
				<td colspan="6" class="cls-side__section">
					<h5 class="cls-side__section-head">Proficiencies</h5>
					<div><b>Armor:</b> <span>${i.armor?f(i.armor):"none"}</span></div>
					<div><b>Weapons:</b> <span>${i.weapons?g(i.weapons):"none"}</span></div>
					<div><b>Tools:</b> <span>${i.tools?i.tools.join(", "):"none"}</span></div>
					<div><b>Saving Throws:</b> <span>${b.proficiency?b.proficiency.map(a=>Parser.attAbvToFull(a)).join(", "):"none"}</span></div>
					<div><b>Skills:</b> <span>${i.skills?h(i.skills):"none"}</span></div>
				</td>
			</tr>

			${j}

			${k}

			<tr><th class="border" colspan="6"></th></tr>
		</table>`.appendTo(a),a.show(),MiscUtil.pDefer(d)}async _render_pRenderSubclassTabs(){const a=$(`#subclasstabs`).empty();this._render_renderSubclassPrimaryControls(a),await this._render_pInitSubclassControls(a)}_render_renderSubclassPrimaryControls(a){const b=this.activeClass,c=ComponentUiUtil.$getBtnBool(this,"isHideFeatures",{text:"Features",activeClass:"cls__btn-cf--active",isInverted:!0}).title("Toggle Class Features"),d=ComponentUiUtil.$getBtnBool(this,"isShowFluff",{text:"Info"}).title("Toggle Class Info");$$`<div class="flex-v-center m-1 btn-group mr-3 no-shrink">${c}${d}</div>`.appendTo(a);const e=$(`<div class="flex-v-center flex-wrap mr-2 w-100"/>`).appendTo(a);for(this._listSubclass=new List({$wrpList:e,isUseJquery:!0,fnSort:ClassesPage._fnSortSubclassFilterItems}),this._ixDataSubclass=0;this._ixDataSubclass<b.subclasses.length;++this._ixDataSubclass){const a=b.subclasses[this._ixDataSubclass],c=this._render_getSubclassTab(b,a,this._ixDataSubclass);c&&this._listSubclass.addItem(c)}const f=$(`<div class="text-muted m-1 cls-tabs__sc-not-shown flex-vh-center"/>`);this._listSubclass.addItem(new ListItem(-1,f,null,{isAlwaysVisible:!0})),this._listSubclass.on("updated",()=>{if(f.off("click"),this._listSubclass.visibleItems.length){const a=this._listSubclass.items.length-this._listSubclass.visibleItems.length;f.html(a?`<i class="clickable" title="Adjust your filters to see more.">(${a} more not shown)</i>`:"").click(()=>this._doSelectAllSubclasses())}else 1<this._listSubclass.items.length?f.html(`<i class="clickable" title="Adjust your filters to see more.">(${this._listSubclass.items.length-1} subclasses not shown)</i>`).click(()=>this._doSelectAllSubclasses()):f.html("")}),this._listSubclass.init()}_doSelectAllSubclasses(){const a=this.activeClass,b=a.subclasses.map(a=>UrlUtil.getStateKeySubclass(a));this._sourceFilter.doSetPillsClear(),this._filterBox.fireChangeEvent(),this._proxyAssign("state","_state","__state",b.mergeMap(a=>({[a]:!0})))}async _render_pInitSubclassControls(a){const b=this.activeClass,c=$(`<button class="btn btn-xs btn-default" title="Select All (SHIFT to include most recent UA/etc.; CTRL to select official only)"><span class="glyphicon glyphicon-check"/></button>`).click(a=>{const c=b.subclasses.map(a=>UrlUtil.getStateKeySubclass(a));if(a.shiftKey)this._doSelectAllSubclasses();else if(a.ctrlKey){const a={};c.forEach(b=>a[b]=!1),this._listSubclass.visibleItems.filter(a=>"brew"===a.values.mod||"fresh"===a.values.mod).map(a=>a.values.stateKey).forEach(b=>a[b]=!0),this._proxyAssign("state","_state","__state",a)}else{const a={};c.forEach(b=>a[b]=!1),this._listSubclass.visibleItems.map(a=>a.values.stateKey).filter(Boolean).forEach(b=>a[b]=!0),this._proxyAssign("state","_state","__state",a)}}),d=[{name:"View Official",subHashes:[]},{name:"View Most Recent",subHashes:["flstsource:dmg=0~erlw=0~ggr=0~phb=0~scag=0~xge=0"]},{name:"View All",subHashes:["flstsource:dmg=0~erlw=0~ggr=0~phb=0~scag=0~xge=0","flstmiscellaneous:reprinted=0"]}],e=a=>{const b=d[a],c=this._filterBox.getBoxSubHashes()||[];this._filterBox.setFromSubHashes([...c,...b.subHashes].filter(Boolean),!0),f.val("-1")},f=$(`<select class="input-xs form-control cls-tabs__sel-preset"><option value="-1" disabled>Filter...</option></select>`).change(()=>{const a=+f.val();null==a||e(a)});d.forEach((a,b)=>f.append(`<option value="${b}">${a.name}</option>`)),f.val("-1");const g=$(`<button class="btn btn-xs btn-default" title="Reset Selection"><span class="glyphicon glyphicon-refresh"/></button>`).click(()=>{this._proxyAssign("state","_state","__state",b.subclasses.mergeMap(a=>({[UrlUtil.getStateKeySubclass(a)]:!1})))});$(this._filterBox).on(FilterBox.EVNT_VALCHANGE,this._handleSubclassFilterChange.bind(this)),this._handleSubclassFilterChange(),this._listSubclass.items.forEach(a=>a.ele.removeClass("hidden"));const h=ComponentUiUtil.$getBtnBool(this,"isShowScSources",{$ele:$(`<button class="btn btn-xs btn-default flex-1" title="Show Subclass Sources"><span class="glyphicon glyphicon-book"/></button>`)}),i=$(`<button title="Feeling Lucky?" class="btn btn-xs btn-default flex-1"><span class="glyphicon glyphicon-random"/></button>`).click(()=>{if(!this._listSubclass.visibleItems.length)return JqueryUtil.doToast({content:"No subclasses to choose from!",type:"warning"});const a=()=>this._listSubclass.items.filter(a=>a.values.stateKey).forEach(a=>this._state[a.values.stateKey]=!1),b=Object.keys(this._state).filter(a=>a.startsWith("sub")),c=this._listSubclass.visibleItems.filter(a=>a.values.stateKey).map(a=>a.values.stateKey).filter(a=>b.includes(a));if(1===c.length){a();const b=this._listSubclass.visibleItems.filter(a=>a.values.stateKey).map(a=>a.values.stateKey).filter(a=>a.values.stateKey!==c[0]);this._state[RollerUtil.rollOnArray(b)]=!0}else{a();const b=RollerUtil.rollOnArray(this._listSubclass.visibleItems.filter(a=>a.values.stateKey));this._state[b.values.stateKey]=!0}});$$`<div class="flex-v-center m-1 no-shrink">${f}</div>`.appendTo(a),$$`<div class="flex-v-center m-1 btn-group no-shrink">
			${c}${i}${g}${h}
		</div>`.appendTo(a)}_handleSubclassFilterChange(){const a=this._filterBox.getValues(),b=this.activeClass;this._listSubclass.filter(c=>{if(c.values.isAlwaysVisible)return!0;const d=b.subclasses[c.ix];return this._filterBox.toDisplay(a,d.source,d._fMisc)})}_render_getSubclassTab(a,b,c){const d=ExcludeUtil.isExcluded(b.name,"subclass",b.source),e=UrlUtil.getStateKeySubclass(b),f=ClassesPage.getSubclassCssMod(a,b);null==this._state[e]&&(this._state[e]=!1);const g=$(`<div title="${ClassesPage.getBtnTitleSubclass(b)}"/>`),h=$(`<div class="ml-1" title="${Parser.sourceJsonToFull(b.source)}">(${Parser.sourceJsonToAbv(b.source)})</div>`),i=()=>{g.text(this._state.isShowScSources?ClassesPage.getBaseShortName(b):b.shortName),h.toggleClass("hidden",!this._state.isShowScSources)};this._addHookBase("isShowScSources",i),MiscUtil.pDefer(i);const j=$$`<button class="btn btn-default btn-xs flex-v-center m-1 hidden ${b.isReprinted?"cls__btn-sc--reprinted":""}">
				${g}
				${h}
			</button>`.click(()=>this._state[e]=!this._state[e]).contextmenu(()=>this._state[e]=!this._state[e]),k=()=>j.toggleClass(`cls__btn-sc--active-${f}`,!!this._state[e]);return this._addHookBase(e,k),MiscUtil.pDefer(k),new ListItem(c,j,b.name,{source:b.source,shortName:b.shortName,stateKey:e,mod:f},{isExcluded:d})}_trackOutlineFluffData(a){this._outlineData.fluff=a}_trackOutlineCfData(a,b,c){((this._outlineData.classFeatures=this._outlineData.classFeatures||[])[a]=this._outlineData.classFeatures[a]||[])[b]=c}_trackOutlineScData(a,b,c,d){((this._outlineData[a]=this._outlineData[a]||[])[b]=this._outlineData[a][b]||[])[c]=d}_render_renderOutline(){this._$wrpOutline.empty();const a=$(`<div class="cls-nav__disp-toggle"/>`),b=$$`<div class="cls-nav__head-inner split">
			<div>Outline</div>
			${a}
		</div>`.click(()=>this._state.isHideOutline=!this._state.isHideOutline),c=$$`<div class="cls-nav__head">
			${b}
			<hr class="cls-nav__hr">
		</div>`.appendTo(this._$wrpOutline),d=$(`<div class="nav-body"/>`).appendTo(this._$wrpOutline),e=()=>{c.toggleClass("cls-nav__head--active",!this._state.isHideOutline),d.toggleClass("hidden",!!this._state.isHideOutline),a.toggleClass("cls-nav__disp-toggle--active",!this._state.isHideOutline)};this._addHookBase("isHideOutline",e),MiscUtil.pDefer(e);const f=MiscUtil.debounce(async()=>{await this._pLock("render-outline"),d.empty();const a=this._filterBox.getValues(),b=(b,c)=>{var e=Math.min;if(!(2<=b.depth)&&(!b.source||this._filterBox.toDisplay(a,b.source,[]))){c=c||(b.source&&SourceUtil.isNonstandardSource(b.source)?`cls-nav__item--spicy`:"");const a=e(b.depth+1,2);$(`<div class="cls-nav__item cls-nav__item--depth-${a} ${c}">${b.name}</div>`).click(()=>{const a=$(`[data-title-index="${b.ixHeader}"]`);a.get()[0]&&a.get()[0].scrollIntoView()}).appendTo(d)}};if(this._state.isShowFluff&&this._outlineData.fluff&&this._outlineData.fluff.filter(a=>a.name).forEach(a=>b(a)),this._state.isHideFeatures&&!this._isAnySubclassActive())return void this._unlock("render-outline");let c=0;this.activeClass.classFeatures.forEach((a,d)=>{a.forEach((a,e)=>{const f=MiscUtil.get(this._outlineData.classFeatures,d,e);!this._state.isHideFeatures&&f&&f.filter(a=>a.name).forEach(a=>b(a));const g=this._getActiveSubclasses(!0);a.gainSubclassFeature&&(g.length&&(this._state.isHideFeatures&&f&&f.filter(a=>a.name).forEach(a=>b(a)),this.activeClass.subclasses.forEach(a=>{const d=UrlUtil.getStateKeySubclass(a);if(!g.includes(d))return;const e=a.subclassFeatures[c];if(!e)return;const f=ClassesPage.getSubclassCssMod(this.activeClass,a);e.forEach((a,e)=>{const g=MiscUtil.get(this._outlineData,d,c,e);g.filter(a=>a.name).map(a=>b(a,`cls-nav__item--sc-${f}`))})})),c++)})}),this._unlock("render-outline")},50);this._addHookBase("isShowFluff",f),this._addHookBase("isHideFeatures",f),this.activeClass.subclasses.forEach(a=>{const b=UrlUtil.getStateKeySubclass(a);this._addHookBase(b,f)}),this._fnOutlineHandleFilterChange=f,MiscUtil.pDefer(f)}_render_renderAltViews(){const a=this.activeClass;this._subclassComparisonView=new BookModeView({stateKey:"isViewActiveScComp",state:this._state,$openBtn:$(`#btn-comparemode`),noneVisibleMsg:"Please select some subclasses first",pageTitle:"Subclass Comparison",isFlex:!0,popTblGetNumShown:b=>{b.removeClass("bkmv__wrp").addClass("h-100").addClass("flex-col"),b.parent().addClass("stats").addClass("stats--book");const c=[],d=a.subclasses[0].subclassFeatures.length;for(let e=0;e<d;++e){const b=e==d-1;c.push(`<div class="flex ${b?"mb-4":""}">`),a.subclasses.filter(a=>!ExcludeUtil.isExcluded(a.name,"subclass",a.source)).forEach((b,d)=>{const f=ClassesPage.getSubclassCssMod(a,b);c.push(`<div class="mx-2 no-shrink cls-comp__wrp-features cls-main__sc-feature ${f?`cls-main__sc-feature--${f}`:""}" data-cls-comp-sc-ix="${d}">`),b.subclassFeatures[e].forEach(a=>Renderer.get().recursiveRender(a,c)),c.push(`</div>`)}),c.push(`</div>`),b||c.push(`<hr class="hr-2 mt-3 cls-comp__hr-level"/>`)}b.append(c.join(""));let e=0;return a.subclasses.filter(a=>!ExcludeUtil.isExcluded(a.name,"subclass",a.source)).forEach((a,c)=>{const d=UrlUtil.getStateKeySubclass(a);this._state[d]?e++:b.find(`[data-cls-comp-sc-ix="${c}"]`).hide()}),e||b.find(".cls-comp__hr-level").addClass("hidden"),e}});const b=async()=>{await this._pLock("sc-comparison "),this._state.isViewActiveScComp?await this._subclassComparisonView.pOpen():(this._subclassComparisonView.teardown(),document.title=`${a?a.name:"Classes"} - 5etools`),this._unlock("sc-comparison ")};this._addHookBase("isViewActiveScComp",b),b(),this._classBookView&&this._classBookView.cleanup(),this._classBookView=new ClassesPage.ClassBookView(this);const c=()=>{this._state.isViewActiveBook?this._classBookView.open():(this._classBookView.teardown(),document.title=`${a?a.name:"Classes"} - 5etools`)};this._addHookBase("isViewActiveBook",c),c()}static getSubclassCssMod(a,b){return b.source===a.source?"fresh":BrewUtil.hasSourceJson(b.source)?"brew":SourceUtil.isNonstandardSource(b.source)?b.isReprinted?"stale":"spicy":b.isReprinted?"reprinted":"fresh"}_render_renderClassContent(){const a=$(`#pagecontent`).empty(),b=this._dataList[this._classId._];if(this._outlineData={},this._$trsContent=[],a.append(Renderer.utils.getBorderTr()),b.fluff){const c=[];let d="";Renderer.get().setFirstSection(!0),b.fluff.forEach((a,e)=>{const f=MiscUtil.copy(a);"string"!=typeof f&&(f.type=f.type||"section",0===e&&!f.name&&(f.name=b.name),a.source&&a.source!==SRC_PHB&&f.entries&&f.entries.unshift(`{@note The following information is from ${Parser.sourceJsonToFull(a.source)}${0<a.page?`, page ${a.page}`:""}.}`)),d+=Renderer.get().setDepthTracker(c).render(f)});const e=$(`<tr class="cls-main__cls-fluff"><td colspan="6"/></tr>`).fastSetHtml(d).appendTo(a);this._$trsContent.push(e),this._trackOutlineFluffData(c)}let c=0;b.classFeatures.forEach((d,e)=>{d.forEach((d,f)=>{const g=[],h=$(`<tr data-scroll-id="${e}-${f}" data-feature-type="class" class="${d.gainSubclassFeature?"cls-main__gain-sc-feature":""} cls-main__linked-titles"><td colspan="6"/></tr>`).fastSetHtml(Renderer.get().setDepthTracker(g).render(d)).appendTo(a);this._$trsContent.push(h),this._trackOutlineCfData(e,f,g),d.gainSubclassFeature&&(h.attr("data-feature-type","gain-subclass"),b.subclasses.forEach(d=>{const e=UrlUtil.getStateKeySubclass(d),f=`cls-main__sc-feature--${ClassesPage.getSubclassCssMod(b,d)}`,g=d.subclassFeatures[c];g&&g.forEach((b,g)=>{const h=[],i=$(`<tr class="cls-main__sc-feature ${f}" data-subclass-id="${UrlUtil.getStateKeySubclass(d)}"><td colspan="6"/></tr>`).fastSetHtml(Renderer.get().setDepthTracker(h).render(b)).appendTo(a);this._$trsContent.push(i),this._trackOutlineScData(e,c,g,h)})}),c++)})}),this._$trNoContent=ClassesPage._render_$getTrNoContent().appendTo(a),a.append(Renderer.utils.getBorderTr())}static _render_$getTrNoContent(){return $(`<tr class="cls-main__msg-no-content"><td colspan="6">Toggle a button to view class and subclass information</td></tr>`)}_getDefaultState(){return MiscUtil.copy(ClassesPage._DEFAULT_STATE)}}ClassesPage._SC_FILTER_NAMESPACE="sctabs",ClassesPage._DEFAULT_STATE={feature:null,isHideSidebar:!1,isHideFeatures:!1,isShowFluff:!1,isShowScSources:!1,isViewActiveScComp:!1,isViewActiveBook:!1,isHideOutline:!1},ClassesPage.ClassBookView=class{constructor(a){this._classPage=a,this._parent=a.getPod(),this._bookViewActive=!1,this._hooks={},this._$body=null,this._$wrpBook=null,$(`#btn-readmode`).off("click").on("click",()=>this._parent.set("isViewActiveBook",!0))}cleanup(){Object.entries(this._hooks).forEach(([a,b])=>{b.forEach(b=>this._parent.removeHook(a,b))})}open(){if(this._bookViewActive)return;this._bookViewActive=!0;const a=this._classPage.activeClass;this._$body=$(document.body),this._$wrpBook=$(`<div class="bkmv"/>`),this._$body.css("overflow","hidden"),this._$body.addClass("bkmv-active");const b=$(`<span class="delete-icon glyphicon glyphicon-remove"/>`).click(()=>this._parent.set("isViewActiveBook",!1));$$`<div class="bkmv__spacer-name flex-h-right no-shrink">${b}</div>`.appendTo(this._$wrpBook);const c=$(`<div class="cls-bkmv__wrp-tabs flex-h-center"/>`).appendTo(this._$wrpBook),d=$(`<table class="stats stats--book stats--book-large"/>`);$$`<div class="flex-col overflow-y-auto container">${d}</div>`.appendTo(this._$wrpBook);const e=[];Renderer.get().setFirstSection(!0),e.push(`<tr><td colspan="6" class="py-3 px-5">`),Renderer.get().recursiveRender({type:"section",name:a.name},e),e.push(`</td></tr>`),e.push(`<tr class="text" data-cls-book-cf="true"><td colspan="6" class="py-3 px-5">`),a.classFeatures.forEach(a=>{a.forEach(a=>Renderer.get().recursiveRender(a,e))}),e.push(`</td></tr>`),a.subclasses.filter(a=>!ExcludeUtil.isExcluded(a.name,"subclass",a.source)).forEach((b,c)=>{const d=ClassesPage.getSubclassCssMod(a,b);e.push(`<tr data-cls-book-sc-ix="${c}" class="cls-main__sc-feature ${d?`cls-main__sc-feature--${d}`:""}"><td colspan="6" class="py-3 px-5">`),b.subclassFeatures.forEach(a=>{a.forEach(a=>Renderer.get().recursiveRender(a,e))}),e.push(`</td></tr>`)}),e.push(Renderer.utils.getBorderTr()),d.append(e.join(""));const g=$(`<span class="cls-bkmv__btn-tab">Class Features</span>`).on("click",()=>{this._parent.set("isHideFeatures",!this._parent.get("isHideFeatures"))});this._parent.get("isHideFeatures")&&this._parent.set("isHideFeatures",!1),c.append(g);const h=this._classPage.filterBox.getValues();a.subclasses.filter(a=>!ExcludeUtil.isExcluded(a.name,"subclass",a.source)).forEach((b,d)=>{const e=b.isReprinted?`${ClassesPage.getBaseShortName(b)} (${Parser.sourceJsonToAbv(b.source)})`:b.shortName,f=ClassesPage.getSubclassCssMod(a,b),g=UrlUtil.getStateKeySubclass(b),i=$(`<span class="cls-bkmv__btn-tab ${b.isReprinted?"cls__btn-sc--reprinted":""}" title="${ClassesPage.getBtnTitleSubclass(b)}">${e}</span>`).on("click",()=>this._parent.set(g,!this._parent.get(g))),j=this._classPage.filterBox.toDisplay(h,b.source,b._fMisc);j||i.addClass("hidden");const k=()=>{const a=this._$wrpBook.find(`[data-cls-book-sc-ix="${d}"]`),b=!!this._parent.get(g);i.toggleClass(`cls__btn-sc--active-${f}`,b),a.toggleClass("hidden",!b)};(this._hooks[g]=this._hooks[g]||[]).push(k),this._parent.addHook(g,k),k(),c.append(i)});const i=()=>{const a=this._$wrpBook.find(`[data-cls-book-cf="true"]`),b=!this._parent.get("isHideFeatures");g.toggleClass("cls__btn-cf--active",b),a.toggleClass("hidden",!b)};(this._hooks.isHideFeatures=this._hooks.isHideFeatures||[]).push(i),this._parent.addHook("isHideFeatures",i),i();const j=this._classPage.filterBox.getValues();this._$wrpBook.find(`tr`).each((a,b)=>{const c=$(b);c.find(`[data-source]`).each((a,b)=>{const c=b.dataset.source;$(b).toggleClass("hidden",!this._classPage.filterBox.toDisplay(j,c,[]))})}),this._$body.append(this._$wrpBook)}teardown(){this._bookViewActive&&(this._$body.css("overflow",""),this._$body.removeClass("bkmv-active"),this._$wrpBook.remove(),this._bookViewActive=!1)}};const classesPage=new ClassesPage;window.addEventListener("load",()=>classesPage.pOnLoad());
IS_DEPLOYED="1.97.1",VERSION_NUMBER="1.97.1",DEPLOYED_STATIC_ROOT="",IS_VTT=!1,IMGUR_CLIENT_ID=`abdea4de492d3b0`,HASH_PART_SEP=",",HASH_LIST_SEP="_",HASH_SUB_LIST_SEP="~",HASH_SUB_KV_SEP=":",HASH_BLANK="blankhash",HASH_SUB_NONE="null",CLSS_NON_STANDARD_SOURCE="spicy-sauce",CLSS_HOMEBREW_SOURCE="refreshing-brew",MON_HASH_SCALED="scaled",STR_NONE="None",STR_SEE_CONSOLE="See the console (CTRL+SHIFT+J) for details.",HOMEBREW_STORAGE="HOMEBREW_STORAGE",HOMEBREW_META_STORAGE="HOMEBREW_META_STORAGE",EXCLUDES_STORAGE="EXCLUDES_STORAGE",DMSCREEN_STORAGE="DMSCREEN_STORAGE",ROLLER_MACRO_STORAGE="ROLLER_MACRO_STORAGE",ENCOUNTER_STORAGE="ENCOUNTER_STORAGE",POINTBUY_STORAGE="POINTBUY_STORAGE",JSON_HOMEBREW_INDEX=`homebrew/index.json`,String.prototype.uppercaseFirst=String.prototype.uppercaseFirst||function(){const e=this.toString();return 0===e.length?e:1===e.length?e.charAt(0).toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)},String.prototype.lowercaseFirst=String.prototype.lowercaseFirst||function(){const e=this.toString();return 0===e.length?e:1===e.length?e.charAt(0).toLowerCase():e.charAt(0).toLowerCase()+e.slice(1)},String.prototype.toTitleCase=String.prototype.toTitleCase||function(){let e;e=this.replace(/([^\W_]+[^\s-/]*) */g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),StrUtil._TITLE_LOWER_WORDS_RE||(StrUtil._TITLE_LOWER_WORDS_RE=StrUtil.TITLE_LOWER_WORDS.map(e=>new RegExp(`\\s${e}\\s`,"g")));for(let n=0;n<StrUtil.TITLE_LOWER_WORDS.length;n++)e=e.replace(StrUtil._TITLE_LOWER_WORDS_RE[n],e=>e.toLowerCase());StrUtil._TITLE_UPPER_WORDS_RE||(StrUtil._TITLE_UPPER_WORDS_RE=StrUtil.TITLE_UPPER_WORDS.map(e=>new RegExp(`\\b${e}\\b`,"g")));for(let n=0;n<StrUtil.TITLE_UPPER_WORDS.length;n++)e=e.replace(StrUtil._TITLE_UPPER_WORDS_RE[n],StrUtil.TITLE_UPPER_WORDS[n].toUpperCase());return e},String.prototype.toSentenceCase=String.prototype.toSentenceCase||function(){const e=[],n=/([^.!?]+)([.!?]\s*|$)/gi;let _;do _=n.exec(this),_&&e.push(_[0].toLowerCase().uppercaseFirst());while(_);return e.join("")},String.prototype.toSpellCase=String.prototype.toSpellCase||function(){return this.toLowerCase().replace(/(^|of )(bigby|otiluke|mordenkainen|evard|hadar|agatys|abi-dalzim|aganazzar|drawmij|leomund|maximilian|melf|nystul|otto|rary|snilloc|tasha|tenser|jim)('s|$| )/g,(...e)=>`${e[1]}${e[2].toTitleCase()}${e[3]}`)},String.prototype.toCamelCase=String.prototype.toCamelCase||function(){return this.split(" ").map((e,n)=>0===n?e.toLowerCase():`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()}`).join("")},String.prototype.escapeQuotes=String.prototype.escapeQuotes||function(){return this.replace(/'/g,`&apos;`).replace(/"/g,`&quot;`)},String.prototype.unescapeQuotes=String.prototype.unescapeQuotes||function(){return this.replace(/&apos;/g,`'`).replace(/&quot;/g,`"`)},String.prototype.encodeApos=String.prototype.encodeApos||function(){return this.replace(/'/g,`%27`)},String.prototype.distance=String.prototype.distance||function(e){var _=Math.min;let t,o,a=this;if(!a)return e?e.length:0;if(!e)return a.length;const r=a.length,s=e.length,n=r+s,d=Array(r+2),l={};for(t=0;t<r+2;t++)d[t]=Array(s+2);for(d[0][0]=n,t=0;t<=r;t++)d[t+1][1]=t,d[t+1][0]=n,l[a[t]]=0;for(o=0;o<=s;o++)d[1][o+1]=o,d[0][o+1]=n,l[e[o]]=0;for(t=1;t<=r;t++){let n=0;for(o=1;o<=s;o++){const i=l[e[o-1]],r=n;a[t-1]===e[o-1]?(d[t+1][o+1]=d[t][o],n=o):d[t+1][o+1]=_(d[t][o],_(d[t+1][o],d[t][o+1]))+1,d[t+1][o+1]=_(d[t+1][o+1],d[i]?d[i][r]+(t-i-1)+1+(o-r-1):1/0)}l[a[t-1]]=t}return d[r+1][s+1]},String.prototype.isNumeric=String.prototype.isNumeric||function(){return!isNaN(parseFloat(this))&&isFinite(this)},String.prototype.last=String.prototype.last||function(){return this[this.length-1]},String.prototype.escapeRegexp=String.prototype.escapeRegexp||function(){return this.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")},String.prototype.toUrlified=String.prototype.toUrlified||function(){return encodeURIComponent(this).toLowerCase()},Array.prototype.joinConjunct=Array.prototype.joinConjunct||function(e,n,_){if(0===this.length)return"";if(1===this.length)return this[0];if(2===this.length)return this.join(n);else{let t="";for(let o=0;o<this.length;++o)t+=this[o],o<this.length-2?t+=e:o==this.length-2&&(t+=`${!_&&2<this.length?e.trim():""}${n}`);return t}},StrUtil={COMMAS_NOT_IN_PARENTHESES_REGEX:/,\s?(?![^(]*\))/g,COMMA_SPACE_NOT_IN_PARENTHESES_REGEX:/, (?![^(]*\))/g,uppercaseFirst:function(e){return e.uppercaseFirst()},TITLE_LOWER_WORDS:["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],TITLE_UPPER_WORDS:["Id","Tv","Dm"],padNumber:(e,n,_)=>(e+"").padStart(n,_),elipsisTruncate(e,n=5,_=0,t=20){var o=Math.max;if(t>=e.length)return e;t=o(n+_+3,t);let a="",r=t-(3+n+_);for(let o=0;o<e.length-_;++o){const _=e[o];o<n?a+=_:0<r--&&(a+=_)}return 0>r&&(a+="..."),a+=e.substring(e.length-_,e.length),a},toTitleCase(e){return e.toTitleCase()}},CleanUtil={getCleanJson(e,n=!1){let _=n?JSON.stringify(e):`${JSON.stringify(e,null,"\t")}\n`;return CleanUtil.getCleanString(_)},getCleanString(e,n=!0){return e=e.replace(CleanUtil.SHARED_REPLACEMENTS_REGEX,e=>CleanUtil.SHARED_REPLACEMENTS[e]).replace(/\u00AD/g,"").replace(/\s*(\.\s*\.\s*\.)/g,"$1"),n?e.replace(CleanUtil.STR_REPLACEMENTS_REGEX,e=>CleanUtil.STR_REPLACEMENTS[e]).replace(/\s*(\\u2014|\\u2013)\s*/g,"$1"):e.replace(CleanUtil.JSON_REPLACEMENTS_REGEX,e=>CleanUtil.JSON_REPLACEMENTS[e]).replace(/\s*([\u2014\u2013])\s*/g,"$1")}},CleanUtil.SHARED_REPLACEMENTS={"’":"'","…":"..."," ":" ",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",Ĳ:"IJ",ĳ:"ij",Ǉ:"LJ",ǈ:"Lj",ǉ:"lj",Ǌ:"NJ",ǋ:"Nj",ǌ:"nj",ﬅ:"ft"},CleanUtil.STR_REPLACEMENTS={"—":"\\u2014","–":"\\u2013","−":"\\u2212","“":`\\"`,"”":`\\"`},CleanUtil.JSON_REPLACEMENTS={"“":`"`,"”":`"`},CleanUtil.SHARED_REPLACEMENTS_REGEX=new RegExp(Object.keys(CleanUtil.SHARED_REPLACEMENTS).join("|"),"g"),CleanUtil.STR_REPLACEMENTS_REGEX=new RegExp(Object.keys(CleanUtil.STR_REPLACEMENTS).join("|"),"g"),CleanUtil.JSON_REPLACEMENTS_REGEX=new RegExp(Object.keys(CleanUtil.JSON_REPLACEMENTS).join("|"),"g"),Parser={},Parser._parse_aToB=function(e,n,_){if(void 0===n||null===n)throw new TypeError("undefined or null object passed to parser");return"string"==typeof n&&(n=n.trim()),void 0===e[n]?void 0===_?n:_:e[n]},Parser._parse_bToA=function(e,n){if(void 0===n||null===n)throw new TypeError("undefined or null object passed to parser");for(const _ in"string"==typeof n&&(n=n.trim()),e)if(e.hasOwnProperty(_)&&e[_]===n)return _;return n},Parser.attrChooseToFull=function(e){if(1===e.length)return`${Parser.attAbvToFull(e[0])} modifier`;else{const n=[];for(let _=0;_<e.length;++_)n.push(Parser.attAbvToFull(e[_]));return`${n.join(" or ")} modifier (your choice)`}},Parser.numberToText=function(e){var _=Math.abs;function n(e){const t=_(e);switch(t){case 0:return"zero";case 1:return"one";case 2:return"two";case 3:return"three";case 4:return"four";case 5:return"five";case 6:return"six";case 7:return"seven";case 8:return"eight";case 9:return"nine";case 10:return"ten";case 11:return"eleven";case 12:return"twelve";case 13:return"thirteen";case 14:return"fourteen";case 15:return"fifteen";case 16:return"sixteen";case 17:return"seventeen";case 18:return"eighteen";case 19:return"nineteen";case 20:return"twenty";case 30:return"thirty";case 40:return"forty";case 50:return"fiddy";case 60:return"sixty";case 70:return"seventy";case 80:return"eighty";case 90:return"ninety";default:{const e=t+"";return`${n(+`${e[0]}0`)}-${n(+e[1])}`}}}if(null==e)throw new TypeError(`undefined or null object passed to parser`);return 100<=_(e)?`${e}`:`${0>e?"negative ":""}${n(e)}`},Parser.numberToVulgar=function(e){const n=`${e}`.split(".");return 1===n.length?e:"5"===n[1]?`${n[0]}½`:"25"===n[1]?`${n[0]}¼`:"75"===n[1]?`${n[0]}¾`:Parser.numberToFractional(e)},Parser._greatestCommonDivisor=function(e,n){var _=Number.EPSILON;return n<_?e:Parser._greatestCommonDivisor(n,Math.floor(e%n))},Parser.numberToFractional=function(e){var n=Math.pow,_=Math.floor;const t=e.toString().length-2;let o=n(10,t),i=e*o;const a=Parser._greatestCommonDivisor(i,o);return i=_(i/a),o=_(o/a),1===o?i+"":`${_(i)}/${_(o)}`},Parser.ALPHABET="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Parser.attAbvToFull=function(e){return Parser._parse_aToB(Parser.ATB_ABV_TO_FULL,e)},Parser.attFullToAbv=function(e){return Parser._parse_bToA(Parser.ATB_ABV_TO_FULL,e)},Parser.sizeAbvToFull=function(e){return Parser._parse_aToB(Parser.SIZE_ABV_TO_FULL,e)},Parser.getAbilityModNumber=function(e){return Math.floor((e-10)/2)},Parser.getAbilityModifier=function(e){let n=Parser.getAbilityModNumber(e);return 0<=n&&(n=`+${n}`),`${n}`},Parser.getSpeedString=e=>{function n(n){function i(e){o.push(`${"walk"===n?"":`${n} `}${_(e)} ft.${t(e)}`)}(e.speed[n]||"walk"===n)&&i(e.speed[n]||0),e.speed.alternate&&e.speed.alternate[n]&&e.speed.alternate[n].forEach(i)}function _(e){return null==e.number?e:e.number}function t(e){return e.condition?` ${Renderer.get().render(e.condition)}`:""}if(null==e.speed)return"\u2014";const o=[];if("object"==typeof e.speed){let _=", ";return n("walk"),n("burrow"),n("climb"),n("fly"),n("swim"),e.speed.choose&&(_="; ",o.push(`${e.speed.choose.from.sort().joinConjunct(", "," or ")} ${e.speed.choose.amount} ft.${e.speed.choose.note?` ${e.speed.choose.note}`:""}`)),o.join(_)}return e.speed+("Varies"===e.speed?"":" ft. ")},Parser.SPEED_TO_PROGRESSIVE={walk:"walking",burrow:"burrowing",climb:"climbing",fly:"flying",swim:"swimming"},Parser.speedToProgressive=function(e){return Parser._parse_aToB(Parser.SPEED_TO_PROGRESSIVE,e)},Parser._addCommas=function(e){return`${e}`.replace(/(\d)(?=(\d{3})+$)/g,"$1,")},Parser.crToXp=function(e){if(null!=e&&e.xp)return Parser._addCommas(e.xp);const n=e?e.cr||e:null;return"Unknown"===n||null==n?"Unknown":"0"===n?"0 or 10":"1/8"===n?"25":"1/4"===n?"50":"1/2"===n?"100":Parser._addCommas(Parser.XP_CHART[parseInt(n)-1])},Parser.crToXpNumber=function(e){if(null!=e&&e.xp)return e.xp;const n=e?e.cr||e:e;return"Unknown"===n||null==n?null:Parser.XP_CHART_ALT[n]},LEVEL_TO_XP_EASY=[0,25,50,75,125,250,300,350,450,550,600,800,1e3,1100,1250,1400,1600,2e3,2100,2400,2800],LEVEL_TO_XP_MEDIUM=[0,50,100,150,250,500,600,750,900,1100,1200,1600,2e3,2200,2500,2800,3200,3900,4100,4900,5700],LEVEL_TO_XP_HARD=[0,75,150,225,375,750,900,1100,1400,1600,1900,2400,3e3,3400,3800,4300,4800,5900,6300,7300,8500],LEVEL_TO_XP_DEADLY=[0,100,200,400,500,1100,1400,1700,2100,2400,2800,3600,4500,5100,5700,6400,7200,8800,9500,10900,12700],LEVEL_TO_XP_DAILY=[0,300,600,1200,1700,3500,4e3,5e3,6e3,7500,9e3,10500,11500,13500,15e3,18e3,2e4,25e3,27e3,3e4,4e4],Parser.LEVEL_XP_REQUIRED=[0,300,900,2700,6500,14e3,23e3,34e3,48e3,64e3,85e3,1e5,12e4,14e4,165e3,195e3,225e3,265e3,305e3,355e3],Parser.CRS=["0","1/8","1/4","1/2","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30"],Parser.levelToXpThreshold=function(e){return[LEVEL_TO_XP_EASY[e],LEVEL_TO_XP_MEDIUM[e],LEVEL_TO_XP_HARD[e],LEVEL_TO_XP_DEADLY[e]]},Parser.isValidCr=function(e){return Parser.CRS.includes(e)},Parser.crToNumber=function(e){if("Unknown"===e||"\u2014"===e||null==e)return 100;if(e.cr)return Parser.crToNumber(e.cr);const n=e.trim().split("/");return 1===n.length?+n[0]:2===n.length?+n[0]/+n[1]:0},Parser.numberToCr=function(e,n){return n&&"string"==typeof e&&Parser.CRS.includes(e)?e:null==e?"Unknown":Parser.numberToFractional(e)},Parser.crToPb=function(e){var n=Math.ceil;return"Unknown"===e||null==e?0:(e=e.cr||e,5>Parser.crToNumber(e)?2:n(e/4)+1)},Parser.levelToPb=function(e){return e?Math.ceil(e/4)+1:2},Parser.SKILL_TO_ATB_ABV={athletics:"str",acrobatics:"dex","sleight of hand":"dex",stealth:"dex",arcana:"int",history:"int",investigation:"int",nature:"int",religion:"int","animal handling":"wis",insight:"wis",medicine:"wis",perception:"wis",survival:"wis",deception:"cha",intimidation:"cha",performance:"cha",persuasion:"cha"},Parser.skillToAbilityAbv=function(e){return Parser._parse_aToB(Parser.SKILL_TO_ATB_ABV,e)},Parser.SKILL_TO_SHORT={athletics:"ath",acrobatics:"acro","sleight of hand":"soh",stealth:"slth",arcana:"arc",history:"hist",investigation:"invn",nature:"natr",religion:"reli","animal handling":"hndl",insight:"ins",medicine:"med",perception:"perp",survival:"surv",deception:"decp",intimidation:"intm",performance:"perf",persuasion:"pers"},Parser.skillToShort=function(e){return Parser._parse_aToB(Parser.SKILL_TO_SHORT,e)},Parser.LANGUAGES_STANDARD=["Common","Dwarvish","Elvish","Giant","Gnomish","Goblin","Halfling","Orc"],Parser.LANGUAGES_EXOTIC=["Abyssal","Celestial","Draconic","Deep","Infernal","Primordial","Sylvan","Undercommon"],Parser.LANGUAGES_SECRET=["Druidic","Thieves' cant"],Parser.LANGUAGES_ALL=[...Parser.LANGUAGES_STANDARD,...Parser.LANGUAGES_EXOTIC,...Parser.LANGUAGES_SECRET].sort(),Parser.dragonColorToFull=function(e){return Parser._parse_aToB(Parser.DRAGON_COLOR_TO_FULL,e)},Parser.DRAGON_COLOR_TO_FULL={B:"black",U:"blue",G:"green",R:"red",W:"white",A:"brass",Z:"bronze",C:"copper",O:"gold",S:"silver"},Parser.acToFull=function(e){if("string"==typeof e)return e;const n=Renderer.get();let _="",t=!1;for(let o=0;o<e.length;++o){const i=e[o],a=e[o+1];if(i.ac){const e=a&&a.braces;0===o&&i.braces&&(_+="(",t=!0),_+=i.ac,i.from&&(_+=i.braces?" (":t?"; ":" (",t=!0,_+=i.from.map(e=>n.render(e)).join(", "),i.braces?_+=")":!e&&(_+=")",t=!1)),i.condition&&(_+=` ${n.render(i.condition)}`),i.braces&&!e&&(_+=")",t=!1)}else _+=i;a&&(a.braces?_+=t?"; ":" (":_+=", ")}return t&&(_+=")"),_.trim()},MONSTER_COUNT_TO_XP_MULTIPLIER=[1,1.5,2,2,2,2,2.5,2.5,2.5,2.5,3,3,3,3,4],Parser.numMonstersToXpMult=function(e,n=3){const _=(()=>e>=MONSTER_COUNT_TO_XP_MULTIPLIER.length?4:MONSTER_COUNT_TO_XP_MULTIPLIER[e-1])();return 3>n?3<=_?_+1:_+.5:5<n?4===_?3:_-.5:_},Parser.armorFullToAbv=function(e){return Parser._parse_bToA(Parser.ARMOR_ABV_TO_FULL,e)},Parser._getSourceStringFromSource=function(e){return e&&e.source?e.source:e},Parser._buildSourceCache=function(e){const n={};return Object.entries(e).forEach(([e,_])=>n[e.toLowerCase()]=_),n},Parser._sourceFullCache=null,Parser.hasSourceFull=function(e){return Parser._sourceFullCache=Parser._sourceFullCache||Parser._buildSourceCache(Parser.SOURCE_JSON_TO_FULL),!!Parser._sourceFullCache[e.toLowerCase()]},Parser._sourceAbvCache=null,Parser.hasSourceAbv=function(e){return Parser._sourceAbvCache=Parser._sourceAbvCache||Parser._buildSourceCache(Parser.SOURCE_JSON_TO_ABV),!!Parser._sourceAbvCache[e.toLowerCase()]},Parser._sourceDateCache=null,Parser.hasSourceDate=function(e){return Parser._sourceDateCache=Parser._sourceDateCache||Parser._buildSourceCache(Parser.SOURCE_JSON_TO_DATE),!!Parser._sourceDateCache[e.toLowerCase()]},Parser.sourceJsonToFull=function(e){return e=Parser._getSourceStringFromSource(e),Parser.hasSourceFull(e)?Parser._sourceFullCache[e.toLowerCase()].replace(/'/g,"\u2019"):BrewUtil.hasSourceJson(e)?BrewUtil.sourceJsonToFull(e).replace(/'/g,"\u2019"):Parser._parse_aToB(Parser.SOURCE_JSON_TO_FULL,e).replace(/'/g,"\u2019")},Parser.sourceJsonToFullCompactPrefix=function(e){return Parser.sourceJsonToFull(e).replace(UA_PREFIX,UA_PREFIX_SHORT).replace(AL_PREFIX,AL_PREFIX_SHORT).replace(PS_PREFIX,PS_PREFIX_SHORT)},Parser.sourceJsonToAbv=function(e){return e=Parser._getSourceStringFromSource(e),Parser.hasSourceAbv(e)?Parser._sourceAbvCache[e.toLowerCase()]:BrewUtil.hasSourceJson(e)?BrewUtil.sourceJsonToAbv(e):Parser._parse_aToB(Parser.SOURCE_JSON_TO_ABV,e)},Parser.sourceJsonToDate=function(e){return e=Parser._getSourceStringFromSource(e),Parser.hasSourceDate(e)?Parser._sourceDateCache[e.toLowerCase()]:BrewUtil.hasSourceJson(e)?BrewUtil.sourceJsonToDate(e):Parser._parse_aToB(Parser.SOURCE_JSON_TO_DATE,e,null)},Parser.sourceJsonToColor=function(e){return`source${Parser.sourceJsonToAbv(e)}`},Parser.stringToSlug=function(e){return e.trim().toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")},Parser.stringToCasedSlug=function(e){return e.replace(/[^\w ]+/g,"").replace(/ +/g,"-")},Parser.itemTypeToFull=function(e){return Parser._parse_aToB(Parser.ITEM_TYPE_JSON_TO_ABV,e)},Parser.itemValueToFull=function(e,n){return Parser._moneyToFull(e,"value","valueMult",n)},Parser.spellComponentCostToFull=function(e,n){return Parser._moneyToFull(e,"cost","costMult",n)},Parser._moneyToFull=function(e,n,_,t){if(e[n]){const{coin:_,mult:t}=Parser.getCurrencyAndMultiplier(e[n],e.currencyConversion);return`${(e[n]*t).toLocaleString()} ${_}`}return e[_]?t?`×${e[_]}`:`base value ×${e[_]}`:""},Parser._DEFAULT_CURRENCY_CONVERSION_TABLE=[{coin:"cp",mult:1},{coin:"sp",mult:.1},{coin:"gp",mult:.01,isFallback:!0}],Parser.getCurrencyAndMultiplier=function(e,n){var _=Number.isInteger;const t=n?MiscUtil.get(BrewUtil.homebrewMeta,"currencyConversions",n):null,o=t&&t.length?t:Parser._DEFAULT_CURRENCY_CONVERSION_TABLE;if(o!==Parser._DEFAULT_CURRENCY_CONVERSION_TABLE&&o.sort((e,n)=>SortUtil.ascSort(n.mult,e.mult)),!e)return o.find(e=>e.isFallback)||o[0];if(1===o.length)return o[0];if(!_(e)&&e<o[0].mult)return o[0];for(let t=o.length-1;0<=t;--t)if(_(e*o[t].mult))return o[t];return o.last()},Parser.COIN_ABVS=["cp","sp","ep","gp","pp"],Parser.COIN_ABV_TO_FULL={cp:"copper pieces",sp:"silver pieces",ep:"electrum pieces",gp:"gold pieces",pp:"platinum pieces"},Parser.COIN_CONVERSIONS=[1,10,50,100,1e3],Parser.coinAbvToFull=function(e){return Parser._parse_aToB(Parser.COIN_ABV_TO_FULL,e)},Parser.itemWeightToFull=function(e,n){return e.weight?`${e.weight} lb.${e.weightNote?` ${e.weightNote}`:""}`:e.weightMult?n?`×${e.weightMult}`:`base weight ×${e.weightMult}`:""},Parser._decimalSeparator=.1.toLocaleString().substring(1,2),Parser._numberCleanRegexp="."===Parser._decimalSeparator?new RegExp(/[\s,]*/g,"g"):new RegExp(/[\s.]*/g,"g"),Parser._costSplitRegexp="."===Parser._decimalSeparator?new RegExp(/(\d+(\.\d+)?)([csegp]p)/):new RegExp(/(\d+(,\d+)?)([csegp]p)/),Parser.weightValueToNumber=function(e){if(!e)return 0;if(+e)return+e;throw new Error(`Badly formatted value ${e}`)},Parser.dmgTypeToFull=function(e){return Parser._parse_aToB(Parser.DMGTYPE_JSON_TO_FULL,e)},Parser.skillToExplanation=function(e){const n=MiscUtil.get(BrewUtil.homebrewMeta,"skills",e);return n?n:Parser._parse_aToB(Parser.SKILL_JSON_TO_FULL,e)},Parser.senseToExplanation=function(e){e=e.toLowerCase();const n=MiscUtil.get(BrewUtil.homebrewMeta,"senses",e);return n?n:Parser._parse_aToB(Parser.SENSE_JSON_TO_FULL,e,["No explanation available."])},Parser.skillProficienciesToFull=function(e){return e.map(function(e){const n=Object.keys(e).sort(SortUtil.ascSortLower),_=n.indexOf("choose");~_&&n.splice(_,1);const t=[];n.filter(n=>e[n]).forEach(e=>t.push(Renderer.get().render(`{@skill ${e.toTitleCase()}}`)));const o=[];if(~_){const n=e.choose;18===n.from.length?o.push(`choose any ${n.count&&1!==n.count?n.count:"skill"}`):o.push(`choose ${n.count||1} from ${n.from.map(e=>Renderer.get().render(`{@skill ${e.toTitleCase()}}`)).joinConjunct(", "," and ")}`)}const i=t.joinConjunct(", "," and "),a=o.join("");if(t.length&&o.length)return`${i}; and ${a}`;return t.length?i:o.length?a:void 0}).join(" <i>or</i> ")},Parser.spSchoolAndSubschoolsAbvsToFull=function(e,n){return n&&n.length?`${Parser.spSchoolAbvToFull(e)} (${n.map(e=>Parser.spSchoolAbvToFull(e)).join(", ")})`:Parser.spSchoolAbvToFull(e)},Parser.spSchoolAbvToFull=function(e){const n=Parser._parse_aToB(Parser.SP_SCHOOL_ABV_TO_FULL,e);return Parser.SP_SCHOOL_ABV_TO_FULL[e]?n:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.spellSchools&&BrewUtil.homebrewMeta.spellSchools[e]?BrewUtil.homebrewMeta.spellSchools[e].full:n},Parser.spSchoolAndSubschoolsAbvsShort=function(e,n){return n&&n.length?`${Parser.spSchoolAbvToShort(e)} (${n.map(e=>Parser.spSchoolAbvToShort(e)).join(", ")})`:Parser.spSchoolAbvToShort(e)},Parser.spSchoolAbvToShort=function(e){const n=Parser._parse_aToB(Parser.SP_SCHOOL_ABV_TO_SHORT,e);return Parser.SP_SCHOOL_ABV_TO_SHORT[e]?n:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.spellSchools&&BrewUtil.homebrewMeta.spellSchools[e]?BrewUtil.homebrewMeta.spellSchools[e].short:n},Parser.spSchoolAbvToStyle=function(e){const n=MiscUtil.get(BrewUtil,"homebrewMeta","spellSchools",e,"color");if(!n||!n.trim())return"";const _=BrewUtil.getValidColor(n);return _.length?`style="color: #${_}"`:""},Parser.getOrdinalForm=function(e){if(e=+e,isNaN(e))return"";const n=e%10,_=e%100;return 1==n&&11!==_?`${e}st`:2==n&&12!==_?`${e}nd`:3==n&&13!==_?`${e}rd`:`${e}th`},Parser.spLevelToFull=function(e){return 0===e?"Cantrip":Parser.getOrdinalForm(e)},Parser.getArticle=function(e){return /^[aeiou]/.test(e)?"an":"a"},Parser.spLevelToFullLevelText=function(e,n){return`${Parser.spLevelToFull(e)}${0===e?"s":`${n?"-":" "}level`}`},Parser.spMetaToArr=function(e){return e?Object.entries(e).filter(([e,n])=>n).sort(SortUtil.ascSort).map(([e])=>e):[]},Parser.spMetaToFull=function(e){if(!e)return"";const n=Parser.spMetaToArr(e);return n.length?` (${n.join(", ")})`:""},Parser.spLevelSchoolMetaToFull=function(e,n,_,t){const o=0===e?Parser.spLevelToFull(e).toLowerCase():`${Parser.spLevelToFull(e)}-level`,i=0===e?`${Parser.spSchoolAbvToFull(n)} ${o}`:`${o} ${Parser.spSchoolAbvToFull(n).toLowerCase()}`,a=Parser.spMetaToArr(_);if(a.length||t&&t.length){const e=[(t||[]).map(e=>Parser.spSchoolAbvToFull(e)).join(", "),a.join(", ")].filter(Boolean).join("; ").toLowerCase();return`${i} (${e})`}return i},Parser.spTimeListToFull=function(e,n){return e.map(e=>`${Parser.getTimeToFull(e)}${e.condition?`, ${n?Renderer.stripTags(e.condition):Renderer.get().render(e.condition)}`:""}`).join(" or ")},Parser.getTimeToFull=function(e){return`${e.number} ${"bonus"===e.unit?"bonus action":e.unit}${1<e.number?"s":""}`},RNG_SPECIAL="special",RNG_POINT="point",RNG_LINE="line",RNG_CUBE="cube",RNG_CONE="cone",RNG_RADIUS="radius",RNG_SPHERE="sphere",RNG_HEMISPHERE="hemisphere",RNG_CYLINDER="cylinder",RNG_SELF="self",RNG_SIGHT="sight",RNG_UNLIMITED="unlimited",RNG_UNLIMITED_SAME_PLANE="plane",RNG_TOUCH="touch",Parser.SP_RANGE_TYPE_TO_FULL={[RNG_SPECIAL]:"Special",[RNG_POINT]:"Point",[RNG_LINE]:"Line",[RNG_CUBE]:"Cube",[RNG_CONE]:"Cone",[RNG_RADIUS]:"Radius",[RNG_SPHERE]:"Sphere",[RNG_HEMISPHERE]:"Hemisphere",[RNG_CYLINDER]:"Cylinder",[RNG_SELF]:"Self",[RNG_SIGHT]:"Sight",[RNG_UNLIMITED]:"Unlimited",[RNG_UNLIMITED_SAME_PLANE]:"Unlimited on the same plane",[RNG_TOUCH]:"Touch"},Parser.spRangeTypeToFull=function(e){return Parser._parse_aToB(Parser.SP_RANGE_TYPE_TO_FULL,e)},UNT_FEET="feet",UNT_MILES="miles",Parser.SP_DIST_TYPE_TO_FULL={[UNT_FEET]:"Feet",[UNT_MILES]:"Miles",[RNG_SELF]:Parser.SP_RANGE_TYPE_TO_FULL[RNG_SELF],[RNG_TOUCH]:Parser.SP_RANGE_TYPE_TO_FULL[RNG_TOUCH],[RNG_SIGHT]:Parser.SP_RANGE_TYPE_TO_FULL[RNG_SIGHT],[RNG_UNLIMITED]:Parser.SP_RANGE_TYPE_TO_FULL[RNG_UNLIMITED],[RNG_UNLIMITED_SAME_PLANE]:Parser.SP_RANGE_TYPE_TO_FULL[RNG_UNLIMITED_SAME_PLANE]},Parser.spDistanceTypeToFull=function(e){return Parser._parse_aToB(Parser.SP_DIST_TYPE_TO_FULL,e)},Parser.SP_RANGE_TO_ICON={[RNG_SPECIAL]:"fa-star",[RNG_POINT]:"",[RNG_LINE]:"fa-grip-lines-vertical",[RNG_CUBE]:"fa-cube",[RNG_CONE]:"fa-traffic-cone",[RNG_RADIUS]:"fa-hockey-puck",[RNG_SPHERE]:"fa-globe",[RNG_HEMISPHERE]:"fa-globe",[RNG_CYLINDER]:"fa-database",[RNG_SELF]:"fa-street-view",[RNG_SIGHT]:"fa-eye",[RNG_UNLIMITED_SAME_PLANE]:"fa-globe-americas",[RNG_UNLIMITED]:"fa-infinity",[RNG_TOUCH]:"fa-hand-paper"},Parser.spRangeTypeToIcon=function(e){return Parser._parse_aToB(Parser.SP_RANGE_TO_ICON,e)},Parser.spRangeToShortHtml=function(e){switch(e.type){case RNG_SPECIAL:return`<span class="fas ${Parser.spRangeTypeToIcon(e.type)} help--subtle" title="Special"/>`;case RNG_POINT:return Parser.spRangeToShortHtml._renderPoint(e);case RNG_LINE:case RNG_CUBE:case RNG_CONE:case RNG_RADIUS:case RNG_SPHERE:case RNG_HEMISPHERE:case RNG_CYLINDER:return Parser.spRangeToShortHtml._renderArea(e);}},Parser.spRangeToShortHtml._renderPoint=function(e){const n=e.distance;switch(n.type){case RNG_SELF:case RNG_SIGHT:case RNG_UNLIMITED:case RNG_UNLIMITED_SAME_PLANE:case RNG_SPECIAL:case RNG_TOUCH:return`<span class="fas ${Parser.spRangeTypeToIcon(n.type)} help--subtle" title="${Parser.spRangeTypeToFull(n.type)}"/>`;case UNT_FEET:case UNT_MILES:default:return`${n.amount} <span class="small">${Parser.getSingletonUnit(n.type,!0)}</span>`;}},Parser.spRangeToShortHtml._renderArea=function(e){const n=e.distance;return`<span class="fas ${Parser.spRangeTypeToIcon(RNG_SELF)} help--subtle" title="Self"/> ${n.amount}<span class="small">-${Parser.getSingletonUnit(n.type,!0)}</span> ${Parser.spRangeToShortHtml._getAreaStyleString(e)}`},Parser.spRangeToShortHtml._getAreaStyleString=function(e){return`<span class="fas ${Parser.spRangeTypeToIcon(e.type)} help--subtle" title="${Parser.spRangeTypeToFull(e.type)}"/>`},Parser.spRangeToFull=function(e){switch(e.type){case RNG_SPECIAL:return Parser.spRangeTypeToFull(e.type);case RNG_POINT:return Parser.spRangeToFull._renderPoint(e);case RNG_LINE:case RNG_CUBE:case RNG_CONE:case RNG_RADIUS:case RNG_SPHERE:case RNG_HEMISPHERE:case RNG_CYLINDER:return Parser.spRangeToFull._renderArea(e);}},Parser.spRangeToFull._renderPoint=function(e){const n=e.distance;switch(n.type){case RNG_SELF:case RNG_SIGHT:case RNG_UNLIMITED:case RNG_UNLIMITED_SAME_PLANE:case RNG_SPECIAL:case RNG_TOUCH:return Parser.spRangeTypeToFull(n.type);case UNT_FEET:case UNT_MILES:default:return`${n.amount} ${1===n.amount?Parser.getSingletonUnit(n.type):n.type}`;}},Parser.spRangeToFull._renderArea=function(e){const n=e.distance;return`Self (${n.amount}-${Parser.getSingletonUnit(n.type)}${Parser.spRangeToFull._getAreaStyleString(e)}${e.type===RNG_CYLINDER?`${null!=n.amountSecondary&&null!=n.typeSecondary?`, ${n.amountSecondary}-${Parser.getSingletonUnit(n.typeSecondary)}-high`:""} cylinder`:""})`},Parser.spRangeToFull._getAreaStyleString=function(e){switch(e.type){case RNG_SPHERE:return" radius";case RNG_HEMISPHERE:return`-radius ${e.type}`;case RNG_CYLINDER:return"-radius";default:return` ${e.type}`;}},Parser.getSingletonUnit=function(e,n){switch(e){case UNT_FEET:return n?"ft.":"foot";case UNT_MILES:return n?"mi.":"mile";default:{const n=MiscUtil.get(BrewUtil.homebrewMeta,"spellDistanceUnits",e,"singular");return n?n:"s"===e.charAt(e.length-1)?e.slice(0,-1):e}}},Parser.RANGE_TYPES=[{type:RNG_POINT,hasDistance:!0,isRequireAmount:!1},{type:RNG_LINE,hasDistance:!0,isRequireAmount:!0},{type:RNG_CUBE,hasDistance:!0,isRequireAmount:!0},{type:RNG_CONE,hasDistance:!0,isRequireAmount:!0},{type:RNG_RADIUS,hasDistance:!0,isRequireAmount:!0},{type:RNG_SPHERE,hasDistance:!0,isRequireAmount:!0},{type:RNG_HEMISPHERE,hasDistance:!0,isRequireAmount:!0},{type:RNG_CYLINDER,hasDistance:!0,isRequireAmount:!0},{type:RNG_SPECIAL,hasDistance:!1,isRequireAmount:!1}],Parser.DIST_TYPES=[{type:RNG_SELF,hasAmount:!1},{type:RNG_TOUCH,hasAmount:!1},{type:UNT_FEET,hasAmount:!0},{type:UNT_MILES,hasAmount:!0},{type:RNG_SIGHT,hasAmount:!1},{type:RNG_UNLIMITED_SAME_PLANE,hasAmount:!1},{type:RNG_UNLIMITED,hasAmount:!1}],Parser.spComponentsToFull=function(e,n){if(!e)return"None";const _=[];return e.v&&_.push("V"),e.s&&_.push("S"),null!=e.m&&_.push(`M${!0===e.m?"":` (${null==e.m.text?e.m:e.m.text})`}`),e.r&&_.push(`R (${n} gp)`),_.join(", ")||"None"},Parser.SP_END_TYPE_TO_FULL={dispel:"dispelled",trigger:"triggered",discharge:"discharged"},Parser.spEndTypeToFull=function(e){return Parser._parse_aToB(Parser.SP_END_TYPE_TO_FULL,e)},Parser.spDurationToFull=function(e){let n=!1;const _=e.map(e=>{switch(e.type){case"special":return"Special";case"instant":return`Instantaneous${e.condition?` (${e.condition})`:""}`;case"timed":return`${e.concentration?"Concentration, ":""}${e.concentration?"u":e.duration.upTo?"U":""}${e.concentration||e.duration.upTo?"p to ":""}${e.duration.amount} ${1===e.duration.amount?e.duration.type:`${e.duration.type}s`}`;case"permanent":{if(e.ends){const _=e.ends.map(e=>Parser.spEndTypeToFull(e));return n=n||1<_.length,`Until ${_.joinConjunct(", "," or ")}`}return"Permanent"}}});return`${_.joinConjunct(n?"; ":", "," or ")}${1<e.length?" (see below)":""}`},Parser.DURATION_TYPES=[{type:"instant",full:"Instantaneous"},{type:"timed",hasAmount:!0},{type:"permanent",hasEnds:!0},{type:"special"}],Parser.DURATION_AMOUNT_TYPES=["turn","round","minute","hour","day","week","year"],Parser.spClassesToFull=function(e,n,_={}){const t=Parser.spSubclassesToFull(e,n,_);return`${Parser.spMainClassesToFull(e,n)}${t?`, ${t}`:""}`},Parser.spMainClassesToFull=function(e,n=!1,_="fromClassList"){return e?(e[_]||[]).filter(e=>!ExcludeUtil.isInitialised||!ExcludeUtil.isExcluded(e.name,"class",e.source)).sort((e,n)=>SortUtil.ascSort(e.name,n.name)).map(e=>n?e.name:`<a title="Source: ${Parser.sourceJsonToFull(e.source)}" href="${UrlUtil.PG_CLASSES}#${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e)}">${e.name}</a>`).join(", "):""},Parser.spSubclassesToFull=function(e,n,_={}){return e&&e.fromSubclass?e.fromSubclass.filter(e=>{if(!ExcludeUtil.isInitialised)return!0;const n=ExcludeUtil.isExcluded(e.class.name,"class",e.class.source);if(n)return!1;const t=MiscUtil.get(_,e.class.source,e.class.name,e.subclass.source,e.subclass.name);if(!t)return!0;const o=ExcludeUtil.isExcluded(t.name||e.subclass.name,"subclass",e.subclass.source);return!o}).sort((e,n)=>{const _=SortUtil.ascSort(e.class.name,n.class.name);return _||SortUtil.ascSort(e.subclass.name,n.subclass.name)}).map(e=>Parser._spSubclassItem(e,n,_)).join(", "):""},Parser._spSubclassItem=function(e,n,_){const t=e.class,o=e.subclass,i=`${o.name}${o.subSubclass?` (${o.subSubclass})`:""}`;if(n)return i;const a=`<a href="${UrlUtil.PG_CLASSES}#${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](t)}" title="Source: ${Parser.sourceJsonToFull(t.source)}">${t.name}</a>`,r=_?MiscUtil.get(_,t.source,t.name,o.source,o.name):null;return r?`<a class="italic" href="${UrlUtil.PG_CLASSES}#${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](t)}${HASH_PART_SEP}${UrlUtil.getClassesPageStatePart({subclass:{shortName:o.name,source:o.source}})}" title="Source: ${Parser.sourceJsonToFull(e.subclass.source)}">${i}</a> ${a}`:`<span class="italic" title="Source: ${Parser.sourceJsonToFull(e.subclass.source)}">${i}</span> ${a}`},Parser.SPELL_ATTACK_TYPE_TO_FULL={},Parser.SPELL_ATTACK_TYPE_TO_FULL.M="Melee",Parser.SPELL_ATTACK_TYPE_TO_FULL.R="Ranged",Parser.SPELL_ATTACK_TYPE_TO_FULL.O="Other/Unknown",Parser.spAttackTypeToFull=function(e){return Parser._parse_aToB(Parser.SPELL_ATTACK_TYPE_TO_FULL,e)},Parser.SPELL_AREA_TYPE_TO_FULL={ST:"Single Target",MT:"Multiple Targets",C:"Cube",N:"Cone",Y:"Cylinder",S:"Sphere",R:"Circle",Q:"Square",L:"Line",H:"Hemisphere",W:"Wall"},Parser.spAreaTypeToFull=function(e){return Parser._parse_aToB(Parser.SPELL_AREA_TYPE_TO_FULL,e)},Parser.SP_MISC_TAG_TO_FULL={HL:"Healing",SGT:"Requires Sight",PRM:"Permanent Effects",SCL:"Scaling Effects",SMN:"Summons Creature"},Parser.spMiscTagToFull=function(e){return Parser._parse_aToB(Parser.SP_MISC_TAG_TO_FULL,e)},Parser.SP_CASTER_PROGRESSION_TO_FULL={full:"Full","1/2":"Half","1/3":"One-Third",pact:"Pact Magic"},Parser.spCasterProgressionToFull=function(e){return Parser._parse_aToB(Parser.SP_CASTER_PROGRESSION_TO_FULL,e)},Parser.monTypeToFullObj=function(e){const n={type:"",tags:[],asText:""};if("string"==typeof e)return n.type=e,n.asText=e,n;const _=[];if(e.tags)for(const t of e.tags)"string"==typeof t?(n.tags.push(t),_.push(t)):(n.tags.push(t.tag),_.push(`${t.prefix} ${t.tag}`));return n.type=e.type,e.swarmSize?(n.tags.push("swarm"),n.asText=`swarm of ${Parser.sizeAbvToFull(e.swarmSize).toLowerCase()} ${Parser.monTypeToPlural(e.type)}`):n.asText=`${e.type}`,_.length&&(n.asText+=` (${_.join(", ")})`),n},Parser.monTypeToPlural=function(e){return Parser._parse_aToB(Parser.MON_TYPE_TO_PLURAL,e)},Parser.monTypeFromPlural=function(e){return Parser._parse_bToA(Parser.MON_TYPE_TO_PLURAL,e)},Parser.monCrToFull=function(e,n){if(null==e)return"";if("string"==typeof e)return`${e} (${null==n?Parser.crToXp(e):Parser._addCommas(n)} XP)`;else{const n=[Parser.monCrToFull(e.cr,e.xp)];return e.lair&&n.push(`${Parser.monCrToFull(e.lair)} when encountered in lair`),e.coven&&n.push(`${Parser.monCrToFull(e.coven)} when part of a coven`),n.join(" or ")}},Parser.monImmResToFull=function(e){var _=Math.max;function n(e,t=0){if(o=_(o,t),"string"==typeof e)return e;if(e.special)return e.special;else{let _=e.preNote?`${e.preNote} `:"";const i=e.immune?"immune":e.resist?"resist":e.vulnerable?"vulnerable":null;if(i){const a=e[i].map(e=>n(e,t+1));_+=t?a.join(o?"; ":", "):a.joinConjunct(", "," and ")}return e.note&&(_+=` ${e.note}`),_}}const t=e.length;let o=0;return 1===t&&(e[0].immune||e[0].resist)?e.map(e=>n(e,-1)).join(o?"; ":", "):function(e){if(1>=e.length)return e.join("");let n="";for(let _=0;_<e.length-1;++_){const t=e[_],o=e[_+1];n+=t,n+=t.includes(",")||o.includes(",")?"; ":", "}return n+=e.last(),n}(e.map(e=>n(e)))},Parser.monCondImmToFull=function(e,n){function _(e){return n?e:Renderer.get().render(`{@condition ${e}}`)}return e.map(e=>e.special?e.special:e.conditionImmune?`${e.preNote?`${e.preNote} `:""}${e.conditionImmune.map(_).join(", ")}${e.note?` ${e.note}`:""}`:_(e)).join(", ")},Parser.MON_SENSE_TAG_TO_FULL={B:"blindsight",D:"darkvision",SD:"superior darkvision",T:"tremorsense",U:"truesight"},Parser.monSenseTagToFull=function(e){return Parser._parse_aToB(Parser.MON_SENSE_TAG_TO_FULL,e)},Parser.MON_SPELLCASTING_TAG_TO_FULL={P:"Psionics",I:"Innate",F:"Form Only",S:"Shared",CB:"Class, Bard",CC:"Class, Cleric",CD:"Class, Druid",CP:"Class, Paladin",CR:"Class, Ranger",CS:"Class, Sorcerer",CL:"Class, Warlock",CW:"Class, Wizard"},Parser.monSpellcastingTagToFull=function(e){return Parser._parse_aToB(Parser.MON_SPELLCASTING_TAG_TO_FULL,e)},Parser.MON_MISC_TAG_TO_FULL={AOE:"Has Areas of Effect",MW:"Has Melee Weapon Attacks",RW:"Has Ranged Weapon Attacks",RNG:"Has Ranged Weapons",RCH:"Has Reach Attacks",THW:"Has Thrown Weapons"},Parser.monMiscTagToFull=function(e){return Parser._parse_aToB(Parser.MON_MISC_TAG_TO_FULL,e)},Parser.ENVIRONMENTS=["arctic","coastal","desert","forest","grassland","hill","mountain","swamp","underdark","underwater","urban"],Parser.PSI_ABV_TYPE_TALENT="T",Parser.PSI_ABV_TYPE_DISCIPLINE="D",Parser.PSI_ORDER_NONE="None",Parser.psiTypeToFull=e=>Parser.psiTypeToMeta(e).full,Parser.psiTypeToMeta=e=>{let n={};return e===Parser.PSI_ABV_TYPE_TALENT?n={hasOrder:!1,full:"Talent"}:e===Parser.PSI_ABV_TYPE_DISCIPLINE?n={hasOrder:!0,full:"Discipline"}:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.psionicTypes&&BrewUtil.homebrewMeta.psionicTypes[e]&&(n=BrewUtil.homebrewMeta.psionicTypes[e]),n.full=n.full||"Unknown",n.short=n.short||n.full,n},Parser.psiOrderToFull=e=>void 0===e?Parser.PSI_ORDER_NONE:e,Parser.prereqSpellToFull=function(e){if(e){const[n,_]=e.split("#");if(!_)return Renderer.get().render(`{@spell ${e}}`);if("c"===_)return Renderer.get().render(`{@spell ${n}} cantrip`);if("x"===_)return Renderer.get().render("{@spell hex} spell or a warlock feature that curses")}else return STR_NONE},Parser.prereqPactToFull=function(e){return"Chain"===e?"Pact of the Chain":"Tome"===e?"Pact of the Tome":"Blade"===e?"Pact of the Blade":"Talisman"===e?"Pact of the Talisman":e},Parser.prereqPatronToShort=function(e){if("Any"===e)return e;const n=/^The (.*?)$/.exec(e);return n?n[1]:e},Parser.OPT_FEATURE_TYPE_TO_FULL={AI:"Artificer Infusion",ED:"Elemental Discipline",EI:"Eldritch Invocation",MM:"Metamagic",MV:"Maneuver","MV:B":"Maneuver, Battle Master","MV:C2-UA":"Maneuver, Cavalier V2 (UA)","AS:V1-UA":"Arcane Shot, V1 (UA)","AS:V2-UA":"Arcane Shot, V2 (UA)",AS:"Arcane Shot",OTH:"Other","FS:F":"Fighting Style; Fighter","FS:B":"Fighting Style; Bard","FS:P":"Fighting Style; Paladin","FS:R":"Fighting Style; Ranger",PB:"Pact Boon","SHP:H":"Ship Upgrade, Hull","SHP:M":"Ship Upgrade, Movement","SHP:W":"Ship Upgrade, Weapon","SHP:F":"Ship Upgrade, Figurehead","SHP:O":"Ship Upgrade, Miscellaneous","IWM:W":"Infernal War Machine Variant, Weapon","IWM:A":"Infernal War Machine Upgrade, Armor","IWM:G":"Infernal War Machine Upgrade, Gadget",OR:"Onomancy Resonant",RN:"Rune Knight Rune",AF:"Alchemical Formula"},Parser.optFeatureTypeToFull=function(e){return Parser.OPT_FEATURE_TYPE_TO_FULL[e]?Parser.OPT_FEATURE_TYPE_TO_FULL[e]:BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.optionalFeatureTypes&&BrewUtil.homebrewMeta.optionalFeatureTypes[e]?BrewUtil.homebrewMeta.optionalFeatureTypes[e]:e},Parser.alignmentAbvToFull=function(e){return e?"object"==typeof e?null==e.special?`${e.alignment.map(e=>Parser.alignmentAbvToFull(e)).join(" ")}${e.chance?` (${e.chance}%)`:""}`:e.special:(e=e.toUpperCase(),"L"===e?"Lawful":"N"===e?"Neutral":"NX"===e?"Neutral (Law/Chaos axis)":"NY"===e?"Neutral (Good/Evil axis)":"C"===e?"Chaotic":"G"===e?"Good":"E"===e?"Evil":"U"===e?"Unaligned":"A"===e?"Any alignment":e):null},Parser.alignmentListToFull=function(e){if(e.some(e=>"string"!=typeof e)){if(e.some(e=>"string"==typeof e))throw new Error(`Mixed alignment types: ${JSON.stringify(e)}`);return e=e.filter(e=>void 0===e.alignment||null!=e.alignment),e.map(e=>null!=e.special||null!=e.chance?Parser.alignmentAbvToFull(e):Parser.alignmentListToFull(e.alignment)).join(" or ")}if(1===e.length)return Parser.alignmentAbvToFull(e[0]);if(2===e.length)return e.map(e=>Parser.alignmentAbvToFull(e)).join(" ");if(3===e.length&&e.includes("NX")&&e.includes("NY")&&e.includes("N"))return"Any Neutral Alignment";if(5===e.length){if(!e.includes("G"))return"Any Non-Good Alignment";if(!e.includes("E"))return"Any Non-Evil Alignment";if(!e.includes("L"))return"Any Non-Lawful Alignment";if(!e.includes("C"))return"Any Non-Chaotic Alignment"}if(4===e.length){if(!e.includes("L")&&!e.includes("NX"))return"Any Chaotic Alignment";if(!e.includes("G")&&!e.includes("NY"))return"Any Evil Alignment";if(!e.includes("C")&&!e.includes("NX"))return"Any Lawful Alignment";if(!e.includes("E")&&!e.includes("NY"))return"Any Good Alignment"}throw new Error(`Unmapped alignment: ${JSON.stringify(e)}`)},Parser.weightToFull=function(e,n){var _=Math.floor;const t=_(e/2e3);return e-=2e3*t,[t?`${t}${n?`<span class="small ml-1">`:" "}ton${1===t?"":"s"}${n?`</span>`:""}`:null,e?`${e}${n?`<span class="small ml-1">`:" "}lb.${n?`</span>`:""}`:null].filter(Boolean).join(", ")},Parser.ITEM_RARITIES=["None","Common","Uncommon","Rare","Very Rare","Legendary","Artifact","Unknown","Unknown (Magic)","Other"],Parser.CAT_ID_CREATURE=1,Parser.CAT_ID_SPELL=2,Parser.CAT_ID_BACKGROUND=3,Parser.CAT_ID_ITEM=4,Parser.CAT_ID_CLASS=5,Parser.CAT_ID_CONDITION=6,Parser.CAT_ID_FEAT=7,Parser.CAT_ID_ELDRITCH_INVOCATION=8,Parser.CAT_ID_PSIONIC=9,Parser.CAT_ID_RACE=10,Parser.CAT_ID_OTHER_REWARD=11,Parser.CAT_ID_VARIANT_OPTIONAL_RULE=12,Parser.CAT_ID_ADVENTURE=13,Parser.CAT_ID_DEITY=14,Parser.CAT_ID_OBJECT=15,Parser.CAT_ID_TRAP=16,Parser.CAT_ID_HAZARD=17,Parser.CAT_ID_QUICKREF=18,Parser.CAT_ID_CULT=19,Parser.CAT_ID_BOON=20,Parser.CAT_ID_DISEASE=21,Parser.CAT_ID_METAMAGIC=22,Parser.CAT_ID_MANEUVER_BATTLEMASTER=23,Parser.CAT_ID_TABLE=24,Parser.CAT_ID_TABLE_GROUP=25,Parser.CAT_ID_MANEUVER_CAVALIER=26,Parser.CAT_ID_ARCANE_SHOT=27,Parser.CAT_ID_OPTIONAL_FEATURE_OTHER=28,Parser.CAT_ID_FIGHTING_STYLE=29,Parser.CAT_ID_CLASS_FEATURE=30,Parser.CAT_ID_VEHICLE=31,Parser.CAT_ID_PACT_BOON=32,Parser.CAT_ID_ELEMENTAL_DISCIPLINE=33,Parser.CAT_ID_ARTIFICER_INFUSION=34,Parser.CAT_ID_SHIP_UPGRADE=35,Parser.CAT_ID_INFERNAL_WAR_MACHINE_UPGRADE=36,Parser.CAT_ID_ONOMANCY_RESONANT=37,Parser.CAT_ID_RUNE_KNIGHT_RUNE=37,Parser.CAT_ID_ALCHEMICAL_FORMULA=38,Parser.CAT_ID_MANEUVER=39,Parser.CAT_ID_SUBCLASS=40,Parser.CAT_ID_SUBCLASS_FEATURE=41,Parser.CAT_ID_ACTION=42,Parser.CAT_ID_LANGUAGE=43,Parser.CAT_ID_TO_FULL={},Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CREATURE]="Bestiary",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SPELL]="Spell",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_BACKGROUND]="Background",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ITEM]="Item",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CLASS]="Class",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CONDITION]="Condition",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_FEAT]="Feat",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ELDRITCH_INVOCATION]="Eldritch Invocation",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_PSIONIC]="Psionic",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_RACE]="Race",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_OTHER_REWARD]="Other Reward",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_VARIANT_OPTIONAL_RULE]="Variant/Optional Rule",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ADVENTURE]="Adventure",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_DEITY]="Deity",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_OBJECT]="Object",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_TRAP]="Trap",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_HAZARD]="Hazard",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_QUICKREF]="Quick Reference",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CULT]="Cult",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_BOON]="Boon",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_DISEASE]="Disease",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_METAMAGIC]="Metamagic",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_MANEUVER_BATTLEMASTER]="Maneuver; Battlemaster",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_TABLE]="Table",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_TABLE_GROUP]="Table",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_MANEUVER_CAVALIER]="Maneuver; Cavalier",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ARCANE_SHOT]="Arcane Shot",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_OPTIONAL_FEATURE_OTHER]="Optional Feature",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_FIGHTING_STYLE]="Fighting Style",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_CLASS_FEATURE]="Class Feature",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_VEHICLE]="Vehicle",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_PACT_BOON]="Pact Boon",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ELEMENTAL_DISCIPLINE]="Elemental Discipline",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ARTIFICER_INFUSION]="Infusion",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SHIP_UPGRADE]="Ship Upgrade",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_INFERNAL_WAR_MACHINE_UPGRADE]="Infernal War Machine Upgrade",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ONOMANCY_RESONANT]="Onomancy Resonant",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_RUNE_KNIGHT_RUNE]="Rune Knight Rune",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ALCHEMICAL_FORMULA]="Alchemical Formula",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_MANEUVER]="Maneuver",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SUBCLASS]="Subclass",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_SUBCLASS_FEATURE]="Subclass Feature",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_ACTION]="Action",Parser.CAT_ID_TO_FULL[Parser.CAT_ID_LANGUAGE]="Language",Parser.pageCategoryToFull=function(e){return Parser._parse_aToB(Parser.CAT_ID_TO_FULL,e)},Parser.CAT_ID_TO_PROP={},Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CREATURE]="monster",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_SPELL]="spell",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_BACKGROUND]="background",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ITEM]="item",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CLASS]="class",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CONDITION]="condition",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_FEAT]="feat",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_PSIONIC]="psionic",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_RACE]="race",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_OTHER_REWARD]="reward",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_VARIANT_OPTIONAL_RULE]="variantrule",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ADVENTURE]="adventure",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_DEITY]="deity",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_OBJECT]="object",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_TRAP]="trap",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_HAZARD]="hazard",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CULT]="cult",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_BOON]="boon",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_DISEASE]="condition",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_TABLE]="table",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_TABLE_GROUP]="tableGroup",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_VEHICLE]="vehicle",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ELDRITCH_INVOCATION]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_MANEUVER_CAVALIER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ARCANE_SHOT]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_OPTIONAL_FEATURE_OTHER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_FIGHTING_STYLE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_METAMAGIC]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_MANEUVER_BATTLEMASTER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_PACT_BOON]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ELEMENTAL_DISCIPLINE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ARTIFICER_INFUSION]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_SHIP_UPGRADE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_INFERNAL_WAR_MACHINE_UPGRADE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ONOMANCY_RESONANT]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_RUNE_KNIGHT_RUNE]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ALCHEMICAL_FORMULA]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_MANEUVER]="optionalfeature",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_QUICKREF]=null,Parser.CAT_ID_TO_PROP[Parser.CAT_ID_CLASS_FEATURE]="class",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_SUBCLASS]="subclass",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_SUBCLASS_FEATURE]="subclass",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_ACTION]="action",Parser.CAT_ID_TO_PROP[Parser.CAT_ID_LANGUAGE]="language",Parser.pageCategoryToProp=function(e){return Parser._parse_aToB(Parser.CAT_ID_TO_PROP,e)},Parser.ABIL_ABVS=["str","dex","con","int","wis","cha"],Parser.spClassesToCurrentAndLegacy=function(e){const n=[],_=[];return e.fromClassList.forEach(e=>{"Artificer"===e.name&&"UAArtificer"===e.source||"Artificer (Revisited)"===e.name&&"UAArtificerRevisited"===e.source?_.push(e):n.push(e)}),[n,_]},Parser.spSubclassesToCurrentAndLegacyFull=function(e,n){function _(e){return"Favored Soul"===e?"Divine Soul":"Undying Light"===e?"Celestial":"Deep Stalker"===e?"Gloom Stalker":e}const t=[[],[]];if(!e.fromSubclass)return t;const o=new Set,i=[];return e.fromSubclass.filter(e=>{const _=ExcludeUtil.isExcluded(e.class.name,"class",e.class.source);if(_)return!1;const t=MiscUtil.get(n,e.class.source,e.class.name,e.subclass.source,e.subclass.name),o=ExcludeUtil.isExcluded((t||{}).name||e.subclass.name,"subclass",e.subclass.source);return!o}).sort((e,n)=>{const _=SortUtil.ascSort(e.subclass.name,n.subclass.name);return _||SortUtil.ascSort(e.class.name,n.class.name)}).forEach(e=>{const a=e.subclass.name,r=e.subclass.source,s=Parser._spSubclassItem(e,!1,n),d=MiscUtil.get(n,e.class.source,e.class.name,e.subclass.source,e.subclass.name);if(d&&d.isReprinted)t[1].push(s);else if(Parser.sourceJsonToFull(r).startsWith(UA_PREFIX)||Parser.sourceJsonToFull(r).startsWith(PS_PREFIX)){const e=_(a.split("(")[0].trim().split(/v\d+/)[0].trim());i.push({name:e,ele:s})}else t[0].push(s),o.add(a)}),i.forEach(e=>{o.has(e.name)?t[1].push(e.ele):t[0].push(e.ele)}),[t[0].join(", "),t[1].join(", ")]},Parser.attackTypeToFull=function(e){return Parser._parse_aToB(Parser.ATK_TYPE_TO_FULL,e)},Parser.trapHazTypeToFull=function(e){return Parser._parse_aToB(Parser.TRAP_HAZARD_TYPE_TO_FULL,e)},Parser.TRAP_HAZARD_TYPE_TO_FULL={MECH:"Mechanical trap",MAG:"Magical trap",SMPL:"Simple trap",CMPX:"Complex trap",HAZ:"Hazard",WTH:"Weather",ENV:"Environmental Hazard",WLD:"Wilderness Hazard",GEN:"Generic"},Parser.tierToFullLevel=function(e){return Parser._parse_aToB(Parser.TIER_TO_FULL_LEVEL,e)},Parser.TIER_TO_FULL_LEVEL={},Parser.TIER_TO_FULL_LEVEL[1]="level 1\u20144",Parser.TIER_TO_FULL_LEVEL[2]="level 5\u201410",Parser.TIER_TO_FULL_LEVEL[3]="level 11\u201416",Parser.TIER_TO_FULL_LEVEL[4]="level 17\u201420",Parser.threatToFull=function(e){return Parser._parse_aToB(Parser.THREAT_TO_FULL,e)},Parser.THREAT_TO_FULL={},Parser.THREAT_TO_FULL[1]="moderate",Parser.THREAT_TO_FULL[2]="dangerous",Parser.THREAT_TO_FULL[3]="deadly",Parser.trapInitToFull=function(e){return Parser._parse_aToB(Parser.TRAP_INIT_TO_FULL,e)},Parser.TRAP_INIT_TO_FULL={},Parser.TRAP_INIT_TO_FULL[1]="initiative count 10",Parser.TRAP_INIT_TO_FULL[2]="initiative count 20",Parser.TRAP_INIT_TO_FULL[3]="initiative count 20 and initiative count 10",Parser.ATK_TYPE_TO_FULL={},Parser.ATK_TYPE_TO_FULL.MW="Melee Weapon Attack",Parser.ATK_TYPE_TO_FULL.RW="Ranged Weapon Attack",Parser.bookOrdinalToAbv=(e,n)=>{if(e===void 0)return"";switch(e.type){case"part":return`${n?" ":""}Part ${e.identifier}${n?"":" \u2014 "}`;case"chapter":return`${n?" ":""}Ch. ${e.identifier}${n?"":": "}`;case"episode":return`${n?" ":""}Ep. ${e.identifier}${n?"":": "}`;case"appendix":return`${n?" ":""}App. ${e.identifier}${n?"":": "}`;case"level":return`${n?" ":""}Level ${e.identifier}${n?"":": "}`;default:throw new Error(`Unhandled ordinal type "${e.type}"`);}},Parser.nameToTokenName=function(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/Æ/g,"AE").replace(/æ/g,"ae").replace(/"/g,"")},SKL_ABV_ABJ="A",SKL_ABV_EVO="V",SKL_ABV_ENC="E",SKL_ABV_ILL="I",SKL_ABV_DIV="D",SKL_ABV_NEC="N",SKL_ABV_TRA="T",SKL_ABV_CON="C",SKL_ABV_PSI="P",Parser.SKL_ABVS=[SKL_ABV_ABJ,SKL_ABV_EVO,SKL_ABV_ENC,SKL_ABV_ILL,SKL_ABV_DIV,SKL_ABV_NEC,SKL_ABV_TRA,SKL_ABV_CON,SKL_ABV_PSI],Parser.SP_TM_ACTION="action",Parser.SP_TM_B_ACTION="bonus",Parser.SP_TM_REACTION="reaction",Parser.SP_TM_ROUND="round",Parser.SP_TM_MINS="minute",Parser.SP_TM_HRS="hour",Parser.SP_TIME_SINGLETONS=[Parser.SP_TM_ACTION,Parser.SP_TM_B_ACTION,Parser.SP_TM_REACTION,Parser.SP_TM_ROUND],Parser.SP_TIME_TO_FULL={[Parser.SP_TM_ACTION]:"Action",[Parser.SP_TM_B_ACTION]:"Bonus Action",[Parser.SP_TM_REACTION]:"Reaction",[Parser.SP_TM_ROUND]:"Rounds",[Parser.SP_TM_MINS]:"Minutes",[Parser.SP_TM_HRS]:"Hours"},Parser.spTimeUnitToFull=function(e){return Parser._parse_aToB(Parser.SP_TIME_TO_FULL,e)},Parser.SP_TIME_TO_ABV={[Parser.SP_TM_ACTION]:"A",[Parser.SP_TM_B_ACTION]:"BA",[Parser.SP_TM_REACTION]:"R",[Parser.SP_TM_ROUND]:"rnd",[Parser.SP_TM_MINS]:"min",[Parser.SP_TM_HRS]:"hr"},Parser.spTimeUnitToAbv=function(e){return Parser._parse_aToB(Parser.SP_TIME_TO_ABV,e)},Parser.spTimeToShort=function(e,n){return e?1===e.number&&Parser.SP_TIME_SINGLETONS.includes(e.unit)?`${Parser.spTimeUnitToAbv(e.unit).uppercaseFirst()}${e.condition?"*":""}`:`${e.number} ${n?`<span class="small">`:""}${Parser.spTimeUnitToAbv(e.unit)}${n?`</span>`:""}${e.condition?"*":""}`:""},SKL_ABJ="Abjuration",SKL_EVO="Evocation",SKL_ENC="Enchantment",SKL_ILL="Illusion",SKL_DIV="Divination",SKL_NEC="Necromancy",SKL_TRA="Transmutation",SKL_CON="Conjuration",SKL_PSI="Psionic",Parser.SP_SCHOOL_ABV_TO_FULL={},Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_ABJ]=SKL_ABJ,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_EVO]=SKL_EVO,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_ENC]=SKL_ENC,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_ILL]=SKL_ILL,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_DIV]=SKL_DIV,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_NEC]=SKL_NEC,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_TRA]=SKL_TRA,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_CON]=SKL_CON,Parser.SP_SCHOOL_ABV_TO_FULL[SKL_ABV_PSI]=SKL_PSI,Parser.SP_SCHOOL_ABV_TO_SHORT={},Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_ABJ]="Abj.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_EVO]="Evoc.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_ENC]="Ench.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_ILL]="Illu.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_DIV]="Divin.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_NEC]="Necro.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_TRA]="Trans.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_CON]="Conj.",Parser.SP_SCHOOL_ABV_TO_SHORT[SKL_ABV_PSI]="Psi.",Parser.ATB_ABV_TO_FULL={str:"Strength",dex:"Dexterity",con:"Constitution",int:"Intelligence",wis:"Wisdom",cha:"Charisma"},TP_ABERRATION="aberration",TP_BEAST="beast",TP_CELESTIAL="celestial",TP_CONSTRUCT="construct",TP_DRAGON="dragon",TP_ELEMENTAL="elemental",TP_FEY="fey",TP_FIEND="fiend",TP_GIANT="giant",TP_HUMANOID="humanoid",TP_MONSTROSITY="monstrosity",TP_OOZE="ooze",TP_PLANT="plant",TP_UNDEAD="undead",Parser.MON_TYPES=[TP_ABERRATION,TP_BEAST,TP_CELESTIAL,TP_CONSTRUCT,TP_DRAGON,TP_ELEMENTAL,TP_FEY,TP_FIEND,TP_GIANT,TP_HUMANOID,TP_MONSTROSITY,TP_OOZE,TP_PLANT,TP_UNDEAD],Parser.MON_TYPE_TO_PLURAL={},Parser.MON_TYPE_TO_PLURAL[TP_ABERRATION]="aberrations",Parser.MON_TYPE_TO_PLURAL[TP_BEAST]="beasts",Parser.MON_TYPE_TO_PLURAL[TP_CELESTIAL]="celestials",Parser.MON_TYPE_TO_PLURAL[TP_CONSTRUCT]="constructs",Parser.MON_TYPE_TO_PLURAL[TP_DRAGON]="dragons",Parser.MON_TYPE_TO_PLURAL[TP_ELEMENTAL]="elementals",Parser.MON_TYPE_TO_PLURAL[TP_FEY]="fey",Parser.MON_TYPE_TO_PLURAL[TP_FIEND]="fiends",Parser.MON_TYPE_TO_PLURAL[TP_GIANT]="giants",Parser.MON_TYPE_TO_PLURAL[TP_HUMANOID]="humanoids",Parser.MON_TYPE_TO_PLURAL[TP_MONSTROSITY]="monstrosities",Parser.MON_TYPE_TO_PLURAL[TP_OOZE]="oozes",Parser.MON_TYPE_TO_PLURAL[TP_PLANT]="plants",Parser.MON_TYPE_TO_PLURAL[TP_UNDEAD]="undead",SZ_FINE="F",SZ_DIMINUTIVE="D",SZ_TINY="T",SZ_SMALL="S",SZ_MEDIUM="M",SZ_LARGE="L",SZ_HUGE="H",SZ_GARGANTUAN="G",SZ_COLOSSAL="C",SZ_VARIES="V",Parser.SIZE_ABVS=[SZ_TINY,SZ_SMALL,SZ_MEDIUM,SZ_LARGE,SZ_HUGE,SZ_GARGANTUAN,SZ_VARIES],Parser.SIZE_ABV_TO_FULL={},Parser.SIZE_ABV_TO_FULL[SZ_FINE]="Fine",Parser.SIZE_ABV_TO_FULL[SZ_DIMINUTIVE]="Diminutive",Parser.SIZE_ABV_TO_FULL[SZ_TINY]="Tiny",Parser.SIZE_ABV_TO_FULL[SZ_SMALL]="Small",Parser.SIZE_ABV_TO_FULL[SZ_MEDIUM]="Medium",Parser.SIZE_ABV_TO_FULL[SZ_LARGE]="Large",Parser.SIZE_ABV_TO_FULL[SZ_HUGE]="Huge",Parser.SIZE_ABV_TO_FULL[SZ_GARGANTUAN]="Gargantuan",Parser.SIZE_ABV_TO_FULL[SZ_COLOSSAL]="Colossal",Parser.SIZE_ABV_TO_FULL[SZ_VARIES]="Varies",Parser.XP_CHART=[200,450,700,1100,1800,2300,2900,3900,5e3,5900,7200,8400,1e4,11500,13e3,15e3,18e3,2e4,22e3,25e3,3e4,41e3,5e4,62e3,75e3,9e4,105e3,12e4,135e3,155e3],Parser.XP_CHART_ALT={0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:3e4,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},Parser.ARMOR_ABV_TO_FULL={"l.":"light","m.":"medium","h.":"heavy"},SRC_CoS="CoS",SRC_DMG="DMG",SRC_EEPC="EEPC",SRC_EET="EET",SRC_HotDQ="HotDQ",SRC_LMoP="LMoP",SRC_Mag="Mag",SRC_MM="MM",SRC_OotA="OotA",SRC_PHB="PHB",SRC_PotA="PotA",SRC_RoT="RoT",SRC_RoTOS="RoTOS",SRC_SCAG="SCAG",SRC_SKT="SKT",SRC_ToA="ToA",SRC_ToD="ToD",SRC_TTP="TTP",SRC_TYP="TftYP",SRC_TYP_AtG="TftYP-AtG",SRC_TYP_DiT="TftYP-DiT",SRC_TYP_TFoF="TftYP-TFoF",SRC_TYP_THSoT="TftYP-THSoT",SRC_TYP_TSC="TftYP-TSC",SRC_TYP_ToH="TftYP-ToH",SRC_TYP_WPM="TftYP-WPM",SRC_VGM="VGM",SRC_XGE="XGE",SRC_OGA="OGA",SRC_MTF="MTF",SRC_WDH="WDH",SRC_WDMM="WDMM",SRC_GGR="GGR",SRC_KKW="KKW",SRC_LLK="LLK",SRC_GoS="GoS",SRC_AI="AI",SRC_OoW="OoW",SRC_ESK="ESK",SRC_DIP="DIP",SRC_HftT="HftT",SRC_DC="DC",SRC_SLW="SLW",SRC_SDW="SDW",SRC_BGDIA="BGDIA",SRC_LR="LR",SRC_AL="AL",SRC_SAC="SAC",SRC_ERLW="ERLW",SRC_EFR="EFR",SRC_RMBRE="RMBRE",SRC_RMR="RMR",SRC_MFF="MFF",SRC_AWM="AWM",SRC_IMR="IMR",SRC_SADS="SADS",SRC_SCREEN="Screen",SRC_AL_PREFIX="AL",SRC_ALCoS=`${SRC_AL_PREFIX}CurseOfStrahd`,SRC_ALEE=`${SRC_AL_PREFIX}ElementalEvil`,SRC_ALRoD=`${SRC_AL_PREFIX}RageOfDemons`,SRC_PS_PREFIX="PS",SRC_PSA=`${SRC_PS_PREFIX}A`,SRC_PSI=`${SRC_PS_PREFIX}I`,SRC_PSK=`${SRC_PS_PREFIX}K`,SRC_PSZ=`${SRC_PS_PREFIX}Z`,SRC_PSX=`${SRC_PS_PREFIX}X`,SRC_PSD=`${SRC_PS_PREFIX}D`,SRC_UA_PREFIX="UA",SRC_UAA=`${SRC_UA_PREFIX}Artificer`,SRC_UAEAG=`${SRC_UA_PREFIX}EladrinAndGith`,SRC_UAEBB=`${SRC_UA_PREFIX}Eberron`,SRC_UAFFR=`${SRC_UA_PREFIX}FeatsForRaces`,SRC_UAFFS=`${SRC_UA_PREFIX}FeatsForSkills`,SRC_UAFO=`${SRC_UA_PREFIX}FiendishOptions`,SRC_UAFT=`${SRC_UA_PREFIX}Feats`,SRC_UAGH=`${SRC_UA_PREFIX}GothicHeroes`,SRC_UAMDM=`${SRC_UA_PREFIX}ModernMagic`,SRC_UASSP=`${SRC_UA_PREFIX}StarterSpells`,SRC_UATMC=`${SRC_UA_PREFIX}TheMysticClass`,SRC_UATOBM=`${SRC_UA_PREFIX}ThatOldBlackMagic`,SRC_UATRR=`${SRC_UA_PREFIX}TheRangerRevised`,SRC_UAWA=`${SRC_UA_PREFIX}WaterborneAdventures`,SRC_UAVR=`${SRC_UA_PREFIX}VariantRules`,SRC_UALDR=`${SRC_UA_PREFIX}LightDarkUnderdark`,SRC_UARAR=`${SRC_UA_PREFIX}RangerAndRogue`,SRC_UAATOSC=`${SRC_UA_PREFIX}ATrioOfSubclasses`,SRC_UABPP=`${SRC_UA_PREFIX}BarbarianPrimalPaths`,SRC_UARSC=`${SRC_UA_PREFIX}RevisedSubclasses`,SRC_UAKOO=`${SRC_UA_PREFIX}KitsOfOld`,SRC_UABBC=`${SRC_UA_PREFIX}BardBardColleges`,SRC_UACDD=`${SRC_UA_PREFIX}ClericDivineDomains`,SRC_UAD=`${SRC_UA_PREFIX}Druid`,SRC_UARCO=`${SRC_UA_PREFIX}RevisedClassOptions`,SRC_UAF=`${SRC_UA_PREFIX}Fighter`,SRC_UAM=`${SRC_UA_PREFIX}Monk`,SRC_UAP=`${SRC_UA_PREFIX}Paladin`,SRC_UAMC=`${SRC_UA_PREFIX}ModifyingClasses`,SRC_UAS=`${SRC_UA_PREFIX}Sorcerer`,SRC_UAWAW=`${SRC_UA_PREFIX}WarlockAndWizard`,SRC_UATF=`${SRC_UA_PREFIX}TheFaithful`,SRC_UAWR=`${SRC_UA_PREFIX}WizardRevisited`,SRC_UAESR=`${SRC_UA_PREFIX}ElfSubraces`,SRC_UAMAC=`${SRC_UA_PREFIX}MassCombat`,SRC_UA3PE=`${SRC_UA_PREFIX}ThreePillarExperience`,SRC_UAGHI=`${SRC_UA_PREFIX}GreyhawkInitiative`,SRC_UATSC=`${SRC_UA_PREFIX}ThreeSubclasses`,SRC_UAOD=`${SRC_UA_PREFIX}OrderDomain`,SRC_UACAM=`${SRC_UA_PREFIX}CentaursMinotaurs`,SRC_UAGSS=`${SRC_UA_PREFIX}GiantSoulSorcerer`,SRC_UARoE=`${SRC_UA_PREFIX}RacesOfEberron`,SRC_UARoR=`${SRC_UA_PREFIX}RacesOfRavnica`,SRC_UAWGE=`${SRC_UA_PREFIX}WGE`,SRC_UAOSS=`${SRC_UA_PREFIX}OfShipsAndSea`,SRC_UASIK=`${SRC_UA_PREFIX}Sidekicks`,SRC_UAAR=`${SRC_UA_PREFIX}ArtificerRevisited`,SRC_UABAM=`${SRC_UA_PREFIX}BarbarianAndMonk`,SRC_UASAW=`${SRC_UA_PREFIX}SorcererAndWarlock`,SRC_UABAP=`${SRC_UA_PREFIX}BardAndPaladin`,SRC_UACDW=`${SRC_UA_PREFIX}ClericDruidWizard`,SRC_UAFRR=`${SRC_UA_PREFIX}FighterRangerRogue`,SRC_UACFV=`${SRC_UA_PREFIX}ClassFeatureVariants`,SRC_UAFRW=`${SRC_UA_PREFIX}FighterRogueWizard`,SRC_UA2020SC1=`${SRC_UA_PREFIX}2020SubclassesPt1`,SRC_UA2020SC2=`${SRC_UA_PREFIX}2020SubclassesPt2`,SRC_3PP_SUFFIX=" 3pp",SRC_STREAM="Stream",SRC_TWITTER="Twitter",AL_PREFIX="Adventurers League: ",AL_PREFIX_SHORT="AL: ",PS_PREFIX="Plane Shift: ",PS_PREFIX_SHORT="PS: ",UA_PREFIX="Unearthed Arcana: ",UA_PREFIX_SHORT="UA: ",TftYP_NAME="Tales from the Yawning Portal",Parser.SOURCE_JSON_TO_FULL={},Parser.SOURCE_JSON_TO_FULL[SRC_CoS]="Curse of Strahd",Parser.SOURCE_JSON_TO_FULL[SRC_DMG]="Dungeon Master's Guide",Parser.SOURCE_JSON_TO_FULL[SRC_EEPC]="Elemental Evil Player's Companion",Parser.SOURCE_JSON_TO_FULL[SRC_EET]="Elemental Evil: Trinkets",Parser.SOURCE_JSON_TO_FULL[SRC_HotDQ]="Hoard of the Dragon Queen",Parser.SOURCE_JSON_TO_FULL[SRC_LMoP]="Lost Mine of Phandelver",Parser.SOURCE_JSON_TO_FULL[SRC_Mag]="Dragon Magazine",Parser.SOURCE_JSON_TO_FULL[SRC_MM]="Monster Manual",Parser.SOURCE_JSON_TO_FULL[SRC_OotA]="Out of the Abyss",Parser.SOURCE_JSON_TO_FULL[SRC_PHB]="Player's Handbook",Parser.SOURCE_JSON_TO_FULL[SRC_PotA]="Princes of the Apocalypse",Parser.SOURCE_JSON_TO_FULL[SRC_RoT]="The Rise of Tiamat",Parser.SOURCE_JSON_TO_FULL[SRC_RoTOS]="The Rise of Tiamat Online Supplement",Parser.SOURCE_JSON_TO_FULL[SRC_SCAG]="Sword Coast Adventurer's Guide",Parser.SOURCE_JSON_TO_FULL[SRC_SKT]="Storm King's Thunder",Parser.SOURCE_JSON_TO_FULL[SRC_ToA]="Tomb of Annihilation",Parser.SOURCE_JSON_TO_FULL[SRC_ToD]="Tyranny of Dragons",Parser.SOURCE_JSON_TO_FULL[SRC_TTP]="The Tortle Package",Parser.SOURCE_JSON_TO_FULL[SRC_TYP]=TftYP_NAME,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_AtG]=`${TftYP_NAME}: Against the Giants`,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_DiT]=`${TftYP_NAME}: Dead in Thay`,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_TFoF]=`${TftYP_NAME}: The Forge of Fury`,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_THSoT]=`${TftYP_NAME}: The Hidden Shrine of Tamoachan`,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_TSC]=`${TftYP_NAME}: The Sunless Citadel`,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_ToH]=`${TftYP_NAME}: Tomb of Horrors`,Parser.SOURCE_JSON_TO_FULL[SRC_TYP_WPM]=`${TftYP_NAME}: White Plume Mountain`,Parser.SOURCE_JSON_TO_FULL[SRC_VGM]="Volo's Guide to Monsters",Parser.SOURCE_JSON_TO_FULL[SRC_XGE]="Xanathar's Guide to Everything",Parser.SOURCE_JSON_TO_FULL[SRC_OGA]="One Grung Above",Parser.SOURCE_JSON_TO_FULL[SRC_MTF]="Mordenkainen's Tome of Foes",Parser.SOURCE_JSON_TO_FULL[SRC_WDH]="Waterdeep: Dragon Heist",Parser.SOURCE_JSON_TO_FULL[SRC_WDMM]="Waterdeep: Dungeon of the Mad Mage",Parser.SOURCE_JSON_TO_FULL[SRC_GGR]="Guildmasters' Guide to Ravnica",Parser.SOURCE_JSON_TO_FULL[SRC_KKW]="Krenko's Way",Parser.SOURCE_JSON_TO_FULL[SRC_LLK]="Lost Laboratory of Kwalish",Parser.SOURCE_JSON_TO_FULL[SRC_GoS]="Ghosts of Saltmarsh",Parser.SOURCE_JSON_TO_FULL[SRC_AI]="Acquisitions Incorporated",Parser.SOURCE_JSON_TO_FULL[SRC_OoW]="The Orrery of the Wanderer",Parser.SOURCE_JSON_TO_FULL[SRC_ESK]="Essentials Kit",Parser.SOURCE_JSON_TO_FULL[SRC_DIP]="Dragon of Icespire Peak",Parser.SOURCE_JSON_TO_FULL[SRC_HftT]="Hunt for the Thessalhydra",Parser.SOURCE_JSON_TO_FULL[SRC_DC]="Divine Contention",Parser.SOURCE_JSON_TO_FULL[SRC_SLW]="Storm Lord's Wrath",Parser.SOURCE_JSON_TO_FULL[SRC_SDW]="Sleeping Dragon's Wake",Parser.SOURCE_JSON_TO_FULL[SRC_BGDIA]="Baldur's Gate: Descent Into Avernus",Parser.SOURCE_JSON_TO_FULL[SRC_LR]="Locathah Rising",Parser.SOURCE_JSON_TO_FULL[SRC_AL]="Adventurers' League",Parser.SOURCE_JSON_TO_FULL[SRC_SAC]="Sage Advice Compendium",Parser.SOURCE_JSON_TO_FULL[SRC_ERLW]="Eberron: Rising from the Last War",Parser.SOURCE_JSON_TO_FULL[SRC_EFR]="Eberron: Forgotten Relics",Parser.SOURCE_JSON_TO_FULL[SRC_RMBRE]="The Lost Dungeon of Rickedness: Big Rick Energy",Parser.SOURCE_JSON_TO_FULL[SRC_RMR]="Dungeons & Dragons vs. Rick and Morty: Basic Rules",Parser.SOURCE_JSON_TO_FULL[SRC_MFF]="Mordenkainen's Fiendish Folio",Parser.SOURCE_JSON_TO_FULL[SRC_AWM]="Adventure with Muk",Parser.SOURCE_JSON_TO_FULL[SRC_IMR]="Infernal Machine Rebuild",Parser.SOURCE_JSON_TO_FULL[SRC_SADS]="Sapphire Anniversary Dice Set",Parser.SOURCE_JSON_TO_FULL[SRC_SCREEN]="Dungeon Master's Screen",Parser.SOURCE_JSON_TO_FULL[SRC_ALCoS]=`${AL_PREFIX}Curse of Strahd`,Parser.SOURCE_JSON_TO_FULL[SRC_ALEE]=`${AL_PREFIX}Elemental Evil`,Parser.SOURCE_JSON_TO_FULL[SRC_ALRoD]=`${AL_PREFIX}Rage of Demons`,Parser.SOURCE_JSON_TO_FULL[SRC_PSA]=`${PS_PREFIX}Amonkhet`,Parser.SOURCE_JSON_TO_FULL[SRC_PSI]=`${PS_PREFIX}Innistrad`,Parser.SOURCE_JSON_TO_FULL[SRC_PSK]=`${PS_PREFIX}Kaladesh`,Parser.SOURCE_JSON_TO_FULL[SRC_PSZ]=`${PS_PREFIX}Zendikar`,Parser.SOURCE_JSON_TO_FULL[SRC_PSX]=`${PS_PREFIX}Ixalan`,Parser.SOURCE_JSON_TO_FULL[SRC_PSD]=`${PS_PREFIX}Dominaria`,Parser.SOURCE_JSON_TO_FULL[SRC_UAA]=`${UA_PREFIX}Artificer`,Parser.SOURCE_JSON_TO_FULL[SRC_UAEAG]=`${UA_PREFIX}Eladrin and Gith`,Parser.SOURCE_JSON_TO_FULL[SRC_UAEBB]=`${UA_PREFIX}Eberron`,Parser.SOURCE_JSON_TO_FULL[SRC_UAFFR]=`${UA_PREFIX}Feats for Races`,Parser.SOURCE_JSON_TO_FULL[SRC_UAFFS]=`${UA_PREFIX}Feats for Skills`,Parser.SOURCE_JSON_TO_FULL[SRC_UAFO]=`${UA_PREFIX}Fiendish Options`,Parser.SOURCE_JSON_TO_FULL[SRC_UAFT]=`${UA_PREFIX}Feats`,Parser.SOURCE_JSON_TO_FULL[SRC_UAGH]=`${UA_PREFIX}Gothic Heroes`,Parser.SOURCE_JSON_TO_FULL[SRC_UAMDM]=`${UA_PREFIX}Modern Magic`,Parser.SOURCE_JSON_TO_FULL[SRC_UASSP]=`${UA_PREFIX}Starter Spells`,Parser.SOURCE_JSON_TO_FULL[SRC_UATMC]=`${UA_PREFIX}The Mystic Class`,Parser.SOURCE_JSON_TO_FULL[SRC_UATOBM]=`${UA_PREFIX}That Old Black Magic`,Parser.SOURCE_JSON_TO_FULL[SRC_UATRR]=`${UA_PREFIX}The Ranger, Revised`,Parser.SOURCE_JSON_TO_FULL[SRC_UAWA]=`${UA_PREFIX}Waterborne Adventures`,Parser.SOURCE_JSON_TO_FULL[SRC_UAVR]=`${UA_PREFIX}Variant Rules`,Parser.SOURCE_JSON_TO_FULL[SRC_UALDR]=`${UA_PREFIX}Light, Dark, Underdark!`,Parser.SOURCE_JSON_TO_FULL[SRC_UARAR]=`${UA_PREFIX}Ranger and Rogue`,Parser.SOURCE_JSON_TO_FULL[SRC_UAATOSC]=`${UA_PREFIX}A Trio of Subclasses`,Parser.SOURCE_JSON_TO_FULL[SRC_UABPP]=`${UA_PREFIX}Barbarian Primal Paths`,Parser.SOURCE_JSON_TO_FULL[SRC_UARSC]=`${UA_PREFIX}Revised Subclasses`,Parser.SOURCE_JSON_TO_FULL[SRC_UAKOO]=`${UA_PREFIX}Kits of Old`,Parser.SOURCE_JSON_TO_FULL[SRC_UABBC]=`${UA_PREFIX}Bard: Bard Colleges`,Parser.SOURCE_JSON_TO_FULL[SRC_UACDD]=`${UA_PREFIX}Cleric: Divine Domains`,Parser.SOURCE_JSON_TO_FULL[SRC_UAD]=`${UA_PREFIX}Druid`,Parser.SOURCE_JSON_TO_FULL[SRC_UARCO]=`${UA_PREFIX}Revised Class Options`,Parser.SOURCE_JSON_TO_FULL[SRC_UAF]=`${UA_PREFIX}Fighter`,Parser.SOURCE_JSON_TO_FULL[SRC_UAM]=`${UA_PREFIX}Monk`,Parser.SOURCE_JSON_TO_FULL[SRC_UAP]=`${UA_PREFIX}Paladin`,Parser.SOURCE_JSON_TO_FULL[SRC_UAMC]=`${UA_PREFIX}Modifying Classes`,Parser.SOURCE_JSON_TO_FULL[SRC_UAS]=`${UA_PREFIX}Sorcerer`,Parser.SOURCE_JSON_TO_FULL[SRC_UAWAW]=`${UA_PREFIX}Warlock and Wizard`,Parser.SOURCE_JSON_TO_FULL[SRC_UATF]=`${UA_PREFIX}The Faithful`,Parser.SOURCE_JSON_TO_FULL[SRC_UAWR]=`${UA_PREFIX}Wizard Revisited`,Parser.SOURCE_JSON_TO_FULL[SRC_UAESR]=`${UA_PREFIX}Elf Subraces`,Parser.SOURCE_JSON_TO_FULL[SRC_UAMAC]=`${UA_PREFIX}Mass Combat`,Parser.SOURCE_JSON_TO_FULL[SRC_UA3PE]=`${UA_PREFIX}Three-Pillar Experience`,Parser.SOURCE_JSON_TO_FULL[SRC_UAGHI]=`${UA_PREFIX}Greyhawk Initiative`,Parser.SOURCE_JSON_TO_FULL[SRC_UATSC]=`${UA_PREFIX}Three Subclasses`,Parser.SOURCE_JSON_TO_FULL[SRC_UAOD]=`${UA_PREFIX}Order Domain`,Parser.SOURCE_JSON_TO_FULL[SRC_UACAM]=`${UA_PREFIX}Centaurs and Minotaurs`,Parser.SOURCE_JSON_TO_FULL[SRC_UAGSS]=`${UA_PREFIX}Giant Soul Sorcerer`,Parser.SOURCE_JSON_TO_FULL[SRC_UARoE]=`${UA_PREFIX}Races of Eberron`,Parser.SOURCE_JSON_TO_FULL[SRC_UARoR]=`${UA_PREFIX}Races of Ravnica`,Parser.SOURCE_JSON_TO_FULL[SRC_UAWGE]="Wayfinder's Guide to Eberron",Parser.SOURCE_JSON_TO_FULL[SRC_UAOSS]=`${UA_PREFIX}Of Ships and the Sea`,Parser.SOURCE_JSON_TO_FULL[SRC_UASIK]=`${UA_PREFIX}Sidekicks`,Parser.SOURCE_JSON_TO_FULL[SRC_UAAR]=`${UA_PREFIX}Artificer Revisited`,Parser.SOURCE_JSON_TO_FULL[SRC_UABAM]=`${UA_PREFIX}Barbarian and Monk`,Parser.SOURCE_JSON_TO_FULL[SRC_UASAW]=`${UA_PREFIX}Sorcerer and Warlock`,Parser.SOURCE_JSON_TO_FULL[SRC_UABAP]=`${UA_PREFIX}Bard and Paladin`,Parser.SOURCE_JSON_TO_FULL[SRC_UACDW]=`${UA_PREFIX}Cleric, Druid, and Wizard`,Parser.SOURCE_JSON_TO_FULL[SRC_UAFRR]=`${UA_PREFIX}Fighter, Ranger, and Rogue`,Parser.SOURCE_JSON_TO_FULL[SRC_UACFV]=`${UA_PREFIX}Class Feature Variants`,Parser.SOURCE_JSON_TO_FULL[SRC_UAFRW]=`${UA_PREFIX}Fighter, Rogue, and Wizard`,Parser.SOURCE_JSON_TO_FULL[SRC_UA2020SC1]=`${UA_PREFIX}2020 Subclasses, Part 1`,Parser.SOURCE_JSON_TO_FULL[SRC_UA2020SC2]=`${UA_PREFIX}2020 Subclasses, Part 2`,Parser.SOURCE_JSON_TO_FULL[SRC_STREAM]="Livestream",Parser.SOURCE_JSON_TO_FULL[SRC_TWITTER]="Twitter",Parser.SOURCE_JSON_TO_ABV={},Parser.SOURCE_JSON_TO_ABV[SRC_CoS]="CoS",Parser.SOURCE_JSON_TO_ABV[SRC_DMG]="DMG",Parser.SOURCE_JSON_TO_ABV[SRC_EEPC]="EEPC",Parser.SOURCE_JSON_TO_ABV[SRC_EET]="EET",Parser.SOURCE_JSON_TO_ABV[SRC_HotDQ]="HotDQ",Parser.SOURCE_JSON_TO_ABV[SRC_LMoP]="LMoP",Parser.SOURCE_JSON_TO_ABV[SRC_Mag]="Mag",Parser.SOURCE_JSON_TO_ABV[SRC_MM]="MM",Parser.SOURCE_JSON_TO_ABV[SRC_OotA]="OotA",Parser.SOURCE_JSON_TO_ABV[SRC_PHB]="PHB",Parser.SOURCE_JSON_TO_ABV[SRC_PotA]="PotA",Parser.SOURCE_JSON_TO_ABV[SRC_RoT]="RoT",Parser.SOURCE_JSON_TO_ABV[SRC_RoTOS]="RoTOS",Parser.SOURCE_JSON_TO_ABV[SRC_SCAG]="SCAG",Parser.SOURCE_JSON_TO_ABV[SRC_SKT]="SKT",Parser.SOURCE_JSON_TO_ABV[SRC_ToA]="ToA",Parser.SOURCE_JSON_TO_ABV[SRC_ToD]="ToD",Parser.SOURCE_JSON_TO_ABV[SRC_TTP]="TTP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_AtG]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_DiT]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_TFoF]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_THSoT]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_TSC]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_ToH]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_TYP_WPM]="TftYP",Parser.SOURCE_JSON_TO_ABV[SRC_VGM]="VGM",Parser.SOURCE_JSON_TO_ABV[SRC_XGE]="XGE",Parser.SOURCE_JSON_TO_ABV[SRC_OGA]="OGA",Parser.SOURCE_JSON_TO_ABV[SRC_MTF]="MTF",Parser.SOURCE_JSON_TO_ABV[SRC_WDH]="WDH",Parser.SOURCE_JSON_TO_ABV[SRC_WDMM]="WDMM",Parser.SOURCE_JSON_TO_ABV[SRC_GGR]="GGR",Parser.SOURCE_JSON_TO_ABV[SRC_KKW]="KKW",Parser.SOURCE_JSON_TO_ABV[SRC_LLK]="LLK",Parser.SOURCE_JSON_TO_ABV[SRC_GoS]="GoS",Parser.SOURCE_JSON_TO_ABV[SRC_AI]="AI",Parser.SOURCE_JSON_TO_ABV[SRC_OoW]="OoW",Parser.SOURCE_JSON_TO_ABV[SRC_ESK]="ESK",Parser.SOURCE_JSON_TO_ABV[SRC_DIP]="DIP",Parser.SOURCE_JSON_TO_ABV[SRC_HftT]="HftT",Parser.SOURCE_JSON_TO_ABV[SRC_DC]="DC",Parser.SOURCE_JSON_TO_ABV[SRC_SLW]="SLW",Parser.SOURCE_JSON_TO_ABV[SRC_SDW]="SDW",Parser.SOURCE_JSON_TO_ABV[SRC_BGDIA]="BGDIA",Parser.SOURCE_JSON_TO_ABV[SRC_LR]="LR",Parser.SOURCE_JSON_TO_ABV[SRC_AL]="AL",Parser.SOURCE_JSON_TO_ABV[SRC_SAC]="SAC",Parser.SOURCE_JSON_TO_ABV[SRC_ERLW]="ERLW",Parser.SOURCE_JSON_TO_ABV[SRC_EFR]="EFR",Parser.SOURCE_JSON_TO_ABV[SRC_RMBRE]="RMBRE",Parser.SOURCE_JSON_TO_ABV[SRC_RMR]="RMR",Parser.SOURCE_JSON_TO_ABV[SRC_MFF]="MFF",Parser.SOURCE_JSON_TO_ABV[SRC_AWM]="AWM",Parser.SOURCE_JSON_TO_ABV[SRC_IMR]="IMR",Parser.SOURCE_JSON_TO_ABV[SRC_SADS]="SADS",Parser.SOURCE_JSON_TO_ABV[SRC_SCREEN]="Screen",Parser.SOURCE_JSON_TO_ABV[SRC_ALCoS]="ALCoS",Parser.SOURCE_JSON_TO_ABV[SRC_ALEE]="ALEE",Parser.SOURCE_JSON_TO_ABV[SRC_ALRoD]="ALRoD",Parser.SOURCE_JSON_TO_ABV[SRC_PSA]="PSA",Parser.SOURCE_JSON_TO_ABV[SRC_PSI]="PSI",Parser.SOURCE_JSON_TO_ABV[SRC_PSK]="PSK",Parser.SOURCE_JSON_TO_ABV[SRC_PSZ]="PSZ",Parser.SOURCE_JSON_TO_ABV[SRC_PSX]="PSX",Parser.SOURCE_JSON_TO_ABV[SRC_PSD]="PSD",Parser.SOURCE_JSON_TO_ABV[SRC_UAA]="UAA",Parser.SOURCE_JSON_TO_ABV[SRC_UAEAG]="UAEaG",Parser.SOURCE_JSON_TO_ABV[SRC_UAEBB]="UAEB",Parser.SOURCE_JSON_TO_ABV[SRC_UAFFR]="UAFFR",Parser.SOURCE_JSON_TO_ABV[SRC_UAFFS]="UAFFS",Parser.SOURCE_JSON_TO_ABV[SRC_UAFO]="UAFO",Parser.SOURCE_JSON_TO_ABV[SRC_UAFT]="UAFT",Parser.SOURCE_JSON_TO_ABV[SRC_UAGH]="UAGH",Parser.SOURCE_JSON_TO_ABV[SRC_UAMDM]="UAMM",Parser.SOURCE_JSON_TO_ABV[SRC_UASSP]="UASS",Parser.SOURCE_JSON_TO_ABV[SRC_UATMC]="UAMy",Parser.SOURCE_JSON_TO_ABV[SRC_UATOBM]="UAOBM",Parser.SOURCE_JSON_TO_ABV[SRC_UATRR]="UATRR",Parser.SOURCE_JSON_TO_ABV[SRC_UAWA]="UAWA",Parser.SOURCE_JSON_TO_ABV[SRC_UAVR]="UAVR",Parser.SOURCE_JSON_TO_ABV[SRC_UALDR]="UALDU",Parser.SOURCE_JSON_TO_ABV[SRC_UARAR]="UARAR",Parser.SOURCE_JSON_TO_ABV[SRC_UAATOSC]="UAATOSC",Parser.SOURCE_JSON_TO_ABV[SRC_UABPP]="UABPP",Parser.SOURCE_JSON_TO_ABV[SRC_UARSC]="UARSC",Parser.SOURCE_JSON_TO_ABV[SRC_UAKOO]="UAKoO",Parser.SOURCE_JSON_TO_ABV[SRC_UABBC]="UABBC",Parser.SOURCE_JSON_TO_ABV[SRC_UACDD]="UACDD",Parser.SOURCE_JSON_TO_ABV[SRC_UAD]="UAD",Parser.SOURCE_JSON_TO_ABV[SRC_UARCO]="UARCO",Parser.SOURCE_JSON_TO_ABV[SRC_UAF]="UAF",Parser.SOURCE_JSON_TO_ABV[SRC_UAM]="UAMk",Parser.SOURCE_JSON_TO_ABV[SRC_UAP]="UAP",Parser.SOURCE_JSON_TO_ABV[SRC_UAMC]="UAMC",Parser.SOURCE_JSON_TO_ABV[SRC_UAS]="UAS",Parser.SOURCE_JSON_TO_ABV[SRC_UAWAW]="UAWAW",Parser.SOURCE_JSON_TO_ABV[SRC_UATF]="UATF",Parser.SOURCE_JSON_TO_ABV[SRC_UAWR]="UAWR",Parser.SOURCE_JSON_TO_ABV[SRC_UAESR]="UAESR",Parser.SOURCE_JSON_TO_ABV[SRC_UAMAC]="UAMAC",Parser.SOURCE_JSON_TO_ABV[SRC_UA3PE]="UA3PE",Parser.SOURCE_JSON_TO_ABV[SRC_UAGHI]="UAGHI",Parser.SOURCE_JSON_TO_ABV[SRC_UATSC]="UATSC",Parser.SOURCE_JSON_TO_ABV[SRC_UAOD]="UAOD",Parser.SOURCE_JSON_TO_ABV[SRC_UACAM]="UACAM",Parser.SOURCE_JSON_TO_ABV[SRC_UAGSS]="UAGSS",Parser.SOURCE_JSON_TO_ABV[SRC_UARoE]="UARoE",Parser.SOURCE_JSON_TO_ABV[SRC_UARoR]="UARoR",Parser.SOURCE_JSON_TO_ABV[SRC_UAWGE]="WGE",Parser.SOURCE_JSON_TO_ABV[SRC_UAOSS]="UAOSS",Parser.SOURCE_JSON_TO_ABV[SRC_UASIK]="UASIK",Parser.SOURCE_JSON_TO_ABV[SRC_UAAR]="UAAR",Parser.SOURCE_JSON_TO_ABV[SRC_UABAM]="UABAM",Parser.SOURCE_JSON_TO_ABV[SRC_UASAW]="UASAW",Parser.SOURCE_JSON_TO_ABV[SRC_UABAP]="UABAP",Parser.SOURCE_JSON_TO_ABV[SRC_UACDW]="UACDW",Parser.SOURCE_JSON_TO_ABV[SRC_UAFRR]="UAFRR",Parser.SOURCE_JSON_TO_ABV[SRC_UACFV]="UACFV",Parser.SOURCE_JSON_TO_ABV[SRC_UAFRW]="UAFRW",Parser.SOURCE_JSON_TO_ABV[SRC_UA2020SC1]="UA20S1",Parser.SOURCE_JSON_TO_ABV[SRC_UA2020SC2]="UA20S2",Parser.SOURCE_JSON_TO_ABV[SRC_STREAM]="Stream",Parser.SOURCE_JSON_TO_ABV[SRC_TWITTER]="Twitter",Parser.SOURCE_JSON_TO_DATE={},Parser.SOURCE_JSON_TO_DATE[SRC_CoS]="2016-03-15",Parser.SOURCE_JSON_TO_DATE[SRC_DMG]="2014-12-09",Parser.SOURCE_JSON_TO_DATE[SRC_EEPC]="2015-03-10",Parser.SOURCE_JSON_TO_DATE[SRC_EET]="2015-03-10",Parser.SOURCE_JSON_TO_DATE[SRC_HotDQ]="2014-08-19",Parser.SOURCE_JSON_TO_DATE[SRC_LMoP]="2014-07-15",Parser.SOURCE_JSON_TO_DATE[SRC_MM]="2014-09-30",Parser.SOURCE_JSON_TO_DATE[SRC_OotA]="2015-09-15",Parser.SOURCE_JSON_TO_DATE[SRC_PHB]="2014-08-19",Parser.SOURCE_JSON_TO_DATE[SRC_PotA]="2015-04-07",Parser.SOURCE_JSON_TO_DATE[SRC_RoT]="2014-11-04",Parser.SOURCE_JSON_TO_DATE[SRC_RoTOS]="2014-11-04",Parser.SOURCE_JSON_TO_DATE[SRC_SCAG]="2015-11-03",Parser.SOURCE_JSON_TO_DATE[SRC_SKT]="2016-09-06",Parser.SOURCE_JSON_TO_DATE[SRC_ToA]="2017-09-19",Parser.SOURCE_JSON_TO_DATE[SRC_ToD]="2019-10-22",Parser.SOURCE_JSON_TO_DATE[SRC_TTP]="2017-09-19",Parser.SOURCE_JSON_TO_DATE[SRC_TYP]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_AtG]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_DiT]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_TFoF]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_THSoT]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_TSC]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_ToH]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_TYP_WPM]="2017-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_VGM]="2016-11-15",Parser.SOURCE_JSON_TO_DATE[SRC_XGE]="2017-11-21",Parser.SOURCE_JSON_TO_DATE[SRC_OGA]="2017-10-11",Parser.SOURCE_JSON_TO_DATE[SRC_MTF]="2018-05-29",Parser.SOURCE_JSON_TO_DATE[SRC_WDH]="2018-09-18",Parser.SOURCE_JSON_TO_DATE[SRC_WDMM]="2018-11-20",Parser.SOURCE_JSON_TO_DATE[SRC_GGR]="2018-11-20",Parser.SOURCE_JSON_TO_DATE[SRC_KKW]="2018-11-20",Parser.SOURCE_JSON_TO_DATE[SRC_LLK]="2018-11-10",Parser.SOURCE_JSON_TO_DATE[SRC_GoS]="2019-05-21",Parser.SOURCE_JSON_TO_DATE[SRC_AI]="2019-06-18",Parser.SOURCE_JSON_TO_DATE[SRC_OoW]="2019-06-18",Parser.SOURCE_JSON_TO_DATE[SRC_ESK]="2019-06-24",Parser.SOURCE_JSON_TO_DATE[SRC_DIP]="2019-06-24",Parser.SOURCE_JSON_TO_DATE[SRC_HftT]="2019-05-01",Parser.SOURCE_JSON_TO_DATE[SRC_DC]="2019-06-24",Parser.SOURCE_JSON_TO_DATE[SRC_SLW]="2019-06-24",Parser.SOURCE_JSON_TO_DATE[SRC_SDW]="2019-06-24",Parser.SOURCE_JSON_TO_DATE[SRC_BGDIA]="2019-09-17",Parser.SOURCE_JSON_TO_DATE[SRC_LR]="2019-09-19",Parser.SOURCE_JSON_TO_DATE[SRC_SAC]="2019-01-31",Parser.SOURCE_JSON_TO_DATE[SRC_ERLW]="2019-11-19",Parser.SOURCE_JSON_TO_DATE[SRC_EFR]="2019-11-19",Parser.SOURCE_JSON_TO_DATE[SRC_RMBRE]="2019-11-19",Parser.SOURCE_JSON_TO_DATE[SRC_RMR]="2019-11-19",Parser.SOURCE_JSON_TO_DATE[SRC_MFF]="2019-11-12",Parser.SOURCE_JSON_TO_DATE[SRC_AWM]="2019-11-12",Parser.SOURCE_JSON_TO_DATE[SRC_IMR]="2019-11-12",Parser.SOURCE_JSON_TO_DATE[SRC_SADS]="2019-12-12",Parser.SOURCE_JSON_TO_DATE[SRC_SCREEN]="2015-01-20",Parser.SOURCE_JSON_TO_DATE[SRC_ALCoS]="2016-03-15",Parser.SOURCE_JSON_TO_DATE[SRC_ALEE]="2015-04-07",Parser.SOURCE_JSON_TO_DATE[SRC_ALRoD]="2015-09-15",Parser.SOURCE_JSON_TO_DATE[SRC_PSA]="2017-07-06",Parser.SOURCE_JSON_TO_DATE[SRC_PSI]="2016-07-12",Parser.SOURCE_JSON_TO_DATE[SRC_PSK]="2017-02-16",Parser.SOURCE_JSON_TO_DATE[SRC_PSZ]="2016-04-27",Parser.SOURCE_JSON_TO_DATE[SRC_PSX]="2018-01-09",Parser.SOURCE_JSON_TO_DATE[SRC_PSD]="2018-07-31",Parser.SOURCE_JSON_TO_DATE[SRC_UAEBB]="2015-02-02",Parser.SOURCE_JSON_TO_DATE[SRC_UAA]="2017-01-09",Parser.SOURCE_JSON_TO_DATE[SRC_UAEAG]="2017-09-11",Parser.SOURCE_JSON_TO_DATE[SRC_UAFFR]="2017-04-24",Parser.SOURCE_JSON_TO_DATE[SRC_UAFFS]="2017-04-17",Parser.SOURCE_JSON_TO_DATE[SRC_UAFO]="2017-10-09",Parser.SOURCE_JSON_TO_DATE[SRC_UAFT]="2016-06-06",Parser.SOURCE_JSON_TO_DATE[SRC_UAGH]="2016-04-04",Parser.SOURCE_JSON_TO_DATE[SRC_UAMDM]="2015-08-03",Parser.SOURCE_JSON_TO_DATE[SRC_UASSP]="2017-04-03",Parser.SOURCE_JSON_TO_DATE[SRC_UATMC]="2017-03-13",Parser.SOURCE_JSON_TO_DATE[SRC_UATOBM]="2015-12-07",Parser.SOURCE_JSON_TO_DATE[SRC_UATRR]="2016-09-12",Parser.SOURCE_JSON_TO_DATE[SRC_UAWA]="2015-05-04",Parser.SOURCE_JSON_TO_DATE[SRC_UAVR]="2015-06-08",Parser.SOURCE_JSON_TO_DATE[SRC_UALDR]="2015-11-02",Parser.SOURCE_JSON_TO_DATE[SRC_UARAR]="2017-01-16",Parser.SOURCE_JSON_TO_DATE[SRC_UAATOSC]="2017-03-27",Parser.SOURCE_JSON_TO_DATE[SRC_UABPP]="2016-11-07",Parser.SOURCE_JSON_TO_DATE[SRC_UARSC]="2017-05-01",Parser.SOURCE_JSON_TO_DATE[SRC_UAKOO]="2016-01-04",Parser.SOURCE_JSON_TO_DATE[SRC_UABBC]="2016-11-14",Parser.SOURCE_JSON_TO_DATE[SRC_UACDD]="2016-11-12",Parser.SOURCE_JSON_TO_DATE[SRC_UAD]="2016-11-28",Parser.SOURCE_JSON_TO_DATE[SRC_UARCO]="2017-06-05",Parser.SOURCE_JSON_TO_DATE[SRC_UAF]="2016-12-5",Parser.SOURCE_JSON_TO_DATE[SRC_UAM]="2016-12-12",Parser.SOURCE_JSON_TO_DATE[SRC_UAP]="2016-12-19",Parser.SOURCE_JSON_TO_DATE[SRC_UAMC]="2015-04-06",Parser.SOURCE_JSON_TO_DATE[SRC_UAS]="2017-02-06",Parser.SOURCE_JSON_TO_DATE[SRC_UAWAW]="2017-02-13",Parser.SOURCE_JSON_TO_DATE[SRC_UATF]="2016-08-01",Parser.SOURCE_JSON_TO_DATE[SRC_UAWR]="2017-03-20",Parser.SOURCE_JSON_TO_DATE[SRC_UAESR]="2017-11-13",Parser.SOURCE_JSON_TO_DATE[SRC_UAMAC]="2017-02-21",Parser.SOURCE_JSON_TO_DATE[SRC_UA3PE]="2017-08-07",Parser.SOURCE_JSON_TO_DATE[SRC_UAGHI]="2017-07-10",Parser.SOURCE_JSON_TO_DATE[SRC_UATSC]="2018-01-08",Parser.SOURCE_JSON_TO_DATE[SRC_UAOD]="2018-04-09",Parser.SOURCE_JSON_TO_DATE[SRC_UACAM]="2018-05-14",Parser.SOURCE_JSON_TO_DATE[SRC_UAGSS]="2018-06-11",Parser.SOURCE_JSON_TO_DATE[SRC_UARoE]="5018-07-23",Parser.SOURCE_JSON_TO_DATE[SRC_UARoR]="2018-08-13",Parser.SOURCE_JSON_TO_DATE[SRC_UAWGE]="2018-07-23",Parser.SOURCE_JSON_TO_DATE[SRC_UAOSS]="2018-11-12",Parser.SOURCE_JSON_TO_DATE[SRC_UASIK]="2018-12-17",Parser.SOURCE_JSON_TO_DATE[SRC_UAAR]="2019-02-28",Parser.SOURCE_JSON_TO_DATE[SRC_UABAM]="2019-08-15",Parser.SOURCE_JSON_TO_DATE[SRC_UASAW]="2019-09-05",Parser.SOURCE_JSON_TO_DATE[SRC_UABAP]="2019-09-18",Parser.SOURCE_JSON_TO_DATE[SRC_UACDW]="2019-10-03",Parser.SOURCE_JSON_TO_DATE[SRC_UAFRR]="2019-10-17",Parser.SOURCE_JSON_TO_DATE[SRC_UACFV]="2019-11-04",Parser.SOURCE_JSON_TO_DATE[SRC_UAFRW]="2019-11-25",Parser.SOURCE_JSON_TO_DATE[SRC_UA2020SC1]="2020-01-14",Parser.SOURCE_JSON_TO_DATE[SRC_UA2020SC2]="2020-02-04",Parser.SOURCES_ADVENTURES=new Set([SRC_LMoP,SRC_HotDQ,SRC_RoT,SRC_PotA,SRC_OotA,SRC_CoS,SRC_SKT,SRC_TYP,SRC_TYP_AtG,SRC_TYP_DiT,SRC_TYP_TFoF,SRC_TYP_THSoT,SRC_TYP_TSC,SRC_TYP_ToH,SRC_TYP_WPM,SRC_ToA,SRC_TTP,SRC_WDH,SRC_LLK,SRC_WDMM,SRC_KKW,SRC_GoS,SRC_HftT,SRC_OoW,SRC_DIP,SRC_SLW,SRC_SDW,SRC_DC,SRC_BGDIA,SRC_LR,SRC_EFR,SRC_RMBRE,SRC_IMR,SRC_AWM]),Parser.SOURCES_CORE_SUPPLEMENTS=new Set(Object.keys(Parser.SOURCE_JSON_TO_FULL).filter(e=>!Parser.SOURCES_ADVENTURES.has(e))),Parser.SOURCES_NON_STANDARD_WOTC=new Set([SRC_OGA,SRC_Mag,SRC_STREAM,SRC_TWITTER,SRC_LLK,SRC_LR,SRC_TTP,SRC_AWM,SRC_IMR,SRC_SADS]),Parser.ITEM_TYPE_JSON_TO_ABV={A:"Ammunition",AF:"Ammunition",AT:"Artisan's Tools",EM:"Eldritch Machine",EXP:"Explosive",G:"Adventuring Gear",GS:"Gaming Set",HA:"Heavy Armor",INS:"Instrument",LA:"Light Armor",M:"Melee Weapon",MA:"Medium Armor",MNT:"Mount",GV:"Generic Variant",P:"Potion",R:"Ranged Weapon",RD:"Rod",RG:"Ring",S:"Shield",SC:"Scroll",SCF:"Spellcasting Focus",OTH:"Other",T:"Tools",TAH:"Tack and Harness",TG:"Trade Good",$:"Treasure",VEH:"Vehicle (land)",SHP:"Vehicle (water)",AIR:"Vehicle (air)",WD:"Wand"},Parser.DMGTYPE_JSON_TO_FULL={A:"acid",B:"bludgeoning",C:"cold",F:"fire",O:"force",L:"lightning",N:"necrotic",P:"piercing",I:"poison",Y:"psychic",R:"radiant",S:"slashing",T:"thunder"},Parser.DMG_TYPES=["acid","bludgeoning","cold","fire","force","lightning","necrotic","piercing","poison","psychic","radiant","slashing","thunder"],Parser.CONDITIONS=["blinded","charmed","deafened","exhaustion","frightened","grappled","incapacitated","invisible","paralyzed","petrified","poisoned","prone","restrained","stunned","unconscious"],Parser.SKILL_JSON_TO_FULL={Acrobatics:["Your Dexterity (Acrobatics) check covers your attempt to stay on your feet in a tricky situation, such as when you're trying to run across a sheet of ice, balance on a tightrope, or stay upright on a rocking ship's deck. The DM might also call for a Dexterity (Acrobatics) check to see if you can perform acrobatic stunts, including dives, rolls, somersaults, and flips."],"Animal Handling":["When there is any question whether you can calm down a domesticated animal, keep a mount from getting spooked, or intuit an animal's intentions, the DM might call for a Wisdom (Animal Handling) check. You also make a Wisdom (Animal Handling) check to control your mount when you attempt a risky maneuver."],Arcana:["Your Intelligence (Arcana) check measures your ability to recall lore about spells, magic items, eldritch symbols, magical traditions, the planes of existence, and the inhabitants of those planes."],Athletics:["Your Strength (Athletics) check covers difficult situations you encounter while climbing, jumping, or swimming. Examples include the following activities:",{type:"list",items:["You attempt to climb a sheer or slippery cliff, avoid hazards while scaling a wall, or cling to a surface while something is trying to knock you off.","You try to jump an unusually long distance or pull off a stunt mid jump.","You struggle to swim or stay afloat in treacherous currents, storm-tossed waves, or areas of thick seaweed. Or another creature tries to push or pull you underwater or otherwise interfere with your swimming."]}],Deception:["Your Charisma (Deception) check determines whether you can convincingly hide the truth, either verbally or through your actions. This deception can encompass everything from misleading others through ambiguity to telling outright lies. Typical situations include trying to fast-talk a guard, con a merchant, earn money through gambling, pass yourself off in a disguise, dull someone's suspicions with false assurances, or maintain a straight face while telling a blatant lie."],History:["Your Intelligence (History) check measures your ability to recall lore about historical events, legendary people, ancient kingdoms, past disputes, recent wars, and lost civilizations."],Insight:["Your Wisdom (Insight) check decides whether you can determine the true intentions of a creature, such as when searching out a lie or predicting someone's next move. Doing so involves gleaning clues from body language, speech habits, and changes in mannerisms."],Intimidation:["When you attempt to influence someone through overt threats, hostile actions, and physical violence, the DM might ask you to make a Charisma (Intimidation) check. Examples include trying to pry information out of a prisoner, convincing street thugs to back down from a confrontation, or using the edge of a broken bottle to convince a sneering vizier to reconsider a decision."],Investigation:["When you look around for clues and make deductions based on those clues, you make an Intelligence (Investigation) check. You might deduce the location of a hidden object, discern from the appearance of a wound what kind of weapon dealt it, or determine the weakest point in a tunnel that could cause it to collapse. Poring through ancient scrolls in search of a hidden fragment of knowledge might also call for an Intelligence (Investigation) check."],Medicine:["A Wisdom (Medicine) check lets you try to stabilize a dying companion or diagnose an illness."],Nature:["Your Intelligence (Nature) check measures your ability to recall lore about terrain, plants and animals, the weather, and natural cycles."],Perception:["Your Wisdom (Perception) check lets you spot, hear, or otherwise detect the presence of something. It measures your general awareness of your surroundings and the keenness of your senses.","For example, you might try to hear a conversation through a closed door, eavesdrop under an open window, or hear monsters moving stealthily in the forest. Or you might try to spot things that are obscured or easy to miss, whether they are orcs lying in ambush on a road, thugs hiding in the shadows of an alley, or candlelight under a closed secret door."],Performance:["Your Charisma (Performance) check determines how well you can delight an audience with music, dance, acting, storytelling, or some other form of entertainment."],Persuasion:["When you attempt to influence someone or a group of people with tact, social graces, or good nature, the DM might ask you to make a Charisma (Persuasion) check. Typically, you use persuasion when acting in good faith, to foster friendships, make cordial requests, or exhibit proper etiquette. Examples of persuading others include convincing a chamberlain to let your party see the king, negotiating peace between warring tribes, or inspiring a crowd of townsfolk."],Religion:["Your Intelligence (Religion) check measures your ability to recall lore about deities, rites and prayers, religious hierarchies, holy symbols, and the practices of secret cults."],"Sleight of Hand":["Whenever you attempt an act of legerdemain or manual trickery, such as planting something on someone else or concealing an object on your person, make a Dexterity (Sleight of Hand) check. The DM might also call for a Dexterity (Sleight of Hand) check to determine whether you can lift a coin purse off another person or slip something out of another person's pocket."],Stealth:["Make a Dexterity (Stealth) check when you attempt to conceal yourself from enemies, slink past guards, slip away without being noticed, or sneak up on someone without being seen or heard."],Survival:["The DM might ask you to make a Wisdom (Survival) check to follow tracks, hunt wild game, guide your group through frozen wastelands, identify signs that owlbears live nearby, predict the weather, or avoid quicksand and other natural hazards."]},Parser.SENSE_JSON_TO_FULL={blindsight:["A creature with blindsight can perceive its surroundings without relying on sight, within a specific radius. Creatures without eyes, such as oozes, and creatures with echolocation or heightened senses, such as bats and true dragons, have this sense."],darkvision:["Many creatures in fantasy gaming worlds, especially those that dwell underground, have darkvision. Within a specified range, a creature with darkvision can see in dim light as if it were bright light and in darkness as if it were dim light, so areas of darkness are only lightly obscured as far as that creature is concerned. However, the creature can't discern color in that darkness, only shades of gray."],tremorsense:["A creature with tremorsense can detect and pinpoint the origin of vibrations within a specific radius, provided that the creature and the source of the vibrations are in contact with the same ground or substance. Tremorsense can't be used to detect flying or incorporeal creatures. Many burrowing creatures, such as ankhegs and umber hulks, have this special sense."],truesight:["A creature with truesight can, out to a specific range, see in normal and magical darkness, see invisible creatures and objects, automatically detect visual illusions and succeed on saving throws against them, and perceives the original form of a shapechanger or a creature that is transformed by magic. Furthermore, the creature can see into the Ethereal Plane."]},Parser.NUMBERS_ONES=["","one","two","three","four","five","six","seven","eight","nine"],Parser.NUMBERS_TENS=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],Parser.NUMBERS_TEENS=["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],SourceUtil={_subclassReprintLookup:{},async pInitSubclassReprintLookup(){SourceUtil._subclassReprintLookup=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/generated/gendata-subclass-lookup.json`)},isSubclassReprinted(e,n,_,t){const o=MiscUtil.get(SourceUtil._subclassReprintLookup,n,e,t,_);return!!o&&o.isReprinted},isAdventure(e){return e instanceof FilterItem&&(e=e.item),Parser.SOURCES_ADVENTURES.has(e)},isCoreOrSupplement(e){return e instanceof FilterItem&&(e=e.item),Parser.SOURCES_CORE_SUPPLEMENTS.has(e)},isNonstandardSource(e){return null!=e&&!BrewUtil.hasSourceJson(e)&&SourceUtil._isNonstandardSourceWiz(e)},_isNonstandardSourceWiz(e){return e.startsWith(SRC_UA_PREFIX)||e.startsWith(SRC_PS_PREFIX)||e.startsWith(SRC_AL_PREFIX)||Parser.SOURCES_NON_STANDARD_WOTC.has(e)},getFilterGroup(e){return e instanceof FilterItem&&(e=e.item),BrewUtil.hasSourceJson(e)?2:+SourceUtil.isNonstandardSource(e)}},CurrencyUtil={doSimplifyCoins(e,n){var _=Math.ceil,t=Math.floor,o=Math.abs;n=n||[];for(let a=0;a<Parser.COIN_CONVERSIONS.length-1;++a){const n=Parser.COIN_ABVS[a],i=Parser.COIN_ABVS[a+1],r=Parser.COIN_CONVERSIONS[a+1]/Parser.COIN_CONVERSIONS[a];if(e[n]&&o(e[n])>=r){const o=0<=e[n]?t(e[n]/r):_(e[n]/r);e[n]%=r,e[i]=(e[i]||0)+o}}for(let _=Parser.COIN_CONVERSIONS.length-1;0<=_;--_){const t=Parser.COIN_ABVS[_],o=Parser.COIN_ABVS[_-1],i=Parser.COIN_CONVERSIONS[_]/Parser.COIN_CONVERSIONS[_-1];n.includes(t)||(e[o]=(e[o]||0)+(e[t]||0)*i,delete e[t])}return Parser.COIN_ABVS.filter(n=>0===e[n]).forEach(n=>delete e[n]),e}},Math.sum=Math.sum||function(...e){return e.reduce((e,n)=>e+n,0)},Math.mean=Math.mean||function(...e){return Math.sum(...e)/e.length},Math.meanAbsoluteDeviation=Math.meanAbsoluteDeviation||function(...e){var n=Math.mean;const _=n(...e);return n(...e.map(e=>Math.abs(e-_)))},Math.seed=Math.seed||function(e){var n=Math.floor;return function(){var _=Math.sin;return e=1e4*_(e),e-n(e)}};function xor(e,n){return!e!=!n}function implies(e,n){return!e||n}function noModifierKeys(n){return!n.ctrlKey&&!n.altKey&&!n.metaKey}function isObject(e){const n=typeof e;return("function"==n||"object"===n)&&!!e}function isString(e){return"string"==typeof e}function isNumber(e){return"[object Number]"===toString.call(e)}function isEmpty(e){return!(null!=e)||(Array.isArray(e)||isString(e)?0===e.length:0===Object.keys(e).length)}JqueryUtil={_isEnhancementsInit:!1,initEnhancements(){JqueryUtil._isEnhancementsInit||(JqueryUtil._isEnhancementsInit=!0,JqueryUtil.addSelectors(),window.$$=function(n,..._){if(n instanceof jQuery)return(...e)=>{const _=[...e[0]],t=e.slice(1);_[0]=`<div>${_[0]}`,_.last(`${_.last()}</div>`);const o=$$(_,...t);return o.children().each((_,t)=>$(t).appendTo(n)),n};else{const e=[];let t=0;const o=n=>n instanceof $?(e.push(n),`<${n.tag()} data-r="true"/>`):n instanceof HTMLElement?o($(n)):n,i=n.reduce((e,n)=>{const i=t++;return null==_[i]?`${e}${n}`:_[i]instanceof Array?`${e}${_[i].map(e=>o(e)).join("")}${n}`:`${e}${o(_[i])}${n}`}),a=$(i);return a.find(`[data-r=true]`).replaceWith(n=>e[n]),a}},$.fn.extend({disableSpellcheck:function(){return this.attr("autocomplete","off").attr("autocapitalize","off").attr("spellcheck","false")},tag:function(){return this.prop("tagName").toLowerCase()},title:function(...e){return this.attr("title",...e)},fastSetHtml:function(e){if(!this.length)return this;let n=this[0];for(;n.children.length;)n=n.children[0];return n.innerHTML=e,this},blurOnEsc:function(){return this.keydown(e=>{27===e.which&&this.blur()})}}),$.event.special.destroyed={remove:function(e){e.handler&&e.handler()}})},addSelectors(){$.expr[":"].textEquals=(e,n,_)=>$(e).text().toLowerCase().trim()===_[3],$.expr[":"].containsInsensitive=(e,n,_)=>{const t=_[3],o=$(e).contents().filter((n,_)=>3===_.nodeType)[0];if(!o)return!1;const i=o.nodeValue.toLowerCase().trim().match(`${t.toLowerCase().trim().escapeRegexp()}`);return i&&0<i.length}},showCopiedEffect(e,n="Copied!",t){const o=$(`<div class="copied-tip"><span>${n}</span></div>`).appendTo($(`body`)),i=o.width()/2,a=$(window).scrollTop(),r=e.offset(),s={top:"-=8",opacity:0};t&&(s.left=`${.5<Math.random()?"-":"+"}=${~~(17*Math.random())}`);const d=Math.random(),l=t?250+200*d:250;o.css({top:t?r.top-5-a:r.top-17-a,left:r.left-i+e.width()/2}).animate(s,{easing:"linear",duration:l,complete:()=>o.remove(),progress:(e,n)=>{if(t){s.top=`${0<.5-n?"-":"+"}=40`,o.css("transform",`rotate(${.5<d?"-":""}${500*d*n}deg)`)}}})},_dropdownInit:!1,bindDropdownButton(e){JqueryUtil._dropdownInit||(JqueryUtil._dropdownInit=!0,document.addEventListener("click",()=>[...document.querySelectorAll(`.open`)].filter(e=>!(e.className||"").split(" ").includes(`dropdown--navbar`)).forEach(e=>e.classList.remove("open")))),e.click(()=>setTimeout(()=>e.parent().addClass("open"),1))},_ACTIVE_TOAST:[],doToast(e){"string"==typeof e&&(e={content:e,type:"info"}),e.type=e.type||"info";const n=e=>{e.removeClass("toast--animate"),setTimeout(()=>e.remove(),85),JqueryUtil._ACTIVE_TOAST.splice(JqueryUtil._ACTIVE_TOAST.indexOf(e),1)},_=$(`<button class="btn toast__btn-close"><span class="glyphicon glyphicon-remove"/></button>`).click(()=>n(t)),t=$$`
		<div class="toast toast--type-${e.type}">
			<div class="toast__wrp-content">${e.content}</div>
			<div class="toast__wrp-control">${_}</div>
		</div>`.prependTo($(`body`)).data("pos",0);setTimeout(()=>t.addClass(`toast--animate`),5),setTimeout(()=>n(t),5e3),JqueryUtil._ACTIVE_TOAST.length&&JqueryUtil._ACTIVE_TOAST.forEach(e=>{const _=e.data("pos");e.data("pos",_+1),2===_&&n(e)}),JqueryUtil._ACTIVE_TOAST.push(t)}},"undefined"!=typeof window&&window.addEventListener("load",JqueryUtil.initEnhancements),ObjUtil={mergeWith(e,n,_,t={depth:1}){if(!e||!n||"function"!=typeof _)throw new Error("Must include a source, target and a fnMerge to handle merging");const o=function(i,a,r=1){if(!(r>t.depth)&&i&&a)for(let t of Object.keys(i))a[t]=_(i[t],a[t],e,n),o(e[t],a[t],r+1)};o(e,n,1)},async pForEachDeep(e,n,_={depth:1/0,callEachLevel:!1}){const t=async function(e,o,i=0){if((_.callEachLevel||"object"!=typeof e||_.depth===i)&&(await n(e,o,i)),_.depth!==i&&"object"==typeof e)for(const n of Object.keys(e))o.push(n),await t(e[n],o,i+1);o.pop()};await t(e,[])}},MiscUtil={COLOR_HEALTHY:"#00bb20",COLOR_HURT:"#c5ca00",COLOR_BLOODIED:"#f7a100",COLOR_DEFEATED:"#cc0000",STR_SEE_CONSOLE:"See the console (CTRL+SHIFT+J) for more information.",copy(e){return JSON.parse(JSON.stringify(e))},async pCopyTextToClipboard(e){function n(){const n=$(`<textarea id="copy-temp" style="position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px;">${e}</textarea>`);$(`body`).append(n),n.select(),document.execCommand("Copy"),n.remove()}if(navigator&&navigator.permissions)try{const _=await navigator.permissions.query({name:"clipboard-write"});"granted"===_.state||"prompt"===_.state?await navigator.clipboard.writeText(e):n()}catch(_){n()}else n()},checkProperty(e,...n){for(let _=0;_<n.length;++_)if(e=e[n[_]],null==e)return!1;return!0},get(e,...n){if(null==e)return null;for(let _=0;_<n.length;++_)if(e=e[n[_]],null==e)return e;return e},mix:e=>new MiscUtil._MixinBuilder(e),_MixinBuilder:function(e){this.superclass=e,this.with=function(...e){return e.reduce((e,n)=>n(e),this.superclass)}},clearSelection(){document.getSelection?(document.getSelection().removeAllRanges(),document.getSelection().addRange(document.createRange())):window.getSelection?window.getSelection().removeAllRanges?(window.getSelection().removeAllRanges(),window.getSelection().addRange(document.createRange())):window.getSelection().empty&&window.getSelection().empty():document.selection&&document.selection.empty()},randomColor(){let e,n,_;const t=RollerUtil.randomise(30,0)/30,o=~~(6*t),i=6*t-o,a=1-i;switch(o%6){case 0:e=1,n=i,_=0;break;case 1:e=a,n=1,_=0;break;case 2:e=0,n=1,_=i;break;case 3:e=0,n=a,_=1;break;case 4:e=i,n=0,_=1;break;case 5:e=1,n=0,_=a;}return`#${`00${(~~(255*e)).toString(16)}`.slice(-2)}${`00${(~~(255*n)).toString(16)}`.slice(-2)}${`00${(~~(255*_)).toString(16)}`.slice(-2)}`},invertColor(e,n){n=n||{},e=e.slice(1);let _=parseInt(e.slice(0,2),16),t=parseInt(e.slice(2,4),16),o=parseInt(e.slice(4,6),16);const i=186<.299*_+.587*t+.114*o;return n.dark&&n.light?i?n.dark:n.light:n.bw?i?"#000000":"#FFFFFF":(_=(255-_).toString(16),t=(255-t).toString(16),o=(255-o).toString(16),`#${[_,t,o].map(e=>e.padStart(2,"0")).join("")}`)},scrollPageTop(){document.body.scrollTop=document.documentElement.scrollTop=0},isInInput(e){return"INPUT"===e.target.nodeName||"TEXTAREA"===e.target.nodeName||"true"===e.target.getAttribute("contenteditable")},expEval(e){return new Function(`return ${e.replace(/[^-()\d/*+.]/g,"")}`)()},parseNumberRange(e,n=Number.MIN_SAFE_INTEGER,_=Number.MAX_SAFE_INTEGER){function t(e){throw new Error(`Could not parse range input "${e}"`)}function o(){throw new Error(`Number was out of range! Range was ${n}-${_} (inclusive).`)}function i(e){return e<n||e>_}function a(e,n){e.add(n)}function r(e,n,_){for(let t=n;t<=_;++t)e.add(t)}for(;;)if(e&&e.trim()){const n=e.replace(/\s*/g,"");if(/^((\d+-\d+|\d+),)*(\d+-\d+|\d+)$/.exec(n)){const e=n.split(","),_=new Set;for(const n of e)if(n.includes("-")){const e=n.split("-"),s=+e[0],d=+e[1];(isNaN(s)||isNaN(d)||0===s||0===d||s>d)&&t(),(i(s)||i(d))&&o(),s===d?a(_,s):r(_,s,d)}else{const e=+n;isNaN(e)||0===e?t():(i(e)&&o(),a(_,e))}return _}t()}else return null},MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],dateToStr(e,n){const _=MiscUtil.MONTH_NAMES[e.getMonth()];return`${n?_.substring(0,3):_} ${e.getDate()}, ${e.getFullYear()}`},findCommonPrefix(e){var n=Math.min;let _=null;return e.forEach(e=>{if(null==_)_=e;else{const t=n(e.length,_.length);for(let n=0;n<t;++n){const t=_[n],o=e[n];if(t!==o){_=_.substring(0,n);break}}}}),_},calculateBlendedColor(e,n,_){const t=CryptUtil.hex2Dec(e),o=CryptUtil.hex2Dec(_);return((t-(1-n)*o)/n).toString(16)},debounce(e,n,_){var u=Math.max,c=Math.min;function t(n){let _=T,t=O;return T=O=void 0,R=n,C=e.apply(t,_),C}function o(e){return R=e,p=setTimeout(r,n),f?t(e):C}function i(e){let _=e-E,t=e-R,o=n-_;return h?c(o,A-t):o}function a(e){let _=e-E,t=e-R;return void 0===E||_>=n||0>_||h&&t>=A}function r(){const e=Date.now();return a(e)?s(e):void(p=setTimeout(r,i(e)))}function s(e){return(p=void 0,m&&T)?t(e):(T=O=void 0,C)}function d(){void 0!==p&&clearTimeout(p),R=0,T=E=O=p=void 0}function l(){return void 0===p?C:s(Date.now())}function S(){let e=Date.now(),_=a(e);if(T=arguments,O=this,E=e,_){if(void 0===p)return o(E);if(h)return p=setTimeout(r,n),t(E)}return void 0===p&&(p=setTimeout(r,n)),C}let T,O,A,C,p,E,R=0,f=!1,h=!1,m=!0;return n=+n||0,"object"==typeof _&&(f=!!_.leading,h="maxWait"in _,A=h?u(+_.maxWait||0,n):A,m="trailing"in _?!!_.trailing:m),S.cancel=d,S.flush=l,S},throttle(e,n,_){let t=!0,o=!0;return"object"==typeof _&&(t="leading"in _?!!_.leading:t,o="trailing"in _?!!_.trailing:o),this.debounce(e,n,{leading:t,maxWait:n,trailing:o})},pDelay(e,n){return new Promise(_=>setTimeout(()=>_(n),e))},getWalker(e=new Set){function n(e,n,_,t){return e instanceof Array||(e=[e]),e.forEach(e=>_=e(n,_,t)),_}const _=(t,o,i,a)=>{if(null==o)return i.null?n(i.null,t,o,a):o;const r=typeof o;switch(r){case void 0:return i.undefined?n(i.undefined,t,o,a):o;case"boolean":return i.boolean?n(i.boolean,t,o,a):o;case"number":return i.number?n(i.number,t,o,a):o;case"string":return i.string?n(i.string,t,o,a):o;case"object":return o instanceof Array?(i.array&&(o=n(i.array,t,o,a)),o.map(e=>_(t,e,i,a))):(i.object&&(o=n(i.object,t,o,a)),Object.keys(o).forEach(n=>{const a=o[n];e.has(n)||(o[n]=_(t,a,i,n))}),o);default:throw new Error(`Unhandled type "${r}"`);}};return{walk:_}},pDefer(e){return(async()=>e())()}},EventUtil={getClientX(e){return e.touches&&e.touches.length?e.touches[0].clientX:e.clientX},getClientY(e){return e.touches&&e.touches.length?e.touches[0].clientY:e.clientY}},ContextUtil={_ctxInit:{},_ctxClick:{},_ctxOpenRefsNextId:1,_ctxOpenRefs:{},_handlePreInitContextMenu:e=>{if(!ContextUtil._ctxInit[e]){ContextUtil._ctxInit[e]=!0;const n=`click.${e}`;$("body").off(n).on(n,n=>{null!=$(n.target).data("ctx-id")||(Object.entries(ContextUtil._ctxOpenRefs[e]||{}).forEach(([n,_])=>{_(!1),delete ContextUtil._ctxOpenRefs[e][n]}),$(`#${e}`).hide())})}},_getMenuPosition:(e,n,_,t)=>{const o=$(window)[_](),i=$(window)[t](),a=$(`#${e}`)[_]();let r=n+i;return n+a>o&&a<n&&(r-=a),r},_lastMenuId:1,getNextGenericMenuId(){return`contextMenu_${ContextUtil._lastMenuId++}`},doInitContextMenu:(e,n,_)=>{ContextUtil._ctxClick[e]=n,ContextUtil._handlePreInitContextMenu(e);let t=`<ul id="${e}" class="dropdown-menu ui-ctx" role="menu">`,o=0;_.forEach(e=>{null===e?t+=`<li class="divider"/>`:"object"==typeof e?(t+=`<li class="${e.isDisabled?`disabled`:``} ${e.style||""}"><span ${e.isDisabled?"":`data-ctx-id="${o}"`} ${e.title?`title="${e.title.escapeQuotes()}"`:""}>${e.text}</span></li>`,!e.isDisabled&&o++):(t+=`<li><span data-ctx-id="${o}">${e}</span></li>`,o++)}),t+=`</ul>`,$(`#${e}`).remove(),$("body").append(t)},doInitActionContextMenu(e,n){ContextUtil.doInitContextMenu(e,(e,_,t,o)=>{const i=+o.data("ctx-id");n.filter(Boolean)[i].action(e,t)},n)},doTeardownContextMenu(e){delete ContextUtil._ctxInit[e],delete ContextUtil._ctxClick[e],delete ContextUtil._ctxOpenRefs[e],$(`#${e}`).remove()},handleOpenContextMenu:(n,_,t,o,i)=>{n.preventDefault(),n.stopPropagation();const a=ContextUtil._ctxOpenRefsNextId++;(ContextUtil._ctxOpenRefs[t]=ContextUtil._ctxOpenRefs[t]||{})[a]=o||(()=>{});const r=$(`#${t}`).show().css({position:"absolute",left:ContextUtil._getMenuPosition(t,n.clientX,"width","scrollLeft"),top:ContextUtil._getMenuPosition(t,n.clientY,"height","scrollTop")}).off("click").on("click","span",function(o){r.hide(),ContextUtil._ctxOpenRefs[t][a]&&ContextUtil._ctxOpenRefs[t][a](!0),delete ContextUtil._ctxOpenRefs[t][a];const e=$(n.target).closest(`li.row`),s=$(o.target),d=+s.data("ctx-id");ContextUtil._ctxClick[t](o,_,e,s,isNaN(d)?null:d,i)})},Action:function(e,n,_){_=_||{},this.text=e,this.action=n,this.isDisabled=_.isDisabled,this.helpText=_.helpText,this.style=_.style}},SearchUtil={removeStemmer(e){const n=elasticlunr.Pipeline.getRegisteredFunction("stemmer");e.pipeline.remove(n)}},ListUtil={SUB_HASH_PREFIX:"sublistselected",bindEscapeKey(e,n,_){(!e._isBoundEscape||_)&&(_&&n.off("keydown.search5e"),e._isBoundEscape=!0,n.on("keydown.search5e",_=>{27===_.which&&setTimeout(()=>{n.blur().val(""),e.search(n.val())},0)}))},_firstInit:!0,initList(e){const n=$("#lst__search"),_=$(`ul.list.${e.listClass}`),t=new List({$iptSearch:n,$wrpList:_,...e});$("#reset").click(function(){n.val(""),t.reset()});const o=$(`#lst__search-glass`).click(()=>n.val("").change().keydown().keyup()),i=MiscUtil.throttle(()=>{setTimeout(()=>{n.val().length?o.removeClass("no-events").addClass("clickable").title("Clear").html(`<span class="glyphicon glyphicon-remove"/>`):o.addClass("no-events").removeClass("clickable").title(null).html(`<span class="glyphicon glyphicon-search"/>`)})},50);if(n.on("keydown",i),ListUtil.bindEscapeKey(t,n),ListUtil._firstInit){ListUtil._firstInit=!1;const e=$(`.page__subtitle`);e.html(`${e.html()} Press J/K to navigate rows.`),ListUtil._initList_bindWindowHandlers()}return t},_initList_scrollToItem(){const e=Hist.getSelectedListElementWithLocation();if(e){const n=$(e.item.ele),_=n.parent(),t=_.scrollTop(),o=_.height(),i=n.position().top,a=n.height();0>i?n[0].scrollIntoView():i+a>o&&_.scrollTop(t+(i-o+a))}},_initList_bindWindowHandlers(){$(window).on("keypress",n=>{if(noModifierKeys(n)&&("k"===n.key||"j"===n.key)){if(MiscUtil.isInInput(n))return;const e=Hist.getSelectedListElementWithLocation();if(e)if("k"===n.key){const n=$(e.item.ele).prev().find("a").attr("href");if(void 0!==n)window.location.hash=n,ListUtil._initList_scrollToItem();else{const n=ListUtil.getPrimaryLists();for(let _=e.x;0<=--_;){const e=n[_];if(e.visibleItems.length){const n=$(e.visibleItems[e.visibleItems.length-1].ele).find("a").attr("href");return void(n&&(window.location.hash=n,ListUtil._initList_scrollToItem()))}}}const _=$(e.item.ele).closest(`ul`).parent().prev(`li`).find(`ul li`).last().find("a").attr("href");_&&(window.location.hash=_)}else if("j"===n.key){const n=$(e.item.ele).next().find("a").attr("href");if(void 0!==n)window.location.hash=n,ListUtil._initList_scrollToItem();else{const n=ListUtil.getPrimaryLists();for(let _=e.x;++_<n.length;){const e=n[_];if(e.visibleItems.length){const n=$(e.visibleItems[0].ele).find("a").attr("href");return void(n&&(window.location.hash=n,ListUtil._initList_scrollToItem()))}}}const _=$(e.item.ele).closest(`ul`).parent().next(`li`).find(`ul li`).first().find("a").attr("href");_&&(window.location.hash=_)}}})},updateSelected(){const e=Hist.getSelectedListItem();ListUtil._primaryLists.forEach(n=>n.updateSelected(e))},openContextMenu(e,n,_){const t=ListUtil._primaryLists.map(e=>({l:e,selected:e.getSelected()}));let o;if(t.some(e=>e.selected.length)){const e=t.some(e=>e.selected.some(e=>e===_));e?o=t.map(e=>e.selected).flat():(ListUtil._primaryLists.forEach(e=>e.deselectAll()),n.doSelect(_),o=[_])}else n.doSelect(_),o=[_];ContextUtil.handleOpenContextMenu(e,_.ele,"list",null,o)},openSubContextMenu(e,n){ContextUtil.handleOpenContextMenu(e,n.ele,"listSub",null,[n])},$sublistContainer:null,sublist:null,_sublistChangeFn:null,_pCustomHashHandler:null,_allItems:null,_primaryLists:[],_pinned:{},initSublist(e){void 0!==e.itemList&&(ListUtil._allItems=e.itemList),delete e.itemList,void 0!==e.getSublistRow&&(ListUtil._getSublistRow=e.getSublistRow),delete e.getSublistRow,void 0!==e.onUpdate&&(ListUtil._sublistChangeFn=e.onUpdate),delete e.onUpdate,void 0!==e.primaryLists&&(ListUtil._primaryLists=e.primaryLists),delete e.primaryLists,void 0!==e.customHashHandler&&(ListUtil._pCustomHashHandler=e.customHashHandler),delete e.customHashHandler,void 0!==e.customHashUnpacker&&(ListUtil._customHashUnpackFn=e.customHashUnpacker),delete e.customHashUnpacker,ListUtil.$sublistContainer=$("#sublistcontainer");const n=$(`ul.${e.listClass}`),_=new List({...e,$wrpList:n,isUseJquery:!0});return ListUtil.sublist=_,ListUtil.$sublistContainer.hasClass(`sublist--resizable`)&&ListUtil._pBindSublistResizeHandlers(ListUtil.$sublistContainer),_},setOptions(e){e.itemList!==void 0&&(ListUtil._allItems=e.itemList),e.getSublistRow!==void 0&&(ListUtil._getSublistRow=e.getSublistRow),e.onUpdate!==void 0&&(ListUtil._sublistChangeFn=e.onUpdate),e.primaryLists!==void 0&&(ListUtil._primaryLists=e.primaryLists),e.customHashHandler!==void 0&&(ListUtil._pCustomHashHandler=e.customHashHandler),e.customHashUnpacker!==void 0&&(ListUtil._customHashUnpackFn=e.customHashUnpacker)},getPrimaryLists(){return this._primaryLists},__mouseMoveId:1,async _pBindSublistResizeHandlers(e){function n(n){const _=n.clientY-o;o=n.clientY,e.css("height",parseInt(e.css("height"))+_)}const _=ListUtil.__mouseMoveId++,t=$(document);let o;e.on("mousedown",i=>{1===i.which&&i.target===e[0]&&(i.preventDefault(),i.offsetY>e.height()-3&&(o=i.clientY,t.on(`mousemove.sublist_resize-${_}`,n)))}),t.on("mouseup",n=>{1===n.which&&($(document).off(`mousemove.sublist_resize-${_}`),StorageUtil.pSetForPage("SUBLIST_RESIZE",e.css("height")))});const i=await StorageUtil.pGetForPage("SUBLIST_RESIZE");i&&e.css("height",i)},getOrTabRightButton:(e,n)=>{let _=$(`#${e}`);return _.length||(_=$(`<button class="stat-tab btn btn-default" id="${e}"><span class="glyphicon glyphicon-${n}"></span></button>`).appendTo($(`#tabs-right`))),_},bindPinButton:()=>{ListUtil.getOrTabRightButton(`btn-pin`,`pushpin`).off("click").on("click",()=>{ListUtil.isSublisted(Hist.lastLoadedId)?ListUtil.pDoSublistRemove(Hist.lastLoadedId):ListUtil.pDoSublistAdd(Hist.lastLoadedId,!0)}).title("Pin (Toggle)")},genericAddButtonHandler(e,n={}){e.shiftKey?ListUtil.pDoSublistAdd(Hist.lastLoadedId,!0,n.shiftCount||20):ListUtil.pDoSublistAdd(Hist.lastLoadedId,!0)},bindAddButton:(e,n={})=>{ListUtil.getOrTabRightButton(`btn-sublist-add`,`plus`).off("click").title(`Add (SHIFT for ${n.shiftCount||20})`).on("click",e?e():ListUtil.genericAddButtonHandler)},genericSubtractButtonHandler(e,n={}){e.shiftKey?ListUtil.pDoSublistSubtract(Hist.lastLoadedId,n.shiftCount||20):ListUtil.pDoSublistSubtract(Hist.lastLoadedId)},bindSubtractButton:(e,n={})=>{ListUtil.getOrTabRightButton(`btn-sublist-subtract`,`minus`).off("click").title(`Subtract (SHIFT for ${n.shiftCount||20})`).on("click",e?e():ListUtil.genericSubtractButtonHandler)},bindDownloadButton:()=>{const e=ListUtil.getOrTabRightButton(`btn-sublist-download`,`download`);e.off("click").on("click",async n=>{if(n.shiftKey){const n=JSON.stringify(ListUtil.getExportableSublist()),_=[window.location.href,UrlUtil.packSubHash(ListUtil.SUB_HASH_PREFIX,[n],{isEncodeBoth:!0})];await MiscUtil.pCopyTextToClipboard(_.join(HASH_PART_SEP)),JqueryUtil.showCopiedEffect(e)}else DataUtil.userDownload(ListUtil._getDownloadName(),JSON.stringify(ListUtil.getExportableSublist(),null,"\t"))}).title("Download List (SHIFT for Link)")},async pDoJsonLoad(e,n){await ListUtil._pLoadSavedSublist(e.items,n),await ListUtil._pFinaliseSublist()},bindUploadButton:e=>{const n=ListUtil.getOrTabRightButton(`btn-sublist-upload`,`upload`);n.off("click").on("click",n=>{function _(n,_){const t=n.target,i=new FileReader;i.onload=async()=>{const n=i.result,t=JSON.parse(n);o.remove(),e&&(await e(t)),await ListUtil.pDoJsonLoad(t,_)},i.readAsText(t.files[0])}const t=n.shiftKey,o=$(`<input type="file" accept=".json" style="position: fixed; top: -100px; left: -100px; display: none;">`).on("change",e=>_(e,t)).appendTo($(`body`));o.click()}).title("Upload List (SHIFT for Add Only)")},async pSetFromSubHashes(e,n){const _={};e.forEach(e=>Object.assign(_,UrlUtil.unpackSubHash(e,!0)));const t=_[ListUtil.SUB_HASH_PREFIX];if(t){const e=JSON.parse(t);n&&(await n(e)),await ListUtil._pLoadSavedSublist(e.items,!1),await ListUtil._pFinaliseSublist();const[o,...i]=Hist.getHashParts(),a=[];Object.keys(_).filter(e=>e!==ListUtil.SUB_HASH_PREFIX).forEach(e=>{a.push(`${e}${HASH_SUB_KV_SEP}${_[e].join(HASH_SUB_LIST_SEP)}`)}),Hist.setSuppressHistory(!0),window.location.hash=`#${o}${a.length?`${HASH_PART_SEP}${a.join(HASH_PART_SEP)}`:""}`}},_getPinnedCount(e,n){const _=ListUtil._pinned[e];return _?n&&n.customHashId?_[n.customHashId]:_._:null},_setPinnedCount(e,n,_){const t=ListUtil._pinned[e],o=_&&_.customHashId?_.customHashId:"_";t?t[o]=n:(ListUtil._pinned[e]={})[o]=n},_deletePinnedCount(e,n){const _=ListUtil._pinned[e];_&&(n&&n.customHashId?delete _[n.customHashId]:delete _._)},async pDoSublistAdd(e,n,_,t){if(null==e)return JqueryUtil.doToast({content:"Please first view something from the list.",type:"danger"});const o=ListUtil._getPinnedCount(e,t)||0;if(_=_||1,ListUtil._setPinnedCount(e,o+_,t),0!==o)ListUtil._setViewCount(e,o+_,t),n&&(await ListUtil._pFinaliseSublist());else{const o=await ListUtil._getSublistRow(ListUtil._allItems[e],e,_,t);ListUtil.sublist.addItem(o),n&&(await ListUtil._pFinaliseSublist())}},async pDoSublistSubtract(e,n,_){const t=ListUtil._getPinnedCount(e,_);n=n||1,t>n?(ListUtil._setPinnedCount(e,t-n,_),ListUtil._setViewCount(e,t-n,_),ListUtil.sublist.update(),await ListUtil._pSaveSublist(),ListUtil._handleCallUpdateFn()):t&&(await ListUtil.pDoSublistRemove(e,_))},getSublisted(){const e=MiscUtil.copy(ListUtil._pinned),n={};return Object.keys(e).filter(n=>Object.keys(e[n]).length).forEach(_=>n[_]=e[_]),n},getSublistedIds(){return Object.keys(ListUtil._pinned).filter(e=>Object.keys(ListUtil._pinned[e]).length).map(e=>+e)},_setViewCount:(e,n,_)=>{let t;t=_&&null!=_.customHashId?ListUtil.sublist.items.find(e=>e.data.customHashId===_.customHashId):ListUtil.sublist.items.find(n=>n.ix===e),t.values.count=n,t.data.$elesCount.forEach(e=>{e.is("input")?e.val(n):e.text(n)})},async _pFinaliseSublist(e){ListUtil.sublist.update(),ListUtil._updateSublistVisibility(),e||(await ListUtil._pSaveSublist()),ListUtil._handleCallUpdateFn()},getExportableSublist:()=>{const e=new Set,n=ListUtil.sublist.items.map(n=>(e.add(ListUtil._allItems[n.ix].source),{h:n.values.hash.split(HASH_PART_SEP)[0],c:n.values.count||void 0,customHashId:n.data.customHashId}));return{items:n,sources:Array.from(e)}},async _pSaveSublist(){await StorageUtil.pSetForPage("sublist",ListUtil.getExportableSublist())},_updateSublistVisibility:()=>{ListUtil.sublist.items.length?ListUtil.$sublistContainer.addClass("sublist--visible"):ListUtil.$sublistContainer.removeClass("sublist--visible")},async pDoSublistRemove(e,n){ListUtil._deletePinnedCount(e,n),n&&n.customHashId?ListUtil.sublist.removeItemBy("customHashId",n.customHashId):ListUtil.sublist.removeItem(e),ListUtil.sublist.update(),ListUtil._updateSublistVisibility(),await ListUtil._pSaveSublist(),ListUtil._handleCallUpdateFn()},async pDoSublistRemoveAll(e){ListUtil._pinned={},ListUtil.sublist.removeAllItems(),ListUtil.sublist.update(),ListUtil._updateSublistVisibility(),e||(await ListUtil._pSaveSublist()),ListUtil._handleCallUpdateFn()},isSublisted:(e,n)=>ListUtil._getPinnedCount(e,n),mapSelectedWithDeslect(e,n){return e.getSelected().map(e=>{e.isSelected=!1,n(e.ix)})},_handleCallUpdateFn:()=>{ListUtil._sublistChangeFn&&ListUtil._sublistChangeFn()},_hasLoadedState:!1,async pLoadState(){if(!ListUtil._hasLoadedState){ListUtil._hasLoadedState=!0;try{const e=await StorageUtil.pGetForPage("sublist");e&&e.items&&ListUtil._pLoadSavedSublist(e.items)}catch(n){setTimeout(()=>{throw n}),await StorageUtil.pRemoveForPage("sublist")}}},async _pLoadSavedSublist(e,n){n||(await ListUtil.pDoSublistRemoveAll(!0));const _=e.map(e=>{const n=Hist.getActiveListItem(e.h);if(null!=n){const _={index:n.ix,addCount:+e.c};return ListUtil._customHashUnpackFn&&e.customHashId&&(_.data=ListUtil._customHashUnpackFn(e.customHashId)),_}return null}).filter(e=>e);for(const t of _)await ListUtil.pDoSublistAdd(t.index,!1,t.addCount,t.data);await ListUtil._pFinaliseSublist(!0)},async pGetSelectedSources(){let e;try{e=await StorageUtil.pGetForPage("sublist")}catch(n){setTimeout(()=>{throw n})}if(e&&e.sources)return e.sources},initGenericPinnable(){ContextUtil.doInitContextMenu("list",ListUtil.handleGenericContextMenuClick,["Popout","Pin"]),ContextUtil.doInitContextMenu("listSub",ListUtil.handleGenericSubContextMenuClick,["Popout","Unpin","Clear Pins",null,"Roll on List",null,"Download JSON Data"])},initGenericAddable(){ContextUtil.doInitContextMenu("list",ListUtil.handleGenericMultiContextMenuClick,["Popout","Add"]),ContextUtil.doInitContextMenu("listSub",ListUtil.handleGenericMultiSubContextMenuClick,["Popout","Remove","Clear List",null,"Roll on List",null,"Download JSON Data"])},handleGenericContextMenuClick:(e,n,t,o,i,_)=>{switch(+o.data("ctx-id")){case 0:ListUtil._handleGenericContextMenuClick_pDoMassPopout(e,n,t,_);break;case 1:Promise.all(ListUtil._primaryLists.map(e=>Promise.all(ListUtil.mapSelectedWithDeslect(e,e=>ListUtil.isSublisted(e)?Promise.resolve():ListUtil.pDoSublistAdd(e))))).then(async()=>ListUtil._pFinaliseSublist());}},handleGenericSubContextMenuClick:(e,n,t,o,i,_)=>{switch(+o.data("ctx-id")){case 0:ListUtil._handleGenericContextMenuClick_pDoMassPopout(e,n,t,_);break;case 1:_.forEach(e=>ListUtil.pDoSublistRemove(e.ix));break;case 2:ListUtil.pDoSublistRemoveAll();break;case 3:ListUtil._rollSubListed();break;case 4:ListUtil._handleJsonDownload();}},handleGenericMultiContextMenuClick:(e,n,t,o,i,_)=>{switch(+o.data("ctx-id")){case 0:ListUtil._handleGenericContextMenuClick_pDoMassPopout(e,n,t,_);break;case 1:Promise.all(ListUtil._primaryLists.map(e=>Promise.all(ListUtil.mapSelectedWithDeslect(e,e=>ListUtil.pDoSublistAdd(e))))).then(async()=>{await ListUtil._pFinaliseSublist(),ListUtil.updateSelected()});}},handleGenericMultiSubContextMenuClick:(e,n,t,o,i,_)=>{switch(+o.data("ctx-id")){case 0:ListUtil._handleGenericContextMenuClick_pDoMassPopout(e,n,t,_);break;case 1:{_.forEach(e=>{e.data.customHashId?ListUtil.pDoSublistRemove(e.ix,{customHashId:e.data.customHashId}):ListUtil.pDoSublistRemove(e.ix)});break}case 2:ListUtil.pDoSublistRemoveAll();break;case 3:ListUtil._rollSubListed();break;case 4:ListUtil._handleJsonDownload();}},async _handleGenericContextMenuClick_pDoMassPopout(e,n,_,t){const o=UrlUtil.getCurrentPage(),a=n.getBoundingClientRect();for(let r=0;r<t.length;++r){const e=t[r],n=ListUtil._allItems[e.ix],_=UrlUtil.autoEncodeHash(n),i=Renderer.hover._BAR_HEIGHT*r;Renderer.hover.getShowWindow(Renderer.hover.$getHoverContent_stats(UrlUtil.getCurrentPage(),n),{mode:"exact",x:a.x+i,y:a.y+i},{title:n.name,isPermanent:!0,pageUrl:`${o}#${_}`})}},_isRolling:!1,_rollSubListed(){function e(e,n){const _=[RollerUtil.rollOnArray(e)];for(let t,o=0;o<n;++o){for(t=RollerUtil.rollOnArray(e);t===_.last();)t=RollerUtil.rollOnArray(e);_.push(t)}return _}const n=RollerUtil.randomise(125,75),_=[0,1,1,1,1,1,1.5,1.5,1.5,2,2,2,2.5,3,4,-1].map(e=>e*n).slice(0,-RollerUtil.randomise(4,1));if(!ListUtil._isRolling){ListUtil._isRolling=!0;const n=ListUtil.sublist.items.map(e=>$(e.ele).find(`a`));if(1>=n.length)return JqueryUtil.doToast({content:"Not enough entries to roll!",type:"danger"}),ListUtil._isRolling=!1;const t=e(n,_.length);let o=0;_.map((e,n)=>{o+=e,setTimeout(()=>{t[n][0].click(),n===_.length-1&&(ListUtil._isRolling=!1)},o)})}},_getDownloadName(){return`${UrlUtil.getCurrentPage().replace(".html","")}-sublist`},genericPinKeyMapper(e=ListUtil._pCustomHashHandler){return Object.entries(ListUtil.getSublisted()).map(([n,_])=>Object.keys(_).map(_=>{const t=ListUtil._allItems[n];return"_"===_?Promise.resolve(MiscUtil.copy(t)):e(t,_)}).reduce((e,n)=>e.concat(n),[])).reduce((e,n)=>e.concat(n),[])},_handleJsonDownload(){if(ListUtil._pCustomHashHandler){const e=ListUtil.genericPinKeyMapper();Promise.all(e).then(e=>{e.forEach(e=>DataUtil.cleanJson(e)),DataUtil.userDownload(`${ListUtil._getDownloadName()}-data`,e)})}else{const e=ListUtil.getSublistedIds().map(e=>{const n=JSON.parse(JSON.stringify(ListUtil._allItems[e]));return DataUtil.cleanJson(n),n});DataUtil.userDownload(`${ListUtil._getDownloadName()}-data`,e)}},getCompleteFilterSources(e){return e.otherSources?[e.source].concat(e.otherSources.map(e=>new FilterItem({item:e.source,isIgnoreRed:!0}))):e.source},bindShowTableButton(e,n,_,t,o,i){$(`#${e}`).click("click",()=>ListUtil.showTable(n,_,t,o,i))},basicFilterGenerator(){const e=ListUtil.getSublistedIds();if(e.length){const n=new Set(e);return n.has.bind(n)}else{const e=new Set(ListUtil.getVisibleIds());return e.has.bind(e)}},getVisibleIds(){return ListUtil._primaryLists.map(e=>e.visibleItems.map(e=>e.ix)).flat()},showTable(e,n,_,t,o){function i(){const e=l.find(`input:checked`).map((n,_)=>$(_).data("name")).get(),n=s.find(`.data-row`).map((n,_)=>$(_)).get().map(e=>e.children().filter(`td:visible`).map((e,n)=>$(n).text().trim()).get());return DataUtil.getCsv(e,n)}const a=$(`<div class="modal__outer dropdown-menu"/>`),r=$(`<div class="modal__wrp">`).appendTo($(`body`)).click(()=>r.remove());a.appendTo(r);const s=$(`<div class="modal__inner"/>`).appendTo(a).click(e=>e.stopPropagation()),d=$(`<div class="split my-3"/>`).appendTo(s),l=$(`<div class="flex" style="align-items: center;"/>`).appendTo(d);Object.values(_).forEach((e,n)=>{const _=$(`<label class="flex-${e.flex||1} px-2 mr-2 no-wrap inline-flex">${e.name} </label>`).appendTo(l),t=$(`<input type="checkbox" class="ml-1" data-name="${e.name}" checked>`).click(()=>{const e=s.find(`.col_${n}`);t.prop("checked")?e.show():e.hide()}).appendTo(_)});const S=$(`<div/>`).appendTo(d),u=$(`<button class="btn btn-primary mr-3">Download CSV</button>`).click(()=>{DataUtil.userDownloadText(`${e}.csv`,i())}).appendTo(S),c=$(`<button class="btn btn-primary">Copy CSV to Clipboard</button>`).click(async()=>{await MiscUtil.pCopyTextToClipboard(i()),JqueryUtil.showCopiedEffect(c)}).appendTo(S);s.append(`<hr>`),"object"==typeof t&&t.generator&&(t=t.generator());let T=`<table class="table-striped stats stats--book stats--book-large" style="width: 100%;"><thead><tr>${Object.values(_).map((e,n)=>`<th class="col_${n} px-2" colspan="${e.flex||1}">${e.name}</th>`).join("")}</tr></thead><tbody>`;const O=JSON.parse(JSON.stringify(n)).filter((e,n)=>t?t(n):e);o&&O.sort(o),O.forEach(e=>{T+=`<tr class="data-row">`,T+=Object.keys(_).map((n,t)=>{const o=_[n];return`<td class="col_${t} px-2" colspan="${o.flex||1}">${!0===o.transform?e[n]:o.transform("_"===n[0]?e:e[n])}</td>`}).join(""),T+=`</tr>`}),T+=`</tbody></table>`,s.append(T)},addListShowHide(){$(`#filter-search-input-group`).find(`#reset`).before(`<button class="btn btn-default" id="hidesearch">Hide</button>`),$(`#contentwrapper`).prepend(`<div class="col-12" id="showsearch"><button class="btn btn-block btn-default btn-xs" type="button">Show Search</button><br></div>`);const e=$(`#listcontainer`),n=$("div#showsearch"),_=$("button#hidesearch");_.title("Hide Search Bar and Entry List"),_.click(function(){e.hide(),n.show(),_.hide()}),n.find("button").click(function(){e.show(),n.hide(),_.show()})}};function getAsiFilter(e){const n={header:"Ability Bonus",items:["str","dex","con","int","wis","cha"],displayFn:Parser.attAbvToFull,itemSortFn:null};return getFilterWithMergedOptions(n,e)}function getFilterWithMergedOptions(e,n){return n&&Object.assign(e,n),new Filter(e)}async function pInitFilterBox(e){e.$iptSearch=$(`#lst__search`),e.$wrpFormTop=$(`#filter-search-input-group`).title("Hotkey: f"),e.$btnReset=$(`#reset`);const n=new FilterBox(e);return await n.pDoLoadState(),n}UrlUtil={encodeForHash(e){return e instanceof Array?e.map(e=>`${e}`.toUrlified()).join(HASH_LIST_SEP):`${e}`.toUrlified()},autoEncodeHash(e){const n=UrlUtil.getCurrentPage(),_=UrlUtil.URL_TO_HASH_BUILDER[n];if(!_)throw new Error(`No encoder found for page ${n}`);return _(e)},getCurrentPage(){const e=window.location.pathname.split("/");let n=e[e.length-1];return n.toLowerCase().endsWith(".html")||(n+=".html"),n},link(e){function n(n){return e.includes("?")?`${n}&v=${VERSION_NUMBER}`:`${n}?v=${VERSION_NUMBER}`}if(!IS_VTT&&IS_DEPLOYED)return n(`${DEPLOYED_STATIC_ROOT}${e}`);return IS_DEPLOYED?n(e):e},unpackSubHash(e,n){if(e.includes(HASH_SUB_KV_SEP)){const _=e.split(HASH_SUB_KV_SEP).map(e=>e.trim()),t={};let o=_[0].toLowerCase();n&&(o=decodeURIComponent(o));let i=_[1].toLowerCase();return n&&(i=decodeURIComponent(i)),t[o]=i.split(HASH_SUB_LIST_SEP).map(e=>e.trim()),1===t[o].length&&t[o]===HASH_SUB_NONE&&(t[o]=[]),t}throw new Error(`Badly formatted subhash ${e}`)},packSubHash(e,n,_){return _=_||{},(_.isEncodeBoth||_.isEncodeKey)&&(e=e.toUrlified()),(_.isEncodeBoth||_.isEncodeValues)&&(n=n.map(e=>e.toUrlified())),`${e}${HASH_SUB_KV_SEP}${n.join(HASH_SUB_LIST_SEP)}`},categoryToPage(e){return UrlUtil.CAT_TO_PAGE[e]},bindLinkExportButton(e,n){n=n||ListUtil.getOrTabRightButton(`btn-link-export`,`magnet`),n.addClass("btn-copy-effect").off("click").on("click",async _=>{let t=window.location.href;const o=e.getSubHashes();if(o.unshift(t),_.shiftKey&&ListUtil.sublist){const e=JSON.stringify(ListUtil.getExportableSublist()),n=UrlUtil.packSubHash(ListUtil.SUB_HASH_PREFIX,[e],{isEncodeBoth:!0});o.push(n)}await MiscUtil.pCopyTextToClipboard(o.join(HASH_PART_SEP)),JqueryUtil.showCopiedEffect(n)}).title("Get Link to Filters (SHIFT adds List)")},mini:{compress(e){const n=typeof e;if(null==e)return`x`;switch(n){case"boolean":return`b${+e}`;case"number":return`n${e}`;case"string":return`s${e.toUrlified()}`;default:throw new Error(`Unhandled type "${n}"`);}},decompress(e){const[n,_]=[e.slice(0,1),e.slice(1)];switch(n){case"x":return null;case"b":return!!+_;case"n":return+_;case"s":return _+"";default:throw new Error(`Unhandled type "${n}"`);}}},class:{getIndexedEntries(e){const n=[];let _=0;return(e.classFeatures||[]).forEach((t,o)=>{t.filter(e=>!e.gainSubclassFeature&&"Ability Score Improvement"!==e.name).forEach((_,t)=>{const i=Renderer.findName(_);if(!i){if(BrewUtil.hasSourceJson(e.source))return;throw new Error("Class feature had no name!")}n.push({_type:"classFeature",source:e.source.source||e.source,name:i,hash:`${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e)}${HASH_PART_SEP}${UrlUtil.getClassesPageStatePart({feature:{ixLevel:o,ixFeature:t}})}`,entry:_,level:o+1})});const i=t.findIndex(e=>e.gainSubclassFeature);~i?(e.subclasses.forEach(t=>{const a=(t.subclassFeatures||[])[_]||[];t.source=t.source||e.source;const r=[];a.forEach(n=>{const _=`${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e)}${HASH_PART_SEP}${UrlUtil.getClassesPageStatePart({subclass:t,feature:{ixLevel:o,ixFeature:i}})}`,a=Renderer.findName(n);if(!a){if(BrewUtil.hasSourceJson(t.source))return;throw new Error("Subclass feature had no name!")}if(r.push({_type:"subclassFeature",name:a,subclassName:t.name,subclassShortName:t.shortName,source:t.source.source||t.source,hash:_,entry:n,level:o+1}),n.entries){const e=n.entries.filter(e=>e.name);e.forEach(e=>{const i=o+1;r.find(n=>e.name===n.name&&i===n.level)||r.push({_type:"subclassFeaturePart",name:e.name,subclassName:t.name,subclassShortName:t.shortName,source:t.source.source||t.source,hash:_,entry:n,level:i})})}}),n.push(...r)}),_++):1<i.length&&setTimeout(()=>{throw new Error(`Multiple subclass features gained at level ${o+1} for class "${e.name}" from source "${e.source}"!`)})}),n}},getStateKeySubclass(e){return Parser.stringToSlug(`sub ${e.shortName||e.name} ${Parser.sourceJsonToAbv(e.source)}`)},getClassesPageStatePart(e){const n=[e.subclass?`${UrlUtil.getStateKeySubclass(e.subclass)}=${UrlUtil.mini.compress(!0)}`:null,e.feature?`feature=${UrlUtil.mini.compress(`${e.feature.ixLevel}-${e.feature.ixFeature}`)}`:""].filter(Boolean);return n.length?UrlUtil.packSubHash("state",n):""}},UrlUtil.PG_BESTIARY="bestiary.html",UrlUtil.PG_SPELLS="spells.html",UrlUtil.PG_BACKGROUNDS="backgrounds.html",UrlUtil.PG_ITEMS="items.html",UrlUtil.PG_CLASSES="classes.html",UrlUtil.PG_CONDITIONS_DISEASES="conditionsdiseases.html",UrlUtil.PG_FEATS="feats.html",UrlUtil.PG_OPT_FEATURES="optionalfeatures.html",UrlUtil.PG_PSIONICS="psionics.html",UrlUtil.PG_RACES="races.html",UrlUtil.PG_REWARDS="rewards.html",UrlUtil.PG_VARIATNRULES="variantrules.html",UrlUtil.PG_ADVENTURE="adventure.html",UrlUtil.PG_ADVENTURES="adventures.html",UrlUtil.PG_BOOK="book.html",UrlUtil.PG_BOOKS="books.html",UrlUtil.PG_DEITIES="deities.html",UrlUtil.PG_CULTS_BOONS="cultsboons.html",UrlUtil.PG_OBJECTS="objects.html",UrlUtil.PG_TRAPS_HAZARDS="trapshazards.html",UrlUtil.PG_QUICKREF="quickreference.html",UrlUtil.PG_MAKE_SHAPED="makeshaped.html",UrlUtil.PG_MANAGE_BREW="managebrew.html",UrlUtil.PG_MAKE_BREW="makebrew.html",UrlUtil.PG_DEMO_RENDER="renderdemo.html",UrlUtil.PG_TABLES="tables.html",UrlUtil.PG_VEHICLES="vehicles.html",UrlUtil.PG_CHARACTERS="characters.html",UrlUtil.PG_ACTIONS="actions.html",UrlUtil.PG_LANGUAGES="languages.html",UrlUtil.URL_TO_HASH_BUILDER={},UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BESTIARY]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_SPELLS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BACKGROUNDS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ITEMS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CONDITIONS_DISEASES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_FEATS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_OPT_FEATURES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_PSIONICS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_RACES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_REWARDS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_VARIATNRULES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ADVENTURE]=e=>UrlUtil.encodeForHash(e.id),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_BOOK]=e=>UrlUtil.encodeForHash(e.id),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_DEITIES]=e=>UrlUtil.encodeForHash([e.name,e.pantheon,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CULTS_BOONS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_OBJECTS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_TRAPS_HAZARDS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_TABLES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_VEHICLES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ACTIONS]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_LANGUAGES]=e=>UrlUtil.encodeForHash([e.name,e.source]),UrlUtil.CAT_TO_PAGE={},UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CREATURE]=UrlUtil.PG_BESTIARY,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_SPELL]=UrlUtil.PG_SPELLS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_BACKGROUND]=UrlUtil.PG_BACKGROUNDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ITEM]=UrlUtil.PG_ITEMS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CLASS]=UrlUtil.PG_CLASSES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CLASS_FEATURE]=UrlUtil.PG_CLASSES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_SUBCLASS]=UrlUtil.PG_CLASSES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_SUBCLASS_FEATURE]=UrlUtil.PG_CLASSES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CONDITION]=UrlUtil.PG_CONDITIONS_DISEASES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_FEAT]=UrlUtil.PG_FEATS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ELDRITCH_INVOCATION]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_METAMAGIC]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_MANEUVER_BATTLEMASTER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_MANEUVER_CAVALIER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ARCANE_SHOT]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_OPTIONAL_FEATURE_OTHER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_FIGHTING_STYLE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_PSIONIC]=UrlUtil.PG_PSIONICS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_RACE]=UrlUtil.PG_RACES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_OTHER_REWARD]=UrlUtil.PG_REWARDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_VARIANT_OPTIONAL_RULE]=UrlUtil.PG_VARIATNRULES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ADVENTURE]=UrlUtil.PG_ADVENTURE,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_DEITY]=UrlUtil.PG_DEITIES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_OBJECT]=UrlUtil.PG_OBJECTS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_TRAP]=UrlUtil.PG_TRAPS_HAZARDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_HAZARD]=UrlUtil.PG_TRAPS_HAZARDS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_QUICKREF]=UrlUtil.PG_QUICKREF,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_CULT]=UrlUtil.PG_CULTS_BOONS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_BOON]=UrlUtil.PG_CULTS_BOONS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_DISEASE]=UrlUtil.PG_CONDITIONS_DISEASES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_TABLE]=UrlUtil.PG_TABLES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_TABLE_GROUP]=UrlUtil.PG_TABLES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_VEHICLE]=UrlUtil.PG_VEHICLES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_PACT_BOON]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ELEMENTAL_DISCIPLINE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ARTIFICER_INFUSION]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_SHIP_UPGRADE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_INFERNAL_WAR_MACHINE_UPGRADE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ONOMANCY_RESONANT]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_RUNE_KNIGHT_RUNE]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ALCHEMICAL_FORMULA]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_MANEUVER]=UrlUtil.PG_OPT_FEATURES,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_ACTION]=UrlUtil.PG_ACTIONS,UrlUtil.CAT_TO_PAGE[Parser.CAT_ID_LANGUAGE]=UrlUtil.PG_LANGUAGES,IS_DEPLOYED||IS_VTT||"undefined"==typeof window||window.addEventListener("keypress",n=>{if(noModifierKeys(n)&&"undefined"==typeof d20&&"#"===n.key){const e=window.location.href.split("/");window.prompt("Copy to clipboard: Ctrl+C, Enter",`https://noads.5e.tools/${e[e.length-1]}`)}}),SortUtil={ascSort:(e,n)=>("undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),n instanceof FilterItem&&(n=n.item)),SortUtil._ascSort(e,n)),ascSortProp:(e,n,_)=>SortUtil.ascSort(n[e],_[e]),ascSortLower:(e,n)=>("undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),n instanceof FilterItem&&(n=n.item)),SortUtil._ascSort(e.toLowerCase(),n.toLowerCase())),ascSortLowerProp:(e,n,_)=>SortUtil.ascSortLower(n[e],_[e]),ascSortNumericalSuffix(e,n){function _(e){const n=e.split(" ");return n.last().isNumeric()?[n.slice(0,-1).join(" "),+n.last().replace(Parser._numberCleanRegexp,"")]:[n.join(" "),0]}"undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),n instanceof FilterItem&&(n=n.item));const[t,o]=_(e.item||e),[i,r]=_(n.item||n),s=SortUtil.ascSort(t,i);return s?s:SortUtil.ascSort(o,r)},_ascSort:(e,n)=>n===e?0:n<e?1:-1,ascSortDate(e,n){return n.getTime()-e.getTime()},ascSortDateString(e,n){return SortUtil.ascSortDate(new Date(e||"1970-01-0"),new Date(n||"1970-01-0"))},compareListNames(e,n){return SortUtil._ascSort(e.name.toLowerCase(),n.name.toLowerCase())},listSort(e,n,_){return _=_||{sortBy:"name"},"name"===_.sortBy?SortUtil.compareListNames(e,n):SortUtil._compareByOrDefault_compareByOrDefault(e,n,_.sortBy)},_listSort_compareBy(e,n,_){const t="string"==typeof e.values[_]?e.values[_].toLowerCase():e.values[_],o="string"==typeof n.values[_]?n.values[_].toLowerCase():n.values[_];return SortUtil._ascSort(t,o)},_compareByOrDefault_compareByOrDefault(e,n,_){return SortUtil._listSort_compareBy(e,n,_)||SortUtil.compareListNames(e,n)},_MON_TRAIT_ORDER:["special equipment","shapechanger"],monTraitSort:(e,n)=>{if(!e&&!n)return 0;const _=e.toLowerCase().trim(),t=n.toLowerCase().trim(),o=SortUtil._MON_TRAIT_ORDER.indexOf(_),i=SortUtil._MON_TRAIT_ORDER.indexOf(t);return~o&&~i?o-i:~o?-1:~i?1:SortUtil.ascSort(_,t)},_alignFirst:["L","C"],_alignSecond:["G","E"],alignmentSort:(e,n)=>e===n?0:SortUtil._alignFirst.includes(e)?-1:SortUtil._alignSecond.includes(e)?1:SortUtil._alignFirst.includes(n)?1:SortUtil._alignSecond.includes(n)?-1:0,ascSortCr(e,n){return"undefined"!=typeof FilterItem&&(e instanceof FilterItem&&(e=e.item),n instanceof FilterItem&&(n=n.item)),("Unknown"===e||void 0===e)&&(e="999"),("Unknown"===n||void 0===n)&&(n="999"),SortUtil.ascSort(Parser.crToNumber(e),Parser.crToNumber(n))},ascSortAtts(e,n){const _="special"===e,t="special"===n;return _&&t?0:_?1:t?-1:Parser.ABIL_ABVS.indexOf(e)-Parser.ABIL_ABVS.indexOf(n)},initBtnSortHandlers(e,n){function _(n,_){e.find(".caret").removeClass("caret"),n.find(".caret_wrp").addClass("caret").toggleClass("caret--reverse","asc"===_)}const t=e.find(`.sort[data-sort="${n.sortBy}"]`);_(t,n.sortDir),e.find(".sort").each((t,o)=>{const e=$(o);e.click(t=>{t.stopPropagation();const o="asc"===n.sortDir?"desc":"asc";_(e,o),n.sort(e.data("sort"),o)})})}},DataUtil={_loading:{},_loaded:{},_merging:{},_merged:{},async _pLoad(n){return DataUtil._loading[n]?(await DataUtil._loading[n],DataUtil._loaded[n]):(DataUtil._loading[n]=new Promise((e,_)=>{const t=new XMLHttpRequest;t.open("GET",n,!0),t.overrideMimeType("application/json"),t.onload=function(){try{DataUtil._loaded[n]=JSON.parse(this.response),e()}catch(t){_(new Error(`Could not parse JSON from ${n}: ${t.message}`))}},t.onerror=n=>_(new Error(`Error during JSON request: ${n.target.status}`)),t.send()}),await DataUtil._loading[n],DataUtil._loaded[n])},async loadJSON(e,...n){const _=UrlUtil.link(e);let t,o=_;try{t=await DataUtil._pLoad(_)}catch(n){setTimeout(()=>{throw n})}return t||(o=e,t=await DataUtil._pLoad(e)),await DataUtil.pDoMetaMerge(o,t),t},async pDoMetaMerge(e,n,_){return DataUtil._merging[e]=DataUtil._merging[e]||DataUtil._pDoMetaMerge(e,n,_),await DataUtil._merging[e],DataUtil._merged[e]},async _pDoMetaMerge(e,n,_){n._meta&&(n._meta.dependencies&&(await Promise.all(Object.entries(n._meta.dependencies).map(async([e,t])=>{if(!n[e])return;const o=await Promise.all(t.map(async n=>DataUtil.pGetLoadableByMeta(e,n))),i=await Promise.all(o.map(e=>DataUtil.loadJSON(e))),a=i.map(n=>n[e]).flat();await Promise.all(n[e].map(async n=>{if(n._copy)switch(e){case"monster":return DataUtil.monster.pMergeCopy(a,n,_);case"spell":return DataUtil.spell.pMergeCopy(a,n,_);default:throw new Error(`No dependency _copy merge strategy specified for property "${e}"`);}}))})),delete n._meta.dependencies),n._meta.internalCopies&&(Promise.all(n._meta.internalCopies.map(async e=>{n[e]&&(await Promise.all(n[e].map(async t=>{if(t._copy)switch(e){case"monster":return DataUtil.monster.pMergeCopy(n[e],t,_);case"spell":return DataUtil.spell.pMergeCopy(n[e],t,_);case"item":return DataUtil.item.pMergeCopy(n[e],t,_);case"background":return DataUtil.background.pMergeCopy(n[e],t,_);case"race":return DataUtil.race.pMergeCopy(n[e],t,_);default:throw new Error(`No internal _copy merge strategy specified for property "${e}"`);}})))})),delete n._meta.internalCopies)),n._meta&&n._meta.otherSources&&(await Promise.all(Object.entries(n._meta.otherSources).map(async([e,_])=>{const t=await Promise.all(Object.entries(_).map(async([n,_])=>({findWith:_,url:await DataUtil.pGetLoadableByMeta(e,n)}))),o=await Promise.all(t.map(async({findWith:e,url:n})=>({findWith:e,sourceData:await DataUtil.loadJSON(n)})));o.forEach(_=>{const t=_.findWith,o=_.sourceData,i=o[e].filter(e=>e.otherSources&&e.otherSources.find(e=>e.source===t));i.length&&(n[e]=(n[e]||[]).concat(i))})})),delete n._meta.otherSources),DataUtil._merged[e]=n},userDownload:function(e,n){"string"!=typeof n&&(n=JSON.stringify(n,null,"\t"));const _=document.createElement("a"),o=new Blob([n],{type:"text/json"});_.href=URL.createObjectURL(o),_.download=`${e}.json`,document.body.appendChild(_),_.click(),document.body.removeChild(_)},getCleanFilename(e){return e.replace(/[^-_a-zA-Z0-9]/g,"_")},getCsv(e,n){function _(e){return`"${e.replace(/"/g,`""`).replace(/ +/g," ").replace(/\n\n+/gi,"\n\n")}"`}function t(e){return e.map(e=>_(e)).join(",")}return`${t(e)}\n${n.map(e=>t(e)).join("\n")}`},userDownloadText(e,n){const _=$(`<a href="data:text/plain;charset=utf-8,${encodeURIComponent(n)}" download="${e}" style="display: none;">DL</a>`);$(`body`).append(_),_[0].click(),_.remove()},pUserUpload(){return new Promise(e=>{const n=$(`<input type="file" accept=".json" style="position: fixed; top: -100px; left: -100px; display: none;">`).on("change",n=>{const _=n.target,t=new FileReader;t.onload=()=>{const n=t.result,_=JSON.parse(n);e(_)},t.readAsText(_.files[0])}).appendTo($(`body`));n.click()})},cleanJson(e){return e.name=e._displayName||e.name,DataUtil.__cleanJsonObject(e),e},__cleanJsonObject(e){return null==e?e:void("object"==typeof e&&(e instanceof Array?e.forEach(e=>DataUtil.__cleanJsonObject(e)):Object.entries(e).forEach(([n,_])=>{n.startsWith("_")||"customHashId"===n?delete e[n]:DataUtil.__cleanJsonObject(_)})))},async pGetLoadableByMeta(e,n){switch(e){case"monster":{const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/bestiary/index.json`);if(!e[n])throw new Error(`Bestiary index did not contain source "${n}"`);return`${Renderer.get().baseUrl}data/bestiary/${e[n]}`}case"spell":{const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/spells/index.json`);if(!e[n])throw new Error(`Spell index did not contain source "${n}"`);return`${Renderer.get().baseUrl}data/spells/${e[n]}`}default:throw new Error(`Could not get loadable URL for \`${JSON.stringify({key:e,value:n})}\``);}},generic:{async _pMergeCopy(e,n,_,t,o){if(t._copy){const i=UrlUtil.URL_TO_HASH_BUILDER[n](t._copy),a=e._mergeCache[i]||DataUtil.generic._pMergeCopy_search(e,n,_,t);return a?DataUtil.generic._pApplyCopy(e,MiscUtil.copy(a),t,o):void 0}},_pMergeCopy_search(e,n,_,t){return _.find(_=>(e._mergeCache[UrlUtil.URL_TO_HASH_BUILDER[n](_)]=_,_.name===t._copy.name&&_.source===t._copy.source))},async _pApplyCopy(impl,copyFrom,copyTo,options={}){var _Mathfloor5=Math.floor;function normaliseMods(e){Object.entries(e._mod).forEach(([n,_])=>{_ instanceof Array||(e._mod[n]=[_])})}function doEnsureArray(e,n){e[n]instanceof Array||(e[n]=[e[n]])}function doMod_appendStr(e,n){copyTo[n]=copyTo[n]?`${copyTo[n]}${e.joiner||""}${e.str}`:e.str}function doMod_replaceTxt(e,n){const _=new RegExp(e.replace,`g${e.flags||""}`);copyTo[n]&&copyTo[n].forEach(n=>{n.entries&&(n.entries=JSON.parse(JSON.stringify(n.entries).replace(_,e.with))),n.headerEntries&&(n.headerEntries=JSON.parse(JSON.stringify(n.headerEntries).replace(_,e.with))),n.footerEntries&&(n.footerEntries=JSON.parse(JSON.stringify(n.footerEntries).replace(_,e.with)))})}function doMod_prependArr(e,n){doEnsureArray(e,"items"),copyTo[n]=copyTo[n]?e.items.concat(copyTo[n]):e.items}function doMod_appendArr(e,n){doEnsureArray(e,"items"),copyTo[n]=copyTo[n]?copyTo[n].concat(e.items):e.items}function doMod_replaceArr(e,n,_=!0){if(doEnsureArray(e,"items"),!copyTo[n]){if(_)throw new Error(`Could not find "${n}" array`);return!1}let t;if(e.replace.regex){const _=new RegExp(e.replace.regex,e.replace.flags||"");t=copyTo[n].findIndex(e=>e.name?_.test(e.name):"string"==typeof e&&_.test(e))}else t=null==e.replace.index?copyTo[n].findIndex(n=>n.name?n.name===e.replace:n===e.replace):e.replace.index;if(~t)return copyTo[n].splice(t,1,...e.items),!0;if(_)throw new Error(`Could not find "${n}" item with name "${e.replace}" to replace`);return!1}function doMod_replaceOrAppendArr(e,n){const _=doMod_replaceArr(e,n,!1);_||doMod_appendArr(e,n)}function doMod_insertArr(e,n){if(doEnsureArray(e,"items"),!copyTo[n])throw new Error(`Could not find "${n}" array`);copyTo[n].splice(e.index,0,...e.items)}function doMod_removeArr(e,n){if(e.names)doEnsureArray(e,"names"),e.names.forEach(e=>{const _=copyTo[n].findIndex(n=>n.name===e);if(~_)copyTo[n].splice(_,1);else throw new Error(`Could not find "${n}" item with name "${e}" to remove`)});else if(e.items)doEnsureArray(e,"items"),e.items.forEach(e=>{const _=copyTo[n].findIndex(n=>n===e);if(~_)copyTo[n].splice(_,1);else throw new Error(`Could not find "${n}" item "${e}" to remove`)});else throw new Error(`One of "names" or "items" must be provided!`)}function doMod_calculateProp(modInfo,prop){copyTo[prop]=copyTo[prop]||{};const toExec=modInfo.formula.replace(/<\$([^$]+)\$>/g,(...e)=>{switch(e[1]){case"prof_bonus":return Parser.crToPb(copyTo.cr);case"dex_mod":return Parser.getAbilityModNumber(copyTo.dex);default:throw new Error(`Unknown variable "${e[1]}"`);}});copyTo[prop][modInfo.prop]=eval(toExec)}function doMod_scalarAddProp(e,n){function _(_){const t=+copyTo[n][_]+e.scalar,o="string"==typeof copyTo[n][_];copyTo[n][_]=o?`${0<=t?"+":""}${t}`:t}copyTo[n]&&("*"===e.prop?Object.keys(copyTo[n]).forEach(e=>_(e)):_(e.prop))}function doMod_scalarMultProp(e,n){function _(_){let t=+copyTo[n][_]*e.scalar;e.floor&&(t=_Mathfloor5(t));const o="string"==typeof copyTo[n][_];copyTo[n][_]=o?`${0<=t?"+":""}${t}`:t}copyTo[n]&&("*"===e.prop?Object.keys(copyTo[n]).forEach(e=>_(e)):_(e.prop))}function doMod_addSenses(e){doEnsureArray(e,"senses"),copyTo.senses=copyTo.senses||[],e.senses.forEach(e=>{let n=!1;for(let _=0;_<copyTo.senses.length;++_){const t=new RegExp(`${e.type} (\\d+)`,"i").exec(copyTo.senses[_]);if(t){n=!0,+t[1]<e.type&&(copyTo.senses[_]=`${e.type} ${e.range} ft.`);break}}n||copyTo.senses.push(`${e.type} ${e.range} ft.`)})}function doMod_addSkills(e){copyTo.skill=copyTo.skill||[],Object.entries(e.skills).forEach(([e,n])=>{const _=n*Parser.crToPb(copyTo.cr)+Parser.getAbilityModNumber(copyTo[Parser.skillToAbilityAbv(e)]),t=0<=_?`+${_}`:`-${_}`;copyTo.skill&&copyTo.skill[e]?+copyTo.skill[e]<_&&(copyTo.skill[e]=t):copyTo.skill[e]=t})}function doMod_addSpells(n){if(!copyTo.spellcasting)throw new Error(`Creature did not have a spellcasting property!`);const _=copyTo.spellcasting[0];if(n.spells){const e=_.spells;Object.keys(n.spells).forEach(_=>{if(!e[_])e[_]=n.spells[_];else{const t=n.spells[_],o=e[_];Object.keys(t).forEach(e=>{if(!o[e])o[e]=t[e];else if("object"!=typeof o[e])o[e]=t[e];else if(o[e]instanceof Array)o[e]=o[e].concat(t[e]).sort(SortUtil.ascSortLower);else throw new Error(`Object at key ${e} not an array!`)})}})}if(n.will&&n.will.forEach(e=>(n.will=n.will||[]).push(e)),n.daily)for(let t=1;9>=t;++t){const o=`${t}e`;_.daily=_.daily||{},n.daily[t]&&n.daily[t].forEach(e=>(_.daily[t]=_.daily[t]||[]).push(e)),n.daily[o]&&n.daily[o].forEach(e=>(_.daily[o]=_.daily[o]||[]).push(e))}}function doMod_replaceSpells(n){if(!copyTo.spellcasting)throw new Error(`Creature did not have a spellcasting property!`);const _=copyTo.spellcasting[0],t=(e,n,_)=>{doEnsureArray(n,"with");const t=e[_].indexOf(n.replace);if(~t)e[_].splice(t,1,...n.with),e[_].sort(SortUtil.ascSortLower);else throw new Error(`Could not find spell "${n.replace}" to replace`)};if(n.spells){const e=_.spells;Object.keys(n.spells).forEach(_=>{if(e[_]){const o=n.spells[_],i=e[_];o.forEach(e=>t(i,e,"spells"))}})}if(n.daily)for(let o=1;9>=o;++o){const i=`${o}e`;n.daily[o]&&n.daily[o].forEach(e=>t(_.daily,e,o)),n.daily[i]&&n.daily[i].forEach(e=>t(_.daily,e,i))}}function doMod_scalarAddHit(e,n){copyTo[n]&&(copyTo[n]=JSON.parse(JSON.stringify(copyTo[n]).replace(/{@hit ([-+]?\d+)}/g,(n,_)=>`{@hit ${+_+e.scalar}}`)))}function doMod_scalarAddDc(e,n){copyTo[n]&&(copyTo[n]=JSON.parse(JSON.stringify(copyTo[n]).replace(/{@dc (\d+)}/g,(n,_)=>`{@dc ${+_+e.scalar}}`)))}function doMod_maxSize(e){const n=Parser.SIZE_ABVS.indexOf(copyTo.size),_=Parser.SIZE_ABVS.indexOf(e.max);if(0>n||0>_)throw new Error(`Unhandled size!`);copyTo.size=Parser.SIZE_ABVS[Math.min(n,_)]}function doMod_scalarMultXp(e){function n(n){let _=n*e.scalar;return e.floor&&(_=_Mathfloor5(_)),_}if(copyTo.cr.xp)copyTo.cr.xp=n(copyTo.cr.xp);else{const e=Parser.crToXpNumber(copyTo.cr);copyTo.cr.cr||(copyTo.cr={cr:copyTo.cr}),copyTo.cr.xp=n(e)}}function doMod(e,...n){function _(n){e.forEach(e=>{if("string"==typeof e)switch(e){case"remove":return delete copyTo[n];default:throw new Error(`Unhandled mode: ${e}`);}else switch(e.mode){case"appendStr":return doMod_appendStr(e,n);case"replaceTxt":return doMod_replaceTxt(e,n);case"prependArr":return doMod_prependArr(e,n);case"appendArr":return doMod_appendArr(e,n);case"replaceArr":return doMod_replaceArr(e,n);case"replaceOrAppendArr":return doMod_replaceOrAppendArr(e,n);case"insertArr":return doMod_insertArr(e,n);case"removeArr":return doMod_removeArr(e,n);case"calculateProp":return doMod_calculateProp(e,n);case"scalarAddProp":return doMod_scalarAddProp(e,n);case"scalarMultProp":return doMod_scalarMultProp(e,n);case"addSenses":return doMod_addSenses(e);case"addSkills":return doMod_addSkills(e);case"addSpells":return doMod_addSpells(e);case"replaceSpells":return doMod_replaceSpells(e);case"scalarAddHit":return doMod_scalarAddHit(e,n);case"scalarAddDc":return doMod_scalarAddDc(e,n);case"maxSize":return doMod_maxSize(e);case"scalarMultXp":return doMod_scalarMultXp(e);default:throw new Error(`Unhandled mode: ${e.mode}`);}})}n.forEach(e=>_(e)),n.length||_()}options.doKeepCopy&&(copyTo.__copy=MiscUtil.copy(copyFrom));const copyMeta=copyTo._copy||{};copyMeta._mod&&normaliseMods(copyMeta);let racials=null;if(copyMeta._trait){const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/bestiary/traits.json`);if(racials=e.trait.find(e=>e.name.toLowerCase()===copyMeta._trait.name.toLowerCase()&&e.source.toLowerCase()===copyMeta._trait.source.toLowerCase()),!racials)throw new Error(`Could not find traits to apply with name "${copyMeta._trait.name}" and source "${copyMeta._trait.source}"`);racials=MiscUtil.copy(racials),racials.apply._mod&&(normaliseMods(racials.apply),copyMeta._mod?Object.entries(racials.apply._mod).forEach(([e,n])=>{copyMeta._mod[e]=copyMeta._mod[e]?copyMeta._mod[e].concat(n):n}):copyMeta._mod=racials.apply._mod),delete copyMeta._trait}Object.keys(copyFrom).forEach(e=>null===copyTo[e]?delete copyTo[e]:void(null==copyTo[e]&&(impl._MERGE_REQUIRES_PRESERVE[e]?copyTo._copy._preserve&&copyTo._copy._preserve[e]&&(copyTo[e]=copyFrom[e]):copyTo[e]=copyFrom[e]))),racials&&racials.apply._root&&Object.entries(racials.apply._root).forEach(([e,n])=>copyTo[e]=n),copyMeta._mod&&(Object.entries(copyMeta._mod).forEach(([k,v])=>{copyMeta._mod[k]=JSON.parse(JSON.stringify(v).replace(/<\$([^$]+)\$>/g,(...m)=>{const parts=m[1].split("__");switch(parts[0]){case"name":return copyTo.name;case"short_name":case"title_name":return copyTo.isNpc?copyTo.name.split(" ")[0]:`${"title_name"===parts[0]?"The ":"the "}${copyTo.name.toLowerCase()}`;case"spell_dc":{if(!Parser.ABIL_ABVS.includes(parts[1]))throw new Error(`Unknown ability score "${parts[1]}"`);return 8+Parser.getAbilityModNumber(+copyTo[parts[1]])+Parser.crToPb(copyTo.cr)}case"to_hit":{if(!Parser.ABIL_ABVS.includes(parts[1]))throw new Error(`Unknown ability score "${parts[1]}"`);const e=Parser.crToPb(copyTo.cr)+Parser.getAbilityModNumber(+copyTo[parts[1]]);return 0<=e?`+${e}`:e}case"damage_mod":{if(!Parser.ABIL_ABVS.includes(parts[1]))throw new Error(`Unknown ability score "${parts[1]}"`);const e=Parser.getAbilityModNumber(+copyTo[parts[1]]);return 0===e?"":0<e?` +${e}`:` ${e}`}case"damage_avg":{const replaced=parts[1].replace(/(str|dex|con|int|wis|cha)/gi,(...e)=>Parser.getAbilityModNumber(+copyTo[e[0]])),clean=replaced.replace(/[^-+/*0-9.,]+/g,"");return _Mathfloor5(eval(clean))}default:return m[0];}}))}),Object.entries(copyMeta._mod).forEach(([e,n])=>{"*"===e?doMod(n,"action","reaction","trait","legendary","variant","spellcasting"):"_"===e?doMod(n):doMod(n,e)})),copyTo._isCopy=!0,delete copyTo._copy}},monster:{_MERGE_REQUIRES_PRESERVE:{legendaryGroup:!0,environment:!0,soundClip:!0,page:!0,altArt:!0,otherSources:!0,variant:!0,dragonCastingColor:!0,srd:!0},_mergeCache:{},async pMergeCopy(e,n,_){return DataUtil.generic._pMergeCopy(DataUtil.monster,UrlUtil.PG_BESTIARY,e,n,_)},async pLoadAll(){const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/bestiary/index.json`),n=await Promise.all(Object.entries(e).map(async([e,n])=>{const _=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/bestiary/${n}`);return _.monster.filter(n=>n.source===e)}));return n.flat()}},spell:{_MERGE_REQUIRES_PRESERVE:{page:!0,otherSources:!0,srd:!0},_mergeCache:{},async pMergeCopy(e,n,_){return DataUtil.generic._pMergeCopy(DataUtil.spell,UrlUtil.PG_SPELLS,e,n,_)},async pLoadAll(){const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/spells/index.json`),n=await Promise.all(Object.entries(e).map(async([e,n])=>{const _=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/spells/${n}`);return _.spell.filter(n=>n.source===e)}));return n.flat()}},item:{_MERGE_REQUIRES_PRESERVE:{lootTables:!0,tier:!0,page:!0,otherSources:!0,srd:!0},_mergeCache:{},async pMergeCopy(e,n,_){return DataUtil.generic._pMergeCopy(DataUtil.item,UrlUtil.PG_ITEMS,e,n,_)}},background:{_MERGE_REQUIRES_PRESERVE:{page:!0,otherSources:!0,srd:!0},_mergeCache:{},async pMergeCopy(e,n,_){return DataUtil.generic._pMergeCopy(DataUtil.background,UrlUtil.PG_BACKGROUNDS,e,n,_)}},race:{_MERGE_REQUIRES_PRESERVE:{subraces:!0,page:!0,otherSources:!0,srd:!0},_mergeCache:{},async pMergeCopy(e,n,_){return DataUtil.generic._pMergeCopy(DataUtil.race,UrlUtil.PG_RACES,e,n,_)}},class:{_pLoadingJson:null,_loadedJson:null,loadJSON:async function(e=""){return DataUtil.class._loadedJson?DataUtil.class._loadedJson:(DataUtil.class._pLoadingJson=(async()=>{const n=await DataUtil.loadJSON(`${e}data/class/index.json`),_=await Promise.all(Object.values(n).map(n=>DataUtil.loadJSON(`${e}data/class/${n}`)));DataUtil.class._loadedJson=_.reduce((e,n)=>({class:e.class.concat(n.class)}),{class:[]})})(),await DataUtil.class._pLoadingJson,DataUtil.class._loadedJson)}},deity:{doPostLoad:function(e){const n=[SRC_PHB,SRC_DMG,SRC_SCAG,SRC_MTF,SRC_ERLW],_={};n.forEach(n=>{_[n]={},e.deity.filter(e=>e.source===n).forEach(e=>_[n][e.reprintAlias||e.name]=e)});const t=[n.last()];[...n].reverse().slice(1).forEach(e=>{t.forEach(n=>{Object.keys(_[e]).forEach(t=>{const o=_[n][t];if(o){const n=_[e][t];n.reprinted=!0,o._isEnhanced||(o.previousVersions=o.previousVersions||[],o.previousVersions.push(n))}})}),t.push(e)}),e.deity.forEach(e=>e._isEnhanced=!0)},loadJSON:async function(e=""){const n=await DataUtil.loadJSON(`${e}data/deities.json`);return DataUtil.deity.doPostLoad(n),n}},table:{async pLoadAll(e=""){const n=await Promise.all([`${e}data/generated/gendata-tables.json`,`${e}data/tables.json`].map(e=>DataUtil.loadJSON(e))),_={};return n.forEach(e=>{Object.entries(e).forEach(([e,n])=>{if(_[e]&&_[e]instanceof Array&&n instanceof Array)_[e]=_[e].concat(n);else if(null==_[e])_[e]=n;else throw new Error(`Could not merge keys for key "${e}"`)})}),_}},brew:{_getCleanUrlRoot(e){return e&&e.trim()?(e=e.trim(),!e.endsWith("/")&&(e=`${e}/`)):e=`https://raw.githubusercontent.com/TheGiddyLimit/homebrew/master/`,e},async pLoadTimestamps(e){return e=DataUtil.brew._getCleanUrlRoot(e),DataUtil.loadJSON(`${e}_generated/index-timestamps.json`)},async pLoadCollectionIndex(e){return e=DataUtil.brew._getCleanUrlRoot(e),DataUtil.loadJSON(`${e}collection/index.json`)},getDirUrl(e,n){return n=DataUtil.brew._getCleanUrlRoot(n),`${n}_generated/index-dir-${e}.json?t=${new Date().getTime()}`}}},RollerUtil={isCrypto(){return"undefined"!=typeof window&&"undefined"!=typeof window.crypto},randomise(e,n=1){return n>e?0:e===n?e:RollerUtil.isCrypto()?RollerUtil._randomise(n,e+1):RollerUtil.roll(e)+n},rollOnArray(e){return e[RollerUtil.randomise(e.length)-1]},_randomise:(e,n)=>{var _=Math.pow;const t=n-e,o=Math.ceil(Math.log2(t)/8),a=new Uint8Array(o),r=_(_(2,8),o),s=Math.floor(r/t)*t;let d,l;for(;;){for(window.crypto.getRandomValues(a),l=0,d=0;d<o;d++)l<<=8,l+=a[d];if(l<s)return l%=t,e+l}},roll(e,n=Math.random){return Math.floor(n()*e)},addListRollButton(e){const n=$(`<button class="btn btn-default ${e?"px-2":""}" id="feelinglucky" title="Feeling Lucky?"><span class="glyphicon glyphicon-random"></span></button>`);n.on("click",()=>{const e=ListUtil.getPrimaryLists();if(e&&e.length){const n=e.filter(e=>e.visibleItems.length);if(n.length){const e=RollerUtil.roll(n.length),_=n[e],t=RollerUtil.roll(_.visibleItems.length);window.location.hash=$(_.visibleItems[t].ele).find(`a`).prop("hash")}}}),$(`#filter-search-input-group`).find(`#reset`).before(n)},isRollCol(e){return!("string"!=typeof e)&&(!!/^{@dice [^}]+}$/.test(e.trim())||(e=Renderer.stripTags(e),!!Renderer.dice.lang.getTree3(e)))},_DICE_REGEX_STR:"((([1-9]\\d*)?d([1-9]\\d*)(\\s*?[-+\xD7x*\xF7/]\\s*?(\\d,\\d|\\d)+(\\.\\d+)?)?))+?"},RollerUtil.DICE_REGEX=new RegExp(RollerUtil._DICE_REGEX_STR,"g"),RollerUtil.REGEX_DAMAGE_DICE=/(\d+)( \((?:{@dice |{@damage ))([-+0-9d ]*)(}\) [a-z]+( \([-a-zA-Z0-9 ]+\))?( or [a-z]+( \([-a-zA-Z0-9 ]+\))?)? damage)/gi,RollerUtil.REGEX_DAMAGE_FLAT=/(Hit: |{@h})([0-9]+)( [a-z]+( \([-a-zA-Z0-9 ]+\))?( or [a-z]+( \([-a-zA-Z0-9 ]+\))?)? damage)/gi,StorageUtil={_init:!1,_initAsync:!1,_fakeStorage:{},_fakeStorageAsync:{},getSyncStorage:()=>{if(StorageUtil._init)return StorageUtil.__fakeStorage?StorageUtil._fakeStorage:window.localStorage;StorageUtil._init=!0;try{return window.localStorage}catch(n){return StorageUtil.__fakeStorage=!0,StorageUtil._fakeStorage={isSyncFake:!0,getItem:e=>StorageUtil.__fakeStorage[e],removeItem:e=>{delete StorageUtil.__fakeStorage[e]},setItem:(e,n)=>{StorageUtil.__fakeStorage[e]=n}},StorageUtil._fakeStorage}},async getAsyncStorage(){if(StorageUtil._initAsync)return StorageUtil.__fakeStorageAsync?StorageUtil._fakeStorageAsync:localforage;StorageUtil._initAsync=!0;const n=()=>(StorageUtil.__fakeStorageAsync={},StorageUtil._fakeStorageAsync={pIsAsyncFake:!0,async setItem(e,n){StorageUtil.__fakeStorageAsync[e]=n},async getItem(e){return StorageUtil.__fakeStorageAsync[e]},async removeItem(e){delete StorageUtil.__fakeStorageAsync[e]}},StorageUtil._fakeStorageAsync);if("undefined"!=typeof window)try{return await new Promise((e,n)=>{const _=window.indexedDB.open("_test_db",1);_.onerror=n,_.onsuccess=e}),await localforage.setItem("_storage_check",!0),localforage}catch(_){return n()}else return n()},syncGet(e){const n=StorageUtil.getSyncStorage().getItem(e);return n&&"undefined"!==n&&"null"!==n?JSON.parse(n):null},syncSet(e,n){StorageUtil.getSyncStorage().setItem(e,JSON.stringify(n)),StorageUtil._syncTrackKey(e)},syncRemove(e){StorageUtil.getSyncStorage().removeItem(e),StorageUtil._syncTrackKey(e,!0)},syncGetForPage(e){return StorageUtil.syncGet(`${e}_${UrlUtil.getCurrentPage()}`)},syncSetForPage(e,n){StorageUtil.syncSet(`${e}_${UrlUtil.getCurrentPage()}`,n)},isSyncFake(){return!!StorageUtil.getSyncStorage().isSyncFake},_syncTrackKey(e,n){const _=StorageUtil.syncGet(StorageUtil._META_KEY)||{};n?delete _[e]:_[e]=1,StorageUtil.getSyncStorage().setItem(StorageUtil._META_KEY,JSON.stringify(_))},syncGetDump(){const e={},n=StorageUtil.syncGet(StorageUtil._META_KEY)||{};return Object.entries(n).filter(([e,n])=>n).forEach(([n])=>e[n]=StorageUtil.syncGet(n)),e},syncSetFromDump(e){Object.entries(e).forEach(([e,n])=>StorageUtil.syncSet(e,n))},async pIsAsyncFake(){const e=await StorageUtil.getAsyncStorage();return!!e.pIsAsyncFake},async pSet(e,n){StorageUtil._pTrackKey(e);const _=await StorageUtil.getAsyncStorage();return _.setItem(e,n)},async pGet(e){const n=await StorageUtil.getAsyncStorage();return n.getItem(e)},async pRemove(e){StorageUtil._pTrackKey(e,!0);const n=await StorageUtil.getAsyncStorage();return n.removeItem(e)},getPageKey(e,n){return`${e}_${n||UrlUtil.getCurrentPage()}`},async pGetForPage(e){return StorageUtil.pGet(StorageUtil.getPageKey(e))},async pSetForPage(e,n){return StorageUtil.pSet(StorageUtil.getPageKey(e),n)},async pRemoveForPage(e){return StorageUtil.pRemove(StorageUtil.getPageKey(e))},async _pTrackKey(e,n){const _=await StorageUtil.getAsyncStorage(),t=(await StorageUtil.pGet(StorageUtil._META_KEY))||{};n?delete t[e]:t[e]=1,_.setItem(StorageUtil._META_KEY,t)},async pGetDump(){const e={},n=(await StorageUtil.pGet(StorageUtil._META_KEY))||{};return await Promise.all(Object.entries(n).filter(([e,n])=>n).map(async([n])=>e[n]=await StorageUtil.pGet(n))),e},async pSetFromDump(e){return Promise.all(Object.entries(e).map(([e,n])=>StorageUtil.pSet(e,n)))}},StorageUtil._META_KEY="_STORAGE_META_STORAGE",SessionStorageUtil={_fakeStorage:{},__storage:null,getStorage:()=>{try{return window.sessionStorage}catch(n){return SessionStorageUtil.__storage?SessionStorageUtil.__storage:SessionStorageUtil.__storage={isFake:!0,getItem:e=>SessionStorageUtil._fakeStorage[e],removeItem:e=>{delete SessionStorageUtil._fakeStorage[e]},setItem:(e,n)=>{SessionStorageUtil._fakeStorage[e]=n}}}},isFake(){return SessionStorageUtil.getStorage().isSyncFake},setForPage:(e,n)=>{SessionStorageUtil.set(`${e}_${UrlUtil.getCurrentPage()}`,n)},set(e,n){SessionStorageUtil.getStorage().setItem(e,JSON.stringify(n))},getForPage:e=>SessionStorageUtil.get(`${e}_${UrlUtil.getCurrentPage()}`),get(e){const n=SessionStorageUtil.getStorage().getItem(e);return n&&"undefined"!==n&&"null"!==n?JSON.parse(n):null},removeForPage:e=>{SessionStorageUtil.remove(`${e}_${UrlUtil.getCurrentPage()}`)},remove(e){SessionStorageUtil.getStorage().removeItem(e)}},BrewUtil={homebrew:null,homebrewMeta:null,_lists:null,_sourceCache:null,_filterBox:null,_sourceFilter:null,_pHandleBrew:null,_lockHandleBrewJson:null,bind(e){e.list?BrewUtil._lists=[e.list]:e.lists&&(BrewUtil._lists=e.lists),e.filterBox&&(BrewUtil._filterBox=e.filterBox),e.sourceFilter&&(BrewUtil._sourceFilter=e.sourceFilter),e.pHandleBrew!==void 0&&(this._pHandleBrew=e.pHandleBrew)},async pAddBrewData(){if(BrewUtil.homebrew)return BrewUtil.homebrew;try{const e=(await StorageUtil.pGet(HOMEBREW_STORAGE))||{};return BrewUtil.homebrewMeta=StorageUtil.syncGet(HOMEBREW_META_STORAGE)||{sources:[]},BrewUtil.homebrewMeta.sources=BrewUtil.homebrewMeta.sources||[],BrewUtil.homebrew=e,BrewUtil._resetSourceCache(),BrewUtil.homebrew}catch(n){BrewUtil.pPurgeBrew(n)}},async pPurgeBrew(e){JqueryUtil.doToast({content:"Error when loading homebrew! Purged homebrew data. (See the log for more information.)",type:"danger"}),await StorageUtil.pRemove(HOMEBREW_STORAGE),StorageUtil.syncRemove(HOMEBREW_META_STORAGE),BrewUtil.homebrew=null,window.location.hash="",BrewUtil.homebrew={},BrewUtil.homebrewMeta={sources:[]},e&&setTimeout(()=>{throw e})},async pAddLocalBrewData(e=async(e,n)=>BrewUtil.pDoHandleBrewJson(e,n,null)){if(!IS_VTT&&!IS_DEPLOYED){const n=await DataUtil.loadJSON(`${Renderer.get().baseUrl}${JSON_HOMEBREW_INDEX}`);if(n.toImport.length){const _=UrlUtil.getCurrentPage(),t=await Promise.all(n.toImport.map(e=>DataUtil.loadJSON(`homebrew/${e}`)));await Promise.all(t.map(n=>e(n,_)))}}},async _pRenderBrewScreen(e,n,_){const t=UrlUtil.getCurrentPage(),o=$(`<div class="manbrew__current_brew flex-col h-100"/>`);await BrewUtil._pRenderBrewScreen_pRefreshBrewList(o);const i=$(`<input multiple type="file" accept=".json" style="display: none;">`).change(e=>{const n=e.target;let _=0;const i=new FileReader;i.onload=async()=>{const a=JSON.parse(i.result);await DataUtil.pDoMetaMerge(CryptUtil.uid(),a),await BrewUtil.pDoHandleBrewJson(a,t,BrewUtil._pRenderBrewScreen_pRefreshBrewList.bind(this,o)),n.files[_]?i.readAsText(n.files[_++]):$(e.target).val("")},i.readAsText(n.files[_++])}),a=$(`<button class="btn btn-default btn-sm mr-2">Load from URL</button>`).click(async()=>{const e=await InputUiUtil.pGetUserString({title:"Homebrew URL"});if(!e||!e.trim())return;let n;try{n=new URL(e)}catch(n){return void JqueryUtil.doToast({content:`The provided URL does not appear to be valid.`,type:"danger"})}BrewUtil.addBrewRemote(null,n.href).catch(()=>{JqueryUtil.doToast({content:"Could not load homebrew from the provided URL.",type:"danger"})})}),r=$(`<button class="btn btn-info btn-sm">Get Homebrew</button>`).click(async()=>{function e(){switch(t){case UrlUtil.PG_SPELLS:return["spell"];case UrlUtil.PG_CLASSES:return["class","subclass"];case UrlUtil.PG_BESTIARY:return["creature"];case UrlUtil.PG_BACKGROUNDS:return["background"];case UrlUtil.PG_FEATS:return["feat"];case UrlUtil.PG_OPT_FEATURES:return["optionalfeature"];case UrlUtil.PG_RACES:return["race","subrace"];case UrlUtil.PG_OBJECTS:return["object"];case UrlUtil.PG_TRAPS_HAZARDS:return["trap","hazard"];case UrlUtil.PG_DEITIES:return["deity"];case UrlUtil.PG_ITEMS:return["item","magicvariant"];case UrlUtil.PG_REWARDS:return["reward"];case UrlUtil.PG_PSIONICS:return["psionic"];case UrlUtil.PG_VARIATNRULES:return["variantrule"];case UrlUtil.PG_CONDITIONS_DISEASES:return["condition","disease"];case UrlUtil.PG_ADVENTURES:return["adventure"];case UrlUtil.PG_BOOKS:return["book"];case UrlUtil.PG_TABLES:return["table"];case UrlUtil.PG_MAKE_SHAPED:return["spell","creature"];case UrlUtil.PG_MANAGE_BREW:case UrlUtil.PG_MAKE_BREW:case UrlUtil.PG_DEMO_RENDER:return BrewUtil._DIRS;case UrlUtil.PG_VEHICLES:return["vehicle"];case UrlUtil.PG_ACTIONS:return["action"];case UrlUtil.PG_CULTS_BOONS:return["cult","boon"];case UrlUtil.PG_LANGUAGES:return["language"];default:throw new Error(`No homebrew directories defined for category ${t}`);}}function n(e,n,_){function t(){return SortUtil.ascSortLower(e._brewName,n._brewName)}function o(_,o){return _(e[o],n[o])||t()}return e=s[e.ix],n=s[n.ix],"name"===_.sortBy?t():"author"===_.sortBy?o(SortUtil.ascSortLower,"_brewAuthor"):"category"===_.sortBy?o(SortUtil.ascSortLower,"_brewCat"):"added"===_.sortBy?o(SortUtil.ascSort,"_brewAdded"):"modified"===_.sortBy?o(SortUtil.ascSort,"_brewModified"):void 0}const o=$(`<button class="btn btn-default btn-xs manbrew__load_all" disabled title="(Excluding samples)">Add All</button>`),i=$$`<ul class="list"><li><div class="lst__wrp-cells"><span style="font-style: italic;">Loading...</span></div></li></ul>`,a=$(`<input type="search" class="search manbrew__search form-control w-100" placeholder="Find homebrew...">`).keydown(e=>{switch(e.which){case 13:return i.find(`li`).first().find(`.manbrew__load_from_url`).click();case 40:{const e=A.visibleItems[0];e&&e.ele.focus()}}}),{$modalInner:r}=UiUtil.getShowModal({fullHeight:!0,title:`Get Homebrew`,cbClose:()=>{_&&_()},isLarge:!0,overlayColor:"transparent"});$$(r)`
					<p><i>A list of homebrew available in the public repository. Click a name to load the homebrew, or view the source directly.<br>
					Contributions are welcome; see the <a href="https://github.com/TheGiddyLimit/homebrew/blob/master/README.md" target="_blank" rel="noopener noreferrer">README</a>, or stop by our <a href="https://discord.gg/nGvRCDs" target="_blank" rel="noopener noreferrer">Discord</a>.</i></p>
					<hr class="manbrew__hr">
					<div class="manbrew__load_all_wrp">${o}</div>
					${a}
					<div class="filtertools manbrew__filtertools sortlabel btn-group lst__form-bottom">
						<button class="col-4 sort btn btn-default btn-xs" data-sort="name">Name</button>
						<button class="col-3 sort btn btn-default btn-xs" data-sort="author">Author</button>
						<button class="col-1-2 sort btn btn-default btn-xs" data-sort="category">Category</button>
						<button class="col-1-4 sort btn btn-default btn-xs" data-sort="modified">Modified</button>
						<button class="col-1-4 sort btn btn-default btn-xs" data-sort="added">Added</button>
						<button class="sort btn btn-default btn-xs" disabled>Source</button>
					</div>
					${i}`;let s;const d=await StorageUtil.pGet(`HOMEBREW_CUSTOM_REPO_URL`),l=await DataUtil.brew.pLoadTimestamps(d),S=await DataUtil.brew.pLoadCollectionIndex(d),u=(()=>{const n=new Set(e().map(e=>BrewUtil._pRenderBrewScreen_dirToCat(e)));return Object.keys(S).filter(e=>S[e].find(e=>n.has(e)))})(),c=e().map(e=>({url:DataUtil.brew.getDirUrl(e,d),_cat:BrewUtil._pRenderBrewScreen_dirToCat(e)}));u.length&&c.push({url:DataUtil.brew.getDirUrl("collection",d),_collection:!0,_cat:"collection"});const T=(await Promise.all(c.map(async e=>{const n=await DataUtil.loadJSON(e.url);return e._collection&&n.filter(e=>"index.json"===e.name||!u.includes(e.name)).forEach(e=>e._brewSkip=!0),n.forEach(n=>n._cat=e._cat),n}))).flat(),O=T.flat();O.forEach(e=>{const n=e.name.trim().replace(/\.json$/,""),_=n.split(";").map(e=>e.trim());1<_.length?(e._brewName=_[1],e._brewAuthor=_[0]):(e._brewName=n,e._brewAuthor="")}),O.sort((e,n)=>SortUtil.ascSortLower(e._brewName,n._brewName));const A=new List({$iptSearch:a,$wrpList:i,fnSort:n,isUseJquery:!0});SortUtil.initBtnSortHandlers(r.find(".manbrew__filtertools"),A),s=O.filter(e=>!e._brewSkip),s.forEach((e,n)=>{e._brewAdded=(l[e.path]||{}).a||0,e._brewModified=(l[e.path]||{}).m||0,e._brewCat=BrewUtil._pRenderBrewScreen_getDisplayCat(BrewUtil._pRenderBrewScreen_dirToCat(e._cat));const _=e._brewAdded?MiscUtil.dateToStr(new Date(1e3*e._brewAdded),!0):"",t=e._brewModified?MiscUtil.dateToStr(new Date(1e3*e._brewModified),!0):"",o=$(`<span class="col-4 bold manbrew__load_from_url pl-0 clickable"/>`).text(e._brewName).click(()=>BrewUtil.addBrewRemote(o,e.download_url||"",!0)),i=$$`<li class="not-clickable lst--border lst__row--focusable" tabindex="1">
						<div class="lst__wrp-cells">
							${o}
							<span class="col-3">${e._brewAuthor}</span>
							<span class="col-1-2 text-center">${e._brewCat}</span>
							<span class="col-1-4 text-center">${t}</span>
							<span class="col-1-4 text-center">${_}</span>
							<span class="col-1 manbrew__source text-center pr-0"><a href="${e.download_url}" target="_blank" rel="noopener noreferrer">View Raw</a></span>
						</div>
					</li>`;i.keydown(e=>{switch(e.which){case 13:return o.click();case 38:{const e=A.visibleItems.indexOf(a);if(~e){const n=A.visibleItems[e-1];n&&n.ele.focus()}else{const e=A.visibleItems[0];e&&e.ele.focus()}return}case 40:{const e=A.visibleItems.indexOf(a);if(~e){const n=A.visibleItems[e+1];n&&n.ele.focus()}else{const e=A.visibleItems.last();e&&e.ele.focus()}}}});const a=new ListItem(n,i,e._brewName,{author:e._brewAuthor,category:e._brewCat,added:_,modified:_},{$btnAdd:o,isSample:e._brewAuthor.toLowerCase().startsWith("sample -")});A.addItem(a)}),A.init(),ListUtil.bindEscapeKey(A,a,!0),o.prop("disabled",!1).click(()=>A.visibleItems.filter(e=>!e.data.isSample).forEach(e=>e.data.$btnAdd.click())),a.focus()}),s=$(`<button class="btn btn-info btn-sm px-2" title="Set Custom Repository URL"><span class="glyphicon glyphicon-cog"/></button>`).click(async()=>{const e=await StorageUtil.pGet(`HOMEBREW_CUSTOM_REPO_URL`),n=await InputUiUtil.pGetUserString({title:"Homebrew Repository URL (Blank for Default)",default:e});null==n?await StorageUtil.pRemove(`HOMEBREW_CUSTOM_REPO_URL`):await StorageUtil.pSet(`HOMEBREW_CUSTOM_REPO_URL`,n)}),d=n?null:BrewUtil._$getBtnDeleteAll(),l=$$`<div class="flex-vh-center no-shrink">
			<div class="flex-v-center btn-group mr-2">
				${r}
				${s}
			</div>
			<label role="button" class="btn btn-default btn-sm btn-file mr-2">Upload File${i}</label>
			${a}
			<a href="https://github.com/TheGiddyLimit/homebrew" class="flex-v-center" target="_blank" rel="noopener noreferrer"><button class="btn btn-default btn-sm btn-file">Browse Source Repository</button></a>
			${d}
		</div>`;n?$$(e)`
			<hr class="manbrew__hr no-shrink">
			${o}
			<div class="mb-3 text-center no-shrink">${l}</div>
		`:$$(e)`
			<div class="mb-3 text-center no-shrink">${l}</div>
			<hr class="manbrew__hr no-shrink">
			${o}
		`,BrewUtil.addBrewRemote=async(e,n,_)=>{let i;e&&(i=e.html(),e.text("Loading...")),_&&(n=n.unescapeQuotes());const a=await DataUtil.loadJSON(`${n}?${new Date().getTime()}`);await BrewUtil.pDoHandleBrewJson(a,t,BrewUtil._pRenderBrewScreen_pRefreshBrewList.bind(this,o)),e&&(e.text("Done!"),setTimeout(()=>e.html(i),500))}},_$getBtnDeleteAll(e){return $(`<button class="btn ${e?"btn-xs":"btn-sm ml-2"} btn-danger">Delete All</button>`).click(async()=>{window.confirm("Are you sure?")&&(await StorageUtil.pSet(HOMEBREW_STORAGE,{}),StorageUtil.syncSet(HOMEBREW_META_STORAGE,{}),window.location.hash="",location.reload())})},async _pCleanSaveBrew(){const e=MiscUtil.copy(BrewUtil.homebrew);BrewUtil._STORABLE.forEach(e=>{(BrewUtil.homebrew[e]||[]).forEach(e=>{Object.keys(e).filter(e=>e.startsWith("_")).forEach(n=>delete e[n])})}),await StorageUtil.pSet(HOMEBREW_STORAGE,e)},async _pRenderBrewScreen_pDeleteSource(e,n,_,t){if(_&&!window.confirm(`Are you sure you want to remove all homebrew${t?"":` with${n?` source "${Parser.sourceJsonToFull(n)}"`:`out a source`}`}?`))return;const o=new Set(BrewUtil._getActiveVetoolsSources().map(e=>e.json)),i=e=>t||e===n||n===void 0&&!o.has(e)&&!BrewUtil.hasSourceJson(e);await Promise.all(BrewUtil._getBrewCategories().map(async e=>{const n=BrewUtil.homebrew[e],_=BrewUtil._getPDeleteFunction(e),t=[];n.filter(e=>i(e.source)).forEach(e=>t.push(e.uniqueId)),await Promise.all(t.map(async e=>_(e)))})),BrewUtil._lists&&BrewUtil._lists.forEach(e=>e.update()),BrewUtil._persistHomebrewDebounced(),BrewUtil.removeJsonSource(n),UrlUtil.getCurrentPage()===UrlUtil.PG_MAKE_SHAPED&&removeBrewSource(n),BrewUtil._sourceFilter&&BrewUtil._sourceFilter.removeItem(n),BrewUtil._filterBox&&BrewUtil._filterBox.render(),await BrewUtil._pRenderBrewScreen_pRefreshBrewList(e),window.location.hash="",BrewUtil._filterBox&&BrewUtil._filterBox.fireChangeEvent()},async _pRenderBrewScreen_pRefreshBrewList(e){function n(n,_){function t(){function e(e,n){const _={name:n.name,uniqueId:n.uniqueId,extraInfo:""};switch(e){case"subclass":_.extraInfo=` (${n.class})`;break;case"subrace":_.extraInfo=` (${(n.race||{}).name})`;break;case"psionic":_.extraInfo=` (${Parser.psiTypeToMeta(n.type).short})`;break;case"itemProperty":{n.entries&&(_.name=Renderer.findName(n.entries)),_.name||(_.name=n.abbreviation);break}case"adventureData":case"bookData":{_.name=((BrewUtil.homebrew[{adventureData:"adventure",bookData:"book"}[e]]||[]).find(e=>e.id===n.id)||{}).name||n.id}}return _.name=_.name||`(Unknown)`,_}s.empty(),l=new List({$iptSearch:d,$wrpList:s,fnSort:SortUtil.listSort});const t=new Set(BrewUtil._getActiveVetoolsSources().map(e=>e.json)),o=e=>_||e===n||void 0===n&&!t.has(e)&&!BrewUtil.hasSourceJson(e);BrewUtil._getBrewCategories().forEach(n=>{BrewUtil.homebrew[n].filter(e=>o(e.source)).map(_=>e(n,_)).sort((e,n)=>SortUtil.ascSort(e.name,n.name)).forEach((e,_)=>{const t=BrewUtil._pRenderBrewScreen_getDisplayCat(n,!0),o=$(`<li class="lst--border"><label class="mb-0 flex-v-center row">
									<span class="col-6 bold">${e.name}</span>
									<span class="col-5 text-center">${t}${e.extraInfo}</span>
									<span class="pr-0 col-1 text-center"><input type="checkbox"></span>
								</label></li>`)[0],i=new ListItem(_,o,e.name,{category:t,category_raw:n},{uniqueId:e.uniqueId});l.addItem(i)})}),s.empty(),l.init(),l.items.length||s.append(`<h5 class="text-center">No results found.</h5>`),ListUtil.bindEscapeKey(l,d,!0)}const o=$(`<div class="flex-v-center"/>`),{$modalInner:i,doClose:a}=UiUtil.getShowModal({fullHeight:!0,title:`View/Manage ${n?`Source Contents: ${Parser.sourceJsonToFull(n)}`:_?"Entries from All Sources":`Entries with No Source`}`,isLarge:!0,overlayColor:"transparent",titleSplit:o}),r=$(`<input type="checkbox">`),s=$$`<ul class="list"/>`,d=$(`<input type="search" class="search manbrew__search form-control w-100" placeholder="Search entries...">`);$$(i)`
				${d}
				<div class="filtertools manbrew__filtertools sortlabel btn-group">
					<button class="col-6 sort btn btn-default btn-xs" data-sort="name">Name</button>
					<button class="col-5 sort btn btn-default btn-xs" data-sort="category">Category</button>
					<label class="col-1 wrp-cb-all pr-0">${r}</label>
				</div>
				${s}`;let l;t(),r.change(function(){const e=this.checked;l.items.forEach(n=>$(n.ele).find(`input`).prop("checked",e))}),$(`<button class="btn btn-danger btn-xs">Delete Selected</button>`).on("click",async()=>{const _=l.items.filter(e=>$(e.ele).find(`input`).prop("checked")).map(e=>({...e.values,...e.data}));_.length&&window.confirm("Are you sure?")&&(_.length===l.items.length?(await BrewUtil._pRenderBrewScreen_pDeleteSource(e,n,!1,!1),a()):(await Promise.all(_.map(async e=>{const n=BrewUtil._getPDeleteFunction(e.category_raw);await n(e.uniqueId)})),BrewUtil._lists&&BrewUtil._lists.forEach(e=>e.update()),BrewUtil._persistHomebrewDebounced(),t(),await BrewUtil._pRenderBrewScreen_pRefreshBrewList(e),window.location.hash=""))}).appendTo(o),d.focus()}if(e.empty(),BrewUtil.homebrew){const _=$(`<input type="search" class="search manbrew__search form-control" placeholder="Search active homebrew...">`),t=$(`<ul class="list-display-only brew-list brew-list--target manbrew__list"></ul>`),o=$(`<ul class="list-display-only brew-list brew-list--groups no-shrink" style="height: initial;"></ul>`),a=new List({$iptSearch:_,$wrpList:t,isUseJquery:!0}),r=$$`
				<div class="flex-col h-100">
					${_}
					<div class="filtertools manbrew__filtertools sortlabel btn-group lst__form-bottom">
						<button class="col-5 sort btn btn-default btn-xs" data-sort="source">Source</button>
						<button class="col-4 sort btn btn-default btn-xs" data-sort="authors">Authors</button>
						<button class="col-1 btn btn-default btn-xs" disabled>Origin</button>
						<button class="btn btn-default btn-xs" disabled>&nbsp;</button>
					</div>
					<div class="flex w-100 h-100 overflow-y-auto relative">${t}</div>
				</div>
			`.appendTo(e);o.appendTo(e),SortUtil.initBtnSortHandlers(r.find(".manbrew__filtertools"),a);const s=(_,t)=>{const o=$(`<span class="col-2 text-right"/>`).appendTo(t);$(`<button class="btn btn-sm btn-default">View/Manage</button>`).on("click",()=>{n(_.json,_._all)}).appendTo(o),o.append(" "),$(`<button class="btn btn-danger btn-sm"><span class="glyphicon glyphicon-trash"></span></button>`).on("click",()=>BrewUtil._pRenderBrewScreen_pDeleteSource(e,_.json,!0,_._all)).appendTo(o)},d=UrlUtil.getCurrentPage(),l=e=>{const n=(()=>{switch(d){case UrlUtil.PG_SPELLS:return["spell"];case UrlUtil.PG_CLASSES:return["class","subclass"];case UrlUtil.PG_BESTIARY:return["monster","legendaryGroup","monsterFluff"];case UrlUtil.PG_BACKGROUNDS:return["background"];case UrlUtil.PG_FEATS:return["feat"];case UrlUtil.PG_OPT_FEATURES:return["optionalfeature"];case UrlUtil.PG_RACES:return["race","raceFluff","subrace"];case UrlUtil.PG_OBJECTS:return["object"];case UrlUtil.PG_TRAPS_HAZARDS:return["trap","hazard"];case UrlUtil.PG_DEITIES:return["deity"];case UrlUtil.PG_ITEMS:return["item","baseitem","variant","itemProperty","itemType"];case UrlUtil.PG_REWARDS:return["reward"];case UrlUtil.PG_PSIONICS:return["psionic"];case UrlUtil.PG_VARIATNRULES:return["variantrule"];case UrlUtil.PG_CONDITIONS_DISEASES:return["condition","disease"];case UrlUtil.PG_ADVENTURES:return["adventure","adventureData"];case UrlUtil.PG_BOOKS:return["book","bookData"];case UrlUtil.PG_TABLES:return["table","tableGroup"];case UrlUtil.PG_MAKE_SHAPED:return["spell","creature"];case UrlUtil.PG_MANAGE_BREW:case UrlUtil.PG_MAKE_BREW:case UrlUtil.PG_DEMO_RENDER:return BrewUtil._STORABLE;case UrlUtil.PG_VEHICLES:return["vehicle"];case UrlUtil.PG_ACTIONS:return["action"];case UrlUtil.PG_CULTS_BOONS:return["cult","boon"];case UrlUtil.PG_LANGUAGES:return["language"];default:throw new Error(`No homebrew properties defined for category ${d}`);}})();return!!n.find(n=>!!(BrewUtil.homebrew[n]||[]).some(n=>n.source===e))},S=MiscUtil.copy(BrewUtil.getJsonSources()).filter(e=>l(e.json));S.sort((e,n)=>SortUtil.ascSort(e.full,n.full)),S.forEach((e,n)=>{const _=(e.authors?e.authors instanceof Array?e.authors:[]:[]).join(", "),t=e._unknown||e._all,o=$(`<li class="row manbrew__row lst--border">
						<span class="col-5 manbrew__col--tall source manbrew__source">${t?"<i>":""}${e.full}${t?"</i>":""}</span>
						<span class="col-4 manbrew__col--tall authors">${_}</span>
						<${e.url?"a":"span"} class="col-1 manbrew__col--tall text-center" ${e.url?`href="${e.url}" target="_blank" rel="noopener noreferrer"`:""}>${e.url?"View Source":""}</${e.url?"a":"span"}>
						<span class="hidden">${e.abbreviation}</span>
					</li>`);s(e,o);const i=new ListItem(n,o,e.full,{authors:_,abbreviation:e.abbreviation});a.addItem(i)});const u=(e,n)=>{const _=$(`<li class="row manbrew__row">
					<span class="col-10 manbrew__col--tall source manbrew__source text-right"><i>${e}</i></span>
				</li>`);s({[n]:!0},_),o.append(_)};u("Entries From All Sources","_all"),u("Entries Without Sources","_unknown"),a.init(),ListUtil.bindEscapeKey(a,_,!0),_.focus()}},_pRenderBrewScreen_dirToCat(e){if(!e)return"";if(BrewUtil._STORABLE.includes(e))return e;switch(e){case"creature":return"monster";case"collection":return e;case"magicvariant":return"variant";}throw new Error(`Directory was not mapped to a category: "${e}"`)},_pRenderBrewScreen_getDisplayCat(e,n){return"variantrule"===e?"Variant Rule":"legendaryGroup"===e?"Legendary Group":"optionalfeature"===e?"Optional Feature":"adventure"===e?n?"Adventure Contents/Info":"Adventure":"adventureData"===e?"Adventure Text":"book"===e?n?"Book Contents/Info":"Book":"bookData"===e?"Book Text":"itemProperty"===e?"Item Property":"baseitem"===e?"Base Item":"variant"===e?"Magic Item Variant":"monsterFluff"===e?"Monster Fluff":e.uppercaseFirst()},handleLoadbrewClick:async(e,n,_)=>{const t=$(e);if(!t.hasClass("rd__wrp-loadbrew--ready"))return;const o=t.html(),i=t.title();t.title(""),t.removeClass("rd__wrp-loadbrew--ready").html(`${_}<span class="glyphicon glyphicon-refresh rd__loadbrew-icon rd__loadbrew-icon--active"/>`),n=n.unescapeQuotes();const a=await DataUtil.loadJSON(`${n}?${new Date().getTime()}`);await BrewUtil.pDoHandleBrewJson(a,UrlUtil.getCurrentPage()),t.html(`${_}<span class="glyphicon glyphicon-saved rd__loadbrew-icon"/>`),setTimeout(()=>t.html(o).addClass("rd__wrp-loadbrew--ready").title(i),500)},async _pDoRemove(e,n,_){const t=function(e,n,_){return BrewUtil.homebrew[e].findIndex(e=>_?e.parentUniqueId:e.uniqueId===n)}(e,n,_);~t&&(BrewUtil.homebrew[e].splice(t,1),BrewUtil._lists&&BrewUtil._lists.forEach(e=>e.removeItemByData(_?"parentuniqueId":"uniqueId",n)))},_getPDeleteFunction(e){switch(e){case"spell":case"monster":case"monsterFluff":case"background":case"feat":case"optionalfeature":case"race":case"raceFluff":case"subrace":case"object":case"trap":case"hazard":case"deity":case"item":case"baseitem":case"variant":case"itemType":case"itemProperty":case"reward":case"psionic":case"variantrule":case"legendaryGroup":case"condition":case"disease":case"table":case"tableGroup":case"vehicle":case"action":case"cult":case"boon":case"language":return BrewUtil._genPDeleteGenericBrew(e);case"subclass":return BrewUtil._pDeleteSubclassBrew;case"class":return BrewUtil._pDeleteClassBrew;case"adventure":case"book":return BrewUtil._genPDeleteGenericBookBrew(e);case"adventureData":case"bookData":return()=>{};default:throw new Error(`No homebrew delete function defined for category ${e}`);}},async _pDeleteClassBrew(e){await BrewUtil._pDoRemove("class",e)},async _pDeleteSubclassBrew(e){let n,_=0;for(;_<BrewUtil.homebrew.subclass.length;++_)if(BrewUtil.homebrew.subclass[_].uniqueId===e){n=BrewUtil.homebrew.subclass[_];break}if(n){const t=n.class;if(BrewUtil.homebrew.subclass.splice(_,1),BrewUtil._persistHomebrewDebounced(),"undefined"!=typeof ClassData){const n=ClassData.classes.find(e=>e.name.toLowerCase()===t.toLowerCase()),_=n.subclasses.findIndex(n=>n.uniqueId===e);~_&&(n.subclasses.splice(_,1),n.subclasses=n.subclasses.sort((e,n)=>SortUtil.ascSort(e.name,n.name)))}}},_genPDeleteGenericBrew(e){return async n=>{await BrewUtil._pDoRemove(e,n)}},_genPDeleteGenericBookBrew(e){return async n=>{await BrewUtil._pDoRemove(e,n),await BrewUtil._pDoRemove(`${e}Data`,n,!0)}},manageBrew:()=>{const{$modalInner:e}=UiUtil.getShowModal({fullHeight:!0,title:`Manage Homebrew`,isLarge:!0,titleSplit:BrewUtil._$getBtnDeleteAll(!0)});BrewUtil._pRenderBrewScreen(e,!0)},async pAddEntry(e,n){return BrewUtil._mutUniqueId(n),(BrewUtil.homebrew[e]=BrewUtil.homebrew[e]||[]).push(n),BrewUtil._persistHomebrewDebounced(),BrewUtil.homebrew[e].length-1},async pRemoveEntry(e,n){const _=(BrewUtil.homebrew[e]=BrewUtil.homebrew[e]||[]).findIndex(e=>e.uniqueId===n.uniqueId);if(~_)BrewUtil.homebrew[e].splice(_,1),BrewUtil._persistHomebrewDebounced();else throw new Error(`Could not find object with ID "${n.uniqueId}" in "${e}" list`)},getEntryIxByName(e,n){return(BrewUtil.homebrew[e]=BrewUtil.homebrew[e]||[]).findIndex(e=>e.name===n.name&&e.source===n.source)},async pUpdateEntryByIx(e,n,_){if(~n&&n<BrewUtil.homebrew[e].length)BrewUtil._mutUniqueId(_),BrewUtil.homebrew[e].splice(n,1,_),BrewUtil._persistHomebrewDebounced();else throw new Error(`Index "${n}" was not valid!`)},_mutUniqueId(e){delete e.uniqueId,e.uniqueId=CryptUtil.md5(JSON.stringify(e))},_DIRS:["action","adventure","background","book","boon","class","condition","creature","cult","deity","disease","feat","hazard","item","language","magicvariant","object","optionalfeature","psionic","race","reward","spell","subclass","subrace","table","trap","variantrule","vehicle"],_STORABLE:["class","subclass","spell","monster","legendaryGroup","monsterFluff","background","feat","optionalfeature","race","raceFluff","subrace","deity","item","baseitem","variant","itemProperty","itemType","psionic","reward","object","trap","hazard","variantrule","condition","disease","adventure","adventureData","book","bookData","table","tableGroup","vehicle","action","cult","boon","language"],async pDoHandleBrewJson(e,n,_){await BrewUtil._lockHandleBrewJson.pLock();try{return BrewUtil._pDoHandleBrewJson(e,n,_)}finally{BrewUtil._lockHandleBrewJson.unlock()}},async _pDoHandleBrewJson(e,n,_){async function t(n){if(BrewUtil.homebrew[n]||(BrewUtil.homebrew[n]=[]),IS_DEPLOYED){const _=[],t=BrewUtil.homebrew[n].map(e=>e.uniqueId);return e[n].forEach(e=>{t.find(n=>e.uniqueId===n)||(BrewUtil.homebrew[n].push(e),_.push(e))}),_}else{const _={};BrewUtil.homebrew[n].forEach(e=>{_[e.source]=_[e.source]||{},_[e.source][e.name]=e.uniqueId});const t=BrewUtil._getPDeleteFunction(n);return await Promise.all(e[n].map(async e=>{const o=e.inherits&&e.inherits.source?e.inherits.source:e.source;_[o]&&_[o][e.name]&&(await t(_[o][e.name])),BrewUtil.homebrew[n].push(e)})),e[n]}}function o(){const n=[];return e._meta&&(!BrewUtil.homebrewMeta&&(BrewUtil.homebrewMeta={sources:[]}),Object.keys(e._meta).forEach(_=>{switch(_){case"dateAdded":case"dateLastModified":break;case"sources":{const _=BrewUtil.homebrewMeta.sources.map(e=>e.json);e._meta.sources.forEach(e=>{_.find(n=>n===e.json)||(BrewUtil.homebrewMeta.sources.push(e),n.push(e))});break}default:{BrewUtil.homebrewMeta[_]=BrewUtil.homebrewMeta[_]||{},Object.assign(BrewUtil.homebrewMeta[_],e._meta[_]);break}}})),n}e.race&&e.race.length&&(e.race=Renderer.race.mergeSubraces(e.race)),BrewUtil._STORABLE.forEach(function(n){e[n]?e[n].forEach(e=>BrewUtil._mutUniqueId(e)):e[n]=[]});[["adventure","adventureData"],["book","bookData"]].forEach(([n,_])=>{e[n]&&e[_]&&e[n].forEach(n=>{const t=e[_].find(e=>e.id===n.id);t&&(t.parentUniqueId=n.uniqueId)})});let i=e._meta?e._meta.sources:[];const a={};switch(BrewUtil._STORABLE.forEach(n=>a[n]=e[n]),BrewUtil.homebrew=BrewUtil.homebrew||{},i=o(),await Promise.all(BrewUtil._STORABLE.map(async e=>a[e]=await t(e))),BrewUtil._persistHomebrewDebounced(),StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta),BrewUtil._resetSourceCache(),n){case UrlUtil.PG_SPELLS:case UrlUtil.PG_CLASSES:case UrlUtil.PG_BESTIARY:case UrlUtil.PG_BACKGROUNDS:case UrlUtil.PG_FEATS:case UrlUtil.PG_OPT_FEATURES:case UrlUtil.PG_RACES:case UrlUtil.PG_OBJECTS:case UrlUtil.PG_TRAPS_HAZARDS:case UrlUtil.PG_DEITIES:case UrlUtil.PG_ITEMS:case UrlUtil.PG_REWARDS:case UrlUtil.PG_PSIONICS:case UrlUtil.PG_VARIATNRULES:case UrlUtil.PG_CONDITIONS_DISEASES:case UrlUtil.PG_ADVENTURE:case UrlUtil.PG_ADVENTURES:case UrlUtil.PG_BOOK:case UrlUtil.PG_BOOKS:case UrlUtil.PG_MAKE_SHAPED:case UrlUtil.PG_TABLES:case UrlUtil.PG_VEHICLES:case UrlUtil.PG_ACTIONS:case UrlUtil.PG_CULTS_BOONS:case UrlUtil.PG_LANGUAGES:await(BrewUtil._pHandleBrew||handleBrew)(MiscUtil.copy(a));break;case UrlUtil.PG_MANAGE_BREW:case UrlUtil.PG_MAKE_BREW:case UrlUtil.PG_DEMO_RENDER:case"NO_PAGE":break;default:throw new Error(`No homebrew add function defined for category ${n}`);}if(_&&(await _()),BrewUtil._filterBox&&BrewUtil._sourceFilter){const e=BrewUtil._filterBox.getValues();if(e.Source){const _=JSON.parse(JSON.stringify(e.Source));(_._totals.yes||_._totals.no)&&(n===UrlUtil.PG_CLASSES?_.Core=1:i.forEach(e=>_[e.json]=1),BrewUtil._filterBox.setFromValues({Source:_}))}BrewUtil._filterBox&&BrewUtil._filterBox.fireChangeEvent()}},makeBrewButton:e=>{$(`#${e}`).on("click",()=>BrewUtil.manageBrew())},_getBrewCategories(){return Object.keys(BrewUtil.homebrew).filter(e=>!e.startsWith("_"))},_buildSourceCache(){function e(){BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.sources&&BrewUtil.homebrewMeta.sources.forEach(e=>BrewUtil._sourceCache[e.json.toLowerCase()]={...e})}if(!BrewUtil._sourceCache)if(BrewUtil._sourceCache={},!BrewUtil.homebrewMeta){const n=StorageUtil.syncGet(HOMEBREW_META_STORAGE)||{};n.sources=n.sources||[],BrewUtil.homebrewMeta=n,e()}else e()},_resetSourceCache(){BrewUtil._sourceCache=null},removeJsonSource(e){if(e){e=e.toLowerCase(),BrewUtil._resetSourceCache();const n=BrewUtil.homebrewMeta.sources.findIndex(n=>n.json.toLowerCase()===e);~n&&BrewUtil.homebrewMeta.sources.splice(n,1),StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta)}},getJsonSources(){return BrewUtil._buildSourceCache(),BrewUtil.homebrewMeta&&BrewUtil.homebrewMeta.sources?BrewUtil.homebrewMeta.sources:[]},hasSourceJson(e){return!!e&&(e=e.toLowerCase(),BrewUtil._buildSourceCache(),!!BrewUtil._sourceCache[e])},sourceJsonToFull(e){return e?(e=e.toLowerCase(),BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e].full||e:e):""},sourceJsonToAbv(e){return e?(e=e.toLowerCase(),BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e].abbreviation||e:e):""},sourceJsonToDate(e){return e?(e=e.toLowerCase(),BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e].dateReleased||e:e):""},sourceJsonToSource(e){return e?(e=e.toLowerCase(),BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]?BrewUtil._sourceCache[e]:null):null},sourceJsonToStyle(e){if(!e)return"";e=e.toLowerCase();const n=BrewUtil.sourceJsonToColor(e);return n?`style="color: #${n};"`:""},sourceJsonToColor(e){if(!e)return"";if(e=e.toLowerCase(),BrewUtil._buildSourceCache(),BrewUtil._sourceCache[e]&&BrewUtil._sourceCache[e].color){const n=BrewUtil.getValidColor(BrewUtil._sourceCache[e].color);return n.length?n:""}return""},getValidColor(e){return e.replace(/[^a-fA-F0-9]/g,"").slice(0,8)},addSource(e){BrewUtil._resetSourceCache();const n=BrewUtil.homebrewMeta.sources.some(n=>n.json===e.json);if(n)throw new Error(`Source "${e.json}" already exists!`);(BrewUtil.homebrewMeta.sources=BrewUtil.homebrewMeta.sources||[]).push(e),StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta)},updateSource(e){BrewUtil._resetSourceCache();const n=BrewUtil.homebrewMeta.sources.findIndex(n=>n.json===e.json);if(!~n)throw new Error(`Source "${e.json}" does not exist!`);const _=BrewUtil.homebrewMeta.sources[n].json;BrewUtil.homebrewMeta.sources[n]={...e,json:_},StorageUtil.syncSet(HOMEBREW_META_STORAGE,BrewUtil.homebrewMeta)},_getActiveVetoolsSources(){if(null===BrewUtil.homebrew)throw new Error(`Homebrew was not initialized!`);const e=new Set;return Object.keys(BrewUtil.homebrew).forEach(n=>BrewUtil.homebrew[n].forEach(n=>n.source&&e.add(n.source))),Object.keys(Parser.SOURCE_JSON_TO_FULL).map(e=>({json:e,full:Parser.SOURCE_JSON_TO_FULL[e],abbreviation:Parser.SOURCE_JSON_TO_ABV[e],dateReleased:Parser.SOURCE_JSON_TO_DATE[e]})).sort((e,n)=>SortUtil.ascSort(e.full,n.full)).filter(n=>e.has(n.json))},async pGetSearchIndex(){BrewUtil._buildSourceCache();const e=new Omnidexer(Omnisearch.highestId+1);if(await BrewUtil.pAddBrewData(),BrewUtil.homebrew){const n=[Omnidexer.TO_INDEX__FROM_INDEX_JSON,Omnidexer.TO_INDEX];for(const _ of n)for(const n of _)if((BrewUtil.homebrew[n.brewProp||n.listProp]||[]).length)if(n.pFnPreProcBrew){const _=await n.pFnPreProcBrew(n,BrewUtil.homebrew);e.addToIndex(n,_)}else e.addToIndex(n,BrewUtil.homebrew)}return Omnidexer.decompressIndex(e.getIndex())},async pGetAdditionalSearchIndices(e,n){BrewUtil._buildSourceCache();const _=new Omnidexer(e+1);if(await BrewUtil.pAddBrewData(),BrewUtil.homebrew){const e=[Omnidexer.TO_INDEX__FROM_INDEX_JSON,Omnidexer.TO_INDEX];await Promise.all(e.map(e=>Promise.all(e.filter(e=>e.additionalIndexes&&(BrewUtil.homebrew[e.listProp]||[]).length).map(e=>Promise.all(Object.entries(e.additionalIndexes).filter(([e])=>e===n).map(async([n,t])=>{const o=await t(_,{[e.listProp]:BrewUtil.homebrew[e.listProp]});o.forEach(e=>_.pushToIndex(e))}))))))}return Omnidexer.decompressIndex(_.getIndex())},async pGetAlternateSearchIndices(e,n){BrewUtil._buildSourceCache();const _=new Omnidexer(e+1);if(await BrewUtil.pAddBrewData(),BrewUtil.homebrew){const e=[Omnidexer.TO_INDEX__FROM_INDEX_JSON,Omnidexer.TO_INDEX];e.forEach(e=>{e.filter(e=>e.alternateIndexes&&(BrewUtil.homebrew[e.listProp]||[]).length).forEach(e=>{Object.entries(e.alternateIndexes).filter(([e])=>e===n).map(async([n,t])=>{_.addToIndex(e,BrewUtil.homebrew,{alt:e.alternateIndexes[n]})})})})}return Omnidexer.decompressIndex(_.getIndex())},__pPersistHomebrewDebounced:null,_persistHomebrewDebounced(){null==BrewUtil.__pPersistHomebrewDebounced&&(BrewUtil.__pPersistHomebrewDebounced=MiscUtil.debounce(()=>BrewUtil._pCleanSaveBrew(),125)),BrewUtil.__pPersistHomebrewDebounced()}},CryptUtil={_md5cycle:(e,n)=>{let _=e[0],t=e[1],o=e[2],i=e[3];_=CryptUtil._ff(_,t,o,i,n[0],7,-680876936),i=CryptUtil._ff(i,_,t,o,n[1],12,-389564586),o=CryptUtil._ff(o,i,_,t,n[2],17,606105819),t=CryptUtil._ff(t,o,i,_,n[3],22,-1044525330),_=CryptUtil._ff(_,t,o,i,n[4],7,-176418897),i=CryptUtil._ff(i,_,t,o,n[5],12,1200080426),o=CryptUtil._ff(o,i,_,t,n[6],17,-1473231341),t=CryptUtil._ff(t,o,i,_,n[7],22,-45705983),_=CryptUtil._ff(_,t,o,i,n[8],7,1770035416),i=CryptUtil._ff(i,_,t,o,n[9],12,-1958414417),o=CryptUtil._ff(o,i,_,t,n[10],17,-42063),t=CryptUtil._ff(t,o,i,_,n[11],22,-1990404162),_=CryptUtil._ff(_,t,o,i,n[12],7,1804603682),i=CryptUtil._ff(i,_,t,o,n[13],12,-40341101),o=CryptUtil._ff(o,i,_,t,n[14],17,-1502002290),t=CryptUtil._ff(t,o,i,_,n[15],22,1236535329),_=CryptUtil._gg(_,t,o,i,n[1],5,-165796510),i=CryptUtil._gg(i,_,t,o,n[6],9,-1069501632),o=CryptUtil._gg(o,i,_,t,n[11],14,643717713),t=CryptUtil._gg(t,o,i,_,n[0],20,-373897302),_=CryptUtil._gg(_,t,o,i,n[5],5,-701558691),i=CryptUtil._gg(i,_,t,o,n[10],9,38016083),o=CryptUtil._gg(o,i,_,t,n[15],14,-660478335),t=CryptUtil._gg(t,o,i,_,n[4],20,-405537848),_=CryptUtil._gg(_,t,o,i,n[9],5,568446438),i=CryptUtil._gg(i,_,t,o,n[14],9,-1019803690),o=CryptUtil._gg(o,i,_,t,n[3],14,-187363961),t=CryptUtil._gg(t,o,i,_,n[8],20,1163531501),_=CryptUtil._gg(_,t,o,i,n[13],5,-1444681467),i=CryptUtil._gg(i,_,t,o,n[2],9,-51403784),o=CryptUtil._gg(o,i,_,t,n[7],14,1735328473),t=CryptUtil._gg(t,o,i,_,n[12],20,-1926607734),_=CryptUtil._hh(_,t,o,i,n[5],4,-378558),i=CryptUtil._hh(i,_,t,o,n[8],11,-2022574463),o=CryptUtil._hh(o,i,_,t,n[11],16,1839030562),t=CryptUtil._hh(t,o,i,_,n[14],23,-35309556),_=CryptUtil._hh(_,t,o,i,n[1],4,-1530992060),i=CryptUtil._hh(i,_,t,o,n[4],11,1272893353),o=CryptUtil._hh(o,i,_,t,n[7],16,-155497632),t=CryptUtil._hh(t,o,i,_,n[10],23,-1094730640),_=CryptUtil._hh(_,t,o,i,n[13],4,681279174),i=CryptUtil._hh(i,_,t,o,n[0],11,-358537222),o=CryptUtil._hh(o,i,_,t,n[3],16,-722521979),t=CryptUtil._hh(t,o,i,_,n[6],23,76029189),_=CryptUtil._hh(_,t,o,i,n[9],4,-640364487),i=CryptUtil._hh(i,_,t,o,n[12],11,-421815835),o=CryptUtil._hh(o,i,_,t,n[15],16,530742520),t=CryptUtil._hh(t,o,i,_,n[2],23,-995338651),_=CryptUtil._ii(_,t,o,i,n[0],6,-198630844),i=CryptUtil._ii(i,_,t,o,n[7],10,1126891415),o=CryptUtil._ii(o,i,_,t,n[14],15,-1416354905),t=CryptUtil._ii(t,o,i,_,n[5],21,-57434055),_=CryptUtil._ii(_,t,o,i,n[12],6,1700485571),i=CryptUtil._ii(i,_,t,o,n[3],10,-1894986606),o=CryptUtil._ii(o,i,_,t,n[10],15,-1051523),t=CryptUtil._ii(t,o,i,_,n[1],21,-2054922799),_=CryptUtil._ii(_,t,o,i,n[8],6,1873313359),i=CryptUtil._ii(i,_,t,o,n[15],10,-30611744),o=CryptUtil._ii(o,i,_,t,n[6],15,-1560198380),t=CryptUtil._ii(t,o,i,_,n[13],21,1309151649),_=CryptUtil._ii(_,t,o,i,n[4],6,-145523070),i=CryptUtil._ii(i,_,t,o,n[11],10,-1120210379),o=CryptUtil._ii(o,i,_,t,n[2],15,718787259),t=CryptUtil._ii(t,o,i,_,n[9],21,-343485551),e[0]=CryptUtil._add32(_,e[0]),e[1]=CryptUtil._add32(t,e[1]),e[2]=CryptUtil._add32(o,e[2]),e[3]=CryptUtil._add32(i,e[3])},_cmn:(e,n,_,o,i,a)=>(n=CryptUtil._add32(CryptUtil._add32(n,e),CryptUtil._add32(o,a)),CryptUtil._add32(n<<i|n>>>32-i,_)),_ff:(e,n,_,o,i,a,r)=>CryptUtil._cmn(n&_|~n&o,e,n,i,a,r),_gg:(e,n,_,o,i,a,r)=>CryptUtil._cmn(n&o|_&~o,e,n,i,a,r),_hh:(e,n,_,o,i,a,r)=>CryptUtil._cmn(n^_^o,e,n,i,a,r),_ii:(e,n,_,o,i,a,r)=>CryptUtil._cmn(_^(n|~o),e,n,i,a,r),_md51:e=>{let _,t=e.length,n=[1732584193,-271733879,-1732584194,271733878];for(_=64;_<=e.length;_+=64)CryptUtil._md5cycle(n,CryptUtil._md5blk(e.substring(_-64,_)));e=e.substring(_-64);let o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(_=0;_<e.length;_++)o[_>>2]|=e.charCodeAt(_)<<(_%4<<3);if(o[_>>2]|=128<<(_%4<<3),55<_)for(CryptUtil._md5cycle(n,o),_=0;16>_;_++)o[_]=0;return o[14]=8*t,CryptUtil._md5cycle(n,o),n},_md5blk:e=>{let n=[];for(let _=0;64>_;_+=4)n[_>>2]=e.charCodeAt(_)+(e.charCodeAt(_+1)<<8)+(e.charCodeAt(_+2)<<16)+(e.charCodeAt(_+3)<<24);return n},_hex_chr:["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],_rhex:e=>{let n="";for(let _=0;4>_;_++)n+=CryptUtil._hex_chr[15&e>>8*_+4]+CryptUtil._hex_chr[15&e>>8*_];return n},_add32:(e,n)=>4294967295&e+n,hex:e=>{for(let n=0;n<e.length;n++)e[n]=CryptUtil._rhex(e[n]);return e.join("")},hex2Dec(e){return parseInt(`0x${e}`)},md5:e=>CryptUtil.hex(CryptUtil._md51(e)),hashCode(e){if("string"==typeof e){if(!e)return 0;let n=0;for(let _=0;_<e.length;++_)n=31*n+e.charCodeAt(_);return n}if("number"==typeof e)return e;throw new Error(`No hashCode implementation for ${e}`)},uid(){var e=Math.floor;if(RollerUtil.isCrypto())return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16));else{let n=Date.now();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(n+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(_){const t=0|(n+16*Math.random())%16;return n=e(n/16),("x"===_?t:8|3&t).toString(16)})}}},CollectionUtil={ObjectSet:class{constructor(){this.map=new Map,this[Symbol.iterator]=this.values}add(e){this.map.set(e._toIdString(),e)}values(){return this.map.values()}},setEq(e,n){if(e.size!==n.size)return!1;for(const _ of e)if(!n.has(_))return!1;return!0},setDiff(e,n){return new Set([...e].filter(e=>!n.has(e)))},deepEquals(e,n){if(CollectionUtil._eq_sameValueZeroEqual(e,n))return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){if(CollectionUtil._eq_isPlainObject(e)&&CollectionUtil._eq_isPlainObject(n))return CollectionUtil._eq_areObjectsEqual(e,n);const _=Array.isArray(e),t=Array.isArray(n);if(_||t)return _===t&&CollectionUtil._eq_areArraysEqual(e,n);const o=e instanceof Set,i=n instanceof Set;return o||i?o===i&&CollectionUtil.setEq(e,n):CollectionUtil._eq_areObjectsEqual(e,n)}return!1},_eq_sameValueZeroEqual:(e,n)=>e===n||e!==e&&n!==n,_eq_isPlainObject:e=>e.constructor===Object||null==e.constructor,_eq_areObjectsEqual(e,n){const _=Object.keys(e),{length:t}=_;if(Object.keys(n).length!==t)return!1;for(let o=0;o<t;o++){if(!n.hasOwnProperty(_[o]))return!1;if(!CollectionUtil.deepEquals(e[_[o]],n[_[o]]))return!1}return!0},_eq_areArraysEqual(e,n){const{length:_}=e;if(n.length!==_)return!1;for(let t=0;t<_;t++)if(!CollectionUtil.deepEquals(e[t],n[t]))return!1;return!0}},Array.prototype.last=Array.prototype.last||function(e){return void 0===e?this[this.length-1]:void(this[this.length-1]=e)},Array.prototype.filterIndex=Array.prototype.filterIndex||function(e){const n=[];return this.forEach((_,t)=>{e(_)&&n.push(t)}),n},Array.prototype.equals=Array.prototype.equals||function(e){const n=this;if(!n&&!e)return!0;if(!n&&e||n&&!e)return!1;let _=[];if(!n[0]||!e[0])return!1;if(n.length!==e.length)return!1;let t;for(let o=0;o<n.length;o++)t=`${typeof n[o]}~${n[o]}`,_[t]?_[t]++:_[t]=1;for(let n=0;n<e.length;n++)if(t=`${typeof e[n]}~${e[n]}`,_[t]){if(0===_[t])return!1;_[t]--}else return!1;return!0},Array.prototype.partition=Array.prototype.partition||function(e){return this.reduce(([n,_],t)=>e(t)?[[...n,t],_]:[n,[..._,t]],[[],[]])},Array.prototype.getNext=Array.prototype.getNext||function(e){let n=this.indexOf(e);if(!~n)throw new Error("Value was not in array!");return++n>=this.length&&(n=0),this[n]},Array.prototype.shuffle=Array.prototype.shuffle||function(){for(let e=0;1e4>e;++e)this.sort(()=>Math.random()-.5);return this},Array.prototype.mergeMap=Array.prototype.mergeMap||function(e){return this.map((...n)=>e(...n)).reduce((e,n)=>Object.assign(e,n),{})};function BookModeView(e){e=e||{};const{hashKey:n,$openBtn:_,noneVisibleMsg:t,pageTitle:o,popTblGetNumShown:i,isFlex:a,state:r,stateKey:s}=e;if(n&&s)throw new Error;this.hashKey=n,this.stateKey=s,this.state=r,this.$openBtn=_,this.noneVisibleMsg=t,this.popTblGetNumShown=i,this.active=!1,this._$body=null,this._$wrpBook=null,this.$openBtn.off("click").on("click",()=>{this.stateKey?this.state[this.stateKey]=!0:Hist.cleanSetHash(`${window.location.hash}${HASH_PART_SEP}${this.hashKey}${HASH_SUB_KV_SEP}true`)}),this._doHashTeardown=()=>{this.stateKey?this.state[this.stateKey]=!1:Hist.cleanSetHash(window.location.hash.replace(`${this.hashKey}${HASH_SUB_KV_SEP}true`,""))},this.pOpen=async()=>{if(this.active)return;this.active=!0,document.title=`${o} - 5etools`,this._$body=$(`body`),this._$wrpBook=$(`<div class="bkmv"/>`),this._$body.css("overflow","hidden"),this._$body.addClass("bkmv-active");const n=$(`<span class="delete-icon glyphicon glyphicon-remove"/>`).click(()=>this._doHashTeardown()),_=$(`<div/>`);$$`<div class="bkmv__spacer-name split-v-center no-shrink">${_}${n}</div>`.appendTo(this._$wrpBook);const t=$(`<div class="w-100 flex-col bkmv__wrp-controls"/>`).appendTo(this._$wrpBook);let i=t;if(e.hasPrintColumns){t.addClass("px-2 mt-2");const e=e=>{$(`#bkmv__print-style`).remove(),$(`<style media="print" id="bkmv__print-style">.bkmv__wrp { column-count: ${e}; }</style>`).appendTo($(document.body))},n=StorageUtil.syncGetForPage(BookModeView._BOOK_VIEW_COLUMNS_K),_=$(`<select class="form-control">
				<option value="0">Two (book style)</option>
				<option value="1">One</option>
			</select>`).change(()=>{const n=+_.val();0==n?e(2):e(1),StorageUtil.syncSetForPage(BookModeView._BOOK_VIEW_COLUMNS_K,n)});null!=n&&_.val(n),_.change(),i=$$`<div class="w-100 flex">
				<div class="flex-vh-center"><div class="mr-2 no-wrap help--subtle" title="Applied when printing the page.">Print columns:</div>${_}</div>
			</div>`.appendTo(t)}const r=$(`<div class="bkmv__wrp p-2"/>`);$$`<div class="bkmv__scroller h-100 overflow-y-auto ${a?"flex":""}">${r}</div>`.appendTo(this._$wrpBook);const s=await this.popTblGetNumShown(r,_,i);if(!s){const e=$(`<button class="btn btn-default">Close</button>`).click(()=>this._doHashTeardown());$$`<div class="w-100 flex-col no-shrink bkmv__footer mb-3">
				<div class="mb-2 flex-vh-center"><span class="initial-message">${this.noneVisibleMsg}</span></div>
				<div class="flex-vh-center">${e}</div>
			</div>`.appendTo(this._$wrpBook)}this._$body.append(this._$wrpBook)},this.teardown=()=>{this.active&&(this._$body.css("overflow",""),this._$body.removeClass("bkmv-active"),this._$wrpBook.remove(),this.active=!1)},this.handleSub=e=>{if(!this.stateKey){const n=e.find(e=>e.startsWith(this.hashKey));n&&"true"===UrlUtil.unpackSubHash(n)[this.hashKey][0]?this.pOpen():this.teardown()}}}BookModeView._BOOK_VIEW_COLUMNS_K="bookViewColumns",ExcludeUtil={isInitialised:!1,_excludes:null,async pInitialise(){ExcludeUtil.pSave=MiscUtil.throttle(ExcludeUtil._pSave,50);try{ExcludeUtil._excludes=(await StorageUtil.pGet(EXCLUDES_STORAGE))||[]}catch(n){JqueryUtil.doToast({content:"Error when loading content blacklist! Purged blacklist data. (See the log for more information.)",type:"danger"});try{await StorageUtil.pRemove(EXCLUDES_STORAGE)}catch(n){setTimeout(()=>{throw n})}ExcludeUtil._excludes=null,window.location.hash="",setTimeout(()=>{throw n})}ExcludeUtil.isInitialised=!0},getList(){return ExcludeUtil._excludes||[]},async pSetList(e){ExcludeUtil._excludes=e,await ExcludeUtil.pSave()},_excludeCount:0,isExcluded(e,n,_){if(!ExcludeUtil._excludes||!ExcludeUtil._excludes.length)return!1;_=_.source||_;const t=!!ExcludeUtil._excludes.find(t=>("*"===t.source||t.source===_)&&("*"===t.category||t.category===n)&&("*"===t.name||t.name===e));return t&&++ExcludeUtil._excludeCount,t},checkShowAllExcluded(e,n){(!e.length&&ExcludeUtil._excludeCount||0<e.length&&e.length===ExcludeUtil._excludeCount)&&n.html(`
				<tr><th class="border" colspan="6"></th></tr>
				<tr><td colspan="6" class="initial-message">(Content <a href="blacklist.html">blacklisted</a>)</td></tr>
				<tr><th class="border" colspan="6"></th></tr>
			`)},addExclude(e,n,_){return!ExcludeUtil._excludes.find(t=>t.source===_&&t.category===n&&t.name===e)&&(ExcludeUtil._excludes.push({name:e,category:n,source:_}),ExcludeUtil.pSave(),!0)},removeExclude(e,n,_){const t=ExcludeUtil._excludes.findIndex(t=>t.source===_&&t.category===n&&t.name===e);~t&&(ExcludeUtil._excludes.splice(t,1),ExcludeUtil.pSave())},async _pSave(){return StorageUtil.pSet(EXCLUDES_STORAGE,ExcludeUtil._excludes)},async pSave(){},resetExcludes(){ExcludeUtil._excludes=[],ExcludeUtil.pSave()}},EncounterUtil={async pGetInitialState(){return(await EncounterUtil._pHasSavedStateLocal())?(await EncounterUtil._hasSavedStateUrl())?{type:"url",data:EncounterUtil._getSavedStateUrl()}:{type:"local",data:await EncounterUtil._pGetSavedStateLocal()}:null},_hasSavedStateUrl(){return window.location.hash.length&&null!=Hist.getSubHash(EncounterUtil.SUB_HASH_PREFIX)},_getSavedStateUrl(){let e=null;try{e=JSON.parse(decodeURIComponent(Hist.getSubHash(EncounterUtil.SUB_HASH_PREFIX)))}catch(n){setTimeout(()=>{throw n})}return Hist.setSubhash(EncounterUtil.SUB_HASH_PREFIX,null),e},async _pHasSavedStateLocal(){return!!StorageUtil.pGet(ENCOUNTER_STORAGE)},async _pGetSavedStateLocal(){try{return await StorageUtil.pGet(ENCOUNTER_STORAGE)}catch(n){JqueryUtil.doToast({content:"Error when loading encounters! Purged encounter data. (See the log for more information.)",type:"danger"}),await StorageUtil.pRemove(ENCOUNTER_STORAGE),setTimeout(()=>{throw n})}},async pDoSaveState(e){StorageUtil.pSet(ENCOUNTER_STORAGE,e)},async pGetSavedState(){const e=await StorageUtil.pGet(EncounterUtil.SAVED_ENCOUNTER_SAVE_LOCATION);return e||{}},getEncounterName(e){if(e.l&&e.l.items&&e.l.items.length){const n=e.l.items.sort((e,n)=>SortUtil.ascSort(+n.c,+e.c))[0],_=decodeURIComponent(n.h.split(HASH_LIST_SEP)[0]).toTitleCase();return`Encounter with ${_} ×${n.c}`}return"(Unnamed Encounter)"}},EncounterUtil.SUB_HASH_PREFIX="encounter",EncounterUtil.SAVED_ENCOUNTER_SAVE_LOCATION="ENCOUNTER_SAVED_STORAGE",ExtensionUtil={ACTIVE:!1,_doSend(e,n){window.dispatchEvent(new CustomEvent("rivet.send",{detail:{type:e,data:n}}))},async pDoSendStats(e,n){const _=$(n).closest(`th.rnd-name`),t=_.attr("data-page"),o=_.attr("data-source"),i=_.attr("data-hash");if(t&&o&&i){const n=await Renderer.hover.pCacheAndGet(t,o,i);ExtensionUtil._doSend("entity",{page:t,entity:n,isTemp:!!e.shiftKey})}},doSendRoll(e){ExtensionUtil._doSend("roll",e)}},"undefined"!=typeof window&&window.addEventListener("rivet.active",()=>ExtensionUtil.ACTIVE=!0);class Reactor{constructor(){this.rvents={}}_registerEvent(e){this.rvents[e]=new ReactorEvent(e)}fire(e,n){this.rvents[e]&&this.rvents[e].callbacks.forEach(e=>e(n))}on(e,n){this.rvents[e]||this._registerEvent(e),this.rvents[e]._registerCallback(n)}off(e,n){this.rvents[e]&&this.rvents[e]._unregisterCallback(n)}}class ReactorEvent{constructor(e){this.name=e,this.callbacks=[]}_registerCallback(e){this.callbacks.push(e)}_unregisterCallback(e){const n=this.callbacks.indexOf(e);this.callbacks.splice(n,1)}}class TokenUtil{static imgError(e){e&&$(e).parent().remove(),$(`.rnd-name`).find(`span.stats-source`).css("margin-right","0")}static handleStatblockScroll(e,n){$(`#token_image`).toggle(32>n.scrollTop).css({opacity:(32-n.scrollTop)/32,top:-n.scrollTop})}}class VeLock{constructor(){this._lockMeta=null}async pLock(){for(;this._lockMeta;)await this._lockMeta.lock;let e=null;const n=new Promise(n=>e=n);this._lockMeta={lock:n,unlock:e}}unlock(){const e=this._lockMeta;e&&(this._lockMeta=null,e.unlock())}}BrewUtil._lockHandleBrewJson=new VeLock,IS_VTT||"undefined"==typeof window||setTimeout(()=>{const e=$(`.cancer__wrp-leaderboard`),n=e.outerHeight();e.css({height:n})},5e3),_Donate={cycleLeader(e){_Donate._cycleMode(e,[{width:970,height:90},{width:970,height:250},{width:320,height:50},{width:728,height:90}])},cycleSide(e){_Donate._cycleMode(e,[{width:300,height:250},{width:300,height:600}])},_cycleMode(e,n){const _=$(e),t=_.data("pos")||0,o=n[t];_.css(o),_.text(`${o.width}*${o.height}`),_.data("pos",(t+1)%n.length)}};;
"use strict";class Prx{static addHook(e,t){this.px._hooks[e]=this.px._hooks[e]||[],this.px._hooks[e].push(t)}static addHookAll(e){this.px._hooksAll.push(e)}static toString(){return JSON.stringify(this,(e,t)=>"px"===e?void 0:t)}static copy(){return JSON.parse(Prx.toString.bind(this)())}static get(e){return e.px={addHook:Prx.addHook.bind(e),addHookAll:Prx.addHookAll.bind(e),toString:Prx.toString.bind(e),copy:Prx.copy.bind(e),_hooksAll:[],_hooks:{}},new Proxy(e,{set:(t,o,d)=>(t[o]=d,e.px._hooksAll.forEach(e=>e(o,d)),e.px._hooks[o]&&e.px._hooks[o].forEach(e=>e(o,d)),!0),deleteProperty:(t,o)=>(delete t[o],e.px._hooksAll.forEach(e=>e(o,null)),e.px._hooks[o]&&e.px._hooks[o].forEach(e=>e(o,null)),!0)})}}class ProxyBase{constructor(){this.__hooks={},this.__hooksAll={},this.__hooksTmp=null,this.__hooksAllTmp=null}_getProxy(e,t){return new Proxy(t,{set:(t,o,d)=>(t[o]=d,this.__hooksAll[e]&&this.__hooksAll[e].forEach(e=>e(o,d)),this.__hooks[e]&&this.__hooks[e][o]&&this.__hooks[e][o].forEach(e=>e(o,d)),!0),deleteProperty:(t,o)=>(delete t[o],this.__hooksAll[e]&&this.__hooksAll[e].forEach(e=>e(o,null)),this.__hooks[e]&&this.__hooks[e][o]&&this.__hooks[e][o].forEach(e=>e(o,null)),!0)})}_addHook(e,t,o){ProxyBase._addHook_to(this.__hooks,e,t,o),this.__hooksTmp&&ProxyBase._addHook_to(this.__hooksTmp,e,t,o)}static _addHook_to(e,t,o,d){((e[t]=e[t]||{})[o]=e[t][o]||[]).push(d)}_addHookAll(e,t){ProxyBase._addHookAll_to(this.__hooksAll,e,t),this.__hooksAllTmp&&ProxyBase._addHookAll_to(this.__hooksAllTmp,e,t)}static _addHookAll_to(e,t,o){(e[t]=e[t]||[]).push(o)}_removeHook(e,t,o){ProxyBase._removeHook_from(this.__hooks,e,t,o),this.__hooksTmp&&ProxyBase._removeHook_from(this.__hooksTmp,e,t,o)}static _removeHook_from(e,t,o,d){if(e[t]&&e[t][o]){const n=e[t][o].findIndex(e=>e===d);~n&&e[t][o].splice(n,1)}}_removeHookAll(e,t){ProxyBase._removeHookAll_from(this.__hooksAll,e,t),this.__hooksAllTmp&&ProxyBase._removeHook_from(this.__hooksAllTmp,e,t)}static _removeHookAll_from(e,t,o){if(e[t]){const d=e[t].findIndex(e=>e===o);~d&&e[t].splice(d,1)}}_resetHooks(e){e===void 0?Object.keys(this.__hooks).forEach(e=>delete this.__hooks[e]):delete this.__hooks[e]}_resetHooksAll(e){e===void 0?Object.keys(this.__hooksAll).forEach(e=>delete this.__hooksAll[e]):delete this.__hooksAll[e]}_saveHookCopiesTo(e){this.__hooksTmp=e}_saveHookAllCopiesTo(e){this.__hooksAllTmp=e}_proxyAssign(e,t,o,d,n){const a=Object.keys(this[t]),i=new Set(Object.keys(d)),s=new Set;n&&a.forEach(e=>{i.has(e)||this[o]===void 0||(delete this[o][e],s.add(e))}),i.forEach(e=>{CollectionUtil.deepEquals(this[o][e],d[e])||(this[o][e]=d[e],s.add(e))}),s.forEach(t=>{this.__hooksAll[e]&&this.__hooksAll[e].forEach(e=>e(t,this[o][t])),this.__hooks[e]&&this.__hooks[e][t]&&this.__hooks[e][t].forEach(e=>e(t,this[o][t]))})}}class UiUtil{static strToInt(e,t=0,o){return UiUtil._strToNumber(e,t,o,!0)}static strToNumber(e,t=0,o){return UiUtil._strToNumber(e,t,o,!1)}static _strToNumber(e,t=0,o,d){var n=Math.max,a=Math.min;o=o||{};let i;if(e=e.trim(),!e)i=t;else{const t=UiUtil._parseStrAsNumber(e,d);i=isNaN(t)||!isFinite(t)?void 0===o.fallbackOnNaN?0:o.fallbackOnNaN:t}return null!=o.max&&(i=a(i,o.max)),null!=o.min&&(i=n(i,o.min)),i}static strToBool(e,t=null,o){return(o=o||{},!e)?t:(e=e.trim().toLowerCase(),e?"true"===e||"false"!==e&&o.fallbackOnNaB:t)}static intToBonus(e){return`${0<=e?"+":""}${e}`}static getEntriesAsText(e){return e&&e.length?JSON.stringify(e,null,2).replace(/^\s*\[/,"").replace(/]\s*$/,"").split("\n").filter(e=>e.trim()).map(e=>{const t=e.replace(/^\s\s/,""),o=/^"(.*?)",?$/.exec(t);return o?o[1]:`  ${t}`}).join("\n"):""}static getTextAsEntries(t){try{const e=[];return t.split("\n").filter(e=>e.trim()).forEach(t=>{/^\s/.exec(t)?e.push(t):e.push(`"${t.replace(/"/g,`\\"`)}",`)}),e.length&&(e[e.length-1]=e.last().replace(/^(.*?),?$/,"$1")),JSON.parse(`[${e.join("")}]`)}catch(o){const e=t.split("\n").filter(e=>e.trim()),d=e.join(" \\ ").substring(0,30);return JqueryUtil.doToast({content:`Could not parse entries! Error was: ${o.message}<br>Text was: ${d}${30===d.length?"...":""}`,type:"danger"}),e}}static getShowModal(e){e=e||{},UiUtil._initModalEscapeHandler(),$(document.activeElement).blur();const t=async(t,...d)=>{e.cbClose&&(await e.cbClose(t,...d)),o.remove();const n=UiUtil._MODAL_STACK.indexOf(a);~n&&UiUtil._MODAL_STACK.splice(n,1)},o=$(`<div class="ui-modal__overlay">`);null!=e.zIndex&&o.css({zIndex:e.zIndex}),null!=e.overlayColor&&o.css({backgroundColor:e.overlayColor});const d=$(`<div class="ui-modal__scroller flex-col"/>`),n=$$`<div class="ui-modal__inner flex-col dropdown-menu ${e.isLarge?`ui-modal__inner--large `:""}${e.fullHeight?"h-100":""}">
			<div class="split-v-center no-shrink">
				${e.title?`<h4>${e.title.escapeQuotes()}</h4>`:""}${e.titleSplit||""}
			</div>
			${d}
		</div>`.appendTo(o);e.noMinHeight&&n.css("height","initial"),o.click(d=>{if(d.target===o[0]){if(e.isPermanent)return;t(!1)}}),$(document.body).append(o);const a={isPermanent:e.isPermanent,handleCloseClick:t};return UiUtil._MODAL_STACK.push(a),{$modalInner:d,doClose:t}}static _initModalEscapeHandler(){UiUtil._MODAL_STACK||(UiUtil._MODAL_STACK=[],$(document.body).keydown(e=>{if(UiUtil._MODAL_STACK.length&&e.target===document.body&&27===e.which){const e=UiUtil._MODAL_STACK.last();e.isPermanent||e.handleCloseClick(!1)}}))}static addModalSep(e){e.append(`<hr class="ui-modal__row-sep">`)}static $getAddModalRow(e,t="div"){return $(`<${t} class="ui-modal__row"/>`).appendTo(e)}static $getAddModalRowHeader(e,t,o){o=o||{};const d=UiUtil.$getAddModalRow(e,"h5").addClass("bold");return o.$eleRhs?$$`<div class="split flex-v-center w-100 pr-1"><span>${t}</span>${o.$eleRhs}</div>`.appendTo(d):d.text(t),o.helpText&&d.title(o.helpText),d}static $getAddModalRowCb(e,t,o,d,n){const a=UiUtil.$getAddModalRow(e,"label").addClass(`ui-modal__row--cb`);n&&a.title(n),a.append(`<span>${t}</span>`);const i=$(`<input type="checkbox">`).appendTo(a).prop("checked",o[d]).on("change",()=>o[d]=i.prop("checked"));return i}static $getAddModalRowSel(e,t,o,d,n,a){a=a||{};const i=UiUtil.$getAddModalRow(e,"label").addClass(`ui-modal__row--sel`);a.helpText&&i.title(a.helpText),i.append(`<span>${t}</span>`);const s=$(`<select class="form-control input-xs w-30">`).appendTo(i);n.forEach((e,t)=>$(`<option value="${t}"/>`).text(a.fnDisplay?a.fnDisplay(e):e).appendTo(s));const r=n.indexOf(o[d]);return s.val(`${~r?r:0}`).change(()=>o[d]=n[s.val()]),s}static _parseStrAsNumber(e,t){var o=Math.round;const d=Renderer.dice.lang.getTree3(e);if(!d)return NaN;const n=d.evl({});return!isNaN(n)&&t?o(n):n}}UiUtil.SEARCH_RESULTS_CAP=75,UiUtil.TYPE_TIMEOUT_MS=100,UiUtil._MODAL_STACK=null;class ProfUiUtil{static getProfCycler(e=0,t){t=t||{};const o=t.isSimple?Object.keys(ProfUiUtil.PROF_TO_FULL).slice(0,2):Object.keys(ProfUiUtil.PROF_TO_FULL),d=Object.keys(o).length;e=+e||0,e>=d?e=d-1:0>e&&(e=0);const n=$(`<button class="ui-prof__btn-cycle"/>`).click(()=>{n.attr("data-state",++e>=d?e=0:e).title(ProfUiUtil.PROF_TO_FULL[e].name).trigger("change")}).contextmenu(t=>{t.preventDefault(),n.attr("data-state",0>--e?e=d-1:e).title(ProfUiUtil.PROF_TO_FULL[e].name).trigger("change")}),a=t=>{e=t,e>d?e=0:0>e&&(e=d-1),n.attr("data-state",e).title(ProfUiUtil.PROF_TO_FULL[e].name)};return{$ele:n,setState:a,getState:()=>e}}}ProfUiUtil.PROF_TO_FULL={0:{name:"No proficiency",mult:0},1:{name:"Proficiency",mult:1},2:{name:"Expertise",mult:2},3:{name:"Half proficiency",mult:.5}};class TabUiUtil{static decorate(e){e.__tabMetas={},e._getTab=function(t,o,d){d.tabGroup=d.tabGroup||"_default";const n=`activeTab__${d.tabGroup}`;e.__tabMetas[d.tabGroup]||(e.__tabMetas[d.tabGroup]=[]);const a=e.__tabMetas[d.tabGroup];d.stateObj[n]=d.stateObj[n]||0;const i=d.stateObj[n]===t,s=$(`<button class="btn btn-default stat-tab ${i?"stat-tab-sel":""}">${o}</button>`).click(()=>{const e=a[d.stateObj[n]];e.$btnTab.removeClass("stat-tab-sel"),e.$wrpTab.toggleClass("hidden",!0),d.stateObj[n]=t,s.addClass("stat-tab-sel"),r.toggleClass("hidden",!1),d.cbTabChange&&d.cbTabChange()}),r=$(`<div class="ui-tab__wrp-tab-body ${i?"":"hidden"} ${d.hasBorder?"ui-tab__wrp-tab-body--border":""}"/>`),l={ix:t,$btnTab:s,$wrpTab:r};return a[t]=l,l},e._resetTabs=function(t){t=t||"_default",e.__tabMetas[t]=[]}}}class SearchUiUtil{static async pDoGlobalInit(){elasticlunr.clearStopWords(),await Renderer.item.populatePropertyAndTypeReference()}static _isNoHoverCat(e){return SearchUiUtil.NO_HOVER_CATEGORIES.has(e)}static async pGetContentIndices(e){var t=Math.max;e=e||{};const o={},d=Omnidexer.decompressIndex((await DataUtil.loadJSON(`${Renderer.get().baseUrl}search/index.json`))),n={};e.additionalIndices&&(await Promise.all(e.additionalIndices.map(async e=>{n[e]=Omnidexer.decompressIndex((await DataUtil.loadJSON(`${Renderer.get().baseUrl}search/index-${e}.json`)));const t=n[e].last().id,o=await BrewUtil.pGetAdditionalSearchIndices(t,e);o.length&&(n[e]=n[e].concat(o))})));const a={};e.alternateIndices&&(await Promise.all(e.alternateIndices.map(async e=>{a[e]=Omnidexer.decompressIndex((await DataUtil.loadJSON(`${Renderer.get().baseUrl}search/index-alt-${e}.json`)));const t=a[e].last().id,o=await BrewUtil.pGetAlternateSearchIndices(t,e);o.length&&(a[e]=a[e].concat(o))})));const i=e=>e.d;o.ALL=elasticlunr(function(){this.addField("n"),this.addField("s"),this.setRef("id")}),SearchUtil.removeStemmer(o.ALL);let s=0;const r=e=>{o[e.cf]||(o[e.cf]=elasticlunr(function(){this.addField("n"),this.addField("s"),this.setRef("id")}),SearchUtil.removeStemmer(o[e.cf]))},l=(e,d)=>{SearchUiUtil._isNoHoverCat(e.c)||i(e)||(e.cf=e.c===Parser.CAT_ID_CREATURE?"Creature":Parser.pageCategoryToFull(e.c),d&&(e.cf=`alt_${e.cf}`),r(e),!d&&o.ALL.addDoc(e),o[e.cf].addDoc(e),s=t(s,e.id))};d.forEach(e=>l(e)),Object.values(n).forEach(e=>e.forEach(e=>l(e))),Object.values(a).forEach(e=>e.forEach(e=>l(e,!0))),Omnisearch.highestId=t(s,Omnisearch.highestId);const p=await BrewUtil.pGetSearchIndex();return p.forEach(e=>{SearchUiUtil._isNoHoverCat(e.c)||i(e)||(e.cf=Parser.pageCategoryToFull(e.c),e.cf=e.c===Parser.CAT_ID_CREATURE?"Creature":Parser.pageCategoryToFull(e.c),r(e),o.ALL.addDoc(e),o[e.cf].addDoc(e))}),o}}SearchUiUtil.NO_HOVER_CATEGORIES=new Set([Parser.CAT_ID_ADVENTURE,Parser.CAT_ID_QUICKREF]);class SearchWidget{static getSearchNoResults(){return`<div class="ui-search__message"><i>No results.</i></div>`}static getSearchLoading(){return`<div class="ui-search__message"><i>\u2022\u2022\u2022</i></div>`}static getSearchEnter(){return`<div class="ui-search__message"><i>Enter a search.</i></div>`}static bindAutoSearch(e,t){SearchWidget.bindTypingEnd({$iptSearch:e,fnKeyup:()=>{t.fnSearch()},fnKeypress:e=>{13===e.which&&(t.flags.doClickFirst=!0,t.fnSearch())},fnKeydown:e=>{if(t.flags.isWait)t.flags.isWait=!1,t.fnShowWait();else switch(e.which){case 40:t.$ptrRows&&t.$ptrRows._[0]&&(e.preventDefault(),t.$ptrRows._[0].focus());}},fnClick:()=>{e.val()&&e.val().trim().length&&t.fnSearch()}})}static bindTypingEnd({$iptSearch:e,fnKeyup:t,fnKeypress:o,fnKeydown:d,fnClick:n}={}){let a;e.on("keyup search",e=>{clearTimeout(a),a=setTimeout(()=>{t(e)},UiUtil.TYPE_TIMEOUT_MS)}).on("keypress",t=>{o&&o(t)}).on("keydown",e=>{d&&d(e),clearTimeout(a)}).on("click",()=>{n&&n()})}static bindRowHandlers({result:e,$row:t,$ptrRows:o,fnHandleClick:d}){return t.keydown(n=>{switch(n.which){case 13:return d(e);case 38:{n.preventDefault();const e=o._.indexOf(t),d=o._[e-1];d?d.focus():o.focus();break}case 40:{n.preventDefault();const e=o._.indexOf(t),d=o._[e+1];d&&d.focus();break}}}).click(()=>d(e))}constructor(e,t,o){o=o||{},this._indexes=e,this._cat=o.defaultCategory||"ALL",this._cbSearch=t,this._resultFilter=o.resultFilter||null,this._searchOptions=o.searchOptions||null,this._fnTransform=o.fnTransform||null,this._flags={doClickFirst:!1,isWait:!1},this._$ptrRows={_:[]},this._$selCat=null,this._$iptSearch=null,this._$wrpResults=null,this._$rendered=null}static pDoGlobalInit(){return SearchWidget.P_LOADING_CONTENT||(SearchWidget.P_LOADING_CONTENT=(async()=>{Object.assign(SearchWidget.CONTENT_INDICES,(await SearchUiUtil.pGetContentIndices({additionalIndices:["item"],alternateIndices:["spell"]})))})()),SearchWidget.P_LOADING_CONTENT}__getSearchOptions(){return this._searchOptions||{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0}}__$getRow(e){return $(`<div class="ui-search__row" tabindex="0">
			<span>${e.doc.n}</span>
			<span>${e.doc.s?`<i title="${Parser.sourceJsonToFull(e.doc.s)}">${Parser.sourceJsonToAbv(e.doc.s)}${e.doc.p?` p${e.doc.p}`:""}</i>`:""}</span>
		</div>`)}static __getAllTitle(){return"All Categories"}static __getCatOptionText(e){return e}get $wrpSearch(){return this._$rendered||this._render(),this._$rendered}__showMsgInputRequired(){this._flags.isWait=!0,this._$wrpResults.empty().append(SearchWidget.getSearchEnter())}__showMsgWait(){this._$wrpResults.empty().append(SearchWidget.getSearchLoading())}__showMsgNoResults(){this._flags.isWait=!0,this._$wrpResults.empty().append(SearchWidget.getSearchEnter())}__doSearch(){const e=this._$iptSearch.val().trim(),t=this._indexes[this._cat],o=t.search(e,this.__getSearchOptions()),{toProcess:d,resultCount:n}=(()=>{if(o.length){if(this._resultFilter){const e=o.filter(e=>this._resultFilter(e.doc));return{toProcess:e.slice(0,UiUtil.SEARCH_RESULTS_CAP),resultCount:e.length}}return{toProcess:o.slice(0,UiUtil.SEARCH_RESULTS_CAP),resultCount:o.length}}if(this._resultFilter){const e=Object.values(t.documentStore.docs).filter(e=>this._resultFilter(e)).map(e=>({doc:e}));return{toProcess:e.slice(0,UiUtil.SEARCH_RESULTS_CAP),resultCount:e.length}}return{toProcess:Object.values(t.documentStore.docs).slice(0,UiUtil.SEARCH_RESULTS_CAP).map(e=>({doc:e})),resultCount:Object.values(t.documentStore.docs).length}})();if(this._$wrpResults.empty(),this._$ptrRows._=[],d.length){const e=e=>{if(this._fnTransform)this._cbSearch(this._fnTransform(e.doc));else{const t=UrlUtil.categoryToPage(e.doc.c),o=e.doc.s,d=e.doc.u;this._cbSearch(t,o,d)}};if(this._flags.doClickFirst)return e(d[0]),void(this._flags.doClickFirst=!1);const t=d.slice(0,UiUtil.SEARCH_RESULTS_CAP);if(t.forEach(t=>{const o=this.__$getRow(t).appendTo(this._$wrpResults);SearchWidget.bindRowHandlers({result:t,$row:o,$ptrRows:this._$ptrRows,fnHandleClick:e}),this._$ptrRows._.push(o)}),n>UiUtil.SEARCH_RESULTS_CAP){const e=n-UiUtil.SEARCH_RESULTS_CAP;this._$wrpResults.append(`<div class="ui-search__row ui-search__row--readonly">...${e} more result${1==e?" was":"s were"} hidden. Refine your search!</div>`)}}else e.trim()?this.__showMsgNoResults():this.__showMsgInputRequired()}_render(){if(!this._$rendered){this._$rendered=$(`<div class="ui-search__wrp-output"/>`);const e=$(`<div class="ui-search__wrp-controls"/>`).appendTo(this._$rendered);this._$selCat=$(`<select class="form-control ui-search__sel-category">
				<option value="ALL">${SearchWidget.__getAllTitle()}</option>
				${Object.keys(this._indexes).sort().filter(e=>"ALL"!==e).map(e=>`<option value="${e}">${SearchWidget.__getCatOptionText(e)}</option>`).join("")}
			</select>`).appendTo(e).toggle(1!==Object.keys(this._indexes).length).on("change",()=>{this._cat=this._$selCat.val(),this.__doSearch()}),this._$iptSearch=$(`<input class="ui-search__ipt-search search form-control" autocomplete="off" placeholder="Search...">`).appendTo(e),this._$wrpResults=$(`<div class="ui-search__wrp-results"/>`).appendTo(this._$rendered),SearchWidget.bindAutoSearch(this._$iptSearch,{flags:this._flags,fnSearch:this.__doSearch.bind(this),fnShowWait:this.__showMsgWait.bind(this),$ptrRows:this._$ptrRows}),this.__doSearch()}}doFocus(){this._$iptSearch.focus()}static addToIndexes(e,t){const o=Object.values(SearchWidget.CONTENT_INDICES.ALL.documentStore.docs).length,d=new Omnidexer(o),n={[e]:[t]};Omnidexer.TO_INDEX__FROM_INDEX_JSON.filter(t=>t.listProp===e).forEach(e=>d.addToIndex(e,n)),Omnidexer.TO_INDEX.filter(t=>t.listProp===e).forEach(e=>d.addToIndex(e,n));const a=Omnidexer.decompressIndex(d.getIndex());a.forEach(e=>{e.cf=e.c===Parser.CAT_ID_CREATURE?"Creature":Parser.pageCategoryToFull(e.c),SearchWidget.CONTENT_INDICES.ALL.addDoc(e),SearchWidget.CONTENT_INDICES[e.cf].addDoc(e)})}static async pGetUserSpellSearch(e){e=e||{},await SearchWidget.P_LOADING_CONTENT;const t={};null!=e.level&&(t.resultFilter=t=>t.lvl===e.level);const o=0===e.level?"Select Cantrip":"Select Spell";return SearchWidget.pGetUserEntitySearch(o,"alt_Spell",(e,t)=>`{@spell ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(t)}`}}`,t)}static async pGetUserFeatSearch(){await SearchWidget.pLoadCustomIndex("entity_Feats",`${Renderer.get().baseUrl}data/feats.json`,"feat",Parser.CAT_ID_FEAT,UrlUtil.PG_FEATS,"feats");return SearchWidget.pGetUserEntitySearch("Select Feat","entity_Feats",(e,t)=>`{@feat ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(t)}`}}`)}static async pGetUserBackgroundSearch(){await SearchWidget.pLoadCustomIndex("entity_Backgrounds",`${Renderer.get().baseUrl}data/backgrounds.json`,"background",Parser.CAT_ID_BACKGROUND,UrlUtil.PG_BACKGROUNDS,"backgrounds");return SearchWidget.pGetUserEntitySearch("Select Background","entity_Backgrounds",(e,t)=>`{@background ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(t)}`}}`)}static async pGetUserRaceSearch(){await SearchWidget.pLoadCustomIndex("entity_Races",async()=>{const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/races.json`),t=Renderer.race.mergeSubraces(e.race);return{race:t}},"race",Parser.CAT_ID_RACE,UrlUtil.PG_RACES,"races");return SearchWidget.pGetUserEntitySearch("Select Race","entity_Races",(e,t)=>`{@race ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(t)}`}}`)}static async pGetUserOptionalFeatureSearch(){await SearchWidget.pLoadCustomIndex("entity_OptionalFeatures",`${Renderer.get().baseUrl}data/optionalfeatures.json`,"optionalfeature",Parser.CAT_ID_OPTIONAL_FEATURE_OTHER,UrlUtil.PG_OPT_FEATURES,"optional features");return SearchWidget.pGetUserEntitySearch("Select Optional Feature","entity_OptionalFeatures",(e,t)=>`{@optfeature ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(t)}`}}`)}static async pGetUserCreatureSearch(){await SearchWidget.P_LOADING_CONTENT;return SearchWidget.pGetUserEntitySearch("Select Creature","Creature",(e,t)=>`{@creature ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_PHB)?"":`|${decodeURIComponent(t)}`}}`,{})}static async __pLoadItemIndex(e){const t=null==e?"entity_Items":e?"entity_ItemsBasic":"entity_ItemsMagic";return SearchWidget.pLoadCustomIndex(t,async()=>{const t=await Renderer.item.pBuildList({isBlacklistVariants:!0});return{item:t.filter(t=>{if("GV"===t.type)return!1;if(null==e)return!0;const o="None"===t.rarity||"Unknown"===t.rarity||"Basic"===t._category;return e?o:!o})}},"item",Parser.CAT_ID_ITEM,UrlUtil.PG_ITEMS,"items")}static async __pGetUserItemSearch(e){const t=null==e?"entity_Items":e?"entity_ItemsBasic":"entity_ItemsMagic";return SearchWidget.pGetUserEntitySearch("Select Item",t,(e,t)=>`{@item ${decodeURIComponent(e)}${t===UrlUtil.encodeForHash(SRC_DMG)?"":`|${decodeURIComponent(t)}`}}`)}static async pGetUserBasicItemSearch(){return await SearchWidget.__pLoadItemIndex(!0),SearchWidget.__pGetUserItemSearch(!0)}static async pGetUserMagicItemSearch(){return await SearchWidget.__pLoadItemIndex(!1),SearchWidget.__pGetUserItemSearch(!1)}static async pGetUserItemSearch(){return await SearchWidget.__pLoadItemIndex(),SearchWidget.__pGetUserItemSearch()}static async pGetUserEntitySearch(e,t,o,d){return d=d||{},new Promise(n=>{const a={defaultCategory:t};d.resultFilter&&(a.resultFilter=d.resultFilter);const i=new SearchWidget({[t]:SearchWidget.CONTENT_INDICES[t]},(e,t,d)=>{const[a]=d.split(HASH_LIST_SEP),i=decodeURIComponent(a);r(!1),n({page:e,source:t,hash:d,name:i,tag:o(i,t)})},a),{$modalInner:s,doClose:r}=UiUtil.getShowModal({title:e,cbClose:e=>{i.$wrpSearch.detach(),e&&n(null)}});s.append(i.$wrpSearch),i.doFocus()})}static async pLoadCustomIndex(e,t,o,d,n,a){if(SearchWidget.P_LOADING_INDICES[e])await SearchWidget.P_LOADING_INDICES[e];else{const i=SearchWidget._showLoadingModal();try{SearchWidget.P_LOADING_INDICES[e]=SearchWidget.CONTENT_INDICES[e]=await SearchWidget._pGetIndex(t,o,d,n),SearchWidget.P_LOADING_INDICES[e]=null}catch(t){throw JqueryUtil.doToast({type:"danger",content:`Could not load ${a}! ${MiscUtil.STR_SEE_CONSOLE}`}),t}finally{i()}}}static async _pGetIndex(e,t,o,d){const n=elasticlunr(function(){this.addField("n"),this.addField("s"),this.setRef("id")}),[a,i]=await Promise.all(["string"==typeof e?DataUtil.loadJSON(e):e(),BrewUtil.pAddBrewData()]);return a[t].concat(i[t]||[]).forEach((e,t)=>n.addDoc({id:t,c:o,cf:Parser.pageCategoryToFull(o),h:1,n:e.name,p:e.page,s:e.source,u:UrlUtil.URL_TO_HASH_BUILDER[d](e)})),n}static _showLoadingModal(){const{$modalInner:e,doClose:t}=UiUtil.getShowModal({isPermanent:!0});return $(`<div class="flex-vh-center w-100 h-100"><span class="dnd-font italic text-muted">Loading...</span></div>`).appendTo(e),t}}SearchWidget.P_LOADING_CONTENT=null,SearchWidget.CONTENT_INDICES={},SearchWidget.P_LOADING_INDICES={};class InputUiUtil{static pGetUserNumber(e){var t=Math.round,o=Math.max,d=Math.min;return e=e||{},new Promise(n=>{const a=$(`<input class="form-control mb-2 text-right" ${e.min?`min="${e.min}"`:""} ${e.max?`max="${e.max}"`:""} ${null==e.default?"":`value="${e.default}"`}>`).keydown(e=>{13===e.which&&r(!0),e.stopPropagation()}),i=$(`<button class="btn btn-default">Enter</button>`).click(()=>r(!0)),{$modalInner:s,doClose:r}=UiUtil.getShowModal({title:e.title||"Enter a Number",noMinHeight:!0,cbClose:i=>{if(!i)return n(null);const s=a.val();if(!s.trim())return n(null);let r=UiUtil.strToInt(s);return e.min&&(r=o(e.min,r)),e.max&&(r=d(e.max,r)),e.int?n(t(r)):void n(r)}});e.$elePre&&e.$elePre.appendTo(s),a.appendTo(s),e.$elePost&&e.$elePost.appendTo(s),$$`<div class="flex-vh-center">${i}</div>`.appendTo(s),a.focus(),a.select()})}static pGetUserBoolean(e){return e=e||{},new Promise(t=>{const o=$(`<button class="btn btn-primary flex-v-center mr-2"><span class="glyphicon glyphicon-ok mr-2"/><span>${e.textYes||"Yes"}</span></button>`).click(()=>a(!0,!0)),d=$(`<button class="btn btn-default flex-v-center"><span class="glyphicon glyphicon-remove mr-2"/><span>${e.textNo||"No"}</span></button>`).click(()=>a(!0,!1)),{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Choose",noMinHeight:!0,cbClose:(e,o)=>{if(!e)return t(null);if(null==o)throw new Error(`Callback must receive a value!`);t(o)}});$$`<div class="flex-vh-center py-1">${o}${d}</div>`.appendTo(n),o.focus(),o.select()})}static pGetUserEnum(e){return e=e||{},new Promise(t=>{const o=$(`<select class="form-control mb-2"><option value="-1" disabled>${e.placeholder||"Select..."}</option></select>`);e.values.forEach((t,d)=>$(`<option value="${d}"/>`).text(e.fnDisplay?e.fnDisplay(t,d):t).appendTo(o)),null==e.default?o[0].selectedIndex=0:o.val(e.default);const d=$(`<button class="btn btn-default">Confirm</button>`).click(()=>a(!0)),{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Select an Option",noMinHeight:!0,cbClose:d=>{if(!d)return t(null);const n=+o.val();if(!~n)return t(null);if(e.fnGetExtraState){const o={extraState:e.fnGetExtraState()};e.isResolveItem?o.item=e.values[n]:o.ix=n,t(o)}else t(e.isResolveItem?e.values[n]:n)}});o.appendTo(n),e.$elePost&&e.$elePost.appendTo(n),$$`<div class="flex-vh-center">${d}</div>`.appendTo(n),o.focus()})}static pGetUserMultipleChoice(e){if(e=e||{},null!=e.count&&(null!=e.min||null!=e.max))throw new Error(`Chooser must be either in "count" mode or "min/max" mode!`);null==e.count&&null==e.min&&null==e.max&&(e.count=1);class t extends BaseComponent{_getDefaultState(){return{isActive:!1}}}return new Promise(o=>{const d=$(`<button class="btn btn-default">Confirm</button>`).click(()=>r(!0)),n=[];e.values.forEach((o,a)=>{const i=new t;e.defaults&&(i._state.isActive=e.defaults.includes(a));const s=ComponentUiUtil.$getCbBool(i,"isActive"),r=()=>{var t=Number.MAX_SAFE_INTEGER;const o=n.filter(e=>e.comp._state.isActive);let a=!1;null==e.count?o.length>=(e.min||0)&&o.length<=(e.max||t)&&(a=!0):o.length>=e.count&&(a=!0),a?(null!=e.count||null!=e.max&&o.length===e.max?n.forEach(e=>e.$cb.attr("disabled",!e.comp._state.isActive)):n.forEach(e=>e.$cb.attr("disabled",!1)),d.attr("disabled",!1)):(n.forEach(e=>e.$cb.attr("disabled",!1)),d.attr("disabled",!0))};i._addHookBase("isActive",r),r(),n.push({$cb:s,$ele:$$`<label class="flex-v-center row my-1">
						<div class="col-2 flex-vh-center">${s}</div>
						<div class="col-10">${e.fnDisplay?e.fnDisplay(o,a):o}</div>
					</label>`,comp:i})});const a=$$`<div class="flex-col w-100 striped-even mb-1 overflow-y-auto">${n.map(e=>e.$ele)}</div>`;let i=e.title;i||(null==e.count?null!=e.min&&null!=e.max?i=`Choose Between ${Parser.numberToText(e.min).uppercaseFirst()} and ${Parser.numberToText(e.max).uppercaseFirst()} Options`:null==e.min?i=`Choose At Most ${Parser.numberToText(e.max).uppercaseFirst()}`:i=`Choose At Least ${Parser.numberToText(e.min).uppercaseFirst()}`:i=`Choose ${Parser.numberToText(e.count).uppercaseFirst()}`);const{$modalInner:s,doClose:r}=UiUtil.getShowModal({title:i,noMinHeight:!0,cbClose:t=>{if(!t)return o(null);const d=n.map((e,t)=>e.comp._state.isActive?t:null).filter(e=>null!=e);o(e.isResolveItems?d.map(t=>e.values[t]):d)}});a.appendTo(s),$$`<div class="flex-vh-center no-shrink">${d}</div>`.appendTo(s),a.focus()})}static pGetUserIcon(e){return e=e||{},new Promise(t=>{let o=null==e.default?-1:e.default;const d=[],{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Select an Option",noMinHeight:!0,cbClose:e=>e?t(~o?o:null):t(null)});$$`<div class="flex flex-wrap flex-h-center mb-2">${e.values.map((t,n)=>{const a=$$`<div class="m-2 btn ${t.buttonClass||"btn-default"} ui__btn-xxl-square flex-col flex-h-center">
					${t.iconClass?`<div class="ui-icn__wrp-icon ${t.iconClass} mb-1"></div>`:""}
					${t.iconContent?t.iconContent:""}
					<div class="whitespace-normal w-100">${t.name}</div>
				</div>`.click(()=>{o=n,d.forEach(e=>e())}).toggleClass(t.buttonClassActive||"active",e.default===n);return t.buttonClassActive&&e.default===n&&a.removeClass("btn-default").addClass(t.buttonClassActive),d.push(()=>{a.toggleClass(t.buttonClassActive||"active",o===n),t.buttonClassActive&&a.toggleClass("btn-default",o!==n)}),a})}</div>`.appendTo(n);const i=$(`<button class="btn btn-default">Confirm</button>`).click(()=>a(!0));$$`<div class="flex-vh-center">${i}</div>`.appendTo(n)})}static pGetUserString(e){return e=e||{},new Promise(t=>{const o=$(`<input class="form-control mb-2">`).val(e.default).keydown(async t=>{e.autocomplete&&(await MiscUtil.pDelay(17),n.find(`.typeahead.dropdown-menu`).is(":visible"))||(13===t.which&&a(!0),t.stopPropagation())});e.isCode&&o.addClass("code"),e.autocomplete&&e.autocomplete.length&&o.typeahead({source:e.autocomplete});const d=$(`<button class="btn btn-default">Enter</button>`).click(()=>a(!0)),{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Enter Text",noMinHeight:!0,cbClose:e=>{if(!e)return t(null);const d=o.val();return d.trim()?t(d):t(null)}});o.appendTo(n),$$`<div class="flex-vh-center">${d}</div>`.appendTo(n),o.focus(),o.select()})}static pGetUserText(e){return e=e||{},new Promise(t=>{const o=$(`<textarea class="form-control mb-2 resize-vertical w-100" ${e.disabled?"disabled":""}/>`).val(e.default);e.isCode&&o.addClass("code");const d=$(`<button class="btn btn-default">${e.buttonText||"Enter"}</button>`).click(()=>a(!0)),{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Enter Text",noMinHeight:!0,cbClose:e=>{if(!e)return t(null);const d=o.val();return d.trim()?t(d):t(null)}});o.appendTo(n),$$`<div class="flex-vh-center">${d}</div>`.appendTo(n),o.focus(),o.select()})}static pGetUserColor(e){return e=e||{},new Promise(t=>{const o=$(`<input class="form-control mb-2" ${null==e.default?"":`value="${e.default}"`} type="color">`),d=$(`<button class="btn btn-default">Confirm</button>`).click(()=>a(!0)),{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Choose Color",noMinHeight:!0,cbClose:e=>{if(!e)return t(null);const d=o.val();return d.trim()?t(d):t(null)}});o.appendTo(n),$$`<div class="flex-vh-center">${d}</div>`.appendTo(n),o.focus(),o.select()})}static pGetUserDirection(e){var o=Math.PI,d=Math.round,n=Math.min;function t(e,t){return 180*Math.atan2(t[i]-e[i],t[a]-e[a])/o}const a=0,i=1,s=360;e=e||{};const r=Math.max(2,n(s,e.step||s)),l=s/r;return new Promise(a=>{let i=!1,p=n(s,e.default)||0;const c=$(`<div class="ui-dir__arm"/>`),_=()=>c.css({transform:`rotate(${p+180}deg)`});_();const u=$$`<div class="ui-dir__face">${c}</div>`.on("mousedown touchstart",e=>{i=!0,m(e)}),f=$(document),h=`ui_user_dir_${CryptUtil.uid()}`;f.on(`mousemove.${h} touchmove${h}`,e=>{m(e)}).on(`mouseup.${h} touchend${h} touchcancel${h}`,e=>{e.preventDefault(),e.stopPropagation(),i=!1});const m=e=>{if(!i)return;const o=[EventUtil.getClientX(e),EventUtil.getClientY(e)],{top:n,left:a}=u.offset(),c=[a+u.width()/2,n+u.height()/2];p=t(c,o)+90,p=r===s?d(p):d(p/l)*l,_()},k=26,g=16,C=(92+k+g)/2,T=e.stepButtons?(()=>{const t=e.stepButtons,d=360/t.length,n=[];for(let e=0;e<t.length;++e){const a=d*e*(o/180)-1.5708,i=C*Math.cos(a),s=C*Math.sin(a);n.push($(`<button class="btn btn-default btn-xxs absolute">${t[e]}</button>`).css({top:s+C-k/2,left:i+C-k/2,width:k,height:k,zIndex:1002}).click(()=>{p=d*e,_()}))}const a=$$`<div class="flex-vh-center relative">${n}${u}</div>`.css({width:2*C,height:2*C});return $$`<div class="flex-vh-center">${a}</div>`.css({width:2*C+k+g,height:2*C+k+g})})():null,S=$(`<button class="btn btn-default">Confirm</button>`).click(()=>E(!0)),{$modalInner:y,doClose:E}=UiUtil.getShowModal({title:e.title||"Select Direction",noMinHeight:!0,cbClose:e=>(f.off(`mousemove.${h} touchmove${h} mouseup.${h} touchend${h} touchcancel${h}`),!e)?a(null):(0>p&&(p+=360),a(p))});$$`<div class="flex-vh-center mb-3">
				${T||u}
			</div>`.appendTo(y),$$`<div class="flex-vh-center">${S}</div>`.appendTo(y)})}static pGetUserDice(e){return e=e||{},new Promise(t=>{const o=BaseComponent.fromObject({num:e.default&&e.default.num||1,faces:e.default&&e.default.faces||6,bonus:e.default&&e.default.bonus||null});o.render=function(e){e.empty();const t=ComponentUiUtil.$getIptInt(this,"num",0,{$ele:$(`<input class="form-control input-xs form-control--minimal text-center mr-1">`)}).appendTo(e).keydown(e=>{13===e.which&&a(!0),e.stopPropagation()}),d=ComponentUiUtil.$getSelEnum(this,"faces",{values:Renderer.dice.DICE}).addClass("mr-2").addClass("text-center").css("textAlignLast","center"),n=$(`<input class="form-control input-xs form-control--minimal text-center">`).change(()=>this._state.bonus=UiUtil.strToInt(n.val(),null,{fallbackOnNaN:null})).keydown(e=>{13===e.which&&a(!0),e.stopPropagation()}),i=()=>n.val(null==this._state.bonus?this._state.bonus:UiUtil.intToBonus(this._state.bonus));o._addHookBase("bonus",i),i(),$$`<div class="flex-vh-center">${t}<div class="mr-1">d</div>${d}${n}</div>`.appendTo(e)},o.getAsString=function(){return`${this._state.num}d${this._state.faces}${this._state.bonus?UiUtil.intToBonus(this._state.bonus):""}`};const d=$(`<button class="btn btn-default">Enter</button>`).click(()=>a(!0)),{$modalInner:n,doClose:a}=UiUtil.getShowModal({title:e.title||"Enter Dice",noMinHeight:!0,cbClose:e=>e?t(o.getAsString()):t(null)});o.render(n),$$`<div class="flex-vh-center">${d}</div>`.appendTo(n)})}}class DragReorderUiUtil{static $getDragPad(e){e=e||{};const t=t=>e.componentsParent[e.componentsProp].find(e=>e.id===t),o={},d=()=>{o.on=!1,o.$wrap.remove(),o.$dummies.forEach(e=>e.remove())},n=()=>{o.on&&d(),o.on=!0,o.$wrap=$(`<div class="flex-col ui-drag__wrp-drag-block"/>`).appendTo(e.$parent),o.$dummies=[];const a=e.componentsParent[e.componentsProp].map(e=>e.id);a.forEach(a=>{const i=$(`<div class="w-100 ${a===e.componentId?"ui-drag__wrp-drag-dummy--highlight":"ui-drag__wrp-drag-dummy--lowlight"}"/>`).height(t(a).height).mouseup(()=>{o.on&&d()}).appendTo(o.$wrap);o.$dummies.push(i),a!==e.componentId&&i.mouseenter(()=>{const o=t(a).pos;t(a).pos=t(e.componentId).pos,t(e.componentId).pos=o,n()})})};return $(`<div class="m${e.marginSide||"l"}-2 ui-drag__patch" title="Drag to Reorder">
		<div class="ui-drag__patch-col"><div>&#8729</div><div>&#8729</div><div>&#8729</div></div>
		<div class="ui-drag__patch-col"><div>&#8729</div><div>&#8729</div><div>&#8729</div></div>
		</div>`).mousedown(()=>n())}static $getDragPadOpts(e,t){if(!t.$parent||!t.swapRowPositions||!t.$children&&!t.$getChildren)throw new Error("Missing required option(s)!");const o={},d=()=>{o.on=!1,o.$wrap.remove(),o.$dummies.forEach(e=>e.remove())},n=()=>{o.on&&d(),o.on=!0,o.$wrap=$(`<div class="flex-col ui-drag__wrp-drag-block"/>`).appendTo(t.$parent),o.$dummies=[];const a=t.$getChildren?t.$getChildren():t.$children,s=a.indexOf(e());a.forEach((e,a)=>{const i={w:e.outerWidth(!0),h:e.outerHeight(!0)},r=$(`<div class="${a===s?"ui-drag__wrp-drag-dummy--highlight":"ui-drag__wrp-drag-dummy--lowlight"}"/>`).width(i.w).height(i.h).mouseup(()=>{o.on&&d()}).appendTo(o.$wrap);o.$dummies.push(r),a!==s&&r.mouseenter(()=>{t.swapRowPositions(a,s),n()})})};return $(`<div class="mr-2 ui-drag__patch" title="Drag to Reorder">
		<div class="ui-drag__patch-col"><div>&#8729</div><div>&#8729</div><div>&#8729</div></div>
		<div class="ui-drag__patch-col"><div>&#8729</div><div>&#8729</div><div>&#8729</div></div>
		</div>`).mousedown(()=>n())}static $getDragPad2(e,t,o){const{swapRowPositions:d,$children:n,$getChildren:a}=o;return this.$getDragPadOpts(e,{$parent:t,swapRowPositions:d,$children:n,$getChildren:a})}}class SourceUiUtil{static _getValidOptions(e){if(!e)throw new Error(`No options were specified!`);if(!e.$parent||!e.cbConfirm||!e.cbConfirmExisting||!e.cbCancel)throw new Error(`Missing options!`);return e.mode=e.mode||"add",e}static render(e){e=SourceUiUtil._getValidOptions(e),e.$parent.empty(),e.mode=e.mode||"select";const t="edit"===e.mode;let o=!1;const d=$(`<input class="form-control ui-source__ipt-named">`).change(()=>{o||t||a.val(d.val().replace(/[^-_a-zA-Z]/g,"")),d.removeClass("form-control--error")});e.source&&d.val(e.source.full);const n=$(`<input class="form-control ui-source__ipt-named">`).change(()=>{n.removeClass("form-control--error")});e.source&&n.val(e.source.abbreviation);const a=$(`<input class="form-control ui-source__ipt-named" ${t?"disabled":""}>`).change(()=>{o=!0,a.removeClass("form-control--error")});e.source&&a.val(e.source.json);const i=$(`<input class="form-control ui-source__ipt-named">`);e.source&&i.val(e.source.url);const s=$(`<input class="form-control ui-source__ipt-named">`);e.source&&s.val((e.source.authors||[]).join(", "));const r=$(`<input class="form-control ui-source__ipt-named">`);e.source&&r.val((e.source.convertedBy||[]).join(", "));const l=$(`<button class="btn btn-default">Confirm</button>`).click(()=>{let o=!1;if([d,n,a].forEach(e=>{const t=e.val();t&&t.trim()||!(o=!0)||e.addClass("form-control--error")}),!o){const o=a.val().trim();if(!t&&BrewUtil.hasSourceJson(o))return a.addClass("form-control--error"),void JqueryUtil.doToast({content:`The JSON identifier "${o}" already exists!`,type:"danger"});const l={json:o,abbreviation:n.val().trim(),full:d.val().trim(),url:i.val().trim(),authors:s.val().trim().split(",").map(e=>e.trim()).filter(Boolean),convertedBy:r.val().trim().split(",").map(e=>e.trim()).filter(Boolean)};e.cbConfirm(l,"edit"!==e.mode)}}),p=e.isRequired&&!t?null:$(`<button class="btn btn-default mr-2">Cancel</button>`).click(()=>e.cbCancel()),c=$(`<button class="btn btn-default">Use an Existing Source</button>`).click(()=>{_.hide(),m.show(),[d,n,a].forEach(e=>e.removeClass("form-control--error"))}),_=$$`<div class="h-100 w-100 flex-vh-center"><div>
			<h3 class="text-center">${t?"Edit Homebrew Source":"Add a Homebrew Source"}</h3>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="The name or title for the homebrew you wish to create. This could be the name of a book or PDF; for example, 'Monster Manual'">Title</span>
				${d}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="An abbreviated form of the title. This will be shown in lists on the site, and in the top-right corner of statblocks or data entries; for example, 'MM'">Abbreviation</span>
				${n}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="This will be used to identify your homebrew universally, so should be unique to you and you alone">JSON Identifier</span>
				${a}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="A link to the original homebrew, e.g. a GM Binder page">Source URL</span>
				${i}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="A comma-separated list of authors, e.g. 'John Doe, Joe Bloggs'">Author(s)</span>
				${s}
			</div></div>
			<div class="row ui-source__row mb-2"><div class="col-12 flex-v-center">
				<span class="mr-2 ui-source__name help" title="A comma-separated list of people who converted the homebrew to 5etools' format, e.g. 'John Doe, Joe Bloggs'">Converted By</span>
				${r}
			</div></div>
			<div class="text-center mb-2">${p}${l}</div>

			${!t&&BrewUtil.homebrewMeta.sources&&BrewUtil.homebrewMeta.sources.length?$$`<div class="flex-vh-center mb-3 mt-3"><span class="ui-source__divider"/>or<span class="ui-source__divider"/></div>
			<div class="flex-vh-center">${c}</div>`:""}
		</div></div>`.appendTo(e.$parent),u=$$`<select class="form-control input-sm">
			<option disabled>Select</option>
			${(BrewUtil.homebrewMeta.sources||[]).sort((e,t)=>SortUtil.ascSortLower(e.full,t.full)).map(e=>`<option value="${e.json.escapeQuotes()}">${e.full.escapeQuotes()}</option>`)}
		</select>`.change(()=>u.removeClass("form-control--error"));u[0].selectedIndex=0;const f=$(`<button class="btn btn-default btn-sm">Confirm</button>`).click(()=>{if(0!==u[0].selectedIndex){const t=u.val(),o=BrewUtil.sourceJsonToSource(t);e.cbConfirmExisting(o),u[0].selectedIndex=0,m.hide(),_.show()}else u.addClass("form-control--error")}),h=$(`<button class="btn btn-default btn-sm mr-2">Back</button>`).click(()=>{u[0].selectedIndex=0,m.hide(),_.show()}),m=$$`<div class="h-100 w-100 flex-vh-center" style="display: none;"><div>
			<h3 class="text-center">Select a Homebrew Source</h3>
			<div class="row mb-2"><div class="col-12 flex-vh-center">${u}</div></div>
			<div class="row"><div class="col-12 flex-vh-center">${h}${f}</div></div>
		</div></div>`.appendTo(e.$parent)}}class BaseComponent extends ProxyBase{constructor(){super(),this.__locks={},this.__rendered={},this.__state={...this._getDefaultState()},this._state=this._getProxy("state",this.__state)}_addHookBase(e,t){this._addHook("state",e,t)}_removeHookBase(e,t){this._removeHook("state",e,t)}_setState(e){this._proxyAssign("state","_state","__state",e,!0)}_getState(){return MiscUtil.copy(this.__state)}getPod(){return this.__pod=this.__pod||{get:e=>this._state[e],set:(e,t)=>this._state[e]=t,delete:e=>delete this._state[e],addHook:(e,t)=>this._addHookBase(e,t),addHookAll:e=>this._addHookAll("state",e),removeHook:(e,t)=>this._removeHookBase(e,t),triggerCollectionUpdate:e=>this._triggerCollectionUpdate(e),setState:e=>this._setState(e),getState:()=>this._getState(),component:this},this.__pod}_getDefaultState(){return{}}getBaseSaveableState(){return{state:MiscUtil.copy(this.__state)}}setBaseSaveableStateFrom(e){e.state&&Object.assign(this._state,e.state)}_renderCollection(e){e=e||{};const t=e.namespace?`${e.namespace}.${e.prop}`:e.prop,o=this.__rendered[t]=this.__rendered[t]||{},d=new Set(Object.keys(o));(this._state[e.prop]||[]).forEach((t,n)=>{if(null==t.id)throw new Error(`Collection item did not have an ID!`);const a=o[t.id];if(d.delete(t.id),a){if(e.isDiffMode){const e=CryptUtil.md5(JSON.stringify(t));if(e!==a.__hash)a.__hash=e;else return}a.data=t,e.fnUpdateExisting(a,t,n)}else{const d=e.fnGetNew(t,n);if(d.data=t,!d.$wrpRow)throw new Error(`A "$wrpRow" property is required in order for deletes!`);e.isDiffMode&&(d.hash=CryptUtil.md5(JSON.stringify(t))),o[t.id]=d}}),this._renderCollection_doDeletes(o,d)}async _pRenderCollection(e){e=e||{};const t=e.namespace?`${e.namespace}.${e.prop}`:e.prop,o=this.__rendered[t]=this.__rendered[t]||{},d=this._state[e.prop];return this._pRenderCollection_doRender(o,d,e)}async _pRenderCollection_doRender(e,t,o){o=o||{};const d=new Set(Object.keys(e));for(let n=0;n<t.length;++n){const a=t[n];if(!a.id)throw new Error(`Collection item did not have an ID!`);const i=e[a.id];if(d.delete(a.id),i){if(o.isDiffMode){const e=CryptUtil.md5(JSON.stringify(a));if(e!==i.__hash)i.__hash=e;else continue}const t=await o.pFnUpdateExisting(i,a);o.isMultiRender&&(e[a.id]=t)}else{const t=await o.pFnGetNew(a);if(null==t)continue;if(o.isMultiRender&&t.some(e=>!e.$wrpRow))throw new Error(`A "$wrpRow" property is required in order for deletes!`);if(!o.isMultiRender&&!t.$wrpRow)throw new Error(`A "$wrpRow" property is required in order for deletes!`);o.isDiffMode&&(t.__hash=CryptUtil.md5(JSON.stringify(a))),e[a.id]=t}}return this._renderCollection_doDeletes(e,d,o)}_renderCollection_doDeletes(e,t,o){o=o||{},t.forEach(t=>{const d=e[t];o.isMultiRender?d.forEach(e=>e.$wrpRow.remove()):d.$wrpRow.remove(),o.additionalCaches&&o.additionalCaches.forEach(e=>delete e[t]),delete e[t]})}_detachCollection(e,t=null){const o=t?`${t}.${e}`:e,d=this.__rendered[o]=this.__rendered[o]||{};Object.values(d).forEach(e=>e.$wrpRow.detach())}_resetCollectionRenders(e,t=null){const o=t?`${t}.${e}`:e,d=this.__rendered[o]=this.__rendered[o]||{};Object.values(d).forEach(e=>e.$wrpRow.remove()),delete this.__rendered[o]}render(){throw new Error("Unimplemented!")}getSaveableState(){return{...this.getBaseSaveableState()}}setStateFrom(e){this.setBaseSaveableStateFrom(e)}async _pLock(e){for(;this.__locks[e];)await this.__locks[e].lock;let t=null;const o=new Promise(e=>t=e);this.__locks[e]={lock:o,unlock:t}}_unlock(e){const t=this.__locks[e];t&&(delete this.__locks[e],t.unlock())}_triggerCollectionUpdate(e){this._state[e]&&(this._state[e]=[...this._state[e]])}static _toCollection(e){if(e)return e.map(e=>({id:CryptUtil.uid(),entity:e}))}static _fromCollection(e){if(e)return e.map(e=>e.entity)}static fromObject(e,...t){const o=new this;return Object.entries(MiscUtil.copy(e)).forEach(([e,d])=>{o.__state[e]=null==d?d:t.includes(e)?d:"object"==typeof d&&d instanceof Array?BaseComponent._toCollection(d):d}),o}toObject(){const e=MiscUtil.copy(this.__state);return Object.entries(e).forEach(([t,o])=>{null!=o&&o instanceof Array&&o.every(e=>e&&e.id)&&(e[t]=BaseComponent._fromCollection(o))}),e}}class BaseLayeredComponent extends BaseComponent{constructor(){super(),this._layers=[],this.__layerMeta={},this._layerMeta=this._getProxy("layerMeta",this.__layerMeta)}_addHookDeep(e,t){this._addHookBase(e,t),this._addHook("layerMeta",e,t)}_removeHookDeep(e,t){this._removeHookBase(e,t),this._removeHook("layerMeta",e,t)}_getBase(e){return this._state[e]}_get(e){if(this._layerMeta[e])for(let t=this._layers.length-1;0<=t;--t){const o=this._layers[t].data[e];if(null!=o)return o}return this._state[e]}_addLayer(e){this._layers.push(e),this._addLayer_addLayerMeta(e)}_addLayer_addLayerMeta(e){Object.entries(e.data).forEach(([e,t])=>this._layerMeta[e]=null!=t)}_removeLayer(e){const t=this._layers.indexOf(e);~t&&(this._layers.splice(t,1),Object.keys(this._layerMeta).forEach(e=>delete this._layerMeta[e]),this._layers.forEach(e=>this._addLayer_addLayerMeta(e)))}updateLayersActive(e){this._layerMeta[e]=this._layers.some(t=>null!=t.data[e])}getBaseSaveableState(){return{state:MiscUtil.copy(this.__state),layers:MiscUtil.copy(this._layers.map(e=>e.getSaveableState()))}}setBaseSaveableStateFrom(e){e.state&&Object.assign(this._state,e.state),e.layers&&e.layers.forEach(e=>this._addLayer(CompLayer.fromSavedState(this,e)))}getPod(){return this.__pod=this.__pod||{...super.getPod(),addHookDeep:(e,t)=>this._addHookDeep(e,t),removeHookDeep:(e,t)=>this._removeHookDeep(e,t),addHookAll:e=>this._addHookAll("state",e),getBase:e=>this._getBase(e),get:e=>this._get(e),addLayer:(e,t)=>{const o=new CompLayer(this,e,t);return this._addLayer(o),o},removeLayer:e=>this._removeLayer(e),layers:this._layers},this.__pod}}class CompLayer extends ProxyBase{constructor(e,t,o){super(),this._name=t,this.__data=o,this.data=this._getProxy("data",this.__data),this._addHookAll("data",t=>e.updateLayersActive(t))}getSaveableState(){return{name:this._name,data:MiscUtil.copy(this.__data)}}static fromSavedState(e,t){return new CompLayer(e,t.name,t.data)}}const MixinComponentHistory=e=>class extends e{constructor(){super(...arguments),this._histStackUndo=[],this._histStackRedo=[],this._isHistDisabled=!0,this._histPropBlacklist=new Set,this._histPropWhitelist=null,this._histInitialState=null}set isHistDisabled(e){this._isHistDisabled=e}addBlacklistProps(...e){e.forEach(e=>this._histPropBlacklist.add(e))}addWhitelistProps(...e){this._histPropWhitelist=this._histPropWhitelist||new Set,e.forEach(e=>this._histPropWhitelist.add(e))}initHistory(){this._histInitialState=MiscUtil.copy(this._state),this._isHistDisabled=!1,this._addHookAll("state",e=>{this._isHistDisabled||this._histPropBlacklist.has(e)||this._histPropWhitelist&&!this._histPropWhitelist.has(e)||this.recordHistory()})}recordHistory(){const e=MiscUtil.copy(this._state);this._histPropBlacklist.forEach(t=>delete e[t]),this._histPropWhitelist&&Object.keys(e).filter(e=>!this._histPropWhitelist.has(e)).forEach(t=>delete e[t]),this._histStackUndo.push(e),this._histStackRedo=[]}_histAddExcludedProperties(e){Object.entries(this._state).forEach(([t,o])=>this._histPropBlacklist.has(t)?e[t]=o:void(this._histPropWhitelist&&!this._histPropWhitelist.has(t)&&(e[t]=o)))}undo(){if(this._histStackUndo.length){const e=this._isHistDisabled;this._isHistDisabled=!0;const t=this._histStackUndo.pop();this._histStackRedo.push(t);const o=MiscUtil.copy(this._histStackUndo.last()||this._histInitialState);this._histAddExcludedProperties(o),this._setState(o),this._isHistDisabled=e}else{const e=this._isHistDisabled;this._isHistDisabled=!0;const t=MiscUtil.copy(this._histInitialState);this._histAddExcludedProperties(t),this._setState(t),this._isHistDisabled=e}}redo(){if(this._histStackRedo.length){const e=this._isHistDisabled;this._isHistDisabled=!0;const t=this._histStackRedo.pop();this._histStackUndo.push(t);const o=MiscUtil.copy(t);this._histAddExcludedProperties(o),this._setState(o),this._isHistDisabled=e}}};class ComponentUiUtil{static trackHook(e,t,o){e[t]=e[t]||[],e[t].push(o)}static $getIptInt(e,t,o=0,d){return ComponentUiUtil._$getIptNumeric(e,t,UiUtil.strToInt,o,d)}static $getIptNumber(e,t,o=0,d){return ComponentUiUtil._$getIptNumeric(e,t,UiUtil.strToNumber,o,d)}static _$getIptNumeric(e,t,o,d=0,n){n=n||{},n.offset=n.offset||0;const a=(n.$ele||$(n.html||`<input class="form-control input-xs form-control--minimal text-right">`)).disableSpellcheck().change(()=>{const i=a.val().trim();if(n.isAllowNull&&!i)return e._state[t]=null;if(i.startsWith("="))e._state[t]=o(i.slice(1),d,n)-n.offset;else{const a=/^[-+/*^]/.exec(i);if(a){const s=e._state[t];let r=i;r=r.slice(1).trim();const l=o(r,d,n),p=`${s}${a[0]}${l}`;e._state[t]=o(p,d,n)-n.offset}else e._state[t]=o(i,d,n)-n.offset}}),i=()=>{if(n.isAllowNull&&null==e._state[t])return a.val(null);const o=(e._state[t]||0)+n.offset;a.val(n.padLength?`${o}`.padStart(n.padLength,"0"):o)};return n.hookTracker&&ComponentUiUtil.trackHook(n.hookTracker,t,i),e._addHookBase(t,i),i(),a}static $getIptStr(e,t,o){if(o=o||{},(o.decorationLeft||o.decorationRight)&&!o.asMeta)throw new Error(`Input must be created with "asMeta" option`);const d=(o.$ele||$(o.html||`<input class="form-control input-xs form-control--minimal">`)).disableSpellcheck().change(()=>{const n=o.isNoTrim?d.val():d.val().trim();e._state[t]=o.isAllowNull&&!n?null:n});o.autocomplete&&o.autocomplete.length&&d.typeahead({source:o.autocomplete});const n=()=>d.val(e._state[t]);if(e._addHookBase(t,n),n(),o.asMeta){const a={$ipt:d,unhook:()=>e._removeHookBase(t,n)};if(o.decorationLeft||o.decorationRight){let e,t;o.decorationLeft&&(d.addClass(`ui__ipt-decorated--left`),e=ComponentUiUtil._$getDecor(d,o.decorationLeft,"left")),o.decorationRight&&(d.addClass(`ui__ipt-decorated--right`),t=ComponentUiUtil._$getDecor(d,o.decorationRight,"right")),a.$wrp=$$`<div class="relative w-100">${d}${e}${t}</div>`}return a}return d}static _$getDecor(e,t,o){switch(t){case"search":return $(`<div class="ui__ipt-decoration ui__ipt-decoration--${o} no-events flex-vh-center"><span class="glyphicon glyphicon-search"/></div>`);case"clear":return $(`<div class="ui__ipt-decoration ui__ipt-decoration--${o} flex-vh-center clickable" title="Clear"><span class="glyphicon glyphicon-remove"/></div>`).click(()=>e.val("").change().keydown().keyup());default:throw new Error(`Unimplemented!`);}}static $getIptEntries(e,t,o){o=o||{};const d=(o.$ele||$(`<textarea class="form-control input-xs form-control--minimal resize-vertical"/>`)).change(()=>e._state[t]=UiUtil.getTextAsEntries(d.val().trim()));return(()=>d.val(UiUtil.getEntriesAsText(e._state[t])))(),d}static $getIptColor(e,t,o){o=o||{};const d=(o.$ele||$(`<input class="form-control input-xs form-control--minimal" type="color">`)).change(()=>e._state[t]=d.val()),n=()=>d.val(e._state[t]);return e._addHookBase(t,n),n(),d}static $getBtnBool(e,t,o){o=o||{},o.html&&(o.$ele=$(o.html));const d=o.activeClass||"active",n=o.stateName||"state",a=o.stateProp||"_state",i=(o.$ele||$(`<button class="btn btn-xs btn-default">${o.text||"Toggle"}</button>`)).click(()=>e[a][t]=!e[a][t]).contextmenu(o=>{o.preventDefault(),e[a][t]=!e[a][t]}),s=()=>{i.toggleClass(d,o.isInverted?!e[a][t]:!!e[a][t]),o.fnHookPost&&o.fnHookPost(e[a][t])};return e._addHook(n,t,s),s(),i}static $getCbBool(e,t,o){o=o||{};const d=(o.$ele||$(`<input type="checkbox">`)).change(()=>e._state[t]=d.prop("checked")),n=()=>d.prop("checked",!!e._state[t]);return e._addHookBase(t,n),n(),o.asMeta?{$cb:d,unhook:()=>e._removeHookBase(t,n)}:d}static $getSelEnum(e,t,o){o=o||{};const d=(o.$ele||$(o.html||`<select class="form-control input-xs"/>`)).change(()=>{const n=+d.val();e._state[t]=~n?o.values[n]:o.isAllowNull?null:0});o.isAllowNull&&$(`<option/>`,{value:-1,text:"\u2014"}).appendTo(d),o.values.forEach((e,t)=>$(`<option/>`,{value:t,text:o.fnDisplay?o.fnDisplay(e):e}).appendTo(d));const n=()=>{const n=void 0===e._state[t]?null:e._state[t],a=o.values.indexOf(n);d.val(`${a}`)};return e._addHookBase(t,n),n(),o.asMeta?{$sel:d,unhook:()=>e._removeHookBase(t,n)}:d}static $getPickEnum(e,t,o){o=o||{};const d=o.values.mergeMap(o=>({[o]:e._state[t]&&e._state[t].includes(o)})),n=ContextUtil.getNextGenericMenuId(),a=o.values.map(e=>new ContextUtil.Action(o.fnDisplay?o.fnDisplay(e):e,()=>i.getPod().set(e,!0)));ContextUtil.doInitActionContextMenu(n,a);const i=BaseComponent.fromObject(d);i.render=function(e){e.empty(),Object.entries(this._state).forEach(([t,d])=>{if(!1!==d){const d=$(`<button class="btn btn-danger ui-pick__btn-remove">×</button>`).click(()=>this._state[t]=!1);$$`<div class="flex mx-1 mb-1 ui-pick__disp-pill"><div class="px-1 ui-pick__disp-text flex-v-center">${o.fnDisplay?o.fnDisplay(t):t}</div>${d}</div>`.appendTo(e)}})};const s=$(`<button class="btn btn-xxs btn-default ui-pick__btn-add mb-1">+</button>`).click(e=>ContextUtil.handleOpenContextMenu(e,s,n)),r=$(`<div class="flex flex-wrap w-100"/>`),l=$$`<div class="flex-v-center">${s}${r}</div>`;return i._addHookAll("state",()=>{e._state[t]=Object.keys(i._state).filter(e=>i._state[e]),i.render(r)}),i.render(r),l}static $getCbsEnum(e,t,o){o=o||{};const d=$(`<div class="flex-col w-100"/>`),n=o.values.map(n=>{const a=$(`<input type="checkbox">`).change(()=>{let o=!1;const d=(e._state[t]||[]).indexOf(n);~d?e._state[t].splice(d,1):e._state[t]?e._state[t].push(n):(o=!0,e._state[t]=[n]),o||(e._state[t]=[...e._state[t]])});return $$`<label class="split-v-center my-1 stripe-odd ${o.isIndent?"ml-4":""}"><div class="no-wrap flex-v-center">${o.fnDisplay?o.fnDisplay(n):n}</div>${a}</label>`.appendTo(d),{$cb:a,value:n}}),a=()=>n.forEach(o=>o.$cb.prop("checked",e._state[t]&&e._state[t].includes(o.value)));return e._addHookBase(t,a),a(),o.asMeta?{$wrp:d,unhook:()=>e._removeHookBase(t,a)}:d}}"undefined"!=typeof module&&(module.exports={ProxyBase,UiUtil,ProfUiUtil,TabUiUtil,SearchUiUtil,SearchWidget,InputUiUtil,DragReorderUiUtil,SourceUiUtil,BaseComponent,ComponentUiUtil});;
"use strict";"undefined"!=typeof require&&(require("../js/utils.js"),require("../js/render.js"));async function pPreProcessSubclassBrew(a,b){const c=await DataUtil.class.loadJSON(),d=MiscUtil.copy(b[a.brewProp]),e={};d.filter(a=>a.class).forEach(a=>{a.classSource=a.classSource||SRC_PHB,((e[a.classSource]=e[a.classSource]||{})[a.class]=e[a.classSource][a.class]||[]).push(a)});const f=[];return Object.entries(e).forEach(([a,d])=>{Object.entries(d).forEach(([d,e])=>{let g=c.class.find(b=>b.name.toLowerCase()===d.toLowerCase()&&(b.source||SRC_PHB).toLowerCase()===a.toLowerCase());if(!g&&b.class&&b.class.length&&(g=b.class.find(b=>b.name.toLowerCase()===d.toLowerCase()&&(b.source||SRC_PHB).toLowerCase()===a.toLowerCase())),g){const a=MiscUtil.copy(g);a.subclasses=e,f.push(a)}else f.push({name:d,source:a,subclasses:e})})}),{[a.listProp]:f}}class Omnidexer{constructor(a=0){this._index=[],this.id=a,this._metaMap={},this._metaIndices={}}getIndex(){return{x:this._index,m:this._metaMap}}static decompressIndex(a){const{x:b,m:c}=a,d=new Set,e={};return Object.keys(c).forEach(a=>{d.add(a),Object.entries(c[a]).forEach(([b,c])=>(e[a]=e[a]||{})[c]=b)}),b.forEach(a=>Object.keys(a).filter(a=>d.has(a)).forEach(b=>a[b]=e[b][a[b]]||a[b])),b}static getProperty(a,b){return b.split(".").reduce((a,b)=>a[b],a)}addToIndex(a,b,c){c=c||{};const d=this._index;let e=this.id;const f=(b,d,f)=>{const g=Omnidexer.getProperty(b,a.source||"source"),h=a.hashBuilder?a.hashBuilder(b,f):UrlUtil.URL_TO_HASH_BUILDER[a.baseUrl](b),i={c:a.category,s:this.getMetaId("s",g),id:e++,u:h,p:Omnidexer.getProperty(b,a.page||"page")};return a.hover&&(i.h=1),c.alt&&c.alt.additionalProperties&&Object.entries(c.alt.additionalProperties).forEach(([a,c])=>i[a]=c(b)),Object.assign(i,d),i},g=(b,e,g)=>{if(!b.noDisplay){const h=f(b,{n:g},e);if(!c.isNoFilter&&(a.include||a.filter&&a.filter(b))&&(a.filter||a.include&&!a.include(b))||a.onlyDeep||d.push(h),a.deepIndex){const c=a.deepIndex(this,{it:b,i:e,parentName:g},b);c.forEach(c=>{const e=f(b,c);a.filter&&a.filter(b)||d.push(e)})}}};Omnidexer.getProperty(b,a.listProp).forEach((b,c)=>{const d=Omnidexer.getProperty(b,a.primary||"name");g(b,c,d),b.alias&&b.alias.forEach(d=>g(b,c,d))}),this.id=e}pushToIndex(a){a.id=this.id++,this._index.push(a)}static arrIncludesOrEquals(a,b){return a instanceof Array?a.includes(b):a===b}getMetaId(a,b){if(this._metaMap[a]=this._metaMap[a]||{},null!=this._metaMap[a][b])return this._metaMap[a][b];else{this._metaIndices[a]=this._metaIndices[a]||0,this._metaMap[a][b]=this._metaIndices[a];const c=this._metaIndices[a];return this._metaIndices[a]++,c}}}Omnidexer.TO_INDEX__FROM_INDEX_JSON=[{category:Parser.CAT_ID_CREATURE,dir:"bestiary",primary:"name",source:"source",listProp:"monster",baseUrl:"bestiary.html",hover:!0},{category:Parser.CAT_ID_SPELL,dir:"spells",primary:"name",source:"source",listProp:"spell",baseUrl:"spells.html",hover:!0,alternateIndexes:{spell:{additionalProperties:{lvl:a=>a.level}}}},{category:Parser.CAT_ID_CLASS,dir:"class",primary:"name",source:"source",listProp:"class",baseUrl:"classes.html",hover:!0},{category:Parser.CAT_ID_SUBCLASS,dir:"class",primary:"name",source:"source",listProp:"class",brewProp:"subclass",baseUrl:"classes.html",hover:!0,onlyDeep:!0,deepIndex:(a,b,c)=>c.subclasses?c.subclasses.map(d=>({b:d.name,n:`${d.name} (${b.parentName})`,s:a.getMetaId("s",d.source),u:`${UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](c)}${HASH_PART_SEP}${UrlUtil.getClassesPageStatePart({subclass:d})}`})):[],pFnPreProcBrew:pPreProcessSubclassBrew},{category:Parser.CAT_ID_CLASS_FEATURE,dir:"class",primary:"name",source:"source",listProp:"class",baseUrl:"classes.html",onlyDeep:!0,hover:!0,deepIndex:(a,b,c)=>{const d=[],e=UrlUtil.class.getIndexedEntries(c);return e.forEach(a=>{switch(a._type){case"classFeature":d.push({b:b.parentName,n:`${b.parentName} ${a.level}; ${a.name}`,s:a.source,u:a.hash});break;case"subclassFeature":case"subclassFeaturePart":break;default:throw new Error(`Unhandled type "${a._type}"`);}}),d}},{category:Parser.CAT_ID_SUBCLASS_FEATURE,dir:"class",primary:"name",source:"source",listProp:"class",brewProp:"subclass",baseUrl:"classes.html",onlyDeep:!0,hover:!0,deepIndex:(a,b,c)=>{const d=[],e=UrlUtil.class.getIndexedEntries(c);return e.forEach(c=>{switch(c._type){case"classFeature":break;case"subclassFeature":case"subclassFeaturePart":d.push({b:c.subclassName,n:`${c.subclassShortName} ${b.parentName} ${c.level}; ${c.name}`,s:a.getMetaId("s",c.source),u:c.hash});break;default:throw new Error(`Unhandled type "${c._type}"`);}}),d},pFnPreProcBrew:pPreProcessSubclassBrew}],Omnidexer.TO_INDEX=[{category:Parser.CAT_ID_BACKGROUND,file:"backgrounds.json",listProp:"background",baseUrl:"backgrounds.html",hover:!0},{category:Parser.CAT_ID_ITEM,file:"items-base.json",listProp:"baseitem",baseUrl:"items.html",hover:!0},{category:Parser.CAT_ID_CONDITION,file:"conditionsdiseases.json",listProp:"condition",baseUrl:"conditionsdiseases.html",hover:!0},{category:Parser.CAT_ID_FEAT,file:"feats.json",listProp:"feat",baseUrl:"feats.html",hover:!0},{category:Parser.CAT_ID_ELDRITCH_INVOCATION,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"EI")},{category:Parser.CAT_ID_METAMAGIC,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MM")},{category:Parser.CAT_ID_MANEUVER_BATTLEMASTER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MV:B")},{category:Parser.CAT_ID_MANEUVER_CAVALIER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MV:C2-UA")},{category:Parser.CAT_ID_ARCANE_SHOT,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"AS:V1-UA")||Omnidexer.arrIncludesOrEquals(a.featureType,"AS:V2-UA")||Omnidexer.arrIncludesOrEquals(a.featureType,"AS")},{category:Parser.CAT_ID_OPTIONAL_FEATURE_OTHER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"OTH")},{category:Parser.CAT_ID_FIGHTING_STYLE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"FS:F")||Omnidexer.arrIncludesOrEquals(a.featureType,"FS:B")||Omnidexer.arrIncludesOrEquals(a.featureType,"FS:R")||Omnidexer.arrIncludesOrEquals(a.featureType,"FS:P")},{category:Parser.CAT_ID_PACT_BOON,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"PB")},{category:Parser.CAT_ID_ELEMENTAL_DISCIPLINE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"ED")},{category:Parser.CAT_ID_ARTIFICER_INFUSION,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"AI")},{category:Parser.CAT_ID_SHIP_UPGRADE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:H")||Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:M")||Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:W")||Omnidexer.arrIncludesOrEquals(a.featureType,"SHP:F")},{category:Parser.CAT_ID_INFERNAL_WAR_MACHINE_UPGRADE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"IWM:W")||Omnidexer.arrIncludesOrEquals(a.featureType,"IWM:A")||Omnidexer.arrIncludesOrEquals(a.featureType,"IWM:G")},{category:Parser.CAT_ID_ONOMANCY_RESONANT,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"OR")},{category:Parser.CAT_ID_RUNE_KNIGHT_RUNE,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"RN")},{category:Parser.CAT_ID_ALCHEMICAL_FORMULA,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"AF")},{category:Parser.CAT_ID_MANEUVER,file:"optionalfeatures.json",listProp:"optionalfeature",baseUrl:"optionalfeatures.html",hover:!0,include:a=>Omnidexer.arrIncludesOrEquals(a.featureType,"MV")},{category:Parser.CAT_ID_ITEM,file:"items.json",listProp:"item",baseUrl:"items.html",hover:!0},{category:Parser.CAT_ID_ITEM,file:"items.json",listProp:"itemGroup",baseUrl:"items.html",hover:!0},{category:Parser.CAT_ID_PSIONIC,file:"psionics.json",listProp:"psionic",baseUrl:"psionics.html",deepIndex:(a,b,c)=>c.modes?c.modes.map(a=>({d:1,n:`${b.parentName}; ${a.name}`})):[],hover:!0},{category:Parser.CAT_ID_RACE,file:"races.json",listProp:"race",baseUrl:"races.html",onlyDeep:!0,deepIndex:(a,b,c)=>{const d=Renderer.race._mergeSubrace(c);return d.map(b=>({n:b.name,s:a.getMetaId("s",b.source),u:UrlUtil.URL_TO_HASH_BUILDER["races.html"](b)}))},hover:!0},{category:Parser.CAT_ID_OTHER_REWARD,file:"rewards.json",listProp:"reward",baseUrl:"rewards.html",hover:!0},{category:Parser.CAT_ID_VARIANT_OPTIONAL_RULE,file:"variantrules.json",listProp:"variantrule",baseUrl:"variantrules.html",hover:!0},{category:Parser.CAT_ID_ADVENTURE,file:"adventures.json",source:"id",listProp:"adventure",baseUrl:"adventure.html"},{category:Parser.CAT_ID_ITEM,file:"magicvariants.json",source:"inherits.source",page:"inherits.page",listProp:"variant",baseUrl:"items.html",hashBuilder:a=>UrlUtil.encodeForHash([a.name,a.inherits.source]),deepIndex:(a,b,c)=>{const d=Renderer.item.modifierPostToPre(c);return d?[{d:1,u:UrlUtil.encodeForHash([d.name,c.inherits.source])}]:[]},additionalIndexes:{item:async(a,b)=>{const c=await(async()=>{if("undefined"!=typeof module)return Renderer.item.getAllIndexableItems(b,require(`../data/items-base.json`));else{const a=await DataUtil.loadJSON(`data/items-base.json`),c={...a,baseitem:[...a.baseitem]},d=await BrewUtil.pAddBrewData();return d.baseitem&&c.baseitem.push(...d.baseitem),Renderer.item.getAllIndexableItems(b,c)}})();return c.map(b=>{const c={c:Parser.CAT_ID_ITEM,u:UrlUtil.encodeForHash([b.name,b.source]),s:a.getMetaId("s",b.source),n:b.name,h:1,p:b.page};return b.genericVariant&&(c.zg={n:a.getMetaId("n",b.genericVariant.name),s:a.getMetaId("s",b.genericVariant.source)}),c})}},hover:!0},{category:Parser.CAT_ID_DEITY,file:"deities.json",postLoad:DataUtil.deity.doPostLoad,listProp:"deity",baseUrl:"deities.html",hover:!0,filter:a=>a.reprinted},{category:Parser.CAT_ID_OBJECT,file:"objects.json",listProp:"object",baseUrl:"objects.html",hover:!0},{category:Parser.CAT_ID_TRAP,file:"trapshazards.json",listProp:"trap",baseUrl:"trapshazards.html",hover:!0},{category:Parser.CAT_ID_HAZARD,file:"trapshazards.json",listProp:"hazard",baseUrl:"trapshazards.html",hover:!0},{category:Parser.CAT_ID_QUICKREF,file:"generated/bookref-quick.json",listProp:"data.bookref-quick",baseUrl:"quickreference.html",hashBuilder:(a,b)=>`bookref-quick,${b}`,onlyDeep:!0,deepIndex:(a,b,c)=>{function d(a,c){return{n:c||a,u:`bookref-quick${HASH_PART_SEP}${b.i}${HASH_PART_SEP}${UrlUtil.encodeForHash(a.toLowerCase())}`,s:void 0}}const e=c.entries.map(a=>({name:a.name,alias:a.alias}));return e.map(b=>{const a=d(b.name);return b.alias?[a,...b.alias.map(c=>d(b.name,c))]:[a]}).reduce((c,a)=>c.concat(a),[])}},{category:Parser.CAT_ID_CULT,file:"cultsboons.json",listProp:"cult",baseUrl:"cultsboons.html",hover:!0},{category:Parser.CAT_ID_BOON,file:"cultsboons.json",listProp:"boon",baseUrl:"cultsboons.html",hover:!0},{category:Parser.CAT_ID_DISEASE,file:"conditionsdiseases.json",listProp:"disease",baseUrl:"conditionsdiseases.html",hover:!0},{category:Parser.CAT_ID_TABLE,file:"generated/gendata-tables.json",listProp:"table",baseUrl:"tables.html",hover:!0},{category:Parser.CAT_ID_TABLE_GROUP,file:"generated/gendata-tables.json",listProp:"tableGroup",baseUrl:"tables.html",hover:!0},{category:Parser.CAT_ID_VEHICLE,file:"vehicles.json",listProp:"vehicle",baseUrl:"vehicles.html",hover:!0},{category:Parser.CAT_ID_ACTION,file:"actions.json",listProp:"action",baseUrl:"actions.html",hover:!0},{category:Parser.CAT_ID_LANGUAGE,file:"languages.json",listProp:"language",baseUrl:"languages.html",deepIndex:(a,b,c)=>(c.dialects||[]).map(a=>({n:a})),hover:!0}],"undefined"!=typeof module&&(module.exports.Omnidexer=Omnidexer);;
"use strict";const Omnisearch={_PLACEHOLDER_TEXT:"Search everywhere...",_searchIndex:null,_pLoadSearch:null,_CATEGORY_COUNTS:{},highestId:-1,init:function(){async function a(){function f(){var i=Math.ceil,m=Math.max,p=Math.min;function h(a,b,c){return`onmouseover="Renderer.hover.pHandleLinkMouseOver(event, this, '${UrlUtil.categoryToPage(a)}', '${c}', '${b.replace(/'/g,"\\'")}')" onmouseleave="Renderer.hover.handleLinkMouseLeave(event, this)" onmousemove="Renderer.hover.handleLinkMouseMove(event, this)" ${Renderer.hover.getPreventTouchString()}`}k.empty();const r=b(),s=$(`<button class="btn btn-default btn-xs btn-file ${r?"active":""}" title="Filter Unearthed Arcana and other unofficial source results" tabindex="-1">Include UA/etc.</button>`).on("click",()=>{c(!r),a()}),t=d(),u=$(`<button class="btn btn-default btn-xs btn-file ${t?"active":""}" style="margin-left: 6px;" title="Filter blacklisted content results" tabindex="-1">Include Blacklisted</button>`).on("click",()=>{e(!t),a()});k.append($(`<div class="text-right"/>`).append([s,u]));const v=n*o;for(let a=v;a<m(p(q.length,o+v),v);++a){const b=q[a].doc,c=$(`<a href="${Renderer.get().baseUrl}${UrlUtil.categoryToPage(b.c)}#${b.u}" ${b.h?h(b.c,b.u,b.s):""}>${b.cf}: ${b.n}</a>`).keydown(a=>Omnisearch.handleLinkKeyDown(a,c,g,k));$$`<p>
						${c}
						${b.s?`<i title="${Parser.sourceJsonToFull(b.s)}">${Parser.sourceJsonToAbv(b.s)}${b.p?` p${b.p}`:""}</i>`:""}
					</p>`.appendTo(k)}if(j.css("display","flex"),q.length>o){const a=$(`<div class="omni__wrp-paginate">`);if(0<n){const b=$(`<span class="omni__paginate-left has-results-left omni__paginate-ctrl"><span class="glyphicon glyphicon-chevron-left"></span></span>`).on("click",()=>{n--,f()});a.append(b)}else a.append(`<span class="omni__paginate-left">`);if(a.append(`<span class="paginate-count">Page ${n+1}/${i(q.length/o)} (${q.length} results)</span>`),q.length-n*o>o){const b=$(`<span class="omni__paginate-right has-results-right omni__paginate-ctrl"><span class="glyphicon glyphicon-chevron-right"></span></span>`).on("click",()=>{n++,f()});a.append(b)}else a.append(`<span class="omni__paginate-right omni__paginate-ctrl">`);k.append(a)}l&&k.find(`a`).first()[0].click()}await Omnisearch.pInit();const h=g.val(),i=elasticlunr.tokenizer(h),m=i.map(a=>{const b=Object.keys(Omnisearch._CATEGORY_COUNTS).map(a=>a.toLowerCase()).find(b=>`in:${b}`===a.toLowerCase().trim()||`in:${b}s`===a.toLowerCase().trim());return{t:a,isCat:!!b,c:b}});let n=0;const p=m.filter(a=>a.isCat);let q;if(1===p.length){const a=m.filter(a=>!a.isCat).map(a=>a.t);q=Omnisearch._searchIndex.search(a.join(" "),{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0}).filter(a=>p[0].c&&a.doc.cf.toLowerCase()===p[0].c.toLowerCase())}else q=Omnisearch._searchIndex.search(h,{fields:{n:{boost:5,expand:!0},s:{expand:!0}},bool:"AND",expand:!0});b()||(q=q.filter(a=>a.doc.s&&!SourceUtil._isNonstandardSourceWiz(a.doc.s))),!d()&&ExcludeUtil.getList().length&&(q=q.filter(a=>{if(a.doc.c===Parser.CAT_ID_QUICKREF)return!0;const b=Parser.pageCategoryToProp(a.doc.c),c=a.doc.b||a.doc.n;return!ExcludeUtil.isExcluded(c,b,a.doc.s)})),q.length?f():(k.empty(),j.hide())}function b(){return t||(t=StorageUtil.syncGet(p)),t!==s}function c(a){t=a?r:s,StorageUtil.syncSet(p,t)}function d(){return u||(u=StorageUtil.syncGet(q)),u===r}function e(a){u=a?r:s,StorageUtil.syncSet(q,u)}if(IS_VTT)return;const f=$(`#navbar`),g=$(`<input class="form-control search omni__input" placeholder="${Omnisearch._PLACEHOLDER_TEXT}" title="Hotkey: F. Disclaimer: unlikely to search everywhere. Use with caution.">`).disableSpellcheck(),h=$(`<button class="btn btn-default omni__submit" tabindex="-1"><span class="glyphicon glyphicon-search"></span></button>`),i=$$`
			<div class="input-group omni__wrp-input">
				${g}
				<div class="input-group-btn">
					${h}
				</div>
			</div>
		`.appendTo(f),j=$(`<div class="omni__wrp-output"/>`).insertAfter(f),k=$(`<div class="omni__output"/>`).appendTo(j);let l=!1;const m=$(`body`);m.on("click",()=>j.hide()),k.on("click",a=>a.stopPropagation()),g.on("keydown",a=>{switch(a.which){case 13:l=!0,h.click();break;case 38:a.preventDefault();break;case 40:a.preventDefault(),k.find(`a`).first().focus();break;case 27:g.val(""),g.blur();}a.stopPropagation()});let n;g.on("keyup",a=>{l=!1;37<=a.which&&40>=a.which||(clearTimeout(n),n=setTimeout(()=>h.click(),100))}),g.on("keydown",()=>clearTimeout(n)),g.on("click",a=>{g.val()&&g.val().trim().length&&h.click(),a.stopPropagation()}),h.on("click",b=>{b.stopPropagation(),a()}),function(){const a=$(window);a.on("scroll",()=>{Renderer.hover.isSmallScreen()?(g.attr("placeholder",Omnisearch._PLACEHOLDER_TEXT),i.removeClass("omni__wrp-input--scrolled"),k.removeClass("omni__output--scrolled")):50<a.scrollTop()?(g.attr("placeholder",""),i.addClass("omni__wrp-input--scrolled"),k.addClass("omni__output--scrolled")):(g.attr("placeholder",Omnisearch._PLACEHOLDER_TEXT),i.removeClass("omni__wrp-input--scrolled"),k.removeClass("omni__output--scrolled"))})}();const o=15,p="search-ua-etc",q="search-blacklist",r="SHOW",s="HIDE";let t,u;m.on("keypress",a=>{if(noModifierKeys(a)&&!MiscUtil.isInInput(a)&&("f"===a.key||"F"===a.key)){const b="F"===a.key?g:$(`#filter-search-input-group`).find(`.search`);setTimeout(()=>b.select().focus(),0)}})},async pInit(){Omnisearch._searchIndex||(Omnisearch._pLoadSearch?await Omnisearch._pLoadSearch:(Omnisearch._pLoadSearch=Omnisearch._pDoSearchLoad(),await Omnisearch._pLoadSearch,Omnisearch._pLoadSearch=null))},_pDoSearchLoad:async function(){const a=Omnidexer.decompressIndex((await DataUtil.loadJSON(`${Renderer.get().baseUrl}search/index.json`)));elasticlunr.clearStopWords(),Omnisearch._searchIndex=elasticlunr(function(){this.addField("n"),this.addField("cf"),this.addField("s"),this.setRef("id")}),SearchUtil.removeStemmer(Omnisearch._searchIndex),a.forEach(Omnisearch._addToIndex),Omnisearch.highestId=a.last().id;const b=await BrewUtil.pGetSearchIndex();b.forEach(Omnisearch._addToIndex),b.length&&(Omnisearch.highestId=b.last().id)},async pAddToIndex(a,...b){if(!b.length)return;await Omnisearch.pInit();const c=new Omnidexer(Omnisearch.highestId+1),d={[a]:b};Omnidexer.TO_INDEX__FROM_INDEX_JSON.filter(b=>b.listProp===a).forEach(a=>c.addToIndex(a,d)),Omnidexer.TO_INDEX.filter(b=>b.listProp===a).forEach(a=>c.addToIndex(a,d));const e=Omnidexer.decompressIndex(c.getIndex());e.forEach(Omnisearch._addToIndex),e.length&&(Omnisearch.highestId=e.last().id)},_addToIndex(a){a.cf=Parser.pageCategoryToFull(a.c),Omnisearch._CATEGORY_COUNTS[a.cf]?Omnisearch._CATEGORY_COUNTS[a.cf]++:Omnisearch._CATEGORY_COUNTS[a.cf]=1,Omnisearch._searchIndex.addDoc(a)},handleLinkKeyDown(a,b,c,d){switch(a.which){case 37:{if(a.preventDefault(),$(`.has-results-left`).length){const a=b.parent().index()-1;$(`.omni__paginate-left`).click();const c=d.find(`p`);$(c[a]||c[c.length-1]).find(`a`).focus()}break}case 38:{a.preventDefault(),b.parent().prev().find(`a`).length?b.parent().prev().find(`a`).focus():$(`.has-results-left`).length?($(`.omni__paginate-left`).click(),d.find(`a`).last().focus()):c.focus();break}case 39:{if(a.preventDefault(),$(`.has-results-right`).length){const a=b.parent().index()-1;$(`.omni__paginate-right`).click();const c=d.find(`p`);$(c[a]||c[c.length-1]).find(`a`).focus()}break}case 40:{a.preventDefault(),b.parent().next().find(`a`).length?b.parent().next().find(`a`).focus():$(`.has-results-right`).length&&($(`.omni__paginate-right`).click(),d.find(`a`).first().focus());break}}},addScrollTopFloat(){const a=$(`<div class="bk__to-top"/>`).appendTo($("body")),b=$(`<button class="btn btn-sm btn-default" title="To Top"><span class="glyphicon glyphicon-arrow-up"/></button>`).appendTo(a).click(()=>MiscUtil.scrollPageTop());return $(window).on("scroll",()=>{50<$(window).scrollTop()?a.addClass("bk__to-top--scrolled"):a.removeClass("bk__to-top--scrolled")}),a}};window.addEventListener("load",Omnisearch.init);;
function Renderer(){var e=Math.min,n=Math.max;this.wrapperTag="div",this.baseUrl="",this._lazyImages=!1,this._subVariant=!1,this._firstSection=!0,this._isAddHandlers=!0,this._headerIndex=1,this._tagExportDict=null,this._roll20Ids=null,this._trackTitles={enabled:!1,titles:{}},this._enumerateTitlesRel={enabled:!1,titles:{}},this._hooks={},this._fnPostProcess=null,this._extraSourceClasses=null,this._depthTracker=null,this._isIternalLinksDisabled=!1,this.setLazyImages=function(e){return this._lazyImages="undefined"!=typeof IntersectionObserver&&!!e,this},this.setWrapperTag=function(e){return this.wrapperTag=e,this},this.setBaseUrl=function(e){return this.baseUrl=e,this},this.setFirstSection=function(e){return this._firstSection=e,this},this.setAddHandlers=function(e){return this._isAddHandlers=e,this},this.setFnPostProcess=function(e){return this._fnPostProcess=e,this},this.setExtraSourceClasses=function(e){return this._extraSourceClasses=e,this},this.resetHeaderIndex=function(){return this._headerIndex=1,this._trackTitles.titles={},this._enumerateTitlesRel.titles={},this},this.doExportTags=function(e){return this._tagExportDict=e,this},this.resetExportTags=function(){return this._tagExportDict=null,this},this.setRoll20Ids=function(e){return this._roll20Ids=e,this},this.resetRoll20Ids=function(){return this._roll20Ids=null,this},this.setInternalLinksDisabled=function(e){return this._isIternalLinksDisabled=e,this},this.setEnumerateTitlesRel=function(e){return this._enumerateTitlesRel.enabled=e,this},this._getEnumeratedTitleRel=function(e){if(this._enumerateTitlesRel.enabled&&e){const n=e.toLowerCase();return this._enumerateTitlesRel.titles[n]=this._enumerateTitlesRel.titles[n]||0,`data-title-relative-index="${this._enumerateTitlesRel.titles[n]++}"`}return""},this.setTrackTitles=function(e){return this._trackTitles.enabled=e,this},this.getTrackedTitles=function(){return MiscUtil.copy(this._trackTitles.titles)},this._handleTrackTitles=function(e){this._trackTitles.enabled&&(this._trackTitles.titles[this._headerIndex]=e)},this._handleTrackDepth=function(e,n){e.name&&this._depthTracker&&this._depthTracker.push({depth:n,name:e.name,type:e.type,ixHeader:this._headerIndex,source:e.source})},this.addHook=function(e,n,t){((this._hooks[e]=this._hooks[e]||{})[n]=this._hooks[e][n]||[]).push(t)},this.removeHook=function(e,n,t){const i=((this._hooks[e]=this._hooks[e]||{})[n]=this._hooks[e][n]||[]).indexOf(t);~i&&this._hooks[e][n].splice(i,1)},this._getHooks=function(e,n){return(this._hooks[e]||{})[n]||[]},this.setDepthTracker=function(e){return this._depthTracker=e,this},this.recursiveRender=function(e,n,t,i){return e instanceof Array?(e.forEach(e=>this.recursiveRender(e,n,t,i)),void setTimeout(()=>{throw new Error(`Array passed to renderer! The renderer only guarantees support for primitives and basic objects.`)})):void(0===n.length?n[0]="":n.reverse(),t=t||{},t._typeStack=[],t.depth=null==t.depth?0:t.depth,this._recursiveRender(e,n,t,i),this._fnPostProcess&&(n[0]=this._fnPostProcess(n[0])),n.reverse())},this._recursiveRender=function(e,n,t,i){if(!t)throw new Error("Missing metadata!");if("section"===e.type&&(t.depth=-1),i=i||{},t._didRenderPrefix=!1,t._didRenderSuffix=!1,"object"==typeof e){const r=null==e.type||"section"===e.type?"entries":e.type;t._typeStack.push(r),"entries"===r?this._renderEntries(e,n,t,i):"options"===r?this._renderOptions(e,n,t,i):"list"===r?this._renderList(e,n,t,i):"table"===r?this._renderTable(e,n,t,i):"tableGroup"===r?this._renderTableGroup(e,n,t,i):"inset"===r?this._renderInset(e,n,t,i):"insetReadaloud"===r?this._renderInsetReadaloud(e,n,t,i):"variant"===r?this._renderVariant(e,n,t,i):"variantSub"===r?this._renderVariantSub(e,n,t,i):"spellcasting"===r?this._renderSpellcasting(e,n,t,i):"quote"===r?this._renderQuote(e,n,t,i):"optfeature"===r?this._renderOptfeature(e,n,t,i):"patron"===r?this._renderPatron(e,n,t,i):"abilityDc"===r?this._renderAbilityDc(e,n,t,i):"abilityAttackMod"===r?this._renderAbilityAttackMod(e,n,t,i):"abilityGeneric"===r?this._renderAbilityGeneric(e,n,t,i):"inline"===r?this._renderInline(e,n,t,i):"inlineBlock"===r?this._renderInlineBlock(e,n,t,i):"bonus"===r?this._renderBonus(e,n,t,i):"bonusSpeed"===r?this._renderBonusSpeed(e,n,t,i):"dice"===r?this._renderDice(e,n,t,i):"link"===r?this._renderLink(e,n,t,i):"actions"===r?this._renderActions(e,n,t,i):"attack"===r?this._renderAttack(e,n,t,i):"item"===r?this._renderItem(e,n,t,i):"itemSub"===r?this._renderItemSub(e,n,t,i):"itemSpell"===r?this._renderItemSpell(e,n,t,i):"dataCreature"===r?this._renderDataCreature(e,n,t,i):"dataSpell"===r?this._renderDataSpell(e,n,t,i):"dataTrapHazard"===r?this._renderDataTrapHazard(e,n,t,i):"image"===r?this._renderImage(e,n,t,i):"gallery"===r?this._renderGallery(e,n,t,i):"flowchart"===r?this._renderFlowchart(e,n,t,i):"flowBlock"===r?this._renderFlowBlock(e,n,t,i):"homebrew"===r?this._renderHomebrew(e,n,t,i):"code"===r?this._renderCode(e,n,t,i):"hr"===r?this._renderHr(e,n,t,i):void 0,t._typeStack.pop()}else"string"==typeof e?(this._renderPrefix(e,n,t,i),this._renderString(e,n,t,i),this._renderSuffix(e,n,t,i)):(this._renderPrefix(e,n,t,i),this._renderPrimitive(e,n,t,i),this._renderSuffix(e,n,t,i))},this._adjustDepth=function(t,i){const r=t.depth;return t.depth+=i,t.depth=e(n(-1,t.depth),2),r},this._renderPrefix=function(e,n,t,i){t._didRenderPrefix||null!=i.prefix&&(n[0]+=i.prefix,t._didRenderPrefix=!0)},this._renderSuffix=function(e,n,t,i){t._didRenderSuffix||null!=i.suffix&&(n[0]+=i.suffix,t._didRenderSuffix=!0)},this._renderImage=function(e,n,t,i){"map"===e.imageType&&(n[0]+=`<div class="rd__wrp-map">`),this._renderPrefix(e,n,t,i),n[0]+=`<div class="float-clear"></div>`,n[0]+=`<div class="${t._typeStack.includes("gallery")?"rd__wrp-gallery-image":""}">`;const r=this._renderImage_getUrl(e),d=this._lazyImages&&null!=e.width&&null!=e.height?`data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${e.width}" height="${e.height}"><rect width="100%" height="100%" fill="#ccc3"></rect></svg>`)}`:null;n[0]+=`<div class="${this._renderImage_getWrapperClasses(e,t)}"><a href="${r}" target="_blank" rel="noopener noreferrer" ${e.title?`title="${Renderer.stripTags(e.title)}"`:""}><img class="rd__image" src="${d||r}" ${e.altText?`alt="${e.altText}"`:""} ${d?`data-src="${r}"`:""} ${function(){return e.maxWidth?`style="max-width: ${e.maxWidth}px"`:""}()}></a></div>`,e.title?n[0]+=`<div class="rd__image-title"><div class="rd__image-title-inner">${this.render(e.title)}</div></div>`:e._galleryTitlePad&&(n[0]+=`<div class="rd__image-title">&nbsp;</div>`),n[0]+=`</div>`,this._renderSuffix(e,n,t,i),"map"===e.imageType&&(n[0]+=`</div>`)},this._renderImage_getWrapperClasses=function(e){const n=["rd__wrp-image"];return e.style&&("comic-speaker-left"===e.style?n.push("rd__comic-img-speaker","rd__comic-img-speaker--left"):"comic-speaker-right"===e.style&&n.push("rd__comic-img-speaker","rd__comic-img-speaker--right")),n.join(" ")},this._renderImage_getUrl=function(e){let n;if("internal"===e.href.type){const t=`img/${e.href.path}`;n=""===this.baseUrl?UrlUtil.link(t):`${this.baseUrl}${t}`}else"external"===e.href.type&&(n=e.href.url);return n},this._renderList_getListCssClasses=function(e){const n=[`rd__list`];return(e.style||e.columns)&&(e.style&&n.push(...e.style.split(" ").map(e=>`rd__${e}`)),e.columns&&n.push(`columns-${e.columns}`)),n.join(" ")},this._renderTableGroup=function(e,n,t){const r=e.tables.length;for(let d=0;d<r;++d)this._recursiveRender(e.tables[d],n,t)},this._renderTable=function(e,n,t){if(e.intro){const r=e.intro.length;for(let d=0;d<r;++d)this._recursiveRender(e.intro[d],n,t,{prefix:"<p>",suffix:"</p>"})}n[0]+=`<table class="${e.style||""} ${!1===e.isStriped?"":"striped-odd"}">`;const d=Renderer.isRollableTable(e);null!=e.caption&&(n[0]+=`<caption>${e.caption}</caption>`);const s=[];let a=[""];a[0]+="<tbody>";const o=e.rows.length;for(let i=0;i<o;++i){a[0]+="<tr>";const n=e.rows[i];let r="row"===n.type?n.row:n;const o=r.length;for(let i=0;i<o;++i){s[i]=s[i]||!1,d&&0===i&&(r=Renderer.getRollableRow(r),s[i]=!0);let o;"cell"===r[i].type?r[i].roll?(s[i]=!0,o=r[i].roll.entry?r[i].roll.entry:null==r[i].roll.exact?r[i].roll.max===Renderer.dice.POS_INFINITE?r[i].roll.pad?`${StrUtil.padNumber(r[i].roll.min,2,"0")}+`:`${r[i].roll.min}+`:r[i].roll.pad?`${StrUtil.padNumber(r[i].roll.min,2,"0")}-${StrUtil.padNumber(r[i].roll.max,2,"0")}`:`${r[i].roll.min}-${r[i].roll.max}`:r[i].roll.pad?StrUtil.padNumber(r[i].roll.exact,2,"0"):r[i].roll.exact):r[i].entry&&(o=r[i].entry):o=r[i],a[0]+=`<td ${this._renderTable_makeTableTdClassText(e,i)} ${this._renderTable_getCellDataStr(r[i])} ${r[i].width?`colspan="${r[i].width}"`:""}>`,"row-indent-first"===n.style&&0===i&&(a[0]+=`<div class="rd__tab-indent"></div>`);const l=this._adjustDepth(t,1);this._recursiveRender(o,a,t),t.depth=l,a[0]+="</td>"}a[0]+="</tr>"}if(a[0]+="</tbody>",n[0]+="<thead>",n[0]+="<tr>",e.colLabels){const r=e.colLabels.length;for(let a=0;a<r;++a){const i=e.colLabels[a];n[0]+=`<th ${this._renderTable_getTableThClassText(e,a)} data-isroller="${s[a]}">`,this._recursiveRender(d&&0===a&&!i.includes("@dice")?`{@dice ${i}}`:i,n,t),n[0]+=`</th>`}}if(n[0]+="</tr>",n[0]+="</thead>",n[0]+=a[0],null!=e.footnotes){n[0]+="<tfoot>";const r=e.footnotes.length;for(let d=0;d<r;++d){n[0]+=`<tr><td colspan="99">`;const i=this._adjustDepth(t,1);this._recursiveRender(e.footnotes[d],n,t),t.depth=i,n[0]+="</td></tr>"}n[0]+="</tfoot>"}if(n[0]+="</table>",e.outro){const r=e.outro.length;for(let d=0;d<r;++d)this._recursiveRender(e.outro[d],n,t,{prefix:"<p>",suffix:"</p>"})}},this._renderTable_getCellDataStr=function(e){function n(e){return 0===e?100:e}return e.roll?`data-roll-min="${n(null==e.roll.exact?e.roll.min:e.roll.exact)}" data-roll-max="${n(null==e.roll.exact?e.roll.max:e.roll.exact)}"`:""},this._renderTable_getTableThClassText=function(e,n){return null==e.colStyles||n>=e.colStyles.length?"":`class="${e.colStyles[n]}"`},this._renderTable_makeTableTdClassText=function(e,n){return null==e.rowStyles?this._renderTable_getTableThClassText(e,n):n>=e.rowStyles.length?"":`class="${e.rowStyles[n]}"`},this._renderEntries=function(e,n,t,i){this._renderEntriesSubtypes(e,n,t,i,!0)},this._renderEntriesSubtypes=function(e,n,t,i,r){const d=2<=t.depth,s=!d&&0<e.page?` <span class="rd__title-link">${e.source?`<span class="help--subtle" title="${Parser.sourceJsonToFull(e.source)}">${Parser.sourceJsonToAbv(e.source)}</span> `:""}p${e.page}</span>`:"",a=r&&2>t.depth?t.depth+1:t.depth,o=this._renderEntriesSubtypes_getStyleString(e,t,d),l=this._renderEntriesSubtypes_getDataString(e);null!=e.name&&this._handleTrackTitles(e.name);const c=`rd__h--${t.depth+1}`;this._handleTrackDepth(e,t.depth);const u=e.name?`<span class="rd__h ${c}" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}> <span class="entry-title-inner"${!s&&e.source?` title="Source: ${Parser.sourceJsonToFull(e.source)}${e.page?`, p${e.page}`:""}"`:""}>${this.render({type:"inline",entries:[e.name]})}${d?".":""}</span>${s}</span> `:"";if(-1===t.depth&&(!this._firstSection&&(n[0]+=`<hr class="rd__hr rd__hr--section">`),this._firstSection=!1),e.entries||e.name){if(n[0]+=`<${this.wrapperTag} ${l} ${o}>${u}`,this._renderEntriesSubtypes_renderPreReqText(e,n,t),e.entries){const i=t.depth,r=e.entries.length;for(let d=0;d<r;++d)t.depth=a,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),0==d&&2<=t.depth&&(n[0]+=`<div class="rd__spc-inline-post"></div>`);t.depth=i}n[0]+=`</${this.wrapperTag}>`}},this._renderEntriesSubtypes_getDataString=function(e){let n="";return e.source&&(n+=`data-source="${e.source}"`),n},this._renderEntriesSubtypes_renderPreReqText=function(e,n,t){e.prerequisite&&(n[0]+=`<span class="rd__prerequisite">Prerequisite: `,this._recursiveRender({type:"inline",entries:[e.prerequisite]},n,t),n[0]+=`</span>`)},this._renderEntriesSubtypes_getStyleString=function(e,n,t){const i=["rd__b"];return i.push(this._getStyleClass(e.source)),t?this._subVariant?i.push(Renderer.HEAD_2_SUB_VARIANT):i.push(Renderer.HEAD_2):i.push(-1===n.depth?Renderer.HEAD_NEG_1:0===n.depth?Renderer.HEAD_0:Renderer.HEAD_1),0<i.length?`class="${i.join(" ")}"`:""},this._renderOptions=function(e,n,t,i){e.entries&&(e.entries=e.entries.sort((e,n)=>e.name&&n.name?SortUtil.ascSort(e.name,n.name):e.name?-1:n.name?1:0),this._renderEntriesSubtypes(e,n,t,i,!1))},this._renderList=function(e,n,t,i){if(e.items){e.name&&(n[0]+=`<p class="rd__list-name">${e.name}</p>`);const r=this._renderList_getListCssClasses(e,n,t,i);n[0]+=`<ul ${r?`class="${r}"`:""}>`;const d=e.style&&e.style.split(" ").includes("list-hang"),s=e.items.length;for(let r=0;r<s;++r){const i=e.items[r];if("list"!==i.type){const e=`${this._getStyleClass(i.source)}${"itemSpell"===i.type?" rd__li-spell":""}`;n[0]+=`<li ${e?`class="${e}"`:""}>`}d&&"string"==typeof i&&(n[0]+="<div>");const s=this._adjustDepth(t,1);this._recursiveRender(i,n,t),t.depth=s,d&&"string"==typeof i&&(n[0]+="</div>"),"list"!==i.type&&(n[0]+="</li>")}n[0]+="</ul>"}},this._renderInset=function(e,n,t){const i=this._renderEntriesSubtypes_getDataString(e);if(n[0]+=`<${this.wrapperTag} class="rd__b-inset" ${i}>`,null!=e.name&&(this._handleTrackTitles(e.name),this._handleTrackDepth(e,1),n[0]+=`<span class="rd__h rd__h--2-inset" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}</span></span>`),e.entries){const r=e.entries.length;for(let d=0;d<r;++d){const i=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=i}}n[0]+=`<div class="float-clear"></div>`,n[0]+=`</${this.wrapperTag}>`},this._renderInsetReadaloud=function(e,n,t){const i=this._renderEntriesSubtypes_getDataString(e);n[0]+=`<${this.wrapperTag} class="rd__b-inset rd__b-inset--readaloud" ${i}>`,null!=e.name&&(this._handleTrackTitles(e.name),this._handleTrackDepth(e,1),n[0]+=`<span class="rd__h rd__h--2-inset" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}</span></span>`);const r=e.entries.length;for(let d=0;d<r;++d){const i=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=i}n[0]+=`<div class="float-clear"></div>`,n[0]+=`</${this.wrapperTag}>`},this._renderVariant=function(e,n,t){const i=this._renderEntriesSubtypes_getDataString(e);this._handleTrackTitles(e.name),this._handleTrackDepth(e,1),n[0]+=`<${this.wrapperTag} class="rd__b-inset" ${i}>`,n[0]+=`<span class="rd__h rd__h--2-inset" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">Variant: ${e.name}</span></span>`;const r=e.entries.length;for(let d=0;d<r;++d){const i=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=i}e.variantSource&&(n[0]+=Renderer.utils._getPageTrText(e.variantSource)),n[0]+=`</${this.wrapperTag}>`},this._renderVariantSub=function(e,n,t){this._subVariant=!0;const i=e;i.type="entries";const r=t.depth;t.depth=3,this._recursiveRender(i,n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=r,this._subVariant=!1},this._renderSpellcasting_getEntries=function(e){const n=new Set(e.hidden||[]),t=[{type:"entries",name:e.name,entries:e.headerEntries?MiscUtil.copy(e.headerEntries):[]}];if(e.constant||e.will||e.rest||e.daily||e.weekly){const i={type:"list",style:"list-hang-notitle",items:[]};if(e.constant&&!n.has("constant")&&i.items.push({type:"itemSpell",name:`Constant:`,entry:e.constant.join(", ")}),e.will&&!n.has("will")&&i.items.push({type:"itemSpell",name:`At will:`,entry:e.will.join(", ")}),e.rest&&!n.has("rest"))for(let n=9;0<n;n--){const t=e.rest;t[n]&&i.items.push({type:"itemSpell",name:`${n}/rest:`,entry:t[n].join(", ")});const r=`${n}e`;t[r]&&i.items.push({type:"itemSpell",name:`${n}/rest each:`,entry:t[r].join(", ")})}if(e.daily&&!n.has("daily"))for(let n=9;0<n;n--){const t=e.daily;t[n]&&i.items.push({type:"itemSpell",name:`${n}/day:`,entry:t[n].join(", ")});const r=`${n}e`;t[r]&&i.items.push({type:"itemSpell",name:`${n}/day each:`,entry:t[r].join(", ")})}if(e.weekly&&!n.has("weekly"))for(let n=9;0<n;n--){const t=e.weekly;t[n]&&i.items.push({type:"itemSpell",name:`${n}/week:`,entry:t[n].join(", ")});const r=`${n}e`;t[r]&&i.items.push({type:"itemSpell",name:`${n}/week each:`,entry:t[r].join(", ")})}i.items.length&&t[0].entries.push(i)}if(e.spells&&!n.has("spells")){const n={type:"list",style:"list-hang-notitle",items:[]};for(let t=0;10>t;++t){const i=e.spells[t];if(i){let e=`${Parser.spLevelToFull(t)}${0===t?"s":" level"}`,r=` (at will)`;const d=i.slots;0<=d&&(r=0<d?` (${d} slot${1<d?"s":""})`:``),i.lower&&i.lower!==t&&(e=`${Parser.spLevelToFull(i.lower)}-${e}`,0<=d&&(r=0<d?` (${d} ${Parser.spLevelToFull(t)}-level slot${1<d?"s":""})`:``)),n.items.push({type:"itemSpell",name:`${e} ${r}:`,entry:i.spells.join(", ")})}}t[0].entries.push(n)}return e.footerEntries&&t.push({type:"entries",entries:e.footerEntries}),t},this._renderSpellcasting=function(e,n,t){const i=this._renderSpellcasting_getEntries(e);this._recursiveRender({type:"entries",entries:i},n,t)},this._renderQuote=function(e,n,t){n[0]+=`<p><i>`;const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t),n[0]+=d==e.entries.length-1?`</i>`:`<br>`;if(e.by){const i=[""];this._recursiveRender(e.by,i,t),n[0]+=`<span class="rd__quote-by">\u2014 ${i.join("")}${e.from?`, <i>${e.from}</i>`:""}</span>`}n[0]+=`</p>`},this._renderOptfeature=function(e,n,t,i){this._renderEntriesSubtypes(e,n,t,i,!0)},this._renderPatron=function(e,n,t,i){this._renderEntriesSubtypes(e,n,t,i,!1)},this._renderAbilityDc=function(e,n,t,i){this._renderPrefix(e,n,t,i),n[0]+=`<div class="text-center"><b>`,this._recursiveRender(e.name,n,t),n[0]+=` save DC</b> = 8 + your proficiency bonus + your ${Parser.attrChooseToFull(e.attributes)}</div>`,this._renderSuffix(e,n,t,i)},this._renderAbilityAttackMod=function(e,n,t,i){this._renderPrefix(e,n,t,i),n[0]+=`<div class="text-center"><b>`,this._recursiveRender(e.name,n,t),n[0]+=` attack modifier</b> = your proficiency bonus + your ${Parser.attrChooseToFull(e.attributes)}</div>`,this._renderSuffix(e,n,t,i)},this._renderAbilityGeneric=function(e,n,t,i){this._renderPrefix(e,n,t,i),n[0]+=`<div class="text-center">`,e.name&&this._recursiveRender(e.name,n,t,{prefix:"<b>",suffix:"</b> = "}),n[0]+=`${e.text}${e.attributes?` ${Parser.attrChooseToFull(e.attributes)}`:""}</div>`,this._renderSuffix(e,n,t,i)},this._renderInline=function(e,n,t){if(e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t)}},this._renderInlineBlock=function(e,n,t,i){if(this._renderPrefix(e,n,t,i),e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t)}this._renderSuffix(e,n,t,i)},this._renderBonus=function(e,n){n[0]+=(0>e.value?"":"+")+e.value},this._renderBonusSpeed=function(e,n){n[0]+=`${0>e.value?"":"+"}${e.value} ft.`},this._renderDice=function(e,n){n[0]+=Renderer.getEntryDice(e,e.name,this._isAddHandlers)},this._renderActions=function(e,n,t){const i=this._renderEntriesSubtypes_getDataString(e);this._handleTrackTitles(e.name),this._handleTrackDepth(e,2),n[0]+=`<${this.wrapperTag} class="${Renderer.HEAD_2}" ${i}><span class="rd__h rd__h--3" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}.</span></span> `;const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"});n[0]+=`</${this.wrapperTag}>`},this._renderAttack=function(e,n,t,i){this._renderPrefix(e,n,t,i),n[0]+=`<i>${Parser.attackTypeToFull(e.attackType)}:</i> `;const r=e.attackEntries.length;for(let d=0;d<r;++d)this._recursiveRender(e.attackEntries[d],n,t);n[0]+=` <i>Hit:</i> `;const d=e.hitEntries.length;for(let r=0;r<d;++r)this._recursiveRender(e.hitEntries[r],n,t);this._renderSuffix(e,n,t,i)},this._renderItem=function(e,n,t,i){if(this._renderPrefix(e,n,t,i),n[0]+=`<p><span class="bold list-item-title">${this.render(e.name)}</span> `,e.entry)this._recursiveRender(e.entry,n,t);else if(e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t,{prefix:0<d?`<span class="rd__p-cont-indent">`:"",suffix:0<d?"</span>":""})}n[0]+="</p>",this._renderSuffix(e,n,t,i)},this._renderItemSub=function(e,n,t,i){this._renderPrefix(e,n,t,i),this._recursiveRender(e.entry,n,t,{prefix:`<p><span class="italic list-item-title">${e.name}</span> `,suffix:"</p>"}),this._renderSuffix(e,n,t,i)},this._renderItemSpell=function(e,n,t,i){this._renderPrefix(e,n,t,i),this._recursiveRender(e.entry,n,t,{prefix:`<p>${e.name} `,suffix:"</p>"}),this._renderSuffix(e,n,t,i)},this._renderDataCreature=function(e,n,t,i){this._renderPrefix(e,n,t,i),this._renderDataHeader(n,e.dataCreature.name),n[0]+=Renderer.monster.getCompactRenderedString(e.dataCreature,this),this._renderDataFooter(n),this._renderSuffix(e,n,t,i)},this._renderDataSpell=function(e,n,t,i){this._renderPrefix(e,n,t,i),this._renderDataHeader(n,e.dataSpell.name),n[0]+=Renderer.spell.getCompactRenderedString(e.dataSpell),this._renderDataFooter(n),this._renderSuffix(e,n,t,i)},this._renderDataTrapHazard=function(e,n,t,i){this._renderPrefix(e,n,t,i),this._renderDataHeader(n,e.dataTrapHazard.name),n[0]+=Renderer.traphazard.getCompactRenderedString(e.dataTrapHazard),this._renderDataFooter(n),this._renderSuffix(e,n,t,i)},this._renderDataHeader=function(e,n){e[0]+=`<table class="rd__b-data">`,e[0]+=`<thead><tr><th class="rd__data-embed-header" colspan="6" onclick="((ele) => {
						$(ele).find('.rd__data-embed-name').toggle();
						$(ele).find('.rd__data-embed-toggle').text($(ele).text().includes('+') ? '[\u2013]' : '[+]');
						$(ele).closest('table').find('tbody').toggle()
					})(this)"><span style="display: none;" class="rd__data-embed-name">${n}</span><span class="rd__data-embed-toggle">[\u2013]</span></th></tr></thead><tbody>`},this._renderDataFooter=function(e){e[0]+=`</tbody></table>`},this._renderGallery=function(e,n,t,r){n[0]+=`<div class="rd__wrp-gallery">`;const d=e.images.length,s=e.images.find(e=>e.title);for(let a=0;a<d;++a){const i=MiscUtil.copy(e.images[a]);s&&!i.title&&(i._galleryTitlePad=!0),delete i.imageType,this._recursiveRender(i,n,t,r)}n[0]+=`</div>`},this._renderFlowchart=function(e,n,t,r){n[0]+=`<div class="rd__wrp-flowchart">`;const d=e.blocks.length;for(let s=0;s<d;++s)this._recursiveRender(e.blocks[s],n,t,r),s!=d-1&&(n[0]+=`<div class="rd__s-v-flow"></div>`);n[0]+=`</div>`},this._renderFlowBlock=function(e,n,t){const i=this._renderEntriesSubtypes_getDataString(e);if(n[0]+=`<${this.wrapperTag} class="rd__b-flow" ${i}>`,null!=e.name&&(this._handleTrackTitles(e.name),this._handleTrackDepth(e,1),n[0]+=`<span class="rd__h rd__h--2-flow-block" data-title-index="${this._headerIndex++}" ${this._getEnumeratedTitleRel(e.name)}><span class="entry-title-inner">${e.name}</span></span>`),e.entries){const r=e.entries.length;for(let d=0;d<r;++d){const i=t.depth;t.depth=2,this._recursiveRender(e.entries[d],n,t,{prefix:"<p>",suffix:"</p>"}),t.depth=i}}n[0]+=`<div class="float-clear"></div>`,n[0]+=`</${this.wrapperTag}>`},this._renderHomebrew=function(e,n,t,i){if(this._renderPrefix(e,n,t,i),n[0]+=`<div class="homebrew-section">`,e.oldEntries){const t=Renderer.hover.getMakePredefinedHover({type:"entries",name:"Homebrew",entries:e.oldEntries});let i;i=e.movedTo?"(See moved content)":e.entries?"(See replaced content)":"(See removed content)",n[0]+=`<span class="homebrew-old-content" href="#${window.location.hash}" ${t.html}>${i}</span>`}if(n[0]+=`<span class="homebrew-notice"></span>`,e.entries){const r=e.entries.length;for(let d=0;d<r;++d)this._recursiveRender(e.entries[d],n,t)}else n[0]+=e.movedTo?`<i>This content has been moved to ${e.movedTo}.</i>`:"<i>This content has been deleted.</i>";n[0]+=`</div>`,this._renderSuffix(e,n,t,i)},this._renderCode=function(e,n){const t=!!StorageUtil.syncGet("rendererCodeWrap");n[0]+=`
			<div class="flex-col h-100">
				<div class="flex no-shrink pt-1">
					<button class="btn btn-default btn-xs mb-1 mr-2" onclick="Renderer.events.handleClick_copyCode(event, this)">Copy Code</button>
					<button class="btn btn-default btn-xs mb-1 ${t?"active":""}" onclick="Renderer.events.handleClick_toggleCodeWrap(event, this)">Word Wrap</button>
				</div>
				<pre class="h-100 w-100 mb-1 ${t?"rd__pre-wrap":""}">${e.preformatted}</pre>
			</div>
		`},this._renderHr=function(e,n){n[0]+=`<hr class="rd__hr">`},this._getStyleClass=function(e){const n=[];return SourceUtil.isNonstandardSource(e)&&n.push(CLSS_NON_STANDARD_SOURCE),BrewUtil.hasSourceJson(e)&&n.push(CLSS_HOMEBREW_SOURCE),this._extraSourceClasses&&n.push(...this._extraSourceClasses),n.join(" ")},this._renderString=function(e,t,i){const r=Renderer.splitByTags(e),d=r.length;for(let n=0;n<d;++n){const e=r[n];if(e)if("@"===e[0]){const[n,r]=Renderer.splitFirstSpace(e);switch(n){case"@b":case"@bold":t[0]+=`<b>`,this._recursiveRender(r,t,i),t[0]+=`</b>`;break;case"@i":case"@italic":t[0]+=`<i>`,this._recursiveRender(r,t,i),t[0]+=`</i>`;break;case"@s":case"@strike":t[0]+=`<s>`,this._recursiveRender(r,t,i),t[0]+=`</s>`;break;case"@u":case"@underline":t[0]+=`<u>`,this._recursiveRender(r,t,i),t[0]+=`</u>`;break;case"@note":t[0]+=`<i class="text-muted">`,this._recursiveRender(r,t,i),t[0]+=`</i>`;break;case"@atk":t[0]+=`<i>${Renderer.attackTagToFull(r)}</i>`;break;case"@h":t[0]+=`<i>Hit:</i> `;break;case"@color":case"@highlight":{const e=r.split("|"),[i,d]=r.split("|"),s=BrewUtil.getValidColor(d);if("@color"===n)t[0]+=`<span style="color: #${s}">`;else if("@highlight"===n)t[0]+=`<span style="background-color: #${s}">`;else throw new Error(`Unhandled tag!`);t[0]+=i,t[0]+=`</span>`;break}case"@comic":t[0]+=`<span class="rd__comic">`,this._recursiveRender(r,t,i),t[0]+=`</span>`;break;case"@comicH1":t[0]+=`<span class="rd__comic rd__comic--h1">`,this._recursiveRender(r,t,i),t[0]+=`</span>`;break;case"@comicH2":t[0]+=`<span class="rd__comic rd__comic--h2">`,this._recursiveRender(r,t,i),t[0]+=`</span>`;break;case"@comicH3":t[0]+=`<span class="rd__comic rd__comic--h3">`,this._recursiveRender(r,t,i),t[0]+=`</span>`;break;case"@comicH4":t[0]+=`<span class="rd__comic rd__comic--h4">`,this._recursiveRender(r,t,i),t[0]+=`</span>`;break;case"@comicNote":t[0]+=`<span class="rd__comic rd__comic--note">`,this._recursiveRender(r,t,i),t[0]+=`</span>`;break;case"@dc":{t[0]+=`DC <span class="rd__dc">${r}</span>`;break}case"@dice":case"@damage":case"@hit":case"@d20":case"@chance":case"@recharge":{const e={type:"dice",rollable:!0},[d,s,a,...o]=r.split("|");switch(s&&(e.displayText=s),a&&(e.name=a),n){case"@dice":{e.toRoll=d,!s&&d.includes(";")&&(e.displayText=d.replace(/;/g,"/")),(!e.displayText&&d.includes("#$")||e.displayText&&e.displayText.includes("#$"))&&(e.displayText=(e.displayText||d).replace(/#\$prompt_number[^$]*\$#/g,"(n)")),this._recursiveRender(e,t,i);break}case"@damage":{e.toRoll=d,e.subType="damage",this._recursiveRender(e,t,i);break}case"@d20":case"@hit":{const r=+d,n=`${0<=r?"+":""}${r}`;e.displayText=e.displayText||n,e.toRoll=`1d20${n}`,e.subType="d20",e.d20mod=n,this._recursiveRender(e,t,i);break}case"@chance":{e.toRoll=`1d100`,e.successThresh=+d,this._recursiveRender(e,t,i);break}case"@recharge":{const n=s?s.split(""):null;e.toRoll="1d6";const r=+(d||6);e.successThresh=7-r,e.successMax=6,t[0]+=`${n&&n.includes("m")?"":"("}Recharge `,e.displayText=`${r}${6>r?`\u20136`:""}`,this._recursiveRender(e,t,i),t[0]+=`${n&&n.includes("m")?"":")"}`;break}}break}case"@scaledice":case"@scaledamage":{const e=Renderer.parseScaleDice(n,r);this._recursiveRender(e,t,i);break}case"@filter":{const[e,n,...d]=r.split("|");let s;const a={type:"link",text:e,href:{type:"internal",path:`${n}.html`,hash:HASH_BLANK,hashPreEncoded:!0,subhashes:d.map(e=>{const[n,t,i]=e.split("=").map(e=>e.trim()).filter(e=>e),r=n.startsWith("fb"),d=r?n:`flst${UrlUtil.encodeForHash(n)}`;let a;if(r)return{key:d,value:t,preEncoded:!0};if("search"===n)a=UrlUtil.encodeForHash(t);else{if("hash"===n)return s=t,null;if(t.startsWith("[")&&t.endsWith("]")){const[e,n]=t.substring(1,t.length-1).split(";").map(e=>e.trim());a=null==n?[`min=${e}`,`max=${e}`].join(HASH_SUB_LIST_SEP):[e?`min=${e}`:"",n?`max=${n}`:""].filter(Boolean).join(HASH_SUB_LIST_SEP)}else a=t.split(";").map(e=>e.trim()).filter(e=>e).map(e=>{const n=e.split("!");return 2===n.length?`${UrlUtil.encodeForHash(n[1])}=2`:`${UrlUtil.encodeForHash(e)}=1`}).join(HASH_SUB_LIST_SEP)}const o={key:d,value:a,preEncoded:!0};return i?[o,{key:`flmt${UrlUtil.encodeForHash(n)}`,value:i,preEncoded:!0}]:o}).flat().filter(Boolean)}};s&&(a.href.hash=s),this._recursiveRender(a,t,i);break}case"@link":{const[e,n]=r.split("|");let d=null==n?e:n;d.startsWith("http")||(d=`http://${d}`);const s={type:"link",href:{type:"external",url:d},text:e};this._recursiveRender(s,t,i);break}case"@5etools":{const[e,n,d]=r.split("|"),s={type:"link",href:{type:"internal",path:n},text:e};d&&(s.hash=d,s.hashPreEncoded=!0),this._recursiveRender(s,t,i);break}case"@footnote":{const[e,n,d]=r.split("|"),s=Renderer.hover.getMakePredefinedHover({type:"entries",name:d?d.toTitleCase():"Footnote",entries:[n,d?`{@note ${d}}`:""].filter(Boolean)});t[0]+=`<span class="help" ${s.html}>`,this._recursiveRender(e,t,i),t[0]+=`</span>`;break}case"@homebrew":{const[e,n]=r.split("|"),d=[];e&&n?d.push("{@b This is a homebrew addition, replacing the following:}"):e?d.push("{@b This is a homebrew addition.}"):n&&d.push("{@b The following text has been removed with this homebrew:}"),n&&d.push(n);const s=Renderer.hover.getMakePredefinedHover({type:"entries",name:"Homebrew Modifications",entries:d});t[0]+=`<span class="homebrew-inline" ${s.html}>`,this._recursiveRender(e||"[...]",t,i),t[0]+=`</span>`;break}case"@skill":case"@sense":{const e=(()=>"@skill"===n?Parser.skillToExplanation:"@sense"===n?Parser.senseToExplanation:void 0)(),[i,d]=r.split("|"),s=Renderer.hover.getMakePredefinedHover({type:"entries",name:i.toTitleCase(),entries:e(i)});t[0]+=`<span class="help--hover" ${s.html}>${d||i}</span>`;break}case"@area":{const[e,n,i,...d]=r.split("|"),s=i&&i.includes("x")?e:`${i&&i.includes("u")?"A":"a"}rea ${e}`;if("undefined"==typeof BookUtil)t[0]+=s;else{const e=BookUtil.curRender.headerMap[n]||{entry:{name:""}},i=Renderer.hover.getMakePredefinedHover(e.entry,!0);t[0]+=`<a href="#${BookUtil.curRender.curBookId},${e.chapter},${UrlUtil.encodeForHash(e.entry.name)}" ${i.html}>${s}</a>`}break}case"@book":case"@adventure":{const e="@book"===n?"book.html":"adventure.html",[d,s,a,o,l]=r.split("|"),c=`${s}${a?`${HASH_PART_SEP}${a}${o?`${HASH_PART_SEP}${UrlUtil.encodeForHash(o)}${null==l?"":`${HASH_PART_SEP}${UrlUtil.encodeForHash(l)}`}`:""}`:""}`;this._recursiveRender({type:"link",href:{type:"internal",path:e,hash:c,hashPreEncoded:!0},text:d},t,i);break}case"@deity":{const[e,n,d,s,...a]=r.split("|"),o=`${e}${n?`${HASH_LIST_SEP}${n}`:""}${d?`${HASH_LIST_SEP}${d}`:""}`,l={type:"link",href:{type:"internal",hash:o},text:s||e};l.href.path="deities.html",n||(l.href.hash+=`${HASH_LIST_SEP}forgotten realms`),d||(l.href.hash+=`${HASH_LIST_SEP}${SRC_PHB}`),l.href.hover={page:UrlUtil.PG_DEITIES,source:d||SRC_PHB},this._recursiveRender(l,t,i);break}case"@loader":{const[e,n]=r.split("|"),i=/^.*?:\/\//.test(n)?n:`https://raw.githubusercontent.com/TheGiddyLimit/homebrew/master/${n}`;t[0]+=`<span onclick="BrewUtil.handleLoadbrewClick(this, '${i.escapeQuotes()}', '${e.escapeQuotes()}')" class="rd__wrp-loadbrew--ready" title="Click to install homebrew">${e}<span class="glyphicon glyphicon-download-alt rd__loadbrew-icon rd__loadbrew-icon"></span></span>`;break}default:{const[e,d,s,...a]=r.split("|"),o=`${e}${d?`${HASH_LIST_SEP}${d}`:""}`,l={type:"link",href:{type:"internal",hash:o},text:s||e};switch(n){case"@spell":l.href.path="spells.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_SPELLS,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@item":l.href.path="items.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_ITEMS,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@class":{if(l.href.hover={page:UrlUtil.PG_CLASSES,source:d||SRC_PHB},a.length){const e={subclass:{shortName:a[0].trim(),source:1<a.length?a[1].trim():"phb"}},n=UrlUtil.unpackSubHash(UrlUtil.getClassesPageStatePart(e));if(l.href.hover.subhashes=[{key:"state",value:n.state,preEncoded:!0}],2<a.length){const n=a[2].trim().split("-");e.feature={ixLevel:n[0]||"0",ixFeature:n[1]||"0"}}const t=UrlUtil.unpackSubHash(UrlUtil.getClassesPageStatePart(e));l.href.subhashes=[{key:"state",value:t.state.join(HASH_SUB_LIST_SEP),preEncoded:!0},{key:"fltsource",value:"clear"},{key:"flstmiscellaneous",value:"clear"}]}l.href.path="classes.html",d||(l.href.hash+=`${HASH_LIST_SEP}${SRC_PHB}`),this._recursiveRender(l,t,i);break}case"@creature":if(l.href.path="bestiary.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_MM),l.href.hover={page:UrlUtil.PG_BESTIARY,source:d||SRC_MM},a.length){const n=Parser.crToNumber(a[0]);l.href.hover.preloadId=`${MON_HASH_SCALED}:${n}`,l.href.subhashes=[{key:MON_HASH_SCALED,value:n}],l.text=s||`${e} (CR ${a[0]})`}this._recursiveRender(l,t,i);break;case"@condition":l.href.path="conditionsdiseases.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_CONDITIONS_DISEASES,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@disease":l.href.path="conditionsdiseases.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_CONDITIONS_DISEASES,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@background":l.href.path="backgrounds.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_BACKGROUNDS,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@race":l.href.path="races.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_RACES,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@optfeature":l.href.path="optionalfeatures.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_OPT_FEATURES,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@reward":l.href.path="rewards.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_REWARDS,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@feat":l.href.path="feats.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_FEATS,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@psionic":l.href.path="psionics.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_UATMC),l.href.hover={page:UrlUtil.PG_PSIONICS,source:d||SRC_UATMC},this._recursiveRender(l,t,i);break;case"@object":l.href.path="objects.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_OBJECTS,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@boon":case"@cult":l.href.path="cultsboons.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_MTF),l.href.hover={page:UrlUtil.PG_CULTS_BOONS,source:d||SRC_MTF},this._recursiveRender(l,t,i);break;case"@trap":case"@hazard":l.href.path="trapshazards.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_TRAPS_HAZARDS,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@variantrule":l.href.path="variantrules.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_VARIATNRULES,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@table":l.href.path="tables.html",d||(l.href.hash+=HASH_LIST_SEP+SRC_DMG),l.href.hover={page:UrlUtil.PG_TABLES,source:d||SRC_DMG},this._recursiveRender(l,t,i);break;case"@vehicle":l.href.path=UrlUtil.PG_VEHICLES,d||(l.href.hash+=HASH_LIST_SEP+SRC_GoS),l.href.hover={page:UrlUtil.PG_VEHICLES,source:d||SRC_GoS},this._recursiveRender(l,t,i);break;case"@action":l.href.path=UrlUtil.PG_ACTIONS,d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_ACTIONS,source:d||SRC_PHB},this._recursiveRender(l,t,i);break;case"@language":l.href.path=UrlUtil.PG_LANGUAGES,d||(l.href.hash+=HASH_LIST_SEP+SRC_PHB),l.href.hover={page:UrlUtil.PG_LANGUAGES,source:d||SRC_PHB},this._recursiveRender(l,t,i);}break}}}else t[0]+=e}},this._renderPrimitive=function(e,n){n[0]+=e},this._renderLink=function(e,n){let t=this._renderLink_getHref(e);if(e.href.hover&&this._roll20Ids){const n=UrlUtil.encodeForHash(e.href.hash),i=this._roll20Ids[n];i&&(t=`http://journal.roll20.net/${i.type}/${i.roll20Id}`)}n[0]+=this._isIternalLinksDisabled&&"internal"===e.href.type?`<span class="bold" ${this._renderLink_getHoverString(e)} ${this._getHooks("link","ele").map(n=>n(e)).join(" ")}>${this.render(e.text)}</span>`:`<a href="${t}" ${"internal"===e.href.type?"":`target="_blank" rel="noopener noreferrer"`} ${this._renderLink_getHoverString(e)} ${this._getHooks("link","ele").map(n=>n(e)).join(" ")}>${this.render(e.text)}</a>`},this._renderLink_getHref=function(e){let n;if("internal"!==e.href.type)"external"===e.href.type&&(n=e.href.url);else if(n=`${this.baseUrl}${e.href.path}#`,null!=e.href.hash&&(n+=e.href.hashPreEncoded?e.href.hash:UrlUtil.encodeForHash(e.href.hash)),null!=e.href.subhashes)for(let t=0;t<e.href.subhashes.length;++t)n+=this._renderLink_getSubhashPart(e.href.subhashes[t]);return n},this._renderLink_getSubhashPart=function(e){let n="";return n+=e.preEncoded?`${HASH_PART_SEP}${e.key}${HASH_SUB_KV_SEP}`:`${HASH_PART_SEP}${UrlUtil.encodeForHash(e.key)}${HASH_SUB_KV_SEP}`,n+=null==e.value?e.values.map(e=>UrlUtil.encodeForHash(e)).join(HASH_SUB_LIST_SEP):e.preEncoded?e.value:UrlUtil.encodeForHash(e.value),n},this._renderLink_getHoverString=function(e){if(!e.href.hover)return"";let n=UrlUtil.encodeForHash(e.href.hash).replace(/'/g,"\\'");if(this._tagExportDict&&(this._tagExportDict[n]={page:e.href.hover.page,source:e.href.hover.source,hash:n}),e.href.hover.subhashes)for(let t=0;t<e.href.hover.subhashes.length;++t)n+=this._renderLink_getSubhashPart(e.href.hover.subhashes[t]);return this._isAddHandlers?`onmouseover="Renderer.hover.pHandleLinkMouseOver(event, this, '${e.href.hover.page}', '${e.href.hover.source}', '${n}', ${e.href.hover.preloadId?`'${e.href.hover.preloadId}'`:"null"})" onmouseleave="Renderer.hover.handleLinkMouseLeave(event, this)" onmousemove="Renderer.hover.handleLinkMouseMove(event, this)"  ${Renderer.hover.getPreventTouchString()}`:""},this.render=function(e,n=0){const t=[];return this.recursiveRender(e,t,{depth:n}),t.join("")}}Renderer.ENTRIES_WITH_CHILDREN=[{type:"section",key:"entries"},{type:"entries",key:"entries"},{type:"inset",key:"entries"},{type:"insetReadaloud",key:"entries"},{type:"list",key:"items"},{type:"table",key:"rows"}],Renderer.events={handleClick_copyCode(e,n){const t=$(n).parent().next("pre");MiscUtil.pCopyTextToClipboard(t.text()),JqueryUtil.showCopiedEffect(t)},handleClick_toggleCodeWrap(e,n){const t=!StorageUtil.syncGet("rendererCodeWrap");StorageUtil.syncSet("rendererCodeWrap",t);const i=$(n).toggleClass("active",t),r=i.parent().next("pre");r.toggleClass("rd__pre-wrap",t)}},Renderer.applyProperties=function(e,n){const t=Renderer.splitByPropertyInjectors(e),r=t.length;if(1===r)return e;let d="";for(let a=0;a<r;++a){const e=t[a];if(e)if("="===e[0]){const[t,i]=e.substring(1).split("/");let r=n[t];if(i)for(const e of i)"a"===e?r=Renderer.applyProperties._leadingAn.has(r[0].toLowerCase())?"an":"a":"l"===e?r=r.toLowerCase():"t"===e?r=r.toTitleCase():"u"===e?r=r.toUpperCase():void 0;d+=r}else d+=e}return d},Renderer.applyProperties._leadingAn=new Set(["a","e","i","o","u"]),Renderer.applyAllProperties=function(e,n){return MiscUtil.getWalker().walk("applyAllProperties",e,{string:(e,t)=>Renderer.applyProperties(t,n)})},Renderer.attackTagToFull=function(e){function n(e){return`${e.includes("m")?"Melee ":e.includes("r")?"Ranged ":e.includes("g")?"Magical ":e.includes("a")?"Area ":""}${e.includes("w")?"Weapon ":e.includes("s")?"Spell ":""}`}const t=e.toLowerCase().split(",").map(e=>e.trim()).filter(e=>e).map(e=>e.split(""));if(1<t.length){const e=new Set(t.last());for(let n=t.length-2;0<=n;--n)t[n]=t[n].filter(n=>{const t=!e.has(n);return e.add(n),t})}return`${t.map(e=>n(e)).join(" or ")}Attack:`},Renderer.HOVER_TAG_TO_PAGE={spell:UrlUtil.PG_SPELLS,item:UrlUtil.PG_ITEMS,creature:UrlUtil.PG_BESTIARY,condition:UrlUtil.PG_CONDITIONS_DISEASES,disease:UrlUtil.PG_CONDITIONS_DISEASES,background:UrlUtil.PG_BACKGROUNDS,race:UrlUtil.PG_RACES,optfeature:UrlUtil.PG_OPT_FEATURES,reward:UrlUtil.PG_REWARDS,feat:UrlUtil.PG_FEATS,psionic:UrlUtil.PG_PSIONICS,object:UrlUtil.PG_OBJECTS,cult:UrlUtil.PG_CULTS_BOONS,boon:UrlUtil.PG_CULTS_BOONS,trap:UrlUtil.PG_TRAPS_HAZARDS,hazard:UrlUtil.PG_TRAPS_HAZARDS,deity:UrlUtil.PG_DEITIES,variantrule:UrlUtil.PG_VARIATNRULES},Renderer.splitFirstSpace=function(e){const n=e.indexOf(" ");return-1===n?[e,""]:[e.substr(0,n),e.substr(n+1)]},Renderer._splitByTagsBase=function(e){return function(n){let t,r,d=0;const s=[];let a="",o=!1;const l=n.length;for(let c=0;c<l;++c)switch(t=n[c],r=n[c+1],t){case"{":o=!0,r===e?0<d++?a+="{":(s.push(a.replace(/<VE_LEAD>/g,e)),a=e,++c):a+="{";break;case"}":o=!1,0===d?a+="}":0==--d?(s.push(a.replace(/<VE_LEAD>/g,e)),a=""):a+="}";break;case e:{a+=o?e:"<VE_LEAD>";break}default:o=!1,a+=t;}return a&&s.push(a.replace(/<VE_LEAD>/g,e)),s}},Renderer.splitByTags=Renderer._splitByTagsBase("@"),Renderer.splitByPropertyInjectors=Renderer._splitByTagsBase("="),Renderer.getEntryDice=function(e,n,t=!0){function i(e){return`'${JSON.stringify(e).escapeQuotes()}'`}const r=Renderer.getEntryDiceDisplayText(e);if(!0===e.rollable){const d=MiscUtil.copy(e);"string"!=typeof d.toRoll&&(d.toRoll=Renderer.legacyDiceToString(d.toRoll));const s=t?`onmousedown="event.preventDefault()" onclick="Renderer.dice.pRollerClickUseData(event, this)" data-packed-dice=${i(d)}`:"",a=t?Renderer.getEntryDiceTitle(d.subType):null,o=t?`title="${[n,a].filter(Boolean).join(". ").escapeQuotes()}" ${n?`data-roll-name="${n}"`:""}`:n?`title="${n.escapeQuotes()}" data-roll-name="${n.escapeQuotes()}"`:"";return`<span class="roller render-roller" ${o} ${s}>${r}</span>`}return r},Renderer.getEntryDiceTitle=function(e){return`Click to roll. ${"damage"===e?"SHIFT to roll a critical hit, CTRL to half damage (rounding down).":"d20"===e?"SHIFT to roll with advantage, CTRL to roll with disadvantage.":"SHIFT/CTRL to roll twice."}`},Renderer.legacyDiceToString=function(e){let n="";return e.forEach(e=>{n+=`${e.neg?"-":""===n?"":"+"}${e.number||1}d${e.faces}${e.mod?0<e.mod?`+${e.mod}`:e.mod:""}`}),n},Renderer.getEntryDiceDisplayText=function(e){return e.displayText?e.displayText:function(){return e.successThresh?`${e.successThresh} percent`:"string"==typeof e.toRoll?e.toRoll:Renderer.legacyDiceToString(e.toRoll)}()},Renderer.parseScaleDice=function(e,n){var t=Math.floor,i=Math.min;const[r,d,s,a]=n.split("|"),o=MiscUtil.parseNumberRange(d,1,9),l=i(...o),c={},u=/^(\d+)d(\d+)$/i.exec(s),p=(()=>{let e=null;const n=[...o].sort(SortUtil.ascSort);for(let t=1;t<n.length;++t){const i=n[t-1],r=n[t];if(null==e)e=r-i;else if(r-i!==e)return null}return e})();o.forEach(e=>{const n=e-l;c[e]=u&&null!=p?n?`${+u[1]*(n/p)}d${u[2]}`:"":n?[...Array(t(n/p))].map(()=>s).join("+"):""});const f={type:"dice",rollable:!0,toRoll:r,displayText:s,prompt:{entry:"psi"===a?"Spend Psi Points...":"Cast at...",mode:a,options:c}};return"@scaledamage"===e&&(f.subType="damage"),f},Renderer.getAbilityData=function(e){function n(e){function n(e,n,t){if(null!=e[n]){const i=0>e[n],l=`${n.uppercaseFirst()} ${i?"":"+"}${e[n]}`;t?t.push(l):(a.push(l),o.push(l)),r.push(n.uppercaseFirst()),d.push(n),i&&s.push(n)}}function t(e){const n=[];for(let t=0;t<r.length;++t)n.push(r[t].toLowerCase());for(let t=0;t<e.from.length;++t){const i=e.from[t].toLowerCase();n.includes(i)||n.push(i),d.includes(i.toLowerCase)||d.push(i.toLowerCase())}return 6===n.length}const r=[],d=[],s=[],a=[],o=[];return null==e?new Renderer._AbilityData("","",[],[]):(function(e,t){MiscUtil.copy(Parser.ABIL_ABVS).sort((n,t)=>SortUtil.ascSort(e[t]||0,e[n]||0)).forEach(i=>n(e,i,t))}(e),function(){if(null!=e.choose){const n=e.choose;let i="";if(n.weighted){const e=n.weighted,t=[],i=e.weights.filter(e=>0<=e).sort(SortUtil.ascSort).reverse().map(e=>(t.push(`+${e}`),`one ability to increase by ${e}`)),r=[],d=e.weights.filter(e=>0>e).map(e=>-e).sort(SortUtil.ascSort).map(e=>(r.push(`-${e}`),`one ability to decrease by ${e}`)),s=e.from.map(e=>e.uppercaseFirst()),l=6===s.length?`Choose `:`From ${s.joinConjunct(", "," and ")} choose `;a.push(`${l}${i.concat(d).joinConjunct(", "," and ")}`),o.push(`${6===s.length?"Any combination ":""}${t.concat(r).join("/")}${6===s.length?"":` from ${s.join("/")}`}`)}else{const e=6===n.from.length,r=t(n);let d=void 0===n.amount?1:n.amount;if(d=(0>d?"":"+")+d,e?i+="any ":r&&(i+="any other "),null!=n.count&&1<n.count&&(i+=`${Parser.numberToText(n.count)} `),e||r)i+=`${1<n.count?"unique ":""}${d}`;else for(let e,t=0;t<n.from.length;++t){e="",1<n.from.length&&(t===n.from.length-2?e=" or ":t<n.from.length-2&&(e=", "));let r=` ${d}`;1<n.from.length&&t!==n.from.length-1&&(r=""),i+=n.from[t].uppercaseFirst()+r+e}}i.trim()&&(a.push(`Choose ${i}`),o.push(i.uppercaseFirst()))}}(),new Renderer._AbilityData(a.join("; "),o.join("; "),d,s))}const t=(e||[null]).map(e=>n(e));return 1>=t.length?t[0]:new Renderer._AbilityData(`Choose one of: ${t.map((e,n)=>`(${Parser.ALPHABET[n].toLowerCase()}) ${e.asText}`).join(" ")}`,`One from: ${t.map((e,n)=>`(${Parser.ALPHABET[n].toLowerCase()}) ${e.asTextShort}`).join(" ")}`,[...new Set(t.map(e=>e.asCollection).flat())],[...new Set(t.map(e=>e.areNegative).flat())])},Renderer._AbilityData=function(e,n,t,i){this.asText=e,this.asTextShort=n,this.asCollection=t,this.areNegative=i},Renderer.utils={getBorderTr:e=>`<tr><th class="border" colspan="6">${e||""}</th></tr>`,getDividerTr:()=>`<tr><td class="divider" colspan="6"><div></div></td></tr>`,getSourceSubText(e){return e.sourceSub?` \u2014 ${e.sourceSub}`:""},getNameTr:(e,n)=>{n=n||{};let t="";if(n.page){const i=UrlUtil.URL_TO_HASH_BUILDER[n.page](e);t=`data-page="${n.page}" data-source="${e.source.escapeQuotes()}" data-hash="${i.escapeQuotes()}"`}return`<tr>
			<th class="rnd-name name ${n.extraThClasses?n.extraThClasses.join(" "):""}" colspan="6" ${t}>
				<div class="name-inner">
					<div class="flex-v-center">
						<span class="stats-name copyable" onmousedown="event.preventDefault()" onclick="Renderer.utils._pHandleNameClick(this)">${n.prefix||""}${e._displayName||e.name}${n.suffix||""}</span>
						${n.pronouncePart||""}
						${ExtensionUtil.ACTIVE?`<button title="Send to Foundry (SHIFT for Temporary Import)" class="btn btn-xs btn-default btn-stats-name" onclick="ExtensionUtil.pDoSendStats(event, this)"><span class="glyphicon glyphicon-send"></span></button>`:""}
					</div>
					<span class="stats-source flex-v-baseline">
						<span class="help--subtle ${e.source?`${Parser.sourceJsonToColor(e.source)}" title="${Parser.sourceJsonToFull(e.source)}${Renderer.utils.getSourceSubText(e)}`:""}" ${BrewUtil.sourceJsonToStyle(e.source)}">${e.source?Parser.sourceJsonToAbv(e.source):""}</span>
						${0<e.page?` <span class="rd__stats-name-page ml-1" title="Page ${e.page}">p${e.page}</span>`:""}
					</span>
				</div>
			</th>
		</tr>`},getExcludedTr(e,n){if(!ExcludeUtil.isInitialised)return"";const t=ExcludeUtil.isExcluded(e.name,n,e.source);return t?`<tr><td colspan="6" class="pt-3 text-center text-danger"><b><i>Warning: This content has been blacklisted.</i></b></td></tr>`:""},async _pHandleNameClick(e){await MiscUtil.pCopyTextToClipboard($(e).text()),JqueryUtil.showCopiedEffect($(e))},getPageTr:e=>`<td colspan=6>${Renderer.utils._getPageTrText(e)}</td>`,_getPageTrText:e=>{function n(n,t){return e[n]&&e[n].length?`${t} ${e[n].map(e=>e.entry?Renderer.get().render(e.entry):`<i title="${Parser.sourceJsonToFull(e.source)}">${Parser.sourceJsonToAbv(e.source)}</i>${0<e.page?`, page ${e.page}`:""}`).join("; ")}`:""}const t=Renderer.utils.getSourceSubText(e),i=0<e.page?`<b>Source:</b> <i title="${Parser.sourceJsonToFull(e.source)}${t}">${Parser.sourceJsonToAbv(e.source)}${t}</i>, page ${e.page}`:"",r=n("additionalSources","Additional information from"),d=n("otherSources","Also found in"),s=e.srd?`Available in the <span title="Systems Reference Document">SRD</span>${"string"==typeof e.srd?` (as &quot;${e.srd}&quot;)`:""}`:"",a=n("externalSources","External sources:");return`${[i,r,d,s,a].filter(e=>e).join(". ")}${i&&(r||d||s||a)?".":""}`},getAbilityRoller(e,n){if(null==e[n])return"\u2014";const t=Parser.getAbilityModifier(e[n]);return Renderer.get().render(`{@d20 ${t}|${e[n]} (${t})|${Parser.attAbvToFull(n)}`)},tabButton:(e,n,t)=>({label:e,funcChange:n,funcPopulate:t}),_tabs:{},_curTab:null,_prevTab:null,bindTabButtons:(...e)=>{Renderer.utils._tabs={},Renderer.utils._prevTab=Renderer.utils._curTab,Renderer.utils._curTab=null;const n=$("#pagecontent"),t=$(`#stat-tabs`);t.find(`.stat-tab-gen`).remove();let r=null;const d=e.map((e,t)=>{const i=!Renderer.utils._prevTab&&0===t||Renderer.utils._prevTab&&Renderer.utils._prevTab.label===e.label,d=$(`<span class="stat-tab ${i?`stat-tab-sel`:""} btn btn-default stat-tab-gen">${e.label}</span>`);return e.$t=d,d.click(()=>{const t=Renderer.utils._curTab,i=Renderer.utils._tabs;t&&t.label===e.label||(t&&t.$t.removeClass(`stat-tab-sel`),Renderer.utils._curTab=e,d.addClass(`stat-tab-sel`),t&&(i[t.label].content=n.children().detach()),i[e.label]=e,!i[e.label].content&&e.funcPopulate?e.funcPopulate():n.append(i[e.label].content),e.funcChange&&e.funcChange())}),Renderer.utils._prevTab&&Renderer.utils._prevTab.label===e.label&&(r=d),d});1!==e.length&&d.reverse().forEach(e=>t.prepend(e)),(r||d[d.length-1]).click()},_pronounceButtonsBound:!1,bindPronounceButtons(){Renderer.utils._pronounceButtonsBound||(Renderer.utils._pronounceButtonsBound=!0,$(`body`).on("click",".btn-name-pronounce",function(){const e=$(this).find(`.name-pronounce`)[0];e.currentTime=0,e.play()}))},getPredefinedFluff(e,n){if(!e.fluff)return null;const t=`_${n}`,i=`_append${n.uppercaseFirst()}`,r={},d=(e,...n)=>{n.forEach(n=>{e[n]&&(r[n]=e[n])})};if(d(e.fluff,"name","type","entries","images"),e.fluff[t]){const i=(BrewUtil.homebrew[n]||[]).find(n=>n.name===e.fluff[t].name&&n.source===e.fluff[t].source);i&&d(i,"name","type","entries","images")}if(e.fluff[i]){const t=(BrewUtil.homebrew[n]||[]).find(n=>n.name===e.fluff[i].name&&n.source===e.fluff[i].source);t&&(t.entries&&(r.entries=MiscUtil.copy(r.entries||[]),r.entries.push(...MiscUtil.copy(t.entries))),t.images&&(r.images=MiscUtil.copy(r.images||[]),r.images.push(...MiscUtil.copy(t.images))))}return r},async pBuildFluffTab(e,n,t,i,r,d){function s(n){a.setFirstSection(!0);const t=i(n);if(!t)return void l.empty().append(e?Renderer.utils.HTML_NO_IMAGES:Renderer.utils.HTML_NO_INFO);if(e)t.images?t.images.forEach(e=>l.append(a.render(e,1))):l.append(Renderer.utils.HTML_NO_IMAGES);else if(t.entries){const e="section"===t.type?-1:2;"section"!==t.type&&t.entries.length&&"section"!==t.entries[0].type&&a.setFirstSection(!1),l.append(a.render({type:t.type,entries:t.entries},e))}else l.append(Renderer.utils.HTML_NO_INFO)}const a=Renderer.get();n.append(Renderer.utils.getBorderTr()),n.append(Renderer.utils.getNameTr(t));const o=$(`<tr class="text"/>`);n.append(o);const l=$(`<td colspan="6" class="text"/>`).appendTo(o);if(n.append(Renderer.utils.getBorderTr()),!(d&&d(t.source)||t.fluff))l.empty(),e?l.append(Renderer.utils.HTML_NO_IMAGES):l.append(Renderer.utils.HTML_NO_INFO);else if(t.fluff)s();else{const e=await DataUtil.loadJSON(r);s(e)}},HTML_NO_INFO:"<i>No information available.</i>",HTML_NO_IMAGES:"<i>No images available.</i>",_prereqWeights:{level:0,pact:1,patron:2,spell:3,race:4,ability:5,proficiency:6,spellcasting:7,feature:8,item:9,other:10,otherSummary:11,[void 0]:12},_getPrerequisiteText_getShortClassName(e){const n=/[aeiou]/.exec(e).index,t=e.slice(0,n+1);let i=e.slice(n+1);return i=i.replace().replace(/[aeiou]/g,""),`${t}${i}`.toTitleCase()},getPrerequisiteText:(e,n=!1,t=new Set)=>{if(!e)return n?"\u2014":"";const i=e.map(e=>Object.entries(e).sort(([e],[n])=>Renderer.utils._prereqWeights[e]-Renderer.utils._prereqWeights[n]).map(([e,i])=>{if(t.has(e))return!1;switch(e){case"level":{const e=i.subclass&&i.subclass.visible,t=i.class&&(i.class.visible||e);if(n){const n=t?Renderer.utils._getPrerequisiteText_getShortClassName(i.class.name):null;return`${t?`${n.slice(0,4)}${e?"*":"."} `:""} Lvl ${i.level}`}else{let n="";return t&&e?n=` ${i.class.name} (${i.subclass.name})`:t?n=` ${i.class.name}`:e&&(n=` &lt;remember to insert class name here&gt; (${i.subclass.name})`),`${Parser.getOrdinalForm(i.level)} level${t?` ${i.class.name}`:""}`}}case"pact":return Parser.prereqPactToFull(i);case"patron":return n?`${Parser.prereqPatronToShort(i)} patron`:`${i} patron`;case"spell":return n?i.map(e=>e.split("#")[0].split("|")[0].toTitleCase()).join("/"):i.map(e=>Parser.prereqSpellToFull(e)).joinConjunct(", "," or ");case"feature":return n?i.map(e=>e.toTitleCase()).join("/"):i.joinConjunct(", "," or ");case"item":return n?i.map(e=>e.toTitleCase()).join("/"):i.joinConjunct(", "," or ");case"otherSummary":return n?i.entrySummary||Renderer.stripTags(i.entry):Renderer.get().render(i.entry);case"other":return n?"Special":Renderer.get().render(i);case"race":{const e=i.map((e,t)=>{if(n)return`${e.name.toTitleCase()}${null==e.subrace?"":` (${e.subrace})`}`;else{const n=e.displayEntry?Renderer.get().render(e.displayEntry):0===t?e.name.toTitleCase():e.name;return`${n}${null==e.subrace?"":` (${e.subrace})`}`}});return n?e.join("/"):e.joinConjunct(", "," or ")}case"ability":{let e=!1,t=!1,r=null;outer:for(const e of i)for(const n of Object.values(e))if(null==r)r=n;else if(n!==r){r=null;break outer}const d=i.map(i=>{if(r){const t=Object.keys(i);return e=e||1<t.length,n?t.map(e=>e.uppercaseFirst()).join(", "):t.map(e=>Parser.attAbvToFull(e)).joinConjunct(", "," and ")}else{const r={};Object.entries(i).forEach(([e,n])=>{(r[n]=r[n]||[]).push(e)});let d=!1;const s=Object.entries(r).sort(([e],[n])=>SortUtil.ascSort(+n,+e)).map(([i,r])=>(e=e||1<r.length,1<r.length&&(t=d=!0),r=r.sort(SortUtil.ascSortAtts),n?`${r.map(e=>e.uppercaseFirst()).join(", ")} ${i}+`:`${r.map(e=>Parser.attAbvToFull(e)).joinConjunct(", "," and ")} ${i} or higher`));return n?`${d||1<s.length?"(":""}${s.join(" & ")}${d||1<s.length?")":""}`:d?s.joinConjunct("; "," and "):s.joinConjunct(", "," and ")}});if(n)return`${d.join("/")}${null==r?"":` ${r}+`}`;else{const n=t||e||null==r,i=d.joinConjunct(t?" - ":e?"; ":", ",n?` <i>or</i> `:" or ");return`${i}${null==r?"":` 13 or higher`}`}}case"proficiency":{const e=i.map(e=>Object.entries(e).map(([e,t])=>{if("armor"===e)return n?`Prof ${Parser.armorFullToAbv(t)} armor`:`Proficiency with ${t} armor`}));return n?e.join("/"):e.joinConjunct(", "," or ")}case"spellcasting":return n?"Spellcasting":"The ability to cast at least one spell";default:throw new Error(`Unhandled key: ${e}`);}}).filter(Boolean).join(", ")).filter(Boolean);return i.length?n?i.join("/"):`Prerequisites: ${i.joinConjunct("; "," or ")}`:n?"\u2014":""}},Renderer.feat={mergeAbilityIncrease:function(e){function n(e){const n=", to a maximum of 20.",t=[];if(!e.choose)Object.keys(e).forEach(i=>t.push(`Increase your ${Parser.attAbvToFull(i)} score by ${e[i]}${n}`));else{const i=e.choose;if(6===i.from.length)i.textreference?t.push(`Increase the chosen ability score by ${i.amount}${n}`):t.push(`Increase one ability score of your choice by ${i.amount}${n}`);else{const e=i.from,r=i.amount,d=[];for(let n=0;n<e.length;++n)d.push(Parser.attAbvToFull(e[n]));const s=d.joinConjunct(", "," or ");t.push(`Increase your ${s} by ${r}${n}`)}}return t.join(" ")}if(!e.ability||e._hasMergedAbility)return;e._hasMergedAbility=!0;const t=e.entries.find(n=>"list"===n.type);t?e.ability.forEach(e=>t.items.unshift(n(e))):(e.ability.forEach(t=>e.entries.unshift(n(t))),setTimeout(()=>{throw new Error(`Could not find object of type "list" in "entries" for feat "${e.name}" from source "${e.source}" when merging ability scores! Reformat the feat to include a "list"-type entry.`)},1))},getCompactRenderedString(e){const n=Renderer.get(),t=[],i=Renderer.utils.getPrerequisiteText(e.prerequisite);return Renderer.feat.mergeAbilityIncrease(e),t.push(`
			${Renderer.utils.getExcludedTr(e,"feat")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_FEATS})}
			<tr class="text"><td colspan="6" class="text">
			${i?`<p><i>${i}</i></p>`:""}
		`),n.recursiveRender({entries:e.entries},t,{depth:2}),t.push(`</td></tr>`),t.join("")}},Renderer.get=()=>(Renderer.defaultRenderer||(Renderer.defaultRenderer=new Renderer),Renderer.defaultRenderer),Renderer.spell={getCompactRenderedString(e){const n=Renderer.get(),t=[];t.push(`
			${Renderer.utils.getExcludedTr(e,"spell")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_SPELLS})}
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th colspan="1">Level</th>
						<th colspan="1">School</th>
						<th colspan="2">Casting Time</th>
						<th colspan="2">Range</th>
					</tr>
					<tr>
						<td colspan="1">${Parser.spLevelToFull(e.level)}${Parser.spMetaToFull(e.meta)}</td>
						<td colspan="1">${Parser.spSchoolAndSubschoolsAbvsToFull(e.school,e.subschools)}</td>
						<td colspan="2">${Parser.spTimeListToFull(e.time)}</td>
						<td colspan="2">${Parser.spRangeToFull(e.range)}</td>
					</tr>
					<tr>
						<th colspan="4">Components</th>
						<th colspan="2">Duration</th>
					</tr>
					<tr>
						<td colspan="4">${Parser.spComponentsToFull(e.components,e.level)}</td>
						<td colspan="2">${Parser.spDurationToFull(e.duration)}</td>
					</tr>
				</table>
			</td></tr>
		`),t.push(`<tr class="text"><td colspan="6" class="text">`);const i={type:"entries",entries:e.entries};if(n.recursiveRender(i,t,{depth:1}),e.entriesHigherLevel){const i={type:"entries",entries:e.entriesHigherLevel};n.recursiveRender(i,t,{depth:2})}if(e.classes&&e.classes.fromClassList){const[n]=Parser.spClassesToCurrentAndLegacy(e.classes);t.push(`<div><span class="bold">Classes: </span>${Parser.spMainClassesToFull({fromClassList:n})}</div>`)}return t.push(`</td></tr>`),t.join("")},initClasses(e,n){if(!e._isInitClasses&&(e._isInitClasses=!0,e.classes&&e.classes.fromClassList&&e.classes.fromClassList.filter(e=>e.name===Renderer.spell.STR_WIZARD&&e.source===SRC_PHB).length&&(!e.classes.fromSubclass&&(e.classes.fromSubclass=[]),e.classes.fromSubclass.push({class:{name:Renderer.spell.STR_FIGHTER,source:SRC_PHB},subclass:{name:Renderer.spell.STR_ELD_KNIGHT,source:SRC_PHB}}),e.classes.fromSubclass.push({class:{name:Renderer.spell.STR_ROGUE,source:SRC_PHB},subclass:{name:Renderer.spell.STR_ARC_TCKER,source:SRC_PHB}}),4<e.level&&(e._scrollNote=!0)),e.classes&&e.classes.fromClassList&&e.classes.fromClassList.filter(e=>e.name===Renderer.spell.STR_CLERIC&&e.source===SRC_PHB).length&&(e.classes.fromSubclass?!e.classes.fromSubclass.find(e=>e.class.name===Renderer.spell.STR_SORCERER&&e.class.source===SRC_PHB&&e.subclass.name===Renderer.spell.STR_DIV_SOUL&&e.subclass.source===SRC_XGE)&&e.classes.fromSubclass.push({class:{name:Renderer.spell.STR_SORCERER,source:SRC_PHB},subclass:{name:Renderer.spell.STR_DIV_SOUL,source:SRC_XGE}}):(e.classes.fromSubclass=[],e.classes.fromSubclass.push({class:{name:Renderer.spell.STR_SORCERER,source:SRC_PHB},subclass:{name:Renderer.spell.STR_DIV_SOUL,source:SRC_XGE}})),e.classes.fromSubclass.push({class:{name:Renderer.spell.STR_SORCERER,source:SRC_PHB},subclass:{name:Renderer.spell.STR_FAV_SOUL_V2,source:SRC_UAS}}),e.classes.fromSubclass.push({class:{name:Renderer.spell.STR_SORCERER,source:SRC_PHB},subclass:{name:Renderer.spell.STR_FAV_SOUL_V3,source:SRC_UARSC}})),e.classes&&e.classes.fromClassList&&e.classes.fromClassList.find(e=>"Wizard"===e.name)&&(0===e.level&&((e.races||(e.races=[])).push({name:"Elf (High)",source:SRC_PHB,baseName:"Elf",baseSource:SRC_PHB}),(e.classes.fromSubclass=e.classes.fromSubclass||[]).push({class:{name:Renderer.spell.STR_CLERIC,source:SRC_PHB},subclass:{name:"Arcana",source:SRC_SCAG}})),6<=e.level&&(e.classes.fromSubclass=e.classes.fromSubclass||[]).push({class:{name:Renderer.spell.STR_CLERIC,source:SRC_PHB},subclass:{name:"Arcana",source:SRC_SCAG}})),e.classes&&e.classes.fromClassList&&e.classes.fromClassList.find(e=>"Druid"===e.name)&&0===e.level&&(e.classes.fromSubclass=e.classes.fromSubclass||[]).push({class:{name:Renderer.spell.STR_CLERIC,source:SRC_PHB},subclass:{name:"Nature",source:SRC_PHB}}),n)){const t=e.name.toLowerCase();if(n.spell&&n.spell[e.source]&&n.spell[e.source][t]&&(e.classes=e.classes||{},n.spell[e.source][t].fromClassList.length&&(e.classes.fromClassList=e.classes.fromClassList||[],e.classes.fromClassList.push(...n.spell[e.source][t].fromClassList)),n.spell[e.source][t].fromSubclass.length&&(e.classes.fromSubclass=e.classes.fromSubclass||[],e.classes.fromSubclass.push(...n.spell[e.source][t].fromSubclass))),n.class&&e.classes&&e.classes.fromClassList)outer:for(const t in n.class){const i=n.class[t];for(const n in i){const r=e.classes.fromClassList.some(e=>e.source===t&&e.name.toLowerCase()===n);if(!r)continue;const d=i[n];d.fromClassList&&e.classes.fromClassList.push(...d.fromClassList),d.fromSubclass&&(e.classes.fromSubclass=e.classes.fromSubclass||[],e.classes.fromSubclass.push(...d.fromSubclass));break outer}}}},STR_WIZARD:"Wizard",STR_FIGHTER:"Fighter",STR_ROGUE:"Rogue",STR_CLERIC:"Cleric",STR_SORCERER:"Sorcerer",STR_ELD_KNIGHT:"Eldritch Knight",STR_ARC_TCKER:"Arcane Trickster",STR_DIV_SOUL:"Divine Soul",STR_FAV_SOUL_V2:"Favored Soul v2 (UA)",STR_FAV_SOUL_V3:"Favored Soul v3 (UA)"},Renderer.condition={getCompactRenderedString(e){const n=Renderer.get(),t=[];return t.push(`
			${Renderer.utils.getExcludedTr(e,e.__prop||e._type)}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_CONDITIONS_DISEASES})}
			<tr class="text"><td colspan="6">
		`),n.recursiveRender({entries:e.entries},t),t.push(`</td></tr>`),t.join("")}},Renderer.background={getCompactRenderedString(e){return`
		${Renderer.utils.getExcludedTr(e,"background")}
		${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_BACKGROUNDS})}
		<tr class="text"><td colspan="6">
		${Renderer.get().render({type:"entries",entries:e.entries})}
		</td></tr>
		`},getSkillSummary(e,n,t){return Renderer.background._summariseProfs(e,n,t,`skill`)},getToolSummary(e,n,t){return Renderer.background._summariseProfs(e,n,t)},getLanguageSummary(e,n,t){return Renderer.background._summariseProfs(e,n,t)},_summariseProfs(e,n,t,i){function r(e){return n?e.toTitleCase():i?`{@${i} ${e.toTitleCase()}}`:e.toTitleCase()}function d(e,n){return e===n?0:"choose"===e?1:"choose"===n?-1:SortUtil.ascSort(e,n)}return e?e.map(e=>{let s=", ";const a=Object.keys(e).sort(d).filter(n=>e[n]).map((d,a)=>{if("choose"===d){s="; ";const i=e[d],o=i.from.map(e=>(t&&!t.includes(e)&&t.push(e),r(e)));return`${n?`${0===a?"C":"c"}hoose `:""}${i.count||1} ${n?`of`:`from`} ${o.joinConjunct(", "," or ")}`}return t&&!t.includes(d)&&t.push(d),r(d)});return a.join(s)}).join(" <i>or</i> "):""}},Renderer.optionalfeature={getListPrerequisiteLevelText(e){return e&&e.some(e=>e.level)?e.find(e=>e.level).level.level:"\u2014"},getPreviouslyPrintedText(e){return e.data&&e.data.previousVersion?`<tr><td colspan="6"><p>${Renderer.get().render(`{@i An earlier version of this ${Parser.optFeatureTypeToFull(e.featureType)} is available in }${Parser.sourceJsonToFull(e.data.previousVersion.source)} {@i as {@optfeature ${e.data.previousVersion.name}|${e.data.previousVersion.source}}.}`)}</p></td></tr>`:""},getCompactRenderedString(e){const n=Renderer.get(),t=[];return t.push(`
			${Renderer.utils.getExcludedTr(e,"optionalfeature")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_OPT_FEATURES})}
			<tr class="text"><td colspan="6">
			${e.prerequisite?`<p><i>${Renderer.utils.getPrerequisiteText(e.prerequisite)}</i></p>`:""}
		`),n.recursiveRender({entries:e.entries},t,{depth:1}),t.push(`</td></tr>`),t.push(Renderer.optionalfeature.getPreviouslyPrintedText(e)),t.join("")}},Renderer.reward={getRenderedString:e=>{const n=Renderer.get(),t=[];return n.recursiveRender({entries:e.entries},t,{depth:1}),`<tr class="text"><td colspan="6">${t.join("")}</td></tr>`},getCompactRenderedString(e){return`
			${Renderer.utils.getExcludedTr(e,"reward")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_REWARDS})}
			${Renderer.reward.getRenderedString(e)}
		`}},Renderer.race={getCompactRenderedString(e){const n=Renderer.get(),t=[],i=Renderer.getAbilityData(e.ability);return t.push(`
			${Renderer.utils.getExcludedTr(e,"race")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_RACES})}
			${e._isBaseRace?"":`
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-4 text-center">Ability Scores</th>
						<th class="col-4 text-center">Size</th>
						<th class="col-4 text-center">Speed</th>
					</tr>
					<tr>
						<td class="text-center">${i.asText}</td>
						<td class="text-center">${Parser.sizeAbvToFull(e.size)}</td>
						<td class="text-center">${Parser.getSpeedString(e)}</td>
					</tr>
				</table>
			</td></tr>`}
			<tr class="text"><td colspan="6">
		`),e._isBaseRace?n.recursiveRender({type:"entries",entries:e._baseRaceEntries},t,{depth:1}):n.recursiveRender({type:"entries",entries:e.entries},t,{depth:1}),t.push("</td></tr>"),t.join("")},mergeSubraces(e,n){n=n||{};const t=[];return e.forEach(e=>{if(e.subraces&&(e.subraces.forEach(n=>n.source=n.source||e.source),e.subraces.sort((e,n)=>SortUtil.ascSortLower(e.name||"_",n.name||"_")||SortUtil.ascSortLower(Parser.sourceJsonToAbv(e.source),Parser.sourceJsonToAbv(n.source)))),n.isAddBaseRaces&&e.subraces){const n=MiscUtil.copy(e);n._isBaseRace=!0;const i=e.subraces.some(e=>!e.name);i&&(n.name=`${n.name} (Base)`);const r={};e.subraces.filter(e=>e.name).forEach(e=>r[e.name.toLowerCase()]=(r[e.name.toLowerCase()]||0)+1),r._=e.subraces.filter(e=>!e.name).length;const d={type:"list",items:e.subraces.map(n=>{const t=r[(n.name||"_").toLowerCase()],i=`${e.name}${n.name?` (${n.name})`:""}`;return`{@race ${i}|${n.source}${1<t?`|${i} (<span title="${Parser.sourceJsonToFull(n.source).escapeQuotes()}">${Parser.sourceJsonToAbv(n.source)}</span>)`:""}}`})};n._baseRaceEntries=["This race has multiple subraces, as listed below:",d],delete n.subraces,t.push(n)}t.push(...Renderer.race._mergeSubrace(e))}),t},_mergeSubrace(e){if(e.subraces){const n=JSON.parse(JSON.stringify(e.subraces)),t=[];return n.forEach(n=>{const r=JSON.parse(JSON.stringify(e));if(r._baseName=r.name,r._baseSource=r.source,delete r.subraces,delete r.srd,n.name&&(r.name=`${r.name} (${n.name})`,delete n.name),n.ability){if((n.overwrite&&n.overwrite.ability||!r.ability)&&(r.ability=n.ability.map(()=>({}))),r.ability.length!==n.ability.length)throw new Error(`Race and subrace ability array lengths did not match!`);n.ability.forEach((e,n)=>Object.assign(r.ability[n],e)),delete n.ability}if(n.entries&&(n.entries.forEach(n=>{if(n.data&&n.data.overwrite){const e=r.entries.findIndex(e=>e.name.toLowerCase().trim()===n.data.overwrite.toLowerCase().trim());~e?r.entries[e]=n:r.entries.push(n)}else r.entries.push(n)}),delete n.entries),n.traitTags&&(r.traitTags=n.overwrite&&n.overwrite.traitTags?n.traitTags:(r.traitTags||[]).concat(n.traitTags),delete n.traitTags),n.languageProficiencies&&(r.languageProficiencies=n.overwrite&&n.overwrite.languageProficiencies?n.languageProficiencies:r.languageProficiencies=(r.languageProficiencies||[]).concat(n.languageProficiencies),delete n.languageProficiencies),n.skillProficiencies){if(!r.skillProficiencies||n.overwrite&&n.overwrite.skillProficiencies)r.skillProficiencies=n.skillProficiencies;else{if(!n.skillProficiencies.length||!r.skillProficiencies.length)throw new Error(`No items!`);if(1<n.skillProficiencies.length||1<r.skillProficiencies.length)throw new Error(`Subrace merging does not handle choices!`);if(n.skillProficiencies.choose){if(r.skillProficiencies.choose)throw new Error(`Subrace choose merging is not supported!!`);r.skillProficiencies.choose=n.skillProficiencies.choose,delete n.skillProficiencies.choose}Object.assign(r.skillProficiencies[0],n.skillProficiencies[0])}delete n.skillProficiencies}Object.assign(r,n),t.push(r)}),t}return[e]},adoptSubraces(e,n){const t=[];return n.forEach(n=>{if(!n.race||!n.race.name||!n.race.source)throw new Error(`Subrace was missing parent race!`);const i=e.find(e=>e.name===n.race.name&&e.source===n.race.source);if(!i)throw new Error(`Could not find parent race for subrace!`);const r=i._baseRaceEntries.find(e=>"list"===e.type);r.items.push(`{@race ${i.name} (${n.name})|${n.source||i.source}}`);let d=t.find(e=>e.name===n.race.name&&e.source===n.race.source);d||(d=MiscUtil.copy(i),delete d._isBaseRace,delete d._baseRaceEntries,t.push(d)),d.subraces=d.subraces||[],d.subraces.push(n)}),t}},Renderer.deity={_basePartTranslators:{Alignment:{prop:"alignment",displayFn:e=>e.map(e=>Parser.alignmentAbvToFull(e)).join(" ")},Pantheon:{prop:"pantheon"},Category:{prop:"category"},Domains:{prop:"domains",displayFn:e=>e.join(", ")},Province:{prop:"province"},"Alternate Names":{prop:"altNames",displayFn:e=>e.join(", ")},Symbol:{prop:"symbol"}},getOrderedParts(e,n,t){const i={};Object.entries(Renderer.deity._basePartTranslators).forEach(([n,t])=>{const r=e[t.prop];if(null!=r){const e=t.displayFn?t.displayFn(r):r;i[n]=e}}),e.customProperties&&Object.entries(e.customProperties).forEach(([e,n])=>i[e]=n);const r=Object.keys(i).sort(SortUtil.ascSortLower);return r.map(e=>`${n}<b>${e}: </b>${Renderer.get().render(i[e])}${t}`).join("")},getCompactRenderedString(e){const n=Renderer.get();return`
			${Renderer.utils.getExcludedTr(e,"deity")}
			${Renderer.utils.getNameTr(e,{suffix:e.title?`, ${e.title.toTitleCase()}`:"",page:UrlUtil.PG_DEITIES})}
			<tr><td colspan="6">
				<div class="rd__compact-stat">${Renderer.deity.getOrderedParts(e,`<p>`,`</p>`)}</div>
			</td>
			${e.entries?`<tr><td colspan="6"><div class="border"></div></td></tr><tr><td colspan="6">${n.render({entries:e.entries},1)}</td></tr>`:""}
		`}},Renderer.object={getCompactRenderedString(e){const n=Renderer.get(),t=12/(!!e.resist+!!e.vulnerable||1);return`
			${Renderer.utils.getExcludedTr(e,"object")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_OBJECTS})}
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th colspan="2" class="text-center">Type</th>
						<th colspan="2" class="text-center">AC</th>
						<th colspan="2" class="text-center">HP</th>
						<th colspan="2" class="text-center">Speed</th>
						<th colspan="4" class="text-center">Damage Imm.</th>
					</tr>
					<tr>
						<td colspan="2" class="text-center">${Parser.sizeAbvToFull(e.size)} object</td>
						<td colspan="2" class="text-center">${e.ac}</td>
						<td colspan="2" class="text-center">${e.hp}</td>
						<td colspan="2" class="text-center">${Parser.getSpeedString(e)}</td>
						<td colspan="4" class="text-center">${e.immune}</td>
					</tr>
					${Parser.ABIL_ABVS.some(n=>null!=e[n])?`
					<tr>${Parser.ABIL_ABVS.map(e=>`<td colspan="2" class="text-center">${e.toUpperCase()}</td>`).join("")}</tr>
					<tr>${Parser.ABIL_ABVS.map(n=>`<td colspan="2" class="text-center">${Renderer.utils.getAbilityRoller(e,n)}</td>`).join("")}</tr>
					`:""}
					${e.resist||e.vulnerable?`
					<tr>
						${e.resist?`<th colspan="${t}" class="text-center">Damage Res.</th>`:""}
						${e.vulnerable?`<th colspan="${t}" class="text-center">Damage Vuln.</th>`:""}
					</tr>
					<tr>
						${e.resist?`<td colspan="${t}" class="text-center">${e.resist}</td>`:""}
						${e.vulnerable?`<td colspan="${t}" class="text-center">${e.vulnerable}</td>`:""}
					</tr>
					`:""}
				</table>
			</td></tr>
			<tr class="text"><td colspan="6">
			${e.entries?n.render({entries:e.entries},2):""}
			${e.actionEntries?n.render({entries:e.actionEntries},2):""}
			</td></tr>
		`}},Renderer.traphazard={getSubtitle(e){const n=e.trapHazType||"HAZ";return"GEN"===n?null:"SMPL"===n||"CMPX"===n?`${Parser.trapHazTypeToFull(n)} (${Parser.tierToFullLevel(e.tier)}, ${Parser.threatToFull(e.threat)} threat)`:Parser.trapHazTypeToFull(n)},getSimplePart(e,n){return"SMPL"===n.trapHazType?e.render({entries:[{type:"entries",name:"Trigger",entries:n.trigger},{type:"entries",name:"Effect",entries:n.effect},{type:"entries",name:"Countermeasures",entries:n.countermeasures}]},1):""},getComplexPart(e,n){return"CMPX"===n.trapHazType?e.render({entries:[{type:"entries",name:"Trigger",entries:n.trigger},{type:"entries",name:"Initiative",entries:[`The trap acts on ${Parser.trapInitToFull(n.initiative)}${n.initiativeNote?` (${n.initiativeNote})`:""}.`]},n.eActive?{type:"entries",name:"Active Elements",entries:n.eActive}:null,n.eDynamic?{type:"entries",name:"Dynamic Elements",entries:n.eDynamic}:null,n.eConstant?{type:"entries",name:"Constant Elements",entries:n.eConstant}:null,{type:"entries",name:"Countermeasures",entries:n.countermeasures}].filter(e=>e)},1):""},getCompactRenderedString(e){const n=Renderer.get(),t=Renderer.traphazard.getSubtitle(e);return`
			${Renderer.utils.getExcludedTr(e,e.__prop||("t"===e._type?"trap":"hazard"))}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_TRAPS_HAZARDS})}
			${t?`<tr class="text"><td colspan="6"><i>${t}</i>${Renderer.traphazard.getSimplePart(n,e)}${Renderer.traphazard.getComplexPart(n,e)}</td>`:""}
			<tr class="text"><td colspan="6">${n.render({entries:e.entries},2)}</td></tr>
		`},_trapTypes:new Set(["MECH","MAG","SMPL","CMPX"]),isTrap(e){return Renderer.traphazard._trapTypes.has(e)}},Renderer.cultboon={doRenderCultParts(e,n,t){if(e.goal||e.cultists||e.signaturespells){const i={type:"list",style:"list-hang-notitle",items:[]};e.goal&&i.items.push({type:"item",name:"Goals:",entry:e.goal.entry}),e.cultists&&i.items.push({type:"item",name:"Typical Cultists:",entry:e.cultists.entry}),e.signaturespells&&i.items.push({type:"item",name:"Signature Spells:",entry:e.signaturespells.entry}),n.recursiveRender(i,t,{depth:2})}},doRenderBoonParts(e,n,t){const i={type:"list",style:"list-hang-notitle",items:[]};e.ability&&i.items.push({type:"item",name:"Ability Score Adjustment:",entry:e.ability?e.ability.entry:"None"}),e.signaturespells&&i.items.push({type:"item",name:"Signature Spells:",entry:e.signaturespells?e.signaturespells.entry:"None"}),i.items.length&&n.recursiveRender(i,t,{depth:1})},getCompactRenderedString(e){const n=Renderer.get(),t=[];return"c"===e._type?(Renderer.cultboon.doRenderCultParts(e,n,t),n.recursiveRender({entries:e.entries},t,{depth:2}),`
			${Renderer.utils.getExcludedTr(e,"cult")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_CULTS_BOONS})}
			<tr id="text"><td class="divider" colspan="6"><div></div></td></tr>
			<tr class='text'><td colspan='6' class='text'>${t.join("")}</td></tr>`):"b"===e._type?(Renderer.cultboon.doRenderBoonParts(e,n,t),n.recursiveRender({entries:e.entries},t,{depth:1}),e._displayName=e._displayName||`${e.type||"Demonic Boon"}: ${e.name}`,`
			${Renderer.utils.getExcludedTr(e,"boon")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_CULTS_BOONS})}
			<tr class='text'><td colspan='6'>${t.join("")}</td></tr>`):void 0}},Renderer.monster={getLegendaryActionIntro:(e,n=Renderer.get())=>{function t(){if(e.shortName)return e.shortName;const n=e.name.split(",")[0],t=n.replace(/(?:adult|ancient|young) \w+ (dragon|dracolich)/gi,"$1");return e.isNamedCreature?t.split(" ")[0]:t.toLowerCase()}if(e.legendaryHeader)return e.legendaryHeader.map(e=>n.render(e)).join("");else{const n=e.legendaryActions||3,i=t();return`${e.isNamedCreature?"":"The "}${i} can take ${n} legendary action${1<n?"s":""}, choosing from the options below. Only one legendary action can be used at a time and only at the end of another creature's turn. ${e.isNamedCreature?"":"The "}${i} regains spent legendary actions at the start of its turn.`}},getSave(e,n,t){return"special"===n?e.render(t):e.render(`<span data-mon-save="${n.uppercaseFirst()}|${t}">${n.uppercaseFirst()} {@d20 ${t}|${t}|${Parser.attAbvToFull([n])} save}</span>`)},getDragonCasterVariant(e,n){if(!n.dragonCastingColor||n.spellcasting)return null;const t=Parser.getAbilityModNumber(n.cha),i=Parser.crToPb(n.cr),r=Math.floor(Parser.crToNumber(n.cr)/3),d=function(e,n){return({2:{B:["darkness","Melf's acid arrow","fog cloud","scorching ray"],G:["ray of sickness","charm person","detect thoughts","invisibility","suggestion"],W:["ice knife|XGE","Snilloc's snowball swarm|XGE"],A:["see invisibility","magic mouth","blindness/deafness","sleep","detect thoughts"],Z:["gust of wind","misty step","locate object","blur","witch bolt","thunderwave","shield"],C:["knock","sleep","detect thoughts","blindness/deafness","tasha's hideous laughter"]},3:{U:["wall of sand|XGE","thunder step|XGE","lightning bolt","blink","magic missile","slow"],R:["fireball","scorching ray","haste","erupting earth|XGE","Aganazzar's scorcher|XGE"],O:["slow","slow","fireball","dispel magic","counterspell","Aganazzar's scorcher|XGE","shield"],S:["sleet storm","protection from energy","catnap|XGE","locate object","identify","Leomund's tiny hut"]},4:{B:["vitriolic sphere|XGE","sickening radiance|XGE","Evard's black tentacles","blight","hunger of Hadar"],W:["fire shield","ice storm","sleet storm"],A:["charm monster|XGE","sending","wall of sand|XGE","hypnotic pattern","tongues"],C:["polymorph","greater invisibility","confusion","stinking cloud","major image","charm monster|XGE"]},5:{U:["telekinesis","hold monster","dimension door","wall of stone","wall of force"],G:["cloudkill","charm monster|XGE","modify memory","mislead","hallucinatory terrain","dimension door"],Z:["steel wind strike|XGE","control weather","control winds|XGE","watery sphere|XGE","storm sphere|XGE","tidal wave|XGE"],O:["hold monster","immolation|XGE","wall of fire","greater invisibility","dimension door"],S:["cone of cold","ice storm","teleportation circle","skill empowerment|XGE","creation","Mordenkainen's private sanctum"]},6:{W:["cone of cold","wall of ice"],A:["scrying","Rary's telepathic bond","Otto's irresistible dance","legend lore","hold monster","dream"]},7:{B:["power word pain|XGE","finger of death","disintegrate","hold monster"],U:["chain lightning","forcecage","teleport","etherealness"],G:["project image","mirage arcane","prismatic spray","teleport"],Z:["whirlwind|XGE","chain lightning","scatter|XGE","teleport","disintegrate","lightning bolt"],C:["symbol","simulacrum","reverse gravity","project image","Bigby's hand","mental prison|XGE","seeming"],S:["Otiluke's freezing sphere","prismatic spray","wall of ice","contingency","arcane gate"]},8:{O:["sunburst","delayed blast fireball","antimagic field","teleport","globe of invulnerability","maze"]}}[e]||{})[n]}(r,n.dragonCastingColor),s=0===r?`${1===t?"This":"These"} spells are Cantrips.`:`${1===t?"The":"Each"} spell's level can be no higher than ${Parser.spLevelToFull(r)}.`,a={type:"variant",name:"Dragons as Innate Spellcasters",entries:["Dragons are innately magical creatures that can master a few spells as they age, using this variant.",`A young or older dragon can innately cast a number of spells equal to its Charisma modifier. Each spell can be cast once per day, requiring no material components, and the spell's level can be no higher than one-third the dragon's challenge rating (rounded down). The dragon's bonus to hit with spell attacks is equal to its proficiency bonus + its Charisma bonus. The dragon's spell save DC equals 8 + its proficiency bonus + its Charisma modifier.`,`{@i This dragon can innately cast ${Parser.numberToText(t)} spell${1===t?"":"s"}, once per day${1===t?"":" each"}, requiring no material components. ${s} The dragon's spell save DC is ${i+t+8}, and it has {@hit ${i+t}} to hit with spell attacks. See the {@filter spell page|spells|level=${[...Array(r+1)].map((e,n)=>n).join(";")}} for a list of spells the dragon is capable of casting.${d?` A selection of examples are shown below:`:""}`]};if(d){const e={type:"list",style:"italic",items:d.map(e=>`{@spell ${e}}`)};a.entries.push(e)}return e.render(a)},getCrScaleTarget(e,n,t,i){function r(){s.find(`.mon__cr_slider_wrp`).remove(),e.off(d)}const d="click.cr-scaler",s=$(`body`),a=$(`<div class="mon__cr_slider_wrp ${i?"mon__cr_slider_wrp--compact":""}"/>`),o=$(`<div class="mon__cr_slider"/>`).appendTo(a),l=Parser.CRS.indexOf(n);if(-1===l)throw new Error(`Initial CR ${n} was not valid!`);r(),e.off("click.cr-scaler").on("click.cr-scaler",e=>e.stopPropagation()),a.on("click.cr-scaler",e=>e.stopPropagation()),s.off("click.cr-scaler").on("click.cr-scaler",r);const c={labels:Parser.CRS};o.slider({min:0,max:Parser.CRS.length-1,value:l}).slider("pips",c).slider("float",c),o.slider().on("slidechange",()=>{const e=o.slider("value");t(Parser.crToNumber(Parser.CRS[e])),s.off(d),r()}),e.after(a)},getCompactRenderedStringSection(e,n,t,i,r){const d=`${i}Note`;return e[i]?`
		<tr class="mon__stat-header-underline"><td colspan="6"><span class="mon__sect-header-inner">${t}${e[d]?` (<span class="small">${e[d]}</span>)`:""}</span></td></tr>
		<tr class="text compact"><td colspan="6">
		${"legendary"===i&&e.legendary?`<p>${Renderer.monster.getLegendaryActionIntro(e)}</p>`:""}
		${e[i].map(e=>e.rendered||n.render(e,r)).join("")}
		</td></tr>
		`:""},getTypeAlignmentPart(e){return`${e.level?`${Parser.getOrdinalForm(e.level)}-level `:""}${Parser.sizeAbvToFull(e.size)}${e.sizeNote?` ${e.sizeNote}`:""} ${Parser.monTypeToFullObj(e.type).asText}${e.alignment?`, ${Parser.alignmentListToFull(e.alignment).toLowerCase()}`:""}`},getSavesPart(e){return`${Object.keys(e.save).sort(SortUtil.ascSortAtts).map(n=>Renderer.monster.getSave(Renderer.get(),n,e.save[n])).join(", ")}`},getSensesPart(e){return`${e.senses?`${Renderer.monster.getRenderedSenses(e.senses)}, `:""}passive Perception ${e.passive||"\u2014"}`},getCompactRenderedString(e,n,t={}){n=n||Renderer.get();const i=[],r=100===Parser.crToNumber(e.cr);return i.push(`
			${Renderer.utils.getExcludedTr(e,"monster")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_BESTIARY})}
			<tr><td colspan="6"><i>${Renderer.monster.getTypeAlignmentPart(e)}</i></td></tr>
			<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr><td colspan="6">
				<table class="summary-noback" style="position: relative;">
					<tr>
						<th>Armor Class</th>
						<th>Hit Points</th>
						<th>Speed</th>
						${r?"":"<th>Challenge Rating</th>"}
					</tr>
					<tr>
						<td>${Parser.acToFull(e.ac)}</td>
						<td>${Renderer.monster.getRenderedHp(e.hp)}</td>
						<td>${Parser.getSpeedString(e)}</td>
						${r?"":`
						<td>
							${Parser.monCrToFull(e.cr)}
							${t.showScaler&&Parser.isValidCr(e.cr?e.cr.cr||e.cr:null)?`
							<button title="Scale Creature By CR (Highly Experimental)" class="mon__btn-scale-cr btn btn-xs btn-default">
								<span class="glyphicon glyphicon-signal"></span>
							</button>
							`:""}
							${t.isScaled?`
							<button title="Reset CR Scaling" class="mon__btn-reset-cr btn btn-xs btn-default">
								<span class="glyphicon glyphicon-refresh"></span>
							</button>
							`:""}
						</td>
						`}
					</tr>
				</table>
			</td></tr>
			<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-2 text-center">STR</th>
						<th class="col-2 text-center">DEX</th>
						<th class="col-2 text-center">CON</th>
						<th class="col-2 text-center">INT</th>
						<th class="col-2 text-center">WIS</th>
						<th class="col-2 text-center">CHA</th>
					</tr>
					<tr>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"str")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"dex")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"con")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"int")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"wis")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"cha")}</td>
					</tr>
				</table>
			</td></tr>
			<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr><td colspan="6">
				<div class="rd__compact-stat">
					${e.save?`<p><b>Saving Throws</b> ${Renderer.monster.getSavesPart(e)}</p>`:""}
					${e.skill?`<p><b>Skills</b> ${Renderer.monster.getSkillsString(n,e)}</p>`:""}
					${e.vulnerable?`<p><b>Damage Vuln.</b> ${Parser.monImmResToFull(e.vulnerable)}</p>`:""}
					${e.resist?`<p><b>Damage Res.</b> ${Parser.monImmResToFull(e.resist)}</p>`:""}
					${e.immune?`<p><b>Damage Imm.</b> ${Parser.monImmResToFull(e.immune)}</p>`:""}
					${e.conditionImmune?`<p><b>Condition Imm.</b> ${Parser.monCondImmToFull(e.conditionImmune)}</p>`:""}
					<p><b>Senses</b> ${Renderer.monster.getSensesPart(e)}</p>
					<p><b>Languages</b> ${Renderer.monster.getRenderedLanguages(e.languages)}</p>
				</div>
			</td></tr>
			${e.trait||e.spellcasting?`<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr class="text compact"><td colspan="6">
			${Renderer.monster.getOrderedTraits(e,n).map(e=>e.rendered||n.render(e,2)).join("")}
			</td></tr>`:""}
			${Renderer.monster.getCompactRenderedStringSection(e,n,"Actions","action",2)}
			${Renderer.monster.getCompactRenderedStringSection(e,n,"Reactions","reaction",2)}
			${Renderer.monster.getCompactRenderedStringSection(e,n,"Legendary Actions","legendary",2)}
			${e.variant||e.dragonCastingColor&&!e.spellcasting?`
			<tr class="text compact"><td colspan="6">
			${e.variant?e.variant.map(e=>e.rendered||n.render(e)).join(""):""}
			${e.dragonCastingColor?Renderer.monster.getDragonCasterVariant(n,e):""}
			${e.footer?n.render({entries:e.footer}):""}
			</td></tr>
			`:""}
		`),i.join("")},getRenderedHp:(e,n)=>{function t(){const n=/^(\d+)d(\d+)([-+]\d+)?$/i.exec(e.formula);if(n){const e=+n[1],t=+n[2],i=n[3]?+n[3]:0;return`Maximum: ${e*t+i}`}return""}if(null!=e.special)return e.special;if(/^\d+d1$/.exec(e.formula))return e.average;else{const i=t(e.formula);return n?`${i}${e.average}${e.formula}`:`${i?`<span title="${i}" class="help--subtle">`:""}${e.average}${i?"</span>":""} ${Renderer.get().render(`({@dice ${e.formula}|${e.formula}|Hit Points})`)}`}},getSpellcastingRenderedTraits:(e,n)=>{const t=[];return e.spellcasting.forEach(e=>{e.type=e.type||"spellcasting";const i=[];n.recursiveRender(e,i,{depth:2}),t.push({name:e.name,rendered:i.join("")})}),t},getOrderedTraits:(e,n)=>{let t=e.trait?MiscUtil.copy(e.trait):null;if(e.spellcasting){const i=Renderer.monster.getSpellcastingRenderedTraits(e,n);t=t?t.concat(i):i}return t?t.sort((e,n)=>SortUtil.monTraitSort(e.name,n.name)):void 0},getSkillsString(e,n){function t(e,n){return Renderer.get().render(`{@d20 ${n}|${n}|${e}`)}function i(n,i,r){const d=i.sort(SortUtil.ascSort).map(i=>`<span data-mon-skill="${i.toTitleCase()}|${n[i]}">${e.render(`{@skill ${i.toTitleCase()}}`)} ${t(i.toTitleCase(),n[i])}</span>`);return r?d.joinConjunct(", "," or "):d.join(", ")}const r=i(n.skill,Object.keys(n.skill).filter(e=>"other"!==e&&"special"!==e));if(n.skill.other||n.skill.special){const e=n.skill.other&&n.skill.other.map(e=>{if(e.oneOf)return`plus one of the following: ${i(e.oneOf,Object.keys(e.oneOf),!0)}`;throw new Error(`Unhandled monster "other" skill properties!`)}),t=n.skill.special&&Renderer.get().render(n.skill.special);return[r,e,t].filter(Boolean).join(", ")}return r},getTokenUrl(e){return e.tokenUrl||UrlUtil.link(`${Renderer.get().baseUrl}img/${Parser.sourceJsonToAbv(e.source)}/${Parser.nameToTokenName(e.name)}.png`)},getFluff(e,n,t){function i(t){if(o)return;o=!0;const i=n[e.legendaryGroup.source][e.legendaryGroup.name],r=(e,n)=>{i[e]&&t.entries.push({type:"section",entries:[{type:"entries",entries:[{type:"entries",name:n,entries:MiscUtil.copy(i[e])}]}]})};r("lairActions","Lair Actions"),r("regionalEffects","Regional Effects")}function r(d){const s=MiscUtil.copy(d.fluff);d.fluff=s;const a=s._appendCopy;if(s._copy){const a=MiscUtil.copy(t.monsterFluff.find(e=>s._copy.name===e.name&&s._copy.source===e.source)),o=s.name,l=s.source,c=s.images;delete s._copy,Object.assign(s,a),s.name=o,s.source=l,c&&(s.images=c),s.entries&&e.legendaryGroup&&(n[e.legendaryGroup.source]||{})[e.legendaryGroup.name]&&i(s),r(d)}if(a){const o=MiscUtil.copy(t.monsterFluff.find(e=>a.name===e.name&&a.source===e.source));o.images&&(s.images?s.images=s.images.concat(o.images):s.images=o.images),o.entries&&(s.entries?"section"===(o.entries[0]||{}).type?s.entries=s.entries.concat(o.entries):s.entries=s.entries.concat({type:"section",entries:o.entries}):s.entries=o.entries),delete s._appendCopy,s._copy=o._copy,s._appendCopy=o._appendCopy,s.entries&&e.legendaryGroup&&(n[e.legendaryGroup.source]||{})[e.legendaryGroup.name]&&i(s),r(d)}}const d=Renderer.utils.getPredefinedFluff(e,"monsterFluff"),s=d||(t||{monsterFluff:[]}).monsterFluff.find(n=>n.name===e.name&&n.source===e.source);if(!s)return null;const a=MiscUtil.copy(s);let o=!1;a.entries&&e.legendaryGroup&&(n[e.legendaryGroup.source]||{})[e.legendaryGroup.name]&&i(a);const l={fluff:a};return(l.fluff._copy||l.fluff._appendCopy)&&r(l),l.fluff},getRenderedSenses(e,n){if("string"==typeof e&&(e=[e]),n)return e.join(", ");const t=e.join(", ").replace(/(^| |\()(tremorsense|blindsight|truesight|darkvision)(\)| |$)/gi,(...e)=>`${e[1]}{@sense ${e[2]}}${e[3]}`).replace(/(^| |\()(blind|blinded)(\)| |$)/gi,(...e)=>`${e[1]}{@condition blinded||${e[2]}}${e[3]}`);return Renderer.get().render(t)},getRenderedLanguages(e){return"string"==typeof e&&(e=[e]),e?e.join(", "):"\u2014"},initParsed(e){e._pTypes=e._pTypes||Parser.monTypeToFullObj(e.type),e._pCr=e._pCr||(null==e.cr?null:e.cr.cr||e.cr)},updateParsed(e){delete e._pTypes,delete e._pCr,Renderer.monster.initParsed(e)},async pPopulateMetaAndLanguages(e,n){const t=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/bestiary/meta.json`);e&&t.legendaryGroup.forEach(n=>{e[n.source]=e[n.source]||{},e[n.source][n.name]=n}),n&&Object.keys(t.language).forEach(e=>n[e]=t.language[e])}},Renderer.item={LINK_SPECIFIC_TO_GENERIC_DIRECTION:1,_sortProperties(e,n){return SortUtil.ascSort(Renderer.item.propertyMap[e].name,Renderer.item.propertyMap[n].name)},_getPropertiesText(e){if(e.property){let n=!1;const t=e.property.sort(Renderer.item._sortProperties).map(t=>{const i=Renderer.item.propertyMap[t];if(i.template){const t=i.template.replace(/{{([^}]+)}}/g,(...t)=>{if("item.dmg1"===t[1])return Renderer.item._renderDamage(e.dmg1);if("item.dmg2"===t[1])return n=!0,Renderer.item._renderDamage(e.dmg2);const r=t[1].split(".");switch(r[0]){case"prop_name":return i.name;case"item":{const n=r.slice(1);return n.length?MiscUtil.get(e,...n)||"":`{@i missing key path}`}default:return`{@i unknown template root: "${r[0]}"}`;}});return Renderer.get().render(t)}return i.name});return!n&&e.dmg2&&t.unshift(`alt. ${Renderer.item._renderDamage(e.dmg2)}`),`${e.dmg1&&t.length?" - ":""}${t.join(", ")}`}else{const n=[];return e.dmg2&&n.push(`alt. ${Renderer.item._renderDamage(e.dmg2)}`),e.range&&n.push(`range ${e.range} ft.`),`${e.dmg1&&n.length?" - ":""}${n.join(", ")}`}},_renderDamage(e){if(!e)return"";const n=e.replace(RollerUtil.DICE_REGEX,(...e)=>`{@damage ${e[1]}}`);return Renderer.get().render(n)},getDamageAndPropertiesText:function(e){const n=[];if(e.dmg1&&n.push(Renderer.item._renderDamage(e.dmg1)),null!=e.ac){const t="S"===e.type?"+":"",i="LA"===e.type?" + Dex":"MA"===e.type?" + Dex (max 2)":"";n.push(`AC ${t}${e.ac}${i}`)}if(null!=e.acSpecial&&n.push(null==e.ac?`AC ${e.acSpecial}`:e.acSpecial),null!=e.speed&&n.push(`Speed: ${e.speed}`),e.carryingCapacity&&n.push(`Carrying Capacity: ${e.carryingCapacity} lb.`),e.vehSpeed||e.capCargo||e.capPassenger||e.crew||e.vehAc||e.vehHp||e.vehDmgThresh){const t=e.vehSpeed?`Speed: ${Parser.numberToVulgar(e.vehSpeed)} mph`:null,i=e.capCargo||e.capPassenger?`Carrying Capacity: ${[e.capCargo?`${Parser.numberToFractional(e.capCargo)} ton${0===e.capCargo||1<e.capCargo?"s":""} cargo`:null,e.capPassenger?`${e.capPassenger} passenger${1===e.capPassenger?"":"s"}`:null].filter(Boolean).join(", ")}`:null,r=[e.crew?`Crew ${e.crew}`:null,e.vehAc?`AC ${e.vehAc}`:null,e.vehHp?`HP ${e.vehHp}${e.vehDmgThresh?`, Damage Threshold ${e.vehDmgThresh}`:""}`:null].filter(Boolean).join(", ");n.push([t,i,r].filter(Boolean).join("<br>"))}const t=n.join(", "),i=e.dmgType?Parser.dmgTypeToFull(e.dmgType):"",r=Renderer.item._getPropertiesText(e);return[t,i,r]},getTypeRarityAndAttunementText(e){const n=["Other"===e._typeHtml?"":e._typeHtml,[e.tier,e.rarity&&Renderer.item.doRenderRarity(e.rarity)?e.rarity:""].map(e=>(e||"").trim()).filter(e=>e).join(", ")].filter(Boolean).join(", ");return e.reqAttune?`${n} ${e._attunement}`:n},getAttunementAndAttunementCatText(e){let n=null,t="No";return null!=e.reqAttune&&(!0===e.reqAttune?(t="Yes",n="(Requires Attunement)"):"OPTIONAL"===e.reqAttune?(t="Optional",n="(Attunement Optional)"):e.reqAttune.toLowerCase().startsWith("by")?(t="By...",n=`(Requires Attunement ${e.reqAttune})`):(t="Yes",n=`(Requires Attunement ${e.reqAttune})`)),[n,t]},getHtmlAndTextTypes(e){const n=[],t=[];let i=!1;if(e.wondrous&&(n.push("Wondrous Item"),t.push("Wondrous Item")),e.staff&&(n.push("Staff"),t.push("Staff")),e.firearm&&(n.push("Firearm"),t.push("Firearm")),e.age&&(n.push(e.age),t.push(e.age)),e.weaponCategory&&(n.push(`${e.weaponCategory} Weapon${e.baseItem?` (${Renderer.get().render(`{@item ${e.baseItem}`)})`:""}`),t.push(`${e.weaponCategory} Weapon`),i=!0),e.staff&&"M"!==e.type&&(n.push("Melee Weapon"),t.push("Melee Weapon")),e.type){const r=Parser.itemTypeToFull(e.type);i||!e.baseItem?n.push(r):n.push(`${r} (${Renderer.get().render(`{@item ${e.baseItem}`)})`),t.push(r)}return e.poison&&(n.push("Poison"),t.push("Poison")),[t,n.join(", ")]},getRenderedEntries(e,n){const t=Renderer.get(),i={string:(n,t)=>{const r=[];let d=0;const s=e.name.length,a=e.name.toLowerCase(),o=e.name.length+1,l=t.length;for(let e=0;e<l;++e){const n=t[e];switch(n){case"{":{"@"===t[e+1]&&d++,r.push(n);break}case"}":{d&&d--,r.push(n);break}default:r.push(n);}d||(r.slice(-s).join("").toLowerCase()===a?r.splice(r.length-s,s,`{@i ${r.slice(-s).join("")}}`):r.slice(-o).join("").toLowerCase()===`${a}s`&&r.splice(r.length-o,o,`{@i ${r.slice(-o).join("")}}`))}return r.join("")}},r=new Set(["caption","type","colLabels","dataCreature","dataSpell","name"]),d=[];if(e._fullEntries||e.entries&&e.entries.length){const n=MiscUtil.copy({type:"entries",entries:e._fullEntries||e.entries}),s=MiscUtil.getWalker(r).walk("italiciseName",n,i);t.recursiveRender(s,d,{depth:1})}if(e._fullAdditionalEntries||e.additionalEntries){const n=MiscUtil.copy({type:"entries",entries:e._fullAdditionalEntries||e.additionalEntries}),s=MiscUtil.getWalker(r).walk("italiciseName",n,i);t.recursiveRender(s,d,{depth:1})}return!n&&e.lootTables&&d.push(`<div><span class="bold">Found On: </span>${e.lootTables.sort(SortUtil.ascSortLower).map(e=>t.render(`{@table ${e}}`)).join(", ")}</div>`),d.join("").trim()},getCompactRenderedString(e){const[n,t,i]=Renderer.item.getDamageAndPropertiesText(e),r=e._fullEntries&&e._fullEntries.length||e.entries&&e.entries.length;return`
		${Renderer.utils.getExcludedTr(e,"item")}
		${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_ITEMS})}
		<tr><td class="rd-item__type-rarity-attunement" colspan="6">${Renderer.item.getTypeRarityAndAttunementText(e)}</td></tr>
		<tr>
			<td colspan="2">${[Parser.itemValueToFull(e),Parser.itemWeightToFull(e)].filter(Boolean).join(", ").uppercaseFirst()}</td>
			<td class="text-right" colspan="4">${n} ${t} ${i}</td>
		</tr>
		${r?`${Renderer.utils.getDividerTr()}<tr class="text"><td colspan="6" class="text">${Renderer.item.getRenderedEntries(e,!0)}</td></tr>`:""}`},_hiddenRarity:new Set(["None","Unknown","Unknown (Magic)","Varies"]),doRenderRarity(e){return!Renderer.item._hiddenRarity.has(e)},_builtLists:{},propertyMap:{},typeMap:{},_additionalEntriesMap:{},_addProperty(e){Renderer.item.propertyMap[e.abbreviation]||(Renderer.item.propertyMap[e.abbreviation]=e.name?MiscUtil.copy(e):{name:e.entries[0].name.toLowerCase(),entries:e.entries,template:e.template})},_addType(e){Renderer.item.typeMap[e.abbreviation]||(Renderer.item.typeMap[e.abbreviation]=e.name?MiscUtil.copy(e):{name:e.entries[0].name.toLowerCase(),entries:e.entries})},_addAdditionalEntries(n){Renderer.item._additionalEntriesMap[n.appliesTo]||(Renderer.item._additionalEntriesMap[n.appliesTo]=MiscUtil.copy(n.entries))},_pAddBrewPropertiesAndTypes(){return new Promise(e=>{BrewUtil.pAddBrewData().then(n=>{(n.itemProperty||[]).forEach(e=>Renderer.item._addProperty(e)),(n.itemType||[]).forEach(e=>Renderer.item._addType(e)),e()})})},_addBasePropertiesAndTypes(e){e.itemProperty.forEach(e=>Renderer.item._addProperty(e)),e.itemType.forEach(e=>{if("SHP"===e.abbreviation){const n=MiscUtil.copy(e);n.abbreviation="AIR",Renderer.item._addType(n)}Renderer.item._addType(e)}),e.itemTypeAdditionalEntries.forEach(n=>Renderer.item._addAdditionalEntries(n))},_lockBuildList:null,async _pLockBuildList(){for(;Renderer.item._lockBuildList;)await Renderer.item._lockBuildList.lock;let e=null;const n=new Promise(n=>e=n);Renderer.item._lockBuildList={lock:n,unlock:e}},_unlockBuildList(){const e=Renderer.item._lockBuildList;Renderer.item._lockBuildList&&(delete Renderer.item._lockBuildList,e.unlock())},async pBuildList(e){await Renderer.item._pLockBuildList(),e=e||{},e.isAddGroups=!!e.isAddGroups,e.urls=e.urls||{};const n=e.isBlacklistVariants?"withBlacklist":"withoutBlacklist";if(Renderer.item._builtLists[n]){const t=e.isAddGroups?Renderer.item._builtLists[n]:Renderer.item._builtLists[n].filter(e=>!e._isItemGroup);return Renderer.item._unlockBuildList(),e.fnCallback?e.fnCallback(t):t}const t=e.urls.items||`${Renderer.get().baseUrl}data/items.json`,i=e.urls.baseitems||`${Renderer.get().baseUrl}data/items-base.json`,r=e.urls.magicvariants||`${Renderer.get().baseUrl}data/magicvariants.json`,d=await async function(){const e=await DataUtil.loadJSON(t),n=e.item;return e.itemGroup.forEach(e=>e._isItemGroup=!0),[...n,...e.itemGroup]}(),s=await Renderer.item._pGetAndProcBaseItems((await DataUtil.loadJSON(i))),[a,o]=await Renderer.item._pGetAndProcGenericVariants((await DataUtil.loadJSON(r)),!0),l=Renderer.item._createSpecificVariants(s,a,o),c=d.concat(s).concat(l);return Renderer.item._enhanceItems(c),Renderer.item._builtLists[n]=c,Renderer.item._unlockBuildList(),e.fnCallback?e.fnCallback(c):c},async _pGetAndProcBaseItems(e){return Renderer.item._addBasePropertiesAndTypes(e),await Renderer.item._pAddBrewPropertiesAndTypes(),e.baseitem},async _pGetAndProcGenericVariants(e,n){return e.variant.forEach(Renderer.item._genericVariants_addInheritedPropertiesToSelf),n?[e.variant.filter(e=>!ExcludeUtil.isExcluded(e.name,"variant",e.source)),e.linkedLootTables]:[e.variant,e.linkedLootTables]},_initFullEntries(e){e._fullEntries=e._fullEntries||(e.entries?MiscUtil.copy(e.entries):[])},_initFullAdditionalEntries(e){e._fullAdditionalEntries=e._fullAdditionalEntries||(e.additionalEntries?MiscUtil.copy(e.additionalEntries):[])},_createSpecificVariants(e,n,t){function i(e,n){return n.requires.some(n=>Object.entries(n).every(([n,t])=>e[n]===t))}function r(e,n){const t=n.excludes||{};return!!Object.keys(t).find(n=>t[n]instanceof Array?e[n]instanceof Array?e[n].find(e=>t[n].includes(e)):t[n].includes(e[n]):e[n]instanceof Array?e[n].find(e=>t[n]===e):t[n]===e[n])}function d(e,n){const i=n.inherits,r=MiscUtil.copy(e);return r._isEnhanced=!1,delete r._fullEntries,e.source!==SRC_PHB&&e.source!==SRC_DMG&&(Renderer.item._initFullEntries(r),r._fullEntries.unshift(`{@note The base item can be found in ${Parser.sourceJsonToFull(e.source)}.}`)),delete r.value,delete r.srd,r._category="Specific Variant",Object.keys(i).forEach(n=>{switch(n){case"namePrefix":r.name=`${i.namePrefix}${r.name}`;break;case"nameSuffix":r.name=`${r.name}${i.nameSuffix}`;break;case"entries":{Renderer.item._initFullEntries(r);const n=Renderer.applyAllProperties(i.entries,Renderer.item._getInjectableProps(e,i));n.forEach((e,n)=>r._fullEntries.splice(n,0,e));break}default:r[n]=i[n];}}),~Renderer.item.LINK_SPECIFIC_TO_GENERIC_DIRECTION&&(n.variants=n.variants||[],n.variants.push({base:e,specificVariant:r})),~Renderer.item.LINK_SPECIFIC_TO_GENERIC_DIRECTION||(r.genericVariant=n),t&&t[r.source]&&t[r.source][r.name]&&(r.lootTables=r.lootTables||[]).push(...t[r.source][r.name]),r}const s=[...n];return e.forEach(e=>{e._category="Basic",null==e.entries&&(e.entries=[]),e.quantity||n.forEach(n=>{!i(e,n)||r(e,n)||s.push(d(e,n))})}),s},_enhanceItems(e){return e.forEach(e=>Renderer.item.enhanceItem(e)),e},async pGetGenericAndSpecificVariants(e,n){n=n||{},n.baseItemsUrl=n.baseItemsUrl||`${Renderer.get().baseUrl}data/items-base.json`;const t=await DataUtil.loadJSON(n.baseItemsUrl),i=t.baseitem.concat(n.additionalBaseItems||[]);Renderer.item._addBasePropertiesAndTypes(t),await Renderer.item._pAddBrewPropertiesAndTypes(),e.forEach(Renderer.item._genericVariants_addInheritedPropertiesToSelf);const r=Renderer.item._createSpecificVariants(i,e);return Renderer.item._enhanceItems(r)},_getInjectableProps(e,n){return{baseName:e.name,dmgType:e.dmgType?Parser.dmgTypeToFull(e.dmgType):null,genericBonus:n.genericBonus}},_INHERITED_PROPS_BLACKLIST:new Set(["entries","genericBonus","namePrefix","nameSuffix"]),_genericVariants_addInheritedPropertiesToSelf(e){for(const n in e.inherits){if(Renderer.item._INHERITED_PROPS_BLACKLIST.has(n))continue;const t=e.inherits[n];null==t?delete e[n]:e[n]?e[n]instanceof Array&&t instanceof Array?e[n]=MiscUtil.copy(e[n]).concat(t):e[n]=t:e[n]=e.inherits[n]}!e.entries&&e.inherits.entries&&(e.entries=MiscUtil.copy(Renderer.applyAllProperties(e.inherits.entries,e.inherits))),e.requires.armor&&(e.armor=e.requires.armor)},enhanceItem(n){if(!n._isEnhanced&&(n._isEnhanced=!0,!n.noDisplay)){if("GV"===n.type&&(n._category="Generic Variant"),null==n._category&&(n._category="Other"),null==n.entries&&(n.entries=[]),n.type&&Renderer.item.typeMap[n.type]&&(Renderer.item._initFullEntries(n),Renderer.item.typeMap[n.type].entries.forEach(t=>n._fullEntries.push(t))),n.property&&n.property.forEach(e=>{if(!Renderer.item.propertyMap[e])throw new Error(`Item property ${e} not found. You probably meant to load the property/type reference first; see \`Renderer.item.populatePropertyAndTypeReference()\`.`);Renderer.item.propertyMap[e].entries&&(Renderer.item._initFullEntries(n),Renderer.item.propertyMap[e].entries.forEach(t=>n._fullEntries.push(t)))}),"LA"===n.type||"MA"===n.type||"HA"===n.type?(n.resist&&(Renderer.item._initFullEntries(n),n._fullEntries.push(`You have resistance to ${n.resist} damage while you wear this armor.`)),n.stealth&&(Renderer.item._initFullEntries(n),n._fullEntries.push("The wearer has disadvantage on Stealth (Dexterity) checks.")),"HA"===n.type&&n.strength&&(Renderer.item._initFullEntries(n),n._fullEntries.push(`If the wearer has a Strength score lower than ${n.strength}, their speed is reduced by 10 feet.`))):n.resist&&("P"===n.type&&(Renderer.item._initFullEntries(n),n._fullEntries.push(`When you drink this potion, you gain resistance to ${n.resist} damage for 1 hour.`)),"RG"===n.type&&(Renderer.item._initFullEntries(n),n._fullEntries.push(`You have resistance to ${n.resist} damage while wearing this ring.`))),"SCF"===n.type&&(n._isItemGroup?("arcane"===n.scfType&&(Renderer.item._initFullEntries(n),n._fullEntries.push("An arcane focus is a special item\u2014an orb, a crystal, a rod, a specially constructed staff, a wand-like length of wood, or some similar item\u2014designed to channel the power of arcane spells. A sorcerer, warlock, or wizard can use such an item as a spellcasting focus.")),"druid"===n.scfType&&(Renderer.item._initFullEntries(n),n._fullEntries.push("A druidic focus might be a sprig of mistletoe or holly, a wand or scepter made of yew or another special wood, a staff drawn whole out of a living tree, or a totem object incorporating feathers, fur, bones, and teeth from sacred animals. A druid can use such an object as a spellcasting focus.")),"holy"===n.scfType&&(Renderer.item._initFullEntries(n),n._fullEntries.push("A holy symbol is a representation of a god or pantheon. It might be an amulet depicting a symbol representing a deity, the same symbol carefully engraved or inlaid as an emblem on a shield, or a tiny box holding a fragment of a sacred relic. A cleric or paladin can use a holy symbol as a spellcasting focus. To use the symbol in this way, the caster must hold it in hand, wear it visibly, or bear it on a shield."))):("arcane"===n.scfType&&(Renderer.item._initFullEntries(n),n._fullEntries.push("An arcane focus is a special item designed to channel the power of arcane spells. A sorcerer, warlock, or wizard can use such an item as a spellcasting focus.")),"druid"===n.scfType&&(Renderer.item._initFullEntries(n),n._fullEntries.push("A druid can use this object as a spellcasting focus.")),"holy"===n.scfType&&(Renderer.item._initFullEntries(n),n._fullEntries.push("A holy symbol is a representation of a god or pantheon."),n._fullEntries.push("A cleric or paladin can use a holy symbol as a spellcasting focus. To use the symbol in this way, the caster must hold it in hand, wear it visibly, or bear it on a shield.")))),("T"===n.type||"AT"===n.type||"INS"===n.type||"GS"===n.type)&&(Renderer.item._initFullAdditionalEntries(n),n._fullAdditionalEntries.push({type:"hr"},`{@note See the {@variantrule Tool Proficiencies|XGE} entry for more information.}`)),("INS"===n.type||"GS"===n.type)&&(n.additionalSources=n.additionalSources||[]),"INS"===n.type?!n.additionalSources.find(e=>"XGE"===e.source&&83===e.page)&&n.additionalSources.push({source:"XGE",page:83}):"GS"===n.type&&!n.additionalSources.find(e=>"XGE"===e.source&&81===e.page)&&n.additionalSources.push({source:"XGE",page:81}),n.type&&Renderer.item._additionalEntriesMap[n.type]){Renderer.item._initFullAdditionalEntries(n);const e=Renderer.item._additionalEntriesMap[n.type];n._fullAdditionalEntries.push({type:"entries",entries:e})}const[e,t]=Renderer.item.getHtmlAndTextTypes(n);n._typeListText=e,n._typeHtml=t;const[i,r]=Renderer.item.getAttunementAndAttunementCatText(n);n._attunement=i,n._attunementCategory=r,n._isItemGroup&&(Renderer.item._initFullEntries(n),n._fullEntries.push("Multiple variations of this item exist, as listed below:",{type:"list",items:n.items.map(e=>"string"==typeof e?`{@item ${e}}`:`{@item ${e.name}|${e.source}}`)})),function(e){function n(e){return`{@item ${e.name}|${e.source}}`}e.variants&&e.variants.length&&(Renderer.item._initFullEntries(e),e._fullEntries.push({type:"entries",name:"Base items",entries:["This item variant can be applied to the following base items:",{type:"list",items:e.variants.map(({base:e,specificVariant:t})=>`${n(e)} (${n(t)})`)}]}))}(n)}},async getItemsFromHomebrew(e){(e.itemProperty||[]).forEach(e=>Renderer.item._addProperty(e)),(e.itemType||[]).forEach(e=>Renderer.item._addType(e));let n=(e.baseitem||[]).concat(e.item||[]);if(Renderer.item._enhanceItems(n),e.variant&&e.variant.length){const t=await Renderer.item.pGetGenericAndSpecificVariants(e.variant,{additionalBaseItems:e.baseitem||[]});n=n.concat(t)}return n},modifierPostToPre(e){const n=/^(.*)(?:,)? (\+\d+)$/.exec(e.name);return n?Object.assign(MiscUtil.copy(e),{name:`${n[2]} ${n[1]}`}):null},_isRefPopulated:!1,populatePropertyAndTypeReference:()=>Renderer.item._isRefPopulated?Promise.resolve():new Promise((e,n)=>{DataUtil.loadJSON(`${Renderer.get().baseUrl}data/items-base.json`).then(t=>{if(Renderer.item._isRefPopulated)e();else try{t.itemProperty.forEach(e=>Renderer.item._addProperty(e)),t.itemType.forEach(e=>Renderer.item._addType(e)),t.itemTypeAdditionalEntries.forEach(n=>Renderer.item._addAdditionalEntries(n)),Renderer.item._pAddBrewPropertiesAndTypes().then(()=>{Renderer.item._isRefPopulated=!0,e()})}catch(t){n(t)}})}),async getAllIndexableItems(e,n){Renderer.item.LINK_SPECIFIC_TO_GENERIC_DIRECTION=-1;const t=await Renderer.item._pGetAndProcBaseItems(n),[i,r]=await Renderer.item._pGetAndProcGenericVariants(e),d=Renderer.item._createSpecificVariants(t,i,r),s=[];return d.forEach(e=>{e.variants&&delete e.variants;const n=Renderer.item.modifierPostToPre(MiscUtil.copy(e));n&&s.push(n)}),d.push(...s),d}},Renderer.psionic={enhanceMode:e=>{function n(e,n){n=null!=n&&n;const t=[],i=function(){const n=[];return e.cost&&n.push(function(){const n=e.cost.min,t=e.cost.max,i=n===t?n:`${n}-${t}`;return`${i} psi`}()),e.concentration&&n.push(function(){return`conc., ${e.concentration.duration} ${e.concentration.unit}.`}()),0===n.length?null:`(${n.join("; ")})`}();return null!=i&&t.push(i),n?`${t.join(" ")}`:`${t.join(" ")}`}e.enhanced||(e.name=`${e.name} ${n(e,!1)}`,e.submodes&&e.submodes.forEach(e=>{e.name=`${e.name} ${n(e,!0)}`}),e.enhanced=!0)},getBodyText(e,n){const t=[];return e.entries&&Renderer.get().recursiveRender({entries:e.entries,type:"entries"},t),e.focus&&t.push(Renderer.psionic.getFocusString(e,n)),e.modes&&t.push(...e.modes.map(e=>Renderer.psionic.getModeString(e,n))),t.join("")},getDescriptionString:(e,n)=>`<p>${n.render({type:"inline",entries:[e.description]})}</p>`,getFocusString:(e,n)=>`<p><span class="psi-focus-title">Psychic Focus.</span> ${n.render({type:"inline",entries:[e.focus]})}</p>`,getModeString:(e,n)=>{Renderer.psionic.enhanceMode(e);const t=[];n.recursiveRender(e,t,{depth:2});const i=t.join("");if(null==e.submodes)return i;const r=Renderer.psionic.getSubModeString(e.submodes,n);return`${i}${r}`},getSubModeString(e,n){const t={type:"list",style:"list-hang-notitle",items:[]};for(let r=0;r<e.length;++r)t.items.push({type:"item",name:e[r].name,entry:e[r].entries.join("<br>")});const i=[];return n.recursiveRender(t,i,{depth:2}),i.join("")},getTypeOrderString(e){const n=Parser.psiTypeToMeta(e.type);return n.hasOrder?n.isAltDisplay?`${n.full} (${e.order})`:`${e.order} ${n.full}`:n.full},getCompactRenderedString(e){return`
			${Renderer.utils.getExcludedTr(e,"psionic")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_PSIONICS})}
			<tr class="text"><td colspan="6">
			<p><i>${Renderer.psionic.getTypeOrderString(e)}</i></p>
			${Renderer.psionic.getBodyText(e,Renderer.get().setFirstSection(!0))}
			</td></tr>
		`}},Renderer.rule={getCompactRenderedString(e){return`
			<tr><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`}},Renderer.variantrule={getCompactRenderedString(e){const n=MiscUtil.copy(e);return delete n.name,`
			${Renderer.utils.getExcludedTr(e,"variantrule")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_VARIATNRULES})}
			<tr><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(n)}
			</td></tr>
		`}},Renderer.table={getCompactRenderedString(e){e.type=e.type||"table";const n=MiscUtil.copy(e);return delete n.name,`
			${Renderer.utils.getExcludedTr(e,"table")}
			${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_TABLES})}
			<tr><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`}},Renderer.vehicle={getCompactRenderedString(e){return Renderer.vehicle.getRenderedString(e,{isCompact:!0})},getRenderedString(e,n){switch(n=n||{},e.vehicleType=e.vehicleType||"SHIP",e.vehicleType){case"SHIP":return Renderer.vehicle._getRenderedString_ship(e,n);case"INFWAR":return Renderer.vehicle._getRenderedString_infwar(e,n);default:throw new Error(`Unhandled vehicle type "${e.vehicleType}"`);}},_getRenderedString_ship(e,n){function t(e){return`<tr class="mon__stat-header-underline"><td colspan="6"><span>${e}</span></td></tr>`}function i(e,n){return e.ac||e.hp?`
				<div><b>Armor Class</b> ${e.ac}</div>
				<div><b>Hit Points</b> ${e.hp}${n?` each`:""}${e.dt?` (damage threshold ${e.dt})`:""}${e.hpNote?`; ${e.hpNote}`:""}</div>
			`:""}const r=Renderer.get();return`
			${Renderer.utils.getExcludedTr(e,"vehicle")}
			${Renderer.utils.getNameTr(e,{extraThClasses:n.isCompact?null:["veh__name--token"],page:UrlUtil.PG_VEHICLES})}
			<tr class="text"><td colspan="6"><i>${Parser.sizeAbvToFull(e.size)} vehicle${e.dimensions?` (${e.dimensions.join(" by ")})`:""}</i><br></td></tr>
			<tr class="text"><td colspan="6">
				<div><b>Creature Capacity</b> ${e.capCrew} crew${e.capPassenger?`, ${e.capPassenger} passengers`:""}</div>
				${e.capCargo?`<div><b>Cargo Capacity</b> ${"string"==typeof e.capCargo?e.capCargo:`${e.capCargo} ton${1===e.capCargo?"":"s"}`}</div>`:""}
				<div><b>Travel Pace</b> ${e.pace} miles per hour (${24*e.pace} miles per day)</div>
			</td></tr>
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-2 text-center">STR</th>
						<th class="col-2 text-center">DEX</th>
						<th class="col-2 text-center">CON</th>
						<th class="col-2 text-center">INT</th>
						<th class="col-2 text-center">WIS</th>
						<th class="col-2 text-center">CHA</th>
					</tr>
					<tr>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"str")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"dex")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"con")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"int")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"wis")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"cha")}</td>
					</tr>
				</table>
			</td></tr>
			<tr class="text"><td colspan="6">
				${e.immune?`<div><b>Damage Immunities</b> ${Parser.monImmResToFull(e.immune)}</div>`:""}
				${e.conditionImmune?`<div><b>Condition Immunities</b> ${Parser.monCondImmToFull(e.conditionImmune)}</div>`:""}
			</td></tr>
			${e.action?t("Actions"):""}
			${e.action?`<tr><td colspan="6">${function(){return r.render({entries:e.action})}()}</td></tr>`:""}
			${t("Hull")}
			<tr><td colspan="6">
			${i(e.hull)}
			</td></tr>
			${(e.control||[]).map(function(e){return e?`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>Control: ${e.name}</span></td></tr>
				<tr><td colspan="6">
				${i(e)}
				<div>${r.render({entries:e.entries})}</div>
				</td></tr>
			`:""}).join("")}
			${(e.movement||[]).map(function(e){return e?`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>${e.isControl?`Control and `:""}Movement: ${e.name}</span></td></tr>
				<tr><td colspan="6">
				${i(e)}
				${(e.locomotion||[]).map(function(e){const n={type:"list",style:"list-hang-notitle",items:[{type:"item",name:`Locomotion (${e.mode})`,entries:e.entries}]};return`<div>${r.render(n)}</div>`})}
				${(e.speed||[]).map(function(e){const n={type:"list",style:"list-hang-notitle",items:[{type:"item",name:`Speed (${e.mode})`,entries:e.entries}]};return`<div>${r.render(n)}</div>`})}
				</td></tr>
			`:""}).join("")}
			${(e.weapon||[]).map(function(e){return`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>Weapons: ${e.name}${e.count?` (${e.count})`:""}</span></td></tr>
				<tr><td colspan="6">
				${i(e,!!e.count)}
				${r.render({entries:e.entries})}
				</td></tr>
			`}).join("")}
			${(e.other||[]).map(function(e){return`
				<tr class="mon__stat-header-underline"><td colspan="6"><span>${e.name}</span></td></tr>
				<tr><td colspan="6">
				${i(e)}
				${r.render({entries:e.entries})}
				</td></tr>
			`}).join("")}
			${Renderer.utils.getPageTr(e)}
		`},_getRenderedString_infwar(e,n){const t=Renderer.get(),i=Parser.getAbilityModNumber(e.dex);return`
			${Renderer.utils.getExcludedTr(e,"vehicle")}
			${Renderer.utils.getNameTr(e,{extraThClasses:n.isCompact?null:["veh__name--token"],page:UrlUtil.PG_VEHICLES})}
			<tr class="text"><td colspan="6"><i>${Parser.sizeAbvToFull(e.size)} vehicle (${e.weight.toLocaleString()} lb.)</i><br></td></tr>
			<tr class="text"><td colspan="6">
				<div><b>Creature Capacity</b> ${e.capCreature} Medium creatures</div>
				<div><b>Cargo Capacity</b> ${Parser.weightToFull(e.capCargo)}</div>
				<div><b>Armor Class</b> ${0===i?`19`:`${19+i} (19 while motionless)`}</div>
				<div><b>Hit Points</b> ${e.hp.hp} (damage threshold ${e.hp.dt}, mishap threshold ${e.hp.mt})</div>
				<div><b>Speed</b> ${e.speed} ft.</div>
			</td></tr>
			<tr><td colspan="6">
				<table class="summary striped-even">
					<tr>
						<th class="col-2 text-center">STR</th>
						<th class="col-2 text-center">DEX</th>
						<th class="col-2 text-center">CON</th>
						<th class="col-2 text-center">INT</th>
						<th class="col-2 text-center">WIS</th>
						<th class="col-2 text-center">CHA</th>
					</tr>
					<tr>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"str")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"dex")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"con")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"int")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"wis")}</td>
						<td class="text-center">${Renderer.utils.getAbilityRoller(e,"cha")}</td>
					</tr>
				</table>
			</td></tr>
			<tr class="text"><td colspan="6">
				${e.immune?`<div><b>Damage Immunities</b> ${Parser.monImmResToFull(e.immune)}</div>`:""}
				${e.conditionImmune?`<div><b>Condition Immunities</b> ${Parser.monCondImmToFull(e.conditionImmune)}</div>`:""}
			</td></tr>
			${e.trait?`<tr><td colspan="6"><div class="border"></div></td></tr>
			<tr class="text compact"><td colspan="6">
			${Renderer.monster.getOrderedTraits(e,t).map(e=>e.rendered||t.render(e,2)).join("")}
			</td></tr>`:""}
			${Renderer.monster.getCompactRenderedStringSection(e,t,"Action Stations","actionStation",2)}
			${Renderer.monster.getCompactRenderedStringSection(e,t,"Reactions","reaction",2)}
			${Renderer.utils.getPageTr(e)}
		`}},Renderer.action={getCompactRenderedString(e){const n=MiscUtil.copy(e);return delete n.name,`${Renderer.utils.getExcludedTr(e,"action")}${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_ACTIONS})}
		<tr><td colspan="6">${Renderer.get().setFirstSection(!0).render(n)}</td></tr>`}},Renderer.language={getCompactRenderedString(e){return Renderer.language.getRenderedString(e)},getRenderedString(e){const n=[],t=e.typicalSpeakers||e.script;return e.entries&&n.push(...e.entries),e.dialects&&n.push(`This language is a family which includes the following dialects: ${e.dialects.sort(SortUtil.ascSortLower).join(", ")}. Creatures that speak different dialects of the same language can communicate with one another.`),n.length||t||n.push("{@i No information available.}"),`
		${Renderer.utils.getExcludedTr(e,"language")}
		${Renderer.utils.getNameTr(e,{page:UrlUtil.PG_LANGUAGES})}
		${e.type?`<tr class="text"><td colspan="6" class="pt-0"><i>${e.type.toTitleCase()} language</i></td></tr>`:""}
		${t?`<tr class="text"><td colspan="6">
		${e.typicalSpeakers?`<div><b>Typical Speakers</b> ${Renderer.get().render(e.typicalSpeakers.join(", "))}</b>`:""}
		${e.script?`<div><b>Script</b> ${Renderer.get().render(e.script)}</div>`:""}
		<div></div>
		</td></tr>`:""}
		${n.length?`<tr class="text"><td colspan="6">
		${Renderer.get().setFirstSection(!0).render({entries:n})}
		</td></tr>`:""}
		${Renderer.utils.getPageTr(e)}`}},Renderer.hover={LinkMeta:function(){this.isHovered=!1,this.isLoading=!1,this.isPermanent=!1,this.windowMeta=null},_BAR_HEIGHT:16,_linkCache:{},_eleCache:new Map,_entryCache:{},_isInit:!1,_dmScreen:null,_lastId:0,bindDmScreen(e){this._dmScreen=e},_getNextId(){return++Renderer.hover._lastId},_doInit(){Renderer.hover._isInit||(Renderer.hover._isInit=!0,$(`body`).on("click",()=>Renderer.hover._cleanTempWindows()),ContextUtil.doInitContextMenu("hoverBorder",(e,n,t,i)=>{const r=$(`.hoverborder[data-perm="true"]`);switch(+i.data("ctx-id")){case 0:r.attr("data-display-title","false");break;case 1:r.attr("data-display-title","true");break;case 2:$(`.hvr__close`).click();}},["Maximize All","Minimize All",null,"Close All"]))},_cleanTempWindows(){for(const[e,n]of Renderer.hover._eleCache.entries())n.isPermanent||document.body.contains(e)||!n.windowMeta||n.windowMeta.doClose()},_getSetMeta(e){return Renderer.hover._eleCache.has(e)||Renderer.hover._eleCache.set(e,new Renderer.hover.LinkMeta),Renderer.hover._eleCache.get(e)},_handleGenericMouseOverStart(e,n){if(!Renderer.hover.isSmallScreen()||e.shiftKey){Renderer.hover._cleanTempWindows();const t=Renderer.hover._getSetMeta(n);if(!(t.isHovered||t.isLoading))return n.style.cursor="wait",t.isHovered=!0,t.isLoading=!0,t.isPermanent=e.shiftKey,t}},async pHandleLinkMouseOver(e,n,t,i,r,d){const s=Renderer.hover._handleGenericMouseOverStart(e,n);if(null==s)return;let a;if(null!=d){const[e,n]=d.split(":");switch(e){case MON_HASH_SCALED:{const e=await Renderer.hover.pCacheAndGet(t,i,r);a=await ScaleCreature.scale(e,+n);break}}}else a=await Renderer.hover.pCacheAndGet(t,i,r);if(s.isLoading=!1,!s.isHovered&&!s.isPermanent)return;const o=Renderer.hover.$getHoverContent_stats(t,a);if(s.windowMeta=Renderer.hover.getShowWindow(o,Renderer.hover.getWindowPositionFromEvent(e),{title:a.name,isPermanent:s.isPermanent,pageUrl:`${t}#${r}`,cbClose:()=>s.isHovered=s.isPermanent=s.isLoading=!1}),n.style.cursor="",t===UrlUtil.PG_BESTIARY){const e=Renderer.hover._pageToRenderFn(t);o.on("click",".mon__btn-scale-cr",n=>{n.stopPropagation();const d=$(n.target).closest("button"),l=null==a._originalCr?a.cr.cr||a.cr:a._originalCr,c=a.cr.cr||a.cr;Renderer.monster.getCrScaleTarget(d,c,async n=>{const d=await Renderer.hover.pCacheAndGet(t,i,r);a=Parser.numberToCr(n)===l?d:await ScaleCreature.scale(a,n),o.empty().append(e(a)),s.windowMeta.$windowTitle.text(a._displayName||a.name)},!0)}),o.on("click",".mon__btn-reset-cr",async()=>{a=await Renderer.hover.pCacheAndGet(t,i,r),o.empty().append(e(a)),s.windowMeta.$windowTitle.text(a._displayName||a.name)})}},handleLinkMouseLeave(e,n){const t=Renderer.hover._eleCache.get(n);return n.style.cursor="",!t||t.isPermanent?void 0:e.shiftKey?(t.isPermanent=!0,void t.windowMeta.setIsPermanent(!0)):void(t.isHovered=!1,t.windowMeta&&(t.windowMeta.doClose(),t.windowMeta=null))},handleLinkMouseMove(e,n){const t=Renderer.hover._eleCache.get(n);t&&!t.isPermanent&&t.windowMeta&&(t.windowMeta.setPosition(Renderer.hover.getWindowPositionFromEvent(e)),e.shiftKey&&!t.isPermanent&&(t.isPermanent=!0,t.windowMeta.setIsPermanent(!0)))},handlePredefinedMouseOver(e,n,t,i){const r=Renderer.hover._handleGenericMouseOverStart(e,n);if(null!=r){Renderer.hover._cleanTempWindows();const d=Renderer.hover._entryCache[t];if(r.isLoading=!1,r.isHovered||r.isPermanent){const t=Renderer.hover.$getHoverContent_generic(d,i);r.windowMeta=Renderer.hover.getShowWindow(t,Renderer.hover.getWindowPositionFromEvent(e),{title:d.data&&null!=d.data.hoverTitle?d.data.hoverTitle:d.name,isPermanent:r.isPermanent,cbClose:()=>r.isHovered=r.isPermanent=r.isLoading=!1}),n.style.cursor=""}}},handlePredefinedMouseLeave(e,n){return Renderer.hover.handleLinkMouseLeave(e,n)},handlePredefinedMouseMove(e,n){return Renderer.hover.handleLinkMouseMove(e,n)},getWindowPositionFromEvent(e){const n=e.target,t=$(n).offset(),i=t.top-$(document).scrollTop(),r=t.left-$(document).scrollLeft(),d=i>window.innerHeight/2,s=r>window.innerWidth/2;return{mode:"autoFromElement",vpOffsetT:i,vpOffsetL:r,fromBottom:d,fromRight:s,eleHeight:$(n).height(),eleWidth:$(n).width(),clientX:EventUtil.getClientX(e)}},getShowWindow(e,n,t){var u=Math.max;function i(e,n){(0===e.which||1===e.which)&&e.preventDefault(),f.css({"z-index":201,animation:"initial"}),C.type=n,C.startX=EventUtil.getClientX(e),C.startY=EventUtil.getClientY(e),C.baseTop=parseFloat(f.css("top")),C.baseLeft=parseFloat(f.css("left")),C.baseHeight=h.height(),C.baseWidth=parseFloat(f.css("width")),9>n&&(h.css("max-height","initial"),f.css("max-width","initial"))}function r(){f.css("z-index",""),f.parent().append(f)}function d(e,n){return EventUtil.getClientX(e)>=n.left&&EventUtil.getClientX(e)<=n.left+n.width&&EventUtil.getClientY(e)>=n.top&&EventUtil.getClientY(e)<=n.top+n.height}function s(e){const n=u(C.startY-EventUtil.getClientY(e),80-C.baseHeight);h.css("height",C.baseHeight+n),f.css("top",C.baseTop-n),C.startY=EventUtil.getClientY(e),C.baseHeight=h.height(),C.baseTop=parseFloat(f.css("top"))}function a(e){const n=C.startX-EventUtil.getClientX(e);f.css("width",C.baseWidth-n),C.startX=EventUtil.getClientX(e),C.baseWidth=parseFloat(f.css("width"))}function o(e){const n=C.startY-EventUtil.getClientY(e);h.css("height",C.baseHeight-n),C.startY=EventUtil.getClientY(e),C.baseHeight=h.height()}function l(e){const n=u(C.startX-EventUtil.getClientX(e),150-C.baseWidth);f.css("width",C.baseWidth+n).css("left",C.baseLeft-n),C.startX=EventUtil.getClientX(e),C.baseWidth=parseFloat(f.css("width")),C.baseLeft=parseFloat(f.css("left"))}function c(){const e=f[0],n=parseFloat(e.style.top),t=parseFloat(e.style.left),i=parseFloat(e.style.width),r=window.innerHeight,d=window.innerWidth;0>n?e.style.top=`0px`:n>=r-Renderer.hover._BAR_HEIGHT&&f.css("top",r-Renderer.hover._BAR_HEIGHT),0>t?f.css("left",0):t+i>d&&f.css("left",u(d-i,0))}Renderer.hover._doInit();const p=$(`body`),f=$(`<div class="hwin" style="right: -600px; width: 600px;"/>`),h=$(`<div class="hwin__wrp-table"/>`),_=$(`<span class="window-title">${t.title||""}</span>`),m={},g=Renderer.hover._getNextId(),y=`mouseup.${g} touchend.${g}`,T=`mousemove.${g} touchmove.${g}`,S=`resize.${g}`,E=()=>{f.remove(),$(document).off(y),$(document).off(T),$(window).off(S),t.cbClose&&t.cbClose(m)};let C={};const k=$(`<div class="hoverborder__resize-ne"/>`).on("mousedown touchstart",e=>i(e,1)).on("click",r),v=$(`<div class="hoverborder__resize-e"/>`).on("mousedown touchstart",e=>i(e,2)).on("click",r),b=$(`<div class="hoverborder__resize-se"/>`).on("mousedown touchstart",e=>i(e,3)).on("click",r),R=$(`<div class="hoverborder hoverborder--btm ${t.isBookContent?"hoverborder-book":""}"><div class="hoverborder__resize-s"/></div>`).on("mousedown touchstart",e=>i(e,4)).on("click",r),P=$(`<div class="hoverborder__resize-sw"/>`).on("mousedown touchstart",e=>i(e,5)).on("click",r),L=$(`<div class="hoverborder__resize-w"/>`).on("mousedown touchstart",e=>i(e,6)).on("click",r),A=$(`<div class="hoverborder__resize-nw"/>`).on("mousedown touchstart",e=>i(e,7)).on("click",r),x=$(`<div class="hoverborder__resize-n"/>`).on("mousedown touchstart",e=>i(e,8)).on("click",r),I=$(`<div class="hoverborder hoverborder--top ${t.isBookContent?"hoverborder-book":""}" ${t.isPermanent?`data-perm="true"`:""}/>`).on("mousedown touchstart",e=>i(e,9)).on("click",r).on("contextmenu",e=>ContextUtil.handleOpenContextMenu(e,I[0],"hoverBorder",null,m));$(document).on(y,e=>{if(C.type){if(9>C.type&&(h.css("max-height",""),f.css("max-width","")),c(),9===C.type){if(e.target.classList.contains("hvr__close")||e.target.classList.contains("hvr__popout"))return e.preventDefault(),C.type=0,void $(e.target).click();if(this._dmScreen){const n=this._dmScreen.getPanelPx(EventUtil.getClientX(e),EventUtil.getClientY(e));if(!n)return;this._dmScreen.setHoveringPanel(n);const t=n.getAddButtonPos();d(e,t)&&(preLoaded&&null!=preLoaded._isScaledCr?n.doPopulate_StatsScaledCr(page,source,hash,preLoaded.cr.cr||preLoaded.cr):n.doPopulate_Stats(page,source,hash),E()),this._dmScreen.resetHoveringButton()}}C.type=0}}).on(T,e=>{switch(C.type){case 1:s(e),a(e);break;case 2:a(e);break;case 3:o(e),a(e);break;case 4:o(e);break;case 5:o(e),l(e);break;case 6:l(e);break;case 7:s(e),l(e);break;case 8:s(e);break;case 9:{const n=C.startX-EventUtil.getClientX(e),t=C.startY-EventUtil.getClientY(e);if(f.css("left",C.baseLeft-n).css("top",C.baseTop-t),C.startX=EventUtil.getClientX(e),C.startY=EventUtil.getClientY(e),C.baseTop=parseFloat(f.css("top")),C.baseLeft=parseFloat(f.css("left")),this._dmScreen){const n=this._dmScreen.getPanelPx(EventUtil.getClientX(e),EventUtil.getClientY(e));if(!n)return;this._dmScreen.setHoveringPanel(n);const t=n.getAddButtonPos();d(e,t)?this._dmScreen.setHoveringButton(n):this._dmScreen.resetHoveringButton()}break}}}),$(window).on(S,()=>c(!0)),I.attr("data-display-title",!1),I.on("dblclick",()=>{const e=I.attr("data-display-title"),n="false"===e;I.attr("data-display-title",n),I.attr("data-perm",!0),f.toggleClass("hwin--minified",n)}),I.append(_);const w=$(`<div class="flex" style="margin-left: auto;"/>`).appendTo(I);if(t.pageUrl){$(`<a class="top-border-icon glyphicon glyphicon-modal-window" style="margin-right: 2px;" title="Go to Page" href="${t.pageUrl}"></a>`).appendTo(w)}const O=$(`<span class="top-border-icon glyphicon glyphicon-new-window hvr__popout" style="margin-right: 2px;" title="Open as Popup Window"></span>`).on("click",n=>{n.stopPropagation();const i=e.height(),r=open("",t.title||"",`width=600,height=${i}location=0,menubar=0,status=0,titlebar=0,toolbar=0`);r.document.write(`
					<!DOCTYPE html>
					<html lang="en" class="${styleSwitcher&&styleSwitcher.getActiveStyleSheet()===StyleSwitcher.STYLE_NIGHT?StyleSwitcher.NIGHT_CLASS:""}"><head>
						<meta name="viewport" content="width=device-width, initial-scale=1">
						<title>${t.title}</title>
						<link rel="manifest" href="manifest.webmanifest">
						<link rel="stylesheet" href="css/bootstrap.css">
						<link rel="stylesheet" href="css/jquery-ui.css">
						<link rel="stylesheet" href="css/jquery-ui-slider-pips.css">
						<link rel="stylesheet" href="css/style.css">
						<link rel="icon" href="favicon.png">

						<script>if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js?v=${VERSION_NUMBER}");</script>
						<style>
							html, body { width: 100%; height: 100%; }
							body { overflow-y: scroll; }
							.hwin--popout { max-width: 100%; max-height: 100%; box-shadow: initial; width: 100%; overflow-y: auto; }
						</style>
					</head><body>
					<div class="hwin hoverbox--popout hwin--popout">
					${e[0].outerHTML}
					</div>
					<script type="text/javascript" src="js/utils.js"></script>
					<script type="text/javascript" src="js/utils-ui.js"></script>
					<script type="text/javascript" src="js/render.js"></script>
					<script type="text/javascript" src="js/scalecreature.js"></script>
					<script type="text/javascript" src="lib/jquery.js"></script>
					<script type="text/javascript" src="lib/jquery-ui.js"></script>
					<script type="text/javascript" src="lib/jquery-ui-slider-pip.js"></script>
					</body></html>
				`),E()}).appendTo(w),G=$(`<span class="delete-icon glyphicon glyphicon-remove hvr__close" title="Close"></span>`).on("click",e=>{e.stopPropagation(),E()}).appendTo(w);h.append(e),f.append(x).append(k).append(v).append(b).append(P).append(L).append(A).append(I).append(h).append(R),p.append(f);const D=e=>{switch(e.mode){case"autoFromElement":{e.fromBottom?f.css("top",e.vpOffsetT-(f.height()+10)):f.css("top",e.vpOffsetT+e.eleHeight+10),e.fromRight?f.css("left",(e.clientX||e.vpOffsetL)-(parseFloat(f.css("width"))+10)):f.css("left",(e.clientX||e.vpOffsetL+e.eleWidth)+10);break}case"exact":{f.css("top",e.y),f.css("left",e.x);break}default:throw new Error(`Positiong mode unimplemented: "${e.mode}"`);}c(!0)};D(n);return m.$windowTitle=_,m.setPosition=D,m.setIsPermanent=e=>{t.isPermanent=e,I.attr("data-perm",e)},m.doClose=E,m},getMakePredefinedHover(e,n){const t=Renderer.hover._getNextId();return Renderer.hover._entryCache[t]=e,{id:t,html:`onmouseover="Renderer.hover.handlePredefinedMouseOver(event, this, ${t}, ${!!n})" onmousemove="Renderer.hover.handlePredefinedMouseMove(event, this)" onmouseleave="Renderer.hover.handlePredefinedMouseLeave(event, this)" ${Renderer.hover.getPreventTouchString()}`,mouseOver:(e,i)=>Renderer.hover.handlePredefinedMouseOver(e,i,t,!!n),mouseMove:(e,n)=>Renderer.hover.handlePredefinedMouseMove(e,n),mouseLeave:(e,n)=>Renderer.hover.handlePredefinedMouseLeave(e,n),touchStart:(e,n)=>Renderer.hover.handleTouchStart(e,n)}},updatePredefinedHover(e,n){Renderer.hover._entryCache[e]=n},getPreventTouchString(){return`ontouchstart="Renderer.hover.handleTouchStart(event, this)"`},handleTouchStart(e,n){Renderer.hover.isSmallScreen()||($(n).data("href",$(n).data("href")||$(n).attr("href")),$(n).attr("href","javascript:void(0)"),setTimeout(()=>{const e=$(n).data("href");e&&($(n).attr("href",e),$(n).data("href",null))},100))},_addToCache:(e,n,t,i)=>{e=e.toLowerCase(),n=n.toLowerCase(),t=t.toLowerCase(),((Renderer.hover._linkCache[e]=Renderer.hover._linkCache[e]||[])[n]=Renderer.hover._linkCache[e][n]||[])[t]=i},_getFromCache:(e,n,t,i)=>{i=i||{},e=e.toLowerCase(),n=n.toLowerCase(),t=t.toLowerCase();const r=Renderer.hover._linkCache[e][n][t];return i.isCopy?MiscUtil.copy(r):r},_isCached:(e,n,t)=>Renderer.hover._linkCache[e]&&Renderer.hover._linkCache[e][n]&&Renderer.hover._linkCache[e][n][t],_psCacheLoading:{},_flagsCacheLoaded:{},async pCacheAndGet(e,n,t,i){function r(n,t,i){n[t].forEach(n=>{const r=UrlUtil.URL_TO_HASH_BUILDER[e](n);i&&i(t,n),Renderer.hover._addToCache(e,n.source,r,n)})}async function d(e,d,s){const a=`${e}${n}`;return Renderer.hover._psCacheLoading[a]&&(await Renderer.hover._psCacheLoading[a]),Renderer.hover._flagsCacheLoaded[a]&&Renderer.hover._isCached(e,n,t)||(Renderer.hover._psCacheLoading[a]=(async()=>{const e=await BrewUtil.pAddBrewData();e[s]&&r(e,s);const t=await DataUtil.loadJSON(`${Renderer.get().baseUrl}${d}index.json`),i={};Object.entries(t).forEach(([e,n])=>i[e.toLowerCase()]=n);const o=i[n.toLowerCase()];if(o){const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}${d}${o}`);r(e,s)}Renderer.hover._flagsCacheLoaded[a]=!0})(),await Renderer.hover._psCacheLoading[a]),Renderer.hover._getFromCache(e,n,t,i)}async function s(e,n){const t=await BrewUtil.pAddBrewData();e=e instanceof Array?e:[e],e.forEach(e=>{t[e]&&r(t,e,n)})}function a(e,n,t){n instanceof Array?n.forEach(n=>r(e,n,t)):r(e,n,t)}async function o(e,r,d,o){const l=r;return Renderer.hover._psCacheLoading[l]&&(await Renderer.hover._psCacheLoading[l]),Renderer.hover._flagsCacheLoaded[l]&&Renderer.hover._isCached(e,n,t)||(Renderer.hover._psCacheLoading[l]=(async()=>{await s(d,o);const e=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/${r}`);a(e,d,o),Renderer.hover._flagsCacheLoaded[l]=!0})(),await Renderer.hover._psCacheLoading[l]),Renderer.hover._getFromCache(e,n,t,i)}async function l(e,r,d,o,l){const c=r;return Renderer.hover._psCacheLoading[c]&&(await Renderer.hover._psCacheLoading[c]),Renderer.hover._flagsCacheLoaded[c]&&Renderer.hover._isCached(e,n,t)||(Renderer.hover._psCacheLoading[c]=(async()=>{await s(d,o);const e=await DataUtil[l].loadJSON(Renderer.get().baseUrl);a(e,d,o),Renderer.hover._flagsCacheLoaded[c]=!0})(),await Renderer.hover._psCacheLoading[c]),Renderer.hover._getFromCache(e,n,t,i)}switch(i=i||{},e=e.toLowerCase(),n=n.toLowerCase(),t=t.toLowerCase(),e){case"generic":case"hover":return null;case UrlUtil.PG_CLASSES:{const r=UrlUtil.PG_CLASSES;return Renderer.hover._psCacheLoading[r]&&(await Renderer.hover._psCacheLoading[r]),Renderer.hover._flagsCacheLoaded[r]&&Renderer.hover._isCached(e,n,t)||(Renderer.hover._psCacheLoading[r]=(async()=>{const e=e=>{const n=UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_CLASSES](e),t={name:e.name,type:"section",entries:MiscUtil.copy((e.classFeatures||[]).flat())};Renderer.hover._addToCache(UrlUtil.PG_CLASSES,e.source||SRC_PHB,n,t),(e.subclasses||[]).forEach(t=>{const i=`${n}${HASH_PART_SEP}${UrlUtil.getClassesPageStatePart({subclass:t})}`,r={name:`${t.name} (${e.name})`,type:"section",entries:MiscUtil.copy((t.subclassFeatures||[]).flat())};Renderer.hover._addToCache(UrlUtil.PG_CLASSES,e.source||SRC_PHB,i,r)}),UrlUtil.class.getIndexedEntries(e).forEach(e=>Renderer.hover._addToCache(UrlUtil.PG_CLASSES,e.source,e.hash,e.entry))},n=await BrewUtil.pAddBrewData();(n.class||[]).forEach(n=>e(n));const t=await DataUtil.class.loadJSON();t.class.forEach(n=>e(n)),Renderer.hover._flagsCacheLoaded[r]=!0})(),await Renderer.hover._psCacheLoading[r]),Renderer.hover._getFromCache(e,n,t,i)}case UrlUtil.PG_SPELLS:return d(e,`data/spells/`,"spell");case UrlUtil.PG_BESTIARY:return d(e,`data/bestiary/`,"monster");case UrlUtil.PG_ITEMS:{const r=UrlUtil.PG_ITEMS;return Renderer.hover._psCacheLoading[r]&&(await Renderer.hover._psCacheLoading[r]),Renderer.hover._flagsCacheLoaded[r]&&Renderer.hover._isCached(e,n,t)||(Renderer.hover._psCacheLoading[r]=(async()=>{const n=await Renderer.item.pBuildList({isAddGroups:!0,isBlacklistVariants:!0}),t=await BrewUtil.pAddBrewData(),i=await Renderer.item.getItemsFromHomebrew(t);i.forEach(n=>{const t=UrlUtil.URL_TO_HASH_BUILDER[e](n);Renderer.hover._addToCache(e,n.source,t,n);const i=Renderer.item.modifierPostToPre(n);i&&Renderer.hover._addToCache(e,n.source,UrlUtil.URL_TO_HASH_BUILDER[e](i),n)}),n.forEach(n=>{const t=UrlUtil.URL_TO_HASH_BUILDER[UrlUtil.PG_ITEMS](n);Renderer.hover._addToCache(e,n.source,t,n);const i=Renderer.item.modifierPostToPre(n);i&&Renderer.hover._addToCache(e,n.source,UrlUtil.URL_TO_HASH_BUILDER[e](i),n)}),Renderer.hover._flagsCacheLoaded[r]=!0})(),await Renderer.hover._psCacheLoading[r]),Renderer.hover._getFromCache(e,n,t,i)}case UrlUtil.PG_BACKGROUNDS:return o(e,"backgrounds.json","background");case UrlUtil.PG_FEATS:return o(e,"feats.json","feat");case UrlUtil.PG_OPT_FEATURES:return o(e,"optionalfeatures.json","optionalfeature");case UrlUtil.PG_PSIONICS:return o(e,"psionics.json","psionic");case UrlUtil.PG_REWARDS:return o(e,"rewards.json","reward");case UrlUtil.PG_RACES:{const d=UrlUtil.PG_RACES;return Renderer.hover._psCacheLoading[d]&&(await Renderer.hover._psCacheLoading[d]),Renderer.hover._flagsCacheLoaded[d]&&Renderer.hover._isCached(e,n,t)||(Renderer.hover._psCacheLoading[d]=(async()=>{const e=await BrewUtil.pAddBrewData();let n=[];e.race&&(n=Renderer.race.mergeSubraces(e.race,{isAddBaseRaces:!0}),r({race:n},"race"));const t=await DataUtil.loadJSON(`${Renderer.get().baseUrl}data/races.json`),i=Renderer.race.mergeSubraces(t.race,{isAddBaseRaces:!0});if(r({race:i},"race"),e.subrace){const t=Renderer.race.adoptSubraces([...n,...i],e.subrace),d=Renderer.race.mergeSubraces(t);r({race:d},"race")}Renderer.hover._flagsCacheLoaded[d]=!0})(),await Renderer.hover._psCacheLoading[d]),Renderer.hover._getFromCache(e,n,t,i)}case UrlUtil.PG_DEITIES:return l(e,"deities.json","deity",null,"deity");case UrlUtil.PG_OBJECTS:return o(e,"objects.json","object");case UrlUtil.PG_TRAPS_HAZARDS:return o(e,"trapshazards.json",["trap","hazard"]);case UrlUtil.PG_VARIATNRULES:return o(e,"variantrules.json","variantrule");case UrlUtil.PG_CULTS_BOONS:return o(e,"cultsboons.json",["cult","boon"],(e,n)=>n._type="cult"===e?"c":"b");case UrlUtil.PG_CONDITIONS_DISEASES:return o(e,"conditionsdiseases.json",["condition","disease"],(e,n)=>n._type="condition"===e?"c":"d");case UrlUtil.PG_TABLES:return o(e,"generated/gendata-tables.json",["table","tableGroup"],(e,n)=>n._type="table"===e?"t":"g");case UrlUtil.PG_VEHICLES:return o(e,"vehicles.json","vehicle");case UrlUtil.PG_ACTIONS:return o(e,"actions.json","action");case UrlUtil.PG_LANGUAGES:return o(e,"languages.json","language");default:throw new Error(`No load function defined for page ${e}`);}},getGenericCompactRenderedString(e){return`
			<tr class="text homebrew-hover"><td colspan="6">
			${Renderer.get().setFirstSection(!0).render(e)}
			</td></tr>
		`},_pageToRenderFn(e){return"generic"===e||"hover"===e?Renderer.hover.getGenericCompactRenderedString:e===UrlUtil.PG_CLASSES?Renderer.hover.getGenericCompactRenderedString:e===UrlUtil.PG_SPELLS?Renderer.spell.getCompactRenderedString:e===UrlUtil.PG_ITEMS?Renderer.item.getCompactRenderedString:e===UrlUtil.PG_BESTIARY?e=>Renderer.monster.getCompactRenderedString(e,null,{showScaler:!0,isScaled:null!=e._originalCr}):e===UrlUtil.PG_CONDITIONS_DISEASES?Renderer.condition.getCompactRenderedString:e===UrlUtil.PG_BACKGROUNDS?Renderer.background.getCompactRenderedString:e===UrlUtil.PG_FEATS?Renderer.feat.getCompactRenderedString:e===UrlUtil.PG_OPT_FEATURES?Renderer.optionalfeature.getCompactRenderedString:e===UrlUtil.PG_PSIONICS?Renderer.psionic.getCompactRenderedString:e===UrlUtil.PG_REWARDS?Renderer.reward.getCompactRenderedString:e===UrlUtil.PG_RACES?Renderer.race.getCompactRenderedString:e===UrlUtil.PG_DEITIES?Renderer.deity.getCompactRenderedString:e===UrlUtil.PG_OBJECTS?Renderer.object.getCompactRenderedString:e===UrlUtil.PG_TRAPS_HAZARDS?Renderer.traphazard.getCompactRenderedString:e===UrlUtil.PG_VARIATNRULES?Renderer.variantrule.getCompactRenderedString:e===UrlUtil.PG_CULTS_BOONS?Renderer.cultboon.getCompactRenderedString:e===UrlUtil.PG_TABLES?Renderer.table.getCompactRenderedString:e===UrlUtil.PG_VEHICLES?Renderer.vehicle.getCompactRenderedString:e===UrlUtil.PG_ACTIONS?Renderer.action.getCompactRenderedString:e===UrlUtil.PG_LANGUAGES?Renderer.language.getCompactRenderedString:null},isSmallScreen(){const e=(()=>{let e=100,n=window.top;for(;window.parent!==n;)if(n=window.parent,0>e--)return window;return n})();return 768>=e.innerWidth},bindPopoutButton(e,n){const t=ListUtil.getOrTabRightButton(`btn-popout`,`new-window`).off("click").title("Popout Window (SHIFT for Source Data)");t.on("click",n?n(e):n=>{if(null!==Hist.lastLoadedId){const t=e[Hist.lastLoadedId];if(n.shiftKey){const e=Renderer.hover.$getHoverContent_statsCode(t);Renderer.hover.getShowWindow(e,Renderer.hover.getWindowPositionFromEvent(n),{title:`${t.name} \u2014 Source Data`,isPermanent:!0,isBookContent:!0})}else Renderer.hover.doPopoutCurPage(n,e,Hist.lastLoadedId)}})},$getHoverContent_stats(e,n){const t=Renderer.hover._pageToRenderFn(e);return $$`<table class="stats">${t(n)}</table>`},$getHoverContent_statsCode(e){const n=DataUtil.cleanJson(MiscUtil.copy(e)),t={type:"code",name:`${n.name} \u2014 Source Data`,preformatted:JSON.stringify(n,null,"\t")};return $$`<table class="stats stats--book">${Renderer.get().render(t)}</table>`},$getHoverContent_generic(e,n){return $$`<table class="stats ${n?"stats--book":""}">${Renderer.hover.getGenericCompactRenderedString(e)}</table>`},doPopoutCurPage(e,n,t){const i=n[t],r=Renderer.hover.$getHoverContent_stats(UrlUtil.getCurrentPage(),i);Renderer.hover.getShowWindow(r,Renderer.hover.getWindowPositionFromEvent(e),{pageUrl:`#${UrlUtil.autoEncodeHash(i)}`,title:i.name,isPermanent:!0})}},Renderer.dice={SYSTEM_USER:{name:"Avandra"},POS_INFINITE:1e20,_$wrpRoll:null,_$minRoll:null,_$iptRoll:null,_$outRoll:null,_$head:null,_hist:[],_histIndex:null,_$lastRolledBy:null,_storage:null,_isManualMode:!1,DICE:[4,6,8,10,12,20,100],getNextDice(e){const n=Renderer.dice.DICE.indexOf(e);return~n?Renderer.dice.DICE[n+1]:null},getPreviousDice(e){const n=Renderer.dice.DICE.indexOf(e);return~n?Renderer.dice.DICE[n-1]:null},_panel:null,bindDmScreenPanel(e,n){Renderer.dice._panel&&Renderer.dice.unbindDmScreenPanel(),Renderer.dice._showBox(),Renderer.dice._panel=e,e.doPopulate_Rollbox(n)},unbindDmScreenPanel(){Renderer.dice._panel&&($(`body`).append(Renderer.dice._$wrpRoll),Renderer.dice._panel.close$TabContent(),Renderer.dice._panel=null,Renderer.dice._hideBox(),Renderer.dice._$wrpRoll.removeClass("rollbox-panel"))},get$Roller(){return Renderer.dice._$wrpRoll},parseRandomise2(e){if(!e||!e.trim())return null;const n=Renderer.dice.lang.getTree3(e);return n?n.evl({}):null},parseAverage(e){if(!e||!e.trim())return null;const n=Renderer.dice.lang.getTree3(e);return n?n.avg({}):null},_showBox(){"flex"!==Renderer.dice._$wrpRoll.css("display")&&(Renderer.dice._$minRoll.hide(),Renderer.dice._$wrpRoll.css("display","flex"),Renderer.dice._$iptRoll.prop("placeholder",`${Renderer.dice._getRandomPlaceholder()} or "/help"`))},_hideBox(){Renderer.dice._$minRoll.show(),Renderer.dice._$wrpRoll.css("display","")},_getRandomPlaceholder(){const e=RollerUtil.randomise(10),n=Renderer.dice.DICE[RollerUtil.randomise(Renderer.dice.DICE.length-1)],t=(RollerUtil.randomise(3)-2)*RollerUtil.randomise(10),i=1<e&&5===RollerUtil.randomise(5),r=i?2===RollerUtil.randomise(2)?"h":"l":"",d=i?RollerUtil.randomise(e-1):null;return`${e}d${n}${i?`d${r}${d}`:""}${0>t?t:0<t?`+${t}`:""}`},async _pInit(){const e=$(`<div class="rollbox"/>`),n=$(`<div class="rollbox-min"><span class="glyphicon glyphicon-chevron-up"></span></div>`).on("click",()=>{Renderer.dice._showBox(),Renderer.dice._$iptRoll.focus()}),t=$(`<div class="head-roll"><span class="hdr-roll">Dice Roller</span><span class="delete-icon glyphicon glyphicon-remove"></span></div>`).on("click",()=>{Renderer.dice._panel||Renderer.dice._hideBox()}),i=$(`<div class="out-roll">`),r=$(`<input class="ipt-roll form-control" autocomplete="off" spellcheck="false">`).on("keypress",async n=>{13===n.which&&(await Renderer.dice.pRoll2(r.val(),{user:!0,name:"Anon"}),r.val("")),n.stopPropagation()}).on("keydown",n=>{38===n.which?Renderer.dice._prevHistory():40===n.which&&Renderer.dice._nextHistory()});e.append(t).append(i).append(r),Renderer.dice._$wrpRoll=e,Renderer.dice._$minRoll=n,Renderer.dice._$head=t,Renderer.dice._$outRoll=i,Renderer.dice._$iptRoll=r,$(`body`).append(n).append(e),e.on("click",".out-roll-item-code",e=>Renderer.dice._$iptRoll.val($(e.target).text()).focus()),Renderer.dice.storage=(await StorageUtil.pGet(ROLLER_MACRO_STORAGE))||{}},_prevHistory:()=>{Renderer.dice._histIndex--,Renderer.dice._cleanHistoryIndex(),Renderer.dice._$iptRoll.val(Renderer.dice._hist[Renderer.dice._histIndex])},_nextHistory:()=>{Renderer.dice._histIndex++,Renderer.dice._cleanHistoryIndex(),Renderer.dice._$iptRoll.val(Renderer.dice._hist[Renderer.dice._histIndex])},_cleanHistoryIndex:()=>{var e=Math.min,n=Math.max;Renderer.dice._histIndex=Renderer.dice._hist.length?e(Renderer.dice._hist.length,n(Renderer.dice._histIndex,0)):null},_addHistory:e=>{Renderer.dice._hist.push(e),Renderer.dice._histIndex=Renderer.dice._hist.length},_scrollBottom:()=>{Renderer.dice._$outRoll.scrollTop(1e10)},_contextRollLabel:"rollChooser",_contextPromptLabel:"rollPrompt",async pRollerClickUseData(e,n){const t=$(n),i=t.data("packed-dice");let r=t.data("roll-name"),d=e.shiftKey,s=e.ctrlKey;const a=i.toRoll.split(";").map(e=>e.trim()).filter(Boolean);let o;if(o=1<a.length?await new Promise(t=>{const r=MiscUtil.copy(i);ContextUtil.doInitContextMenu(Renderer.dice._contextRollLabel,(e,n,i,o,l)=>{d=d||e.shiftKey,s=s||e.ctrlKey,r.toRoll=a[l],t(r)},[new ContextUtil.Action("Choose Roll",null,{isDisabled:!0}),null,...a.map(e=>`Roll ${e}`)]),ContextUtil.handleOpenContextMenu(e,n,Renderer.dice._contextRollLabel,e=>{e||t()})}):i,!o)return;const l=/#\$prompt_number:?([^$]*)\$#/g,c=[];for(let t;t=l.exec(o.toRoll);){const e=t[1],n={};if(e){const t=e.split(",");t.map(e=>e.trim()).forEach(e=>{const[t,i]=e.split("=").map(e=>e.trim());n[t]="min"===t||"max"===t?+i:i})}null==n.min&&(n.min=0),null==n.max&&(n.max=Renderer.dice.POS_INFINITE),null==n.default&&(n.default=0);const i=await InputUiUtil.pGetUserNumber(n);if(null==i)return;c.push(i)}const u=MiscUtil.copy(o);l.lastIndex=0,u.toRoll=u.toRoll.replace(l,()=>c.shift());let p;p=i.prompt?await new Promise(t=>{const i=Object.keys(u.prompt.options).sort(SortUtil.ascSortLower);ContextUtil.doInitContextMenu(Renderer.dice._contextPromptLabel,(e,n,a,o,l)=>{null==l&&t(),d=d||e.shiftKey,s=s||e.ctrlKey;const c=i[l],p=u.prompt.options[c];p?(r="psi"===u.prompt.mode?`${c} psi activation`:`${Parser.spLevelToFull(c)}-level cast`,u.toRoll+=`+${p}`,t(u)):(r="",t(u))},[new ContextUtil.Action(u.prompt.entry,null,{isDisabled:!0}),null,...i.map(e=>"psi"===u.prompt.mode?`${e} point${"1"===e?"":"s"}`:`${Parser.spLevelToFull(e)} level`)]),ContextUtil.handleOpenContextMenu(e,n,Renderer.dice._contextPromptLabel,e=>{e||t()})}):u,p&&Renderer.dice.rollerClick({shiftKey:d,ctrlKey:s},n,JSON.stringify(p),r)},__rerollNextInlineResult(e){const n=$(e),t=n.next(`.result`),i=Renderer.dice.__rollPackedData(n);t.text(i)},__rollPackedData(e){const n=Renderer.dice.lang.getTree3(e.data("packed-dice").toRoll);return n.evl({})},rollerClick(e,n,t,i){const r=$(n),d=JSON.parse(t),s={name:function(){const e=r.closest(`.hwin`);if(e.length)return e.find(`.stats-name`).first().text();const n=r.closest(`.out-roll-wrp`);if(n.length)return n.data("name");const t=r.closest(`.dm-screen-panel`).children(`.panel-control-title`);if(t.length)return t.text().trim();let i=document.title.replace("- 5etools","").trim();return"DM Screen"===i?"Dungeon Master":i}(),label:null==i?function(){let e=$(n).closest(`table:not(.stats)`).children(`caption`).text();return e?e.trim():(e=$(n).parent().children(`.list-item-title`).text(),e)?e.trim():(e=$(n).closest(`div`).children(`.rd__h`).first().find(`.entry-title-inner`).text(),e)?(e=e.trim().replace(/[.,:]\s*$/,""),e):(e=$(n).closest(`table.stats`).children(`tbody`).first().children(`tr`).first().find(`th.name .stats-name`).text(),e?e.trim():UrlUtil.getCurrentPage()===UrlUtil.PG_CHARACTERS&&(e=($(n).closest(`.chr-entity__row`).find(".chr-entity__ipt-name").val()||"").trim(),e)?e:e)}(n):i},a=Renderer.dice.getEventModifiedRollMeta(e,d);let o=r.parent();for(;o.length&&!(o.is("th")||o.is("p")||o.is("table"));)o=o.parent();o.is("th")&&"true"===o.attr("data-isroller")?Renderer.dice.pRollEntry(a.entry,s,{fnGetMessage:function(n){const t=r.closest(`table`),i=t.find(`td`).filter((r,i)=>{const e=$(i);return!!e.closest(`table`).is(t)&&n>=+e.data("roll-min")&&n<=+e.data("roll-max")});if(i.length&&i.nextAll().length){const e=i.nextAll().get().map(e=>e.innerHTML.trim()).filter(e=>e).join(" | "),n=$(`<span class="message">${e}</span>`);return n.find(`.render-roller`).each((n,t)=>{const e=$(t),i=Renderer.dice.__rollPackedData(e);e.attr("onclick",`Renderer.dice.__rerollNextInlineResult(this)`),e.after(` (<span class="result">${i}</span>)`)}),n.html()}return`<span class="message">No result found matching roll ${n}?! <span class="help--subtle" title="Bug!">🐛</span></span>`},rollCount:a.rollCount}):Renderer.dice.pRollEntry(a.entry,s,{rollCount:a.rollCount})},getEventModifiedRollMeta(e,n){const t={rollCount:1,entry:n};if(e.shiftKey)if("damage"===n.subType){const e=[];n.toRoll.replace(/\s+/g,"").replace(/\d*?d\d+/gi,n=>e.push(n)),n.toRoll=`${n.toRoll}${e.length?`+${e.join("+")}`:""}`}else"d20"===n.subType?n.toRoll=null==n.d20mod?n.toRoll.replace(/^\s*1?\s*d\s*20/,"2d20dl1"):`2d20dl1${n.d20mod}`:t.rollCount=2;return e.ctrlKey&&("damage"===n.subType?n.toRoll=`floor((${n.toRoll}) / 2)`:"d20"===n.subType?null==n.d20mod?n.toRoll=n.toRoll.replace(/^\s*1?\s*d\s*20/,"2d20dh1"):n.toRoll=`2d20dh1${n.d20mod}`:t.rollCount=2),t},async pRoll2(e,n,t){if(t=t||{},e=e.trim(),!!e)if(n.user&&Renderer.dice._addHistory(e),e.startsWith("/"))Renderer.dice._handleCommand(e,n);else if(e.startsWith("#"))return Renderer.dice._pHandleSavedRoll(e,n,t);else{const[i,...r]=e.split(":");r.length&&(e=r.join(":"),n.label=i);const d=Renderer.dice.lang.getTree3(e);return Renderer.dice._pHandleRoll2(d,n,t)}},async pRollEntry(e,n,t){var i=Math.round;t=t||{};const r=i(t.rollCount||1);if(delete t.rollCount,0>=r)throw new Error(`Invalid roll count: ${r} (must be a positive integer)`);const d=Renderer.dice.lang.getTree3(e.toRoll);d.successThresh=e.successThresh,d.successMax=e.successMax;let s=null;1<r&&Renderer.dice._showMessage(`Rolling twice...`,n);for(let a=0;a<r;++a)if(s=await Renderer.dice._pHandleRoll2(d,n,t),null==s)return null;return s},_pHandleRoll2(e,n,t){return t=t||{},Renderer.dice._isManualMode?Renderer.dice._pHandleRoll2_manual(e,n,t):Renderer.dice._pHandleRoll2_automatic(e,n,t)},_pHandleRoll2_automatic(e,n,t){t=t||{},Renderer.dice._showBox(),Renderer.dice._checkHandleName(n.name);const i=Renderer.dice._$lastRolledBy;if(e){const r={},d=e.evl(r),s=(r.html||[]).join(""),a=r.allMax&&r.allMax.length&&!r.allMax.filter(e=>!e).length,o=r.allMin&&r.allMin.length&&!r.allMin.filter(e=>!e).length,l=n.label&&(!n.name||n.label.trim().toLowerCase()!==n.name.trim().toLowerCase())?n.label:null,c=e.successThresh?`<span class="roll">${d>(e.successMax||100)-e.successThresh?"Success!":"Failure"}</span>`:`<span class="roll ${a?"roll-max":o?"roll-min":""}">${d}</span>`,u=`${n.name?`${n.name} \u2014 `:""}${l?`${l}: `:""}${e}`;return i.append(`
				<div class="out-roll-item" title="${u}">
					<div>
						${l?`<span class="roll-label">${l}: </span>`:""}
						${c}
						<span class="all-rolls text-muted">${s}</span>
						${t.fnGetMessage?`<span class="message">${t.fnGetMessage(d)}</span>`:""}
					</div>
					<div class="out-roll-item-button-wrp">
						<button title="Copy to input" class="btn btn-default btn-xs btn-copy-roll" onclick="Renderer.dice._$iptRoll.val('${e.toString().replace(/\s+/g,"")}'); Renderer.dice._$iptRoll.focus()"><span class="glyphicon glyphicon-pencil"></span></button>
					</div>
				</div>`),ExtensionUtil.doSendRoll({dice:e.toString(),rolledBy:n.name,label:l}),Renderer.dice._scrollBottom(),d}return i.append(`<div class="out-roll-item">Invalid input! Try &quot;/help&quot;</div>`),Renderer.dice._scrollBottom(),null},_pHandleRoll2_manual(e,n,t){if(t=t||{},!e)return JqueryUtil.doToast({type:"danger",content:`Invalid roll input!`});const i=(n.label||"").toTitleCase()||"Roll Dice",r=$(`<div class="p-2 bold flex-vh-center rll__prompt-header">${e.toString()}</div>`);if(t.isResultUsed)return InputUiUtil.pGetUserNumber({title:i,$elePre:r});else{const{$modalInner:e}=UiUtil.getShowModal({title:i,noMinHeight:!0});return r.appendTo(e),null}},_showMessage(e,n){Renderer.dice._showBox(),Renderer.dice._checkHandleName(n.name);const t=Renderer.dice._$lastRolledBy;t.append(`<div class="out-roll-item out-roll-item--message">${e}</div>`),Renderer.dice._scrollBottom()},_validCommands:new Set(["/c","/cls","/clear"]),_handleCommand(e,n){function t(){Renderer.dice._showMessage("Invalid input! Try &quot;/help&quot;",Renderer.dice.SYSTEM_USER)}function i(e,n){return e.length===n}async function r(){await StorageUtil.pSet(ROLLER_MACRO_STORAGE,Renderer.dice.storage)}Renderer.dice._showMessage(`<span class="out-roll-item-code">${e}</span>`,n);if("/help"===e||"/h"===e)Renderer.dice._showMessage(`<ul class="rll__list">
					<li>Keep highest; <span class="out-roll-item-code">4d6kh3</span></li>
					<li>Drop lowest; <span class="out-roll-item-code">4d6dl1</span></li>
					<li>Drop highest; <span class="out-roll-item-code">3d4dh1</span></li>
					<li>Keep lowest; <span class="out-roll-item-code">3d4kl1</span></li>

					<li>Reroll equal; <span class="out-roll-item-code">2d4r1</span></li>
					<li>Reroll less; <span class="out-roll-item-code">2d4r&lt;2</span></li>
					<li>Reroll less or equal; <span class="out-roll-item-code">2d4r&lt;=2</span></li>
					<li>Reroll greater; <span class="out-roll-item-code">2d4r&gt;2</span></li>
					<li>Reroll greater equal; <span class="out-roll-item-code">2d4r&gt;=3</span></li>

					<li>Explode equal; <span class="out-roll-item-code">2d4x4</span></li>
					<li>Explode less; <span class="out-roll-item-code">2d4x&lt;2</span></li>
					<li>Explode less or equal; <span class="out-roll-item-code">2d4x&lt;=2</span></li>
					<li>Explode greater; <span class="out-roll-item-code">2d4x&gt;2</span></li>
					<li>Explode greater equal; <span class="out-roll-item-code">2d4x&gt;=3</span></li>

					<li>Count Successes equal; <span class="out-roll-item-code">2d4cs=4</span></li>
					<li>Count Successes less; <span class="out-roll-item-code">2d4cs&lt;2</span></li>
					<li>Count Successes less or equal; <span class="out-roll-item-code">2d4cs&lt;=2</span></li>
					<li>Count Successes greater; <span class="out-roll-item-code">2d4cs&gt;2</span></li>
					<li>Count Successes greater equal; <span class="out-roll-item-code">2d4cs&gt;=3</span></li>

					<li>Dice pools; <span class="out-roll-item-code">{2d8, 1d6}</span></li>
					<li>Dice pools with modifiers; <span class="out-roll-item-code">{1d20+7, 10}kh1</span></li>

					<li>Rounding; <span class="out-roll-item-code">floor(1.5)</span>, <span class="out-roll-item-code">ceil(1.5)</span>, <span class="out-roll-item-code">round(1.5)</span></li>

					<li>Average; <span class="out-roll-item-code">avg(8d6)</span></li>
				</ul>
				Up and down arrow keys cycle input history.<br>
				Anything before a colon is treated as a label (<span class="out-roll-item-code">Fireball: 8d6</span>)<br>
Use <span class="out-roll-item-code">${"/macro"} list</span> to list saved macros.<br>
				Use <span class="out-roll-item-code">${"/macro"} add myName 1d2+3</span> to add (or update) a macro. Macro names should not contain spaces or hashes.<br>
				Use <span class="out-roll-item-code">${"/macro"} remove myName</span> to remove a macro.<br>
				Use <span class="out-roll-item-code">#myName</span> to roll a macro.<br>
				Use <span class="out-roll-item-code">/clear</span> to clear the roller.`,Renderer.dice.SYSTEM_USER);else if(e.startsWith("/macro")){const[n,d,...s]=e.split(/\s+/);if(!["list","add","remove","clear"].includes(d))t();else switch(d){case"list":i(s,0)?Object.keys(Renderer.dice.storage).forEach(e=>{Renderer.dice._showMessage(`<span class="out-roll-item-code">#${e}</span> \u2014 ${Renderer.dice.storage[e]}`,Renderer.dice.SYSTEM_USER)}):t();break;case"add":{if(i(s,2)){const[e,n]=s;e.includes(" ")||e.includes("#")?t():(Renderer.dice.storage[e]=n,r().then(()=>Renderer.dice._showMessage(`Saved macro <span class="out-roll-item-code">#${e}</span>`,Renderer.dice.SYSTEM_USER)))}else t();break}case"remove":i(s,1)?Renderer.dice.storage[s[0]]?(delete Renderer.dice.storage[s[0]],r().then(()=>Renderer.dice._showMessage(`Removed macro <span class="out-roll-item-code">#${s[0]}</span>`,Renderer.dice.SYSTEM_USER))):Renderer.dice._showMessage(`Macro <span class="out-roll-item-code">#${s[0]}</span> not found`,Renderer.dice.SYSTEM_USER):t();}}else Renderer.dice._validCommands.has(e)?"/c"===e||"/cls"===e||"/clear"===e?(Renderer.dice._$outRoll.empty(),Renderer.dice._$lastRolledBy.empty(),Renderer.dice._$lastRolledBy=null):void 0:t()},_pHandleSavedRoll(e,n,t){e=e.replace(/^#/,"");const i=Renderer.dice.storage[e];if(i){n.label=e;const r=Renderer.dice.lang.getTree3(i);return Renderer.dice._pHandleRoll2(r,n,t)}Renderer.dice._showMessage(`Macro <span class="out-roll-item-code">#${e}</span> not found`,Renderer.dice.SYSTEM_USER)},addRoll(e,n){n.trim()&&(Renderer.dice._showBox(),Renderer.dice._checkHandleName(e.name),Renderer.dice._$outRoll.prepend(`<div class="out-roll-item" title="${e.name||""}">${n}</div>`),Renderer.dice._scrollBottom())},addElement(e,n){Renderer.dice._showBox(),Renderer.dice._checkHandleName(e.name),$$`<div class="out-roll-item out-roll-item--message">${n}</div>`.appendTo(Renderer.dice._$lastRolledBy),Renderer.dice._scrollBottom()},_checkHandleName(e){Renderer.dice._$lastRolledBy&&Renderer.dice._$lastRolledBy.data("name")===e||(Renderer.dice._$outRoll.prepend(`<div class="text-muted out-roll-id">${e}</div>`),Renderer.dice._$lastRolledBy=$(`<div class="out-roll-wrp"/>`).data("name",e),Renderer.dice._$outRoll.prepend(Renderer.dice._$lastRolledBy))}},Renderer.dice.lang={validate3(e){e=e.trim();let n;try{n=Renderer.dice.lang._lex3(e)}catch(n){return n.message}try{Renderer.dice.lang._parse3(n)}catch(n){return n.message}return null},getTree3(e,n=!0){if(e=e.trim(),n)try{const n=Renderer.dice.lang._lex3(e);return Renderer.dice.lang._parse3(n)}catch(n){return null}else{const n=Renderer.dice.lang._lex3(e);return Renderer.dice.lang._parse3(n)}},_M_NUMBER_CHAR:/[0-9.]/,_M_SYMBOL_CHAR:/[-+/*^=><florceidhkxunavgs,]/,_M_NUMBER:/^[\d.,]+$/,_lex3(e){const n={tokenStack:[],parenCount:0,braceCount:0,mode:null,token:""};return(e=e.trim().toLowerCase().replace(/\s+/g,"").replace(/[×]/g,"*").replace(/\*\*/g,"^").replace(/÷/g,"/").replace(/--/g,"+").replace(/\+-|-\+/g,"-"),!e)?[]:(this._lex3_lex(n,e),n.tokenStack)},_lex3_lex(e,n){const t=n.length;for(let r=0;r<t;++r){const t=n[r];switch(t){case"(":e.parenCount++,this._lex3_outputToken(e),e.token="(",this._lex3_outputToken(e);break;case")":if(e.parenCount--,0>e.parenCount)throw new Error(`Syntax error: closing <code>)</code> without opening <code>(</code>`);this._lex3_outputToken(e),e.token=")",this._lex3_outputToken(e);break;case"{":e.braceCount++,this._lex3_outputToken(e),e.token="{",this._lex3_outputToken(e);break;case"}":if(e.braceCount--,0>e.parenCount)throw new Error(`Syntax error: closing <code>}</code> without opening <code>(</code>`);this._lex3_outputToken(e),e.token="}",this._lex3_outputToken(e);break;case"+":case"-":case"*":case"/":case"^":case",":this._lex3_outputToken(e),e.token+=t,this._lex3_outputToken(e);break;default:{if(Renderer.dice.lang._M_NUMBER_CHAR.test(t))"symbol"===e.mode&&this._lex3_outputToken(e),e.token+=t,e.mode="text";else if(Renderer.dice.lang._M_SYMBOL_CHAR.test(t))"text"===e.mode&&this._lex3_outputToken(e),e.token+=t,e.mode="symbol";else throw new Error(`Syntax error: unexpected character <code>${t}</code>`);break}}}this._lex3_outputToken(e)},_lex3_outputToken(e){if(e.token){switch(e.token){case"(":e.tokenStack.push(Renderer.dice.tk.PAREN_OPEN);break;case")":e.tokenStack.push(Renderer.dice.tk.PAREN_CLOSE);break;case"{":e.tokenStack.push(Renderer.dice.tk.BRACE_OPEN);break;case"}":e.tokenStack.push(Renderer.dice.tk.BRACE_CLOSE);break;case",":e.tokenStack.push(Renderer.dice.tk.SET_SEPARATOR);break;case"+":e.tokenStack.push(Renderer.dice.tk.ADD);break;case"-":e.tokenStack.push(Renderer.dice.tk.SUB);break;case"*":e.tokenStack.push(Renderer.dice.tk.MULT);break;case"/":e.tokenStack.push(Renderer.dice.tk.DIV);break;case"^":e.tokenStack.push(Renderer.dice.tk.POW);break;case"floor":e.tokenStack.push(Renderer.dice.tk.FLOOR);break;case"ceil":e.tokenStack.push(Renderer.dice.tk.CEIL);break;case"round":e.tokenStack.push(Renderer.dice.tk.ROUND);break;case"avg":e.tokenStack.push(Renderer.dice.tk.AVERAGE);break;case"d":e.tokenStack.push(Renderer.dice.tk.DICE);break;case"dh":e.tokenStack.push(Renderer.dice.tk.DROP_HIGHEST);break;case"kh":e.tokenStack.push(Renderer.dice.tk.KEEP_HIGHEST);break;case"dl":e.tokenStack.push(Renderer.dice.tk.DROP_LOWEST);break;case"kl":e.tokenStack.push(Renderer.dice.tk.KEEP_LOWEST);break;case"r":e.tokenStack.push(Renderer.dice.tk.REROLL_EXACT);break;case"r>":e.tokenStack.push(Renderer.dice.tk.REROLL_GT);break;case"r>=":e.tokenStack.push(Renderer.dice.tk.REROLL_GTEQ);break;case"r<":e.tokenStack.push(Renderer.dice.tk.REROLL_LT);break;case"r<=":e.tokenStack.push(Renderer.dice.tk.REROLL_LTEQ);break;case"x":e.tokenStack.push(Renderer.dice.tk.EXPLODE_EXACT);break;case"x>":e.tokenStack.push(Renderer.dice.tk.EXPLODE_GT);break;case"x>=":e.tokenStack.push(Renderer.dice.tk.EXPLODE_GTEQ);break;case"x<":e.tokenStack.push(Renderer.dice.tk.EXPLODE_LT);break;case"x<=":e.tokenStack.push(Renderer.dice.tk.EXPLODE_LTEQ);break;case"cs=":e.tokenStack.push(Renderer.dice.tk.COUNT_SUCCESS_EXACT);break;case"cs>":e.tokenStack.push(Renderer.dice.tk.COUNT_SUCCESS_GT);break;case"cs>=":e.tokenStack.push(Renderer.dice.tk.COUNT_SUCCESS_GTEQ);break;case"cs<":e.tokenStack.push(Renderer.dice.tk.COUNT_SUCCESS_LT);break;case"cs<=":e.tokenStack.push(Renderer.dice.tk.COUNT_SUCCESS_LTEQ);break;default:if(Renderer.dice.lang._M_NUMBER.test(e.token)){if(2<e.token.split(Parser._decimalSeparator).length)throw new Error(`Syntax error: too many decimal separators <code>${e.token}</code>`);e.tokenStack.push(Renderer.dice.tk.NUMBER(e.token))}else throw new Error(`Syntax error: unexpected token <code>${e.token}</code>`);}e.token=""}},_parse3(e){const n={ixSym:-1,syms:e,sym:null,lastAccepted:null};return this._parse3_nextSym(n),this._parse3_expression(n)},_parse3_nextSym(e){const n=e.syms[e.ixSym];return e.ixSym++,e.sym=e.syms[e.ixSym],n},_parse3_match(e,n){return null!=e.sym&&(n.type&&(n=n.type),e.sym.type===n)},_parse3_accept(e,n){if(this._parse3_match(e,n)){const n=e.sym;return this._parse3_nextSym(e),e.lastAccepted=n,n}return!1},_parse3_expect(e,n){const t=this._parse3_accept(e,n);if(t)return t;if(e.sym)throw new Error(`Unexpected input: Expected <code>${n}</code> but found <code>${e.sym}</code>`);else throw new Error(`Unexpected end of input: Expected <code>${n}</code>`)},_parse3_factor(e){if(this._parse3_accept(e,Renderer.dice.tk.TYP_NUMBER))return new Renderer.dice.parsed.Factor(e.lastAccepted);if(this._parse3_match(e,Renderer.dice.tk.FLOOR)||this._parse3_match(e,Renderer.dice.tk.CEIL)||this._parse3_match(e,Renderer.dice.tk.ROUND)||this._parse3_match(e,Renderer.dice.tk.AVERAGE)){const n=[];return n.push(this._parse3_nextSym(e)),this._parse3_expect(e,Renderer.dice.tk.PAREN_OPEN),n.push(this._parse3_expression(e)),this._parse3_expect(e,Renderer.dice.tk.PAREN_CLOSE),new Renderer.dice.parsed.Function(n)}if(this._parse3_accept(e,Renderer.dice.tk.PAREN_OPEN)){const n=this._parse3_expression(e);return this._parse3_expect(e,Renderer.dice.tk.PAREN_CLOSE),new Renderer.dice.parsed.Factor(n,{hasParens:!0})}if(this._parse3_accept(e,Renderer.dice.tk.BRACE_OPEN)){const n=[this._parse3_expression(e)];for(;this._parse3_accept(e,Renderer.dice.tk.SET_SEPARATOR);)n.push(this._parse3_expression(e));this._parse3_expect(e,Renderer.dice.tk.BRACE_CLOSE);const t=[];return this._parse3__dice_modifiers(e,t),new Renderer.dice.parsed.Pool(n,t)}if(e.sym)throw new Error(`Unexpected input: <code>${e.sym}</code>`);else throw new Error(`Unexpected end of input`)},_parse3_dice(e){const n=[];for(this._parse3_match(e,Renderer.dice.tk.DICE)?n.push(new Renderer.dice.parsed.Factor(Renderer.dice.tk.NUMBER(1))):n.push(this._parse3_factor(e));this._parse3_match(e,Renderer.dice.tk.DICE);)this._parse3_nextSym(e),n.push(this._parse3_factor(e)),this._parse3__dice_modifiers(e,n);return new Renderer.dice.parsed.Dice(n)},_parse3__dice_modifiers(e,n){(this._parse3_match(e,Renderer.dice.tk.DROP_HIGHEST)||this._parse3_match(e,Renderer.dice.tk.KEEP_HIGHEST)||this._parse3_match(e,Renderer.dice.tk.DROP_LOWEST)||this._parse3_match(e,Renderer.dice.tk.KEEP_LOWEST)||this._parse3_match(e,Renderer.dice.tk.REROLL_EXACT)||this._parse3_match(e,Renderer.dice.tk.REROLL_GT)||this._parse3_match(e,Renderer.dice.tk.REROLL_GTEQ)||this._parse3_match(e,Renderer.dice.tk.REROLL_LT)||this._parse3_match(e,Renderer.dice.tk.REROLL_LTEQ)||this._parse3_match(e,Renderer.dice.tk.EXPLODE_EXACT)||this._parse3_match(e,Renderer.dice.tk.EXPLODE_GT)||this._parse3_match(e,Renderer.dice.tk.EXPLODE_GTEQ)||this._parse3_match(e,Renderer.dice.tk.EXPLODE_LT)||this._parse3_match(e,Renderer.dice.tk.EXPLODE_LTEQ)||this._parse3_match(e,Renderer.dice.tk.COUNT_SUCCESS_EXACT)||this._parse3_match(e,Renderer.dice.tk.COUNT_SUCCESS_GT)||this._parse3_match(e,Renderer.dice.tk.COUNT_SUCCESS_GTEQ)||this._parse3_match(e,Renderer.dice.tk.COUNT_SUCCESS_LT)||this._parse3_match(e,Renderer.dice.tk.COUNT_SUCCESS_LTEQ))&&(n.push(this._parse3_nextSym(e)),n.push(this._parse3_factor(e)))},_parse3_exponent(e){const n=[this._parse3_dice(e)];for(;this._parse3_match(e,Renderer.dice.tk.POW);)this._parse3_nextSym(e),n.push(this._parse3_dice(e));return new Renderer.dice.parsed.Exponent(n)},_parse3_term(e){const n=[this._parse3_exponent(e)];for(;this._parse3_match(e,Renderer.dice.tk.MULT)||this._parse3_match(e,Renderer.dice.tk.DIV);)n.push(this._parse3_nextSym(e)),n.push(this._parse3_exponent(e));return new Renderer.dice.parsed.Term(n)},_parse3_expression(e){const n=[];for((this._parse3_match(e,Renderer.dice.tk.ADD)||this._parse3_match(e,Renderer.dice.tk.SUB))&&n.push(this._parse3_nextSym(e)),n.push(this._parse3_term(e));this._parse3_match(e,Renderer.dice.tk.ADD)||this._parse3_match(e,Renderer.dice.tk.SUB);)n.push(this._parse3_nextSym(e)),n.push(this._parse3_term(e));return new Renderer.dice.parsed.Expression(n)}},Renderer.dice.tk={Token:class{constructor(e,n,t,i){i=i||{},this.type=e,this.value=n,this._asString=t,i.isDiceModifier&&(this.isDiceModifier=!0),i.isSuccessMode&&(this.isSuccessMode=!0)}eq(e){return e&&e.type===this.type}toString(){return this._asString?this._asString:this.toDebugString()}toDebugString(){return`${this.type}${this.value?` :: ${this.value}`:""}`}},_new(e,n,t){return new Renderer.dice.tk.Token(e,null,n,t)},TYP_NUMBER:"NUMBER",TYP_DICE:"DICE",TYP_SYMBOL:"SYMBOL",NUMBER(e){return new Renderer.dice.tk.Token(Renderer.dice.tk.TYP_NUMBER,e)}},Renderer.dice.tk.PAREN_OPEN=Renderer.dice.tk._new("PAREN_OPEN","("),Renderer.dice.tk.PAREN_CLOSE=Renderer.dice.tk._new("PAREN_CLOSE",")"),Renderer.dice.tk.BRACE_OPEN=Renderer.dice.tk._new("BRACE_OPEN","{"),Renderer.dice.tk.BRACE_CLOSE=Renderer.dice.tk._new("BRACE_CLOSE","}"),Renderer.dice.tk.SET_SEPARATOR=Renderer.dice.tk._new("SET_SEPARATOR",","),Renderer.dice.tk.ADD=Renderer.dice.tk._new("ADD","+"),Renderer.dice.tk.SUB=Renderer.dice.tk._new("SUB","-"),Renderer.dice.tk.MULT=Renderer.dice.tk._new("MULT","*"),Renderer.dice.tk.DIV=Renderer.dice.tk._new("DIV","/"),Renderer.dice.tk.POW=Renderer.dice.tk._new("POW","^"),Renderer.dice.tk.FLOOR=Renderer.dice.tk._new("FLOOR","floor"),Renderer.dice.tk.CEIL=Renderer.dice.tk._new("CEIL","ceil"),Renderer.dice.tk.ROUND=Renderer.dice.tk._new("ROUND","round"),Renderer.dice.tk.AVERAGE=Renderer.dice.tk._new("AVERAGE","avg"),Renderer.dice.tk.DICE=Renderer.dice.tk._new("DICE","d"),Renderer.dice.tk.DROP_HIGHEST=Renderer.dice.tk._new("DH","dh",{isDiceModifier:!0}),Renderer.dice.tk.KEEP_HIGHEST=Renderer.dice.tk._new("KH","kh",{isDiceModifier:!0}),Renderer.dice.tk.DROP_LOWEST=Renderer.dice.tk._new("DL","dl",{isDiceModifier:!0}),Renderer.dice.tk.KEEP_LOWEST=Renderer.dice.tk._new("KL","kl",{isDiceModifier:!0}),Renderer.dice.tk.REROLL_EXACT=Renderer.dice.tk._new("REROLL","r",{isDiceModifier:!0}),Renderer.dice.tk.REROLL_GT=Renderer.dice.tk._new("REROLL_GT","r>",{isDiceModifier:!0}),Renderer.dice.tk.REROLL_GTEQ=Renderer.dice.tk._new("REROLL_GTEQ","r>=",{isDiceModifier:!0}),Renderer.dice.tk.REROLL_LT=Renderer.dice.tk._new("REROLL_LT","r<",{isDiceModifier:!0}),Renderer.dice.tk.REROLL_LTEQ=Renderer.dice.tk._new("REROLL_LTEQ","r<=",{isDiceModifier:!0}),Renderer.dice.tk.EXPLODE_EXACT=Renderer.dice.tk._new("EXPLODE","x",{isDiceModifier:!0}),Renderer.dice.tk.EXPLODE_GT=Renderer.dice.tk._new("EXPLODE_GT","x>",{isDiceModifier:!0}),Renderer.dice.tk.EXPLODE_GTEQ=Renderer.dice.tk._new("EXPLODE_GTEQ","x>=",{isDiceModifier:!0}),Renderer.dice.tk.EXPLODE_LT=Renderer.dice.tk._new("EXPLODE_LT","x<",{isDiceModifier:!0}),Renderer.dice.tk.EXPLODE_LTEQ=Renderer.dice.tk._new("EXPLODE_LTEQ","x<=",{isDiceModifier:!0}),Renderer.dice.tk.COUNT_SUCCESS_EXACT=Renderer.dice.tk._new("COUNT_SUCCESS_EXACT","cs=",{isDiceModifier:!0,isSuccessMode:!0}),Renderer.dice.tk.COUNT_SUCCESS_GT=Renderer.dice.tk._new("COUNT_SUCCESS_GT","cs>",{isDiceModifier:!0,isSuccessMode:!0}),Renderer.dice.tk.COUNT_SUCCESS_GTEQ=Renderer.dice.tk._new("COUNT_SUCCESS_GTEQ","cs>=",{isDiceModifier:!0,isSuccessMode:!0}),Renderer.dice.tk.COUNT_SUCCESS_LT=Renderer.dice.tk._new("COUNT_SUCCESS_LT","cs<",{isDiceModifier:!0,isSuccessMode:!0}),Renderer.dice.tk.COUNT_SUCCESS_LTEQ=Renderer.dice.tk._new("COUNT_SUCCESS_LTEQ","cs<=",{isDiceModifier:!0,isSuccessMode:!0}),Renderer.dice.AbstractSymbol=class{constructor(){this.type=Renderer.dice.tk.TYP_SYMBOL}eq(e){return e&&this.type===e.type}evl(){throw new Error("Unimplemented!")}avg(){throw new Error("Unimplemented!")}min(){throw new Error("Unimplemented!")}max(){throw new Error("Unimplemented!")}toString(){throw new Error("Unimplemented!")}addToMeta(e,n,t){e&&(t=t||n,e.html=e.html||[],e.text=e.text||[],e.html.push(n),e.text.push(t))}},Renderer.dice.parsed={_PARTITION_EQ:(e,n)=>e===n,_PARTITION_GT:(e,n)=>e>n,_PARTITION_GTEQ:(e,n)=>e>=n,_PARTITION_LT:(e,n)=>e<n,_PARTITION_LTEQ:(e,n)=>e<=n,_handleModifiers(e,n,t,i,r){r=r||{};const d=t.slice();t.sort(SortUtil.ascSortProp.bind(null,"val")).reverse();const[s,a]=i,o=a[e]();switch(s.type){case Renderer.dice.tk.DROP_HIGHEST.type:case Renderer.dice.tk.KEEP_HIGHEST.type:case Renderer.dice.tk.DROP_LOWEST.type:case Renderer.dice.tk.KEEP_LOWEST.type:{const e=s.type.endsWith("H"),n=e?o:t.length-o,i=t.slice(0,n),r=t.slice(n,t.length);switch(s.type){case Renderer.dice.tk.DROP_HIGHEST.type:case Renderer.dice.tk.KEEP_LOWEST.type:i.forEach(e=>e.isDropped=!0);break;case Renderer.dice.tk.KEEP_HIGHEST.type:case Renderer.dice.tk.DROP_LOWEST.type:r.forEach(e=>e.isDropped=!0);break;default:throw new Error(`Unimplemented!`);}break}case Renderer.dice.tk.REROLL_EXACT.type:case Renderer.dice.tk.REROLL_GT.type:case Renderer.dice.tk.REROLL_GTEQ.type:case Renderer.dice.tk.REROLL_LT.type:case Renderer.dice.tk.REROLL_LTEQ.type:{let e;switch(s.type){case Renderer.dice.tk.REROLL_EXACT.type:e=Renderer.dice.parsed._PARTITION_EQ;break;case Renderer.dice.tk.REROLL_GT.type:e=Renderer.dice.parsed._PARTITION_GT;break;case Renderer.dice.tk.REROLL_GTEQ.type:e=Renderer.dice.parsed._PARTITION_GTEQ;break;case Renderer.dice.tk.REROLL_LT.type:e=Renderer.dice.parsed._PARTITION_LT;break;case Renderer.dice.tk.REROLL_LTEQ.type:e=Renderer.dice.parsed._PARTITION_LTEQ;break;default:throw new Error(`Unimplemented!`);}const n=t.filter(n=>e(n.val,o));n.forEach(e=>e.isDropped=!0);const i=r.fnGetRerolls(n);t.push(...i),d.push(...i);break}case Renderer.dice.tk.EXPLODE_EXACT.type:case Renderer.dice.tk.EXPLODE_GT.type:case Renderer.dice.tk.EXPLODE_GTEQ.type:case Renderer.dice.tk.EXPLODE_LT.type:case Renderer.dice.tk.EXPLODE_LTEQ.type:{let e;switch(s.type){case Renderer.dice.tk.EXPLODE_EXACT.type:e=Renderer.dice.parsed._PARTITION_EQ;break;case Renderer.dice.tk.EXPLODE_GT.type:e=Renderer.dice.parsed._PARTITION_GT;break;case Renderer.dice.tk.EXPLODE_GTEQ.type:e=Renderer.dice.parsed._PARTITION_GTEQ;break;case Renderer.dice.tk.EXPLODE_LT.type:e=Renderer.dice.parsed._PARTITION_LT;break;case Renderer.dice.tk.EXPLODE_LTEQ.type:e=Renderer.dice.parsed._PARTITION_LTEQ;break;default:throw new Error(`Unimplemented!`);}let n,i=999,a=t;do{n=t.length;const[i]=a.partition(n=>!n.isExploded&&e(n.val,o));i.forEach(e=>e.isExploded=!0);const s=r.fnGetExplosions(i);a=s,t.push(...s),d.push(...s)}while(0<i--&&t.length!==n);~i||JqueryUtil.doToast({type:"warning",content:`Stopped exploding after 999 additional rolls.`});break}case Renderer.dice.tk.COUNT_SUCCESS_EXACT.type:case Renderer.dice.tk.COUNT_SUCCESS_GT.type:case Renderer.dice.tk.COUNT_SUCCESS_GTEQ.type:case Renderer.dice.tk.COUNT_SUCCESS_LT.type:case Renderer.dice.tk.COUNT_SUCCESS_LTEQ.type:{let e;switch(s.type){case Renderer.dice.tk.COUNT_SUCCESS_EXACT.type:e=Renderer.dice.parsed._PARTITION_EQ;break;case Renderer.dice.tk.COUNT_SUCCESS_GT.type:e=Renderer.dice.parsed._PARTITION_GT;break;case Renderer.dice.tk.COUNT_SUCCESS_GTEQ.type:e=Renderer.dice.parsed._PARTITION_GTEQ;break;case Renderer.dice.tk.COUNT_SUCCESS_LT.type:e=Renderer.dice.parsed._PARTITION_LT;break;case Renderer.dice.tk.COUNT_SUCCESS_LTEQ.type:e=Renderer.dice.parsed._PARTITION_LTEQ;break;default:throw new Error(`Unimplemented!`);}const n=t.filter(n=>e(n.val,o));n.forEach(e=>e.isSuccess=!0);break}default:throw new Error(`Unimplemented!`);}return d},Function:class extends Renderer.dice.AbstractSymbol{constructor(e){super(),this._nodes=e}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){const[t,i]=this._nodes;switch(t.type){case Renderer.dice.tk.FLOOR.type:{this.addToMeta(n,"floor(");const t=Math.floor(i[e](n));return this.addToMeta(n,")"),t}case Renderer.dice.tk.CEIL.type:{this.addToMeta(n,"ceil(");const t=Math.ceil(i[e](n));return this.addToMeta(n,")"),t}case Renderer.dice.tk.ROUND.type:{this.addToMeta(n,"round(");const t=Math.round(i[e](n));return this.addToMeta(n,")"),t}case Renderer.dice.tk.AVERAGE.type:return i.avg(n);default:throw new Error(`Unimplemented!`);}}toString(){let e;const[n,t]=this._nodes;switch(n.type){case Renderer.dice.tk.FLOOR.type:e="floor";break;case Renderer.dice.tk.CEIL.type:e="ceil";break;case Renderer.dice.tk.ROUND.type:e="round";break;case Renderer.dice.tk.AVERAGE.type:e="avg";break;default:throw new Error(`Unimplemented!`);}return e+=`(${t.toString()})`,e}},Pool:class extends Renderer.dice.AbstractSymbol{constructor(e,n){super(),this._nodesPool=e,this._nodesMod=n}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){var t=Math.sum;const i=this._nodesPool.map(n=>{const t={};return{node:n,val:n[e](t),meta:t}});if(this._nodesMod.length&&i.length){const r=this._nodesMod[0].isSuccessMode,d=Renderer.dice.parsed._handleModifiers(e,n,i,this._nodesMod,{fnGetRerolls:n=>n.map(n=>{const t={};return{node:n.node,val:n.node[e](t),meta:t}}),fnGetExplosions:n=>n.map(n=>{const t={};return{node:n.node,val:n.node[e](t),meta:t}})}),s=d.map(e=>{const n=e.meta.html.join("");return e.isDropped?`<span class="rll__dropped">(${n})</span>`:e.isExploded?`<span class="rll__exploded">(</span>${n}<span class="rll__exploded">)</span>`:e.isSuccess?`<span class="rll__success">(${n})</span>`:`(${n})`}).join("+"),a=d.map(e=>`(${e.meta.text.join("")})`).join("+");return this.addToMeta(n,s,a),r?i.filter(e=>!e.isDropped&&e.isSuccess).length:t(...i.filter(e=>!e.isDropped).map(e=>e.val))}return this.addToMeta(n,`${i.map(e=>`(${e.meta.html.join("")})`).join("+")}`,`${i.map(e=>`(${e.meta.text.join("")})`).join("+")}`),t(...i.map(e=>e.val))}toString(){return`{${this._nodesPool.map(e=>e.toString()).join(", ")}}${this._nodesMod.map(e=>e.toString()).join("")}`}},Factor:class extends Renderer.dice.AbstractSymbol{constructor(e,n){super(),n=n||{},this._node=e,this._hasParens=!!n.hasParens}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){switch(this._node.type){case Renderer.dice.tk.TYP_NUMBER:return this.addToMeta(n,this.toString()),+this._node.value;case Renderer.dice.tk.TYP_SYMBOL:{this._hasParens&&this.addToMeta(n,"(");const t=this._node[e](n);return this._hasParens&&this.addToMeta(n,")"),t}default:throw new Error(`Unimplemented!`);}}toString(){let e;switch(this._node.type){case Renderer.dice.tk.TYP_NUMBER:e=this._node.value;break;case Renderer.dice.tk.TYP_SYMBOL:e=this._node.toString();break;default:throw new Error(`Unimplemented!`);}return this._hasParens?`(${e})`:e}},Dice:class extends Renderer.dice.AbstractSymbol{static _facesToValue(e,n){return"evl"===n?RollerUtil.randomise(e):"avg"===n?(e+1)/2:"min"===n?1:"max"===n?e:void 0}constructor(e){super(),this._nodes=e}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){if(1===this._nodes.length)return this._nodes[0][e](n);const t=this._nodes.slice(),i=t.shift();let r=i[e]();for(;t.length;){if(Math.round(r)!==r)throw new Error(`Number of dice to roll (${r}) was not an integer!`);const i=1===t.length||3===t.length&&t.slice(-2,-1)[0].isDiceModifier;r=Math.floor(this._invoke_handlePart(e,n,t,r,i))}return r}_invoke_handlePart(e,n,t,i,r){var d=Math.sum;const s=t.shift(),a=s[e]();if(Math.round(a)!==a)throw new Error(`Dice face count (${a}) was not an integer!`);const o=[...Array(i)].map(()=>({val:Renderer.dice.parsed.Dice._facesToValue(a,e)}));let l,c=!1;if(t.length&&t[0].isDiceModifier){if("evl"===e||"min"===e||"max"===e){c=t[0].isSuccessMode;l=Renderer.dice.parsed._handleModifiers(e,n,o,t,{fnGetRerolls:n=>[...Array(n.length)].map(()=>({val:Renderer.dice.parsed.Dice._facesToValue(a,e)})),fnGetExplosions:n=>[...Array(n.length)].map(()=>({val:Renderer.dice.parsed.Dice._facesToValue(a,e)}))})}t.shift(),t.shift()}else l=o;if(r){const e=l.map(e=>{const n=e.val===a?`<span class="rll__max--muted">${e.val}</span>`:1===e.val?`<span class="rll__min--muted">${e.val}</span>`:e.val;return e.isDropped?`<span class="rll__dropped">[${n}]</span>`:e.isExploded?`<span class="rll__exploded">[</span>${n}<span class="rll__exploded">]</span>`:e.isSuccess?`<span class="rll__success">[${n}]</span>`:`[${n}]`}).join("+"),t=l.map(e=>`[${e.val}]`).join("+");this.addToMeta(n,e,t)}if("evl"===e){const e=o.filter(e=>e.val===a&&!e.isDropped),t=o.filter(e=>1===e.val&&!e.isDropped);n.allMax=n.allMax||[],n.allMin=n.allMin||[],n.allMax.push(e.length&&e.length===o.length),n.allMin.push(t.length&&t.length===o.length)}return c?o.filter(e=>!e.isDropped&&e.isSuccess).length:d(...o.filter(e=>!e.isDropped).map(e=>e.val))}toString(){if(1===this._nodes.length)return this._nodes[0].toString();const[e,n]=this._nodes;let t=`${e.toString()}d${n.toString()}`;if(4===this._nodes.length){const[e,n]=this._nodes.slice(2);t+=`${e.toString()}${n.toString()}`}return t}},Exponent:class extends Renderer.dice.AbstractSymbol{constructor(e){super(),this._nodes=e}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){var t=Math.pow;const i=this._nodes.slice();let r=i.pop()[e](n);for(;i.length;)this.addToMeta(n,"^"),r=t(i.pop()[e](n),r);return r}toString(){const e=this._nodes.slice();let n=e.pop().toString();for(;e.length;)n=`${e.pop().toString()}^${n}`;return n}},Term:class extends Renderer.dice.AbstractSymbol{constructor(e){super(),this._nodes=e}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){let t=this._nodes[0][e](n);for(let r=1;r<this._nodes.length;r+=2)if(this._nodes[r].eq(Renderer.dice.tk.MULT))this.addToMeta(n," \xD7 "),t*=this._nodes[r+1][e](n);else if(this._nodes[r].eq(Renderer.dice.tk.DIV))this.addToMeta(n," \xF7 "),t/=this._nodes[r+1][e](n);else throw new Error(`Unimplemented!`);return t}toString(){let e=this._nodes[0].toString();for(let n=1;n<this._nodes.length;n+=2)if(this._nodes[n].eq(Renderer.dice.tk.MULT))e+=` * ${this._nodes[n+1].toString()}`;else if(this._nodes[n].eq(Renderer.dice.tk.DIV))e+=` / ${this._nodes[n+1].toString()}`;else throw new Error(`Unimplemented!`);return e}},Expression:class extends Renderer.dice.AbstractSymbol{constructor(e){super(),this._nodes=e}evl(e){return this._invoke("evl",e)}avg(e){return this._invoke("avg",e)}min(e){return this._invoke("min",e)}max(e){return this._invoke("max",e)}_invoke(e,n){const t=this._nodes.slice();let i=!1;(t[0].eq(Renderer.dice.tk.ADD)||t[0].eq(Renderer.dice.tk.SUB))&&(i=t.shift().eq(Renderer.dice.tk.SUB),i&&this.addToMeta(n,"-"));let r=t[0][e](n);i&&(r=-r);for(let d=1;d<t.length;d+=2)if(t[d].eq(Renderer.dice.tk.ADD))this.addToMeta(n," + "),r+=t[d+1][e](n);else if(t[d].eq(Renderer.dice.tk.SUB))this.addToMeta(n," - "),r-=t[d+1][e](n);else throw new Error(`Unimplemented!`);return r}toString(e=0){let n="";const t=this._nodes.slice();let i=!1;(t[0].eq(Renderer.dice.tk.ADD)||t[0].eq(Renderer.dice.tk.SUB))&&(i=t.shift().eq(Renderer.dice.tk.SUB),i&&(n+="-")),n+=t[0].toString(e);for(let r=1;r<t.length;r+=2)if(t[r].eq(Renderer.dice.tk.ADD))n+=` + ${t[r+1].toString(e)}`;else if(t[r].eq(Renderer.dice.tk.SUB))n+=` - ${t[r+1].toString(e)}`;else throw new Error(`Unimplemented!`);return n}}},IS_VTT||"undefined"==typeof window||window.addEventListener("load",Renderer.dice._pInit),Renderer.getNames=function(e,n,t){if((t=t||{},null==t.maxDepth&&(t.maxDepth=!1),null==t.depth&&(t.depth=0),!(t.typeBlacklist&&n.type&&t.typeBlacklist.has(n.type)))&&!(!1!==t.maxDepth&&t.depth>t.maxDepth))if(n.name&&e.push(Renderer.stripTags(n.name)),n.entries){let i="section"===n.type?-1:"entries"===n.type?t.depth+1:t.depth;for(const r of n.entries){const n={...t};n.depth=i,Renderer.getNames(e,r,n)}}else if(n.items)for(const i of n.items)Renderer.getNames(e,i,t)},Renderer.getNumberedNames=function(e){const n=new Renderer().setTrackTitles(!0);n.render(e);const t=n.getTrackedTitles(),i={};return Object.entries(t).forEach(([e,n])=>{n=Renderer.stripTags(n),i[n]=+e}),i},Renderer.findName=function(e){function t(e){if(e instanceof Array)for(const i of e){const e=t(i);if(e)return e}else if(e instanceof Object){if(e.name)return e.name;for(const i of Object.values(e)){const e=t(i);if(e)return e}}}return t(e)},Renderer.stripTags=function(e){let n=Renderer._stripTagLayer(e);for(;n.length!==e.length;)e=n,n=Renderer._stripTagLayer(e);return n},Renderer._stripTagLayer=function(e){if(e.includes("{@")){const n=Renderer.splitByTags(e);return n.filter(e=>e).map(e=>{if(e.startsWith("@")){let[n,t]=Renderer.splitFirstSpace(e);switch(t=t.replace(/<\$([^$]+)\$>/gi,""),n){case"@b":case"@bold":case"@i":case"@italic":case"@s":case"@strike":case"@u":case"@underline":return t;case"@h":return"Hit: ";case"@dc":return`DC ${t}`;case"@atk":return Renderer.attackTagToFull(t);case"@chance":case"@d20":case"@damage":case"@dice":case"@hit":case"@recharge":{const[e,i]=t.split("|");switch(n){case"@damage":case"@dice":return i||e.replace(/;/g,"/");case"@d20":case"@hit":return i||(()=>{const t=+e;if(isNaN(t))throw new Error(`Could not parse "${e}" as a number!`);return`${0<=t?"+":""}${t}`})();case"@recharge":{const n=+(e||6);if(isNaN(n))throw new Error(`Could not parse "${e}" as a number!`);return`(Recharge ${n}${6>n?`\u20136`:""})`}case"@chance":return i||`${e} percent`;}throw new Error(`Unhandled tag: ${n}`)}case"@comic":case"@comicH1":case"@comicH2":case"@comicH3":case"@comicH4":case"@comicNote":case"@note":case"@sense":case"@skill":return t;case"@5etools":case"@adventure":case"@book":case"@filter":case"@footnote":case"@link":case"@scaledice":case"@scaledamage":case"@loader":case"@color":case"@highlight":{const e=t.split("|");return e[0]}case"@area":{const[e,n,i,...r]=t.split("|");return i&&i.includes("x")?e:`${i&&i.includes("u")?"A":"a"}rea ${e}`}case"@action":case"@background":case"@boon":case"@class":case"@condition":case"@creature":case"@cult":case"@disease":case"@feat":case"@hazard":case"@item":case"@language":case"@object":case"@optfeature":case"@psionic":case"@race":case"@reward":case"@vehicle":case"@spell":case"@table":case"@trap":case"@variantrule":{const e=t.split("|");return 3<=e.length?e[2]:e[0]}case"@deity":{const e=t.split("|");return 4<=e.length?e[3]:e[0]}case"@homebrew":{const[e,n]=t.split("|");if(e&&n)return`${e} [this is a homebrew addition, replacing the following: "${n}"]`;if(e)return`${e} [this is a homebrew addition]`;if(n)return`[the following text has been removed due to homebrew: ${n}]`;throw new Error(`Homebrew tag had neither old nor new text!`)}default:throw new Error(`Unhandled tag: "${n}"`);}}else return e}).join("")}return e},Renderer.isRollableTable=function(e){let n=!1;if(e.colLabels&&(n=2<=e.colLabels.length&&RollerUtil.isRollCol(e.colLabels[0]),n)){const t=e.rows.find(e=>{try{return!/\d+([-\u2012\u2013]\d+)?/.exec(e[0])}catch(n){return!0}});t&&(n=!1)}return n},Renderer.getRollableRow=function(n,t){n=MiscUtil.copy(n);try{const e=/^(\d+)([-\u2012\u2013](\d+))?$/.exec((n[0]+"").trim());if(e)e[1]&&!e[2]?(n[0]={type:"cell",roll:{exact:+e[1]}},"0"===e[1][0]&&(n[0].roll.pad=!0)):(n[0]={type:"cell",roll:{min:+e[1],max:+e[3]}},("0"===e[1][0]||"0"===e[3][0])&&(n[0].roll.pad=!0));else{const e=/^(\d+)\+$/.exec(n[0]);n[0]={type:"cell",roll:{min:+e[1],max:Renderer.dice.POS_INFINITE}}}}catch(i){t&&t(n[0],i)}return n},Renderer.initLazyImageLoaders=function(){let e=null;const n=$(`img[data-src]`);Renderer._imageObserver&&(Renderer._imageObserver.disconnect(),window.removeEventListener("beforeprint",e)),Renderer._imageObserver=new IntersectionObserver(function(e){e.forEach(e=>{if(0<e.intersectionRatio){Renderer._imageObserver.unobserve(e.target);const n=$(e.target);n.attr("src",n.attr("data-src")).removeAttr("data-src")}})},{rootMargin:"150px 0px",threshold:.01}),n.each((e,n)=>Renderer._imageObserver.observe(n)),e=()=>{alert(`All images in the page will now be loaded. This may take a while.`),n.each((e,n)=>{Renderer._imageObserver.unobserve(n);const t=$(n);t.attr("src",t.attr("data-src")).removeAttr("data-src")})},window.addEventListener("beforeprint",e)},Renderer._imageObserver=null,Renderer.HEAD_NEG_1="rd__b--0",Renderer.HEAD_0="rd__b--1",Renderer.HEAD_1="rd__b--2",Renderer.HEAD_2="rd__b--3",Renderer.HEAD_2_SUB_VARIANT="rd__b--4",Renderer.DATA_NONE="data-none","undefined"!=typeof module&&(module.exports.Renderer=Renderer,global.Renderer=Renderer);;
"use strict";("undefined"==typeof module?window:global).ScaleCreature={_crRangeToVal(c,d){return Object.keys(d).find(e=>{const[f,a]=d[e];return c>=f&&c<=a})},_acCrRanges:{13:[-1,3],14:[4,4],15:[5,7],16:[8,9],17:[10,12],18:[13,16],19:[17,30]},_crToAc(a){return+this._crRangeToVal(a,this._acCrRanges)},_crHpRanges:{0:[1,6],0.125:[7,35],0.25:[36,49],0.5:[50,70],1:[71,85],2:[86,100],3:[101,115],4:[116,130],5:[131,145],6:[146,160],7:[161,175],8:[176,190],9:[191,205],10:[206,220],11:[221,235],12:[236,250],13:[251,265],14:[266,280],15:[281,295],16:[296,310],17:[311,325],18:[326,340],19:[341,355],20:[356,400],21:[401,445],22:[446,490],23:[491,535],24:[536,580],25:[581,625],26:[626,670],27:[671,715],28:[716,760],29:[761,805],30:[806,850]},_crToEstimatedConModRange:{0:[-1,2],0.125:[-1,1],0.25:[0,2],0.5:[0,2],1:[0,2],2:[0,3],3:[1,3],4:[1,4],5:[2,4],6:[2,5],7:[1,5],8:[1,5],9:[2,5],10:[2,5],11:[2,6],12:[1,5],13:[3,6],14:[3,6],15:[3,6],16:[4,7],17:[3,7],18:[1,7],19:[4,6],20:[5,9],21:[3,8],22:[4,9],23:[5,9],24:[5,9],25:[7,9],26:[7,9],27:[7,9],28:[7,9],29:[7,9],30:[10,10]},_atkCrRanges:{3:[-1,2],4:[3,3],5:[4,4],6:[5,7],7:[8,10],8:[11,15],9:[16,16],10:[17,20],11:[21,23],12:[24,26],13:[27,29],14:[30,30]},_crToAtk(a){return this._crRangeToVal(a,this._atkCrRanges)},_crDprRanges:{0:[0,1],0.125:[2,3],0.25:[4,5],0.5:[6,8],1:[9,14],2:[15,20],3:[21,26],4:[27,32],5:[33,38],6:[39,44],7:[45,50],8:[51,56],9:[57,62],10:[63,68],11:[69,74],12:[75,80],13:[81,86],14:[87,92],15:[93,98],16:[99,104],17:[105,110],18:[111,116],19:[117,122],20:[123,140],21:[141,158],22:[159,176],23:[177,194],24:[195,212],25:[213,230],26:[231,248],27:[249,266],28:[267,284],29:[285,302],30:[303,320]},_crToEstimatedDamageMod:{0:[-1,2],0.125:[0,2],0.25:[0,3],0.5:[0,3],1:[0,3],2:[1,4],3:[1,4],4:[2,4],5:[2,5],6:[2,5],7:[2,5],8:[2,5],9:[2,6],10:[3,6],11:[3,7],12:[2,6],13:[3,7],14:[4,7],15:[3,7],16:[4,8],17:[4,8],18:[3,7],19:[5,8],20:[6,9],21:[5,9],22:[6,10],23:[6,10],24:[6,11],25:[8,11],26:[7,9],27:[7,9],28:[7,9],29:[7,9],30:[9,11]},_dcRanges:{13:[-1,3],14:[4,4],15:[5,7],16:[8,10],17:[11,12],18:[13,16],19:[17,20],20:[21,23],21:[24,26],22:[27,29],23:[30,30]},_crToDc(a){return this._crRangeToVal(a,this._dcRanges)},_casterLevelAndClassCantrips:{bard:[2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4],cleric:[3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5],druid:[2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4],sorcerer:[4,4,4,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6],warlock:[2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4],wizard:[3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5]},_casterLevelAndClassToCantrips(a,b){return b=(b||"cleric").toLowerCase(),this._casterLevelAndClassCantrips[b][a]},_protectedCantrips:["acid splash","chill touch","eldritch blast","fire bolt","poison spray","produce flame","ray of frost","sacred flame","shocking grasp","thorn whip","vicious mockery"],_crToCasterLevelAvg:{0:2,0.125:2,0.25:2,0.5:2,1:3.5,2:4.25,3:5.75,4:6.75,5:8,6:9.75,7:10.5,8:10.75,9:11.5,10:11.75,11:12,12:13,13:14,14:15,15:16,16:17,17:18,18:19},_crToCasterLevel(a){return 0===a?2:19<=a?20:this._crToCasterLevelAvg[a]},_calcNewAbility(a,b,c){return Math.max(1,2*(c+5)+a[b]%2)},_rng:null,_initRng(a,b){let c=CryptUtil.hashCode(b);c=31*c+CryptUtil.hashCode(a.source),c=31*c+CryptUtil.hashCode(a.name),this._rng=Math.seed(c)},scale(b,c){return this._pInitSpellCache().then(()=>{if(null==c||"Unknown"===c)throw new Error("Attempting to scale unknown CR!");this._initRng(b,c),b=JSON.parse(JSON.stringify(b));const a=b.cr.cr||b.cr,d=Parser.crToNumber(a);if(d===c)throw new Error("Attempting to scale creature to own CR!");if(30<d)throw new Error("Attempting to scale a creature beyond 30 CR!");if(0>d)throw new Error("Attempting to scale a creature below 0 CR!");const e=Parser.crToPb(a),f=Parser.crToPb(c+"");e!==f&&this._applyPb(b,e,f),this._adjustHp(b,d,c),this._adjustAtkBonusAndSaveDc(b,d,c,e,f),this._adjustDpr(b,d,c),this._adjustSpellcasting(b,d,c),this._adjustAc(b,d,c),this._handleUpdateAbilityScoresSkillsSaves(b,f),[`str`,`dex`,`con`,`int`,`wis`,`cha`].forEach(c=>delete b[`${c}Old`]);const g=Parser.numberToCr(c);return b.cr.cr?b.cr.cr=g:b.cr=g,b._displayName=`${b.name} (CR ${g})`,b._isScaledCr=c,b._originalCr=b._originalCr||a,b})},_applyPb(a,b,c){const d=(a,d)=>{const e=+a-(d?2*b:b)+(d?2*c:c);return`${0<=e?"+":""}${e}`};a.save&&Object.keys(a.save).forEach(c=>{const e=a.save[c],f=Parser.getAbilityModNumber(a[c]);if(f===+e)return;a.save[c]=d(e,e-f===2*b)}),a.skill&&Object.keys(a.skill).forEach(c=>{const e=a.skill[c],f=Parser.getAbilityModNumber(a[Parser.skillToAbilityAbv(c)]);if(f===+e)return;a.skill[c]=d(e,e-f===2*b),"perception"===c&&null!=a.passive&&(a.passive=10+ +a.skill[c])});const e=c-b,f=a=>a.replace(/{@hit ([-+]?\d+)}/g,(a,b)=>{return`{@hit ${+b+e}}`}),g=a=>a.replace(/DC (\d+)/g,(a,b)=>`{@dc ${b}}`).replace(/{@dc (\d+)}/g,(a,b)=>{return`DC ${+b+e}`});a.spellcasting&&a.spellcasting.forEach(a=>{if(a.headerEntries){const b=JSON.stringify(a.headerEntries),c=g(f(b));a.headerEntries=JSON.parse(c)}});const h=b=>{a[b]&&a[b].forEach(a=>{const b=JSON.stringify(a.entries),c=g(f(b));a.entries=JSON.parse(c)})};h("trait"),h("action"),h("reaction"),h("legendary"),h("variant")},_acHeavy:{"ring mail":14,"chain mail":16,"splint armor":17,"plate armor":18},_acMedium:{"hide armor":12,"chain shirt":13,"scale mail":14,breastplate:14,"half plate armor":15},_acLight:{"padded armor":11,"leather armor":11,"studded leather armor":12},_acMageArmor:"@spell mage armor",_adjustAc(a,b,c){var d=Math.min;const e=(a,b)=>{const c=[];for(let d=0;3>d;++d)c.push({tag:`${a} +${d+1}|dmg`,mod:b+d+1}),c.push({tag:`+${d+1} ${a}|dmg`,mod:b+d+1});return c},f=a=>Object.keys(a).map(b=>{const c=a[b];return[{tag:`${b}|phb`,mod:c}].concat(e(b,c))}).reduce((c,a)=>c.concat(a),[]),g=(()=>[{tag:"shield|phb",mod:2}].concat(e("shield",2)))(),h=f(this._acHeavy),i=f(this._acMedium),j=f(this._acLight),k=(a,b)=>{const c=b.replace(/( \+\d)?\|.*$/,""),d=a[c],e=/^.*? (\+\d)\|.*$/.exec(b),f=e?+e[1]:0;return[d,f]},l=(a,b)=>a.find(a=>b.includes(`@item ${a}`)),m=(a,b,c)=>{const d=a.replace(`@item ${b}`,`@item ${c}`),e=d.split("|");return 2<e.length?`${e.slice(0,2).join("|")}}`:d},n=()=>!1===a._shieldRequired&&!1===a._shieldDropped,o=a=>{const b=a.from.findIndex(a=>g.find(b=>a._.includes(b.tag)));if(-1===b)throw new Error("Should never occur!");a.from.splice(b,1)},p=a=>{a=a.trim().toLowerCase();const b=[this._acHeavy,this._acMedium,this._acLight,{shield:2}];for(const c of b){const b=Object.keys(c).find(b=>a===b);if(b){const a=c[b];if(10<a)return a-10}}},q=a=>{a=a.trim().toLowerCase();const b=[this._acHeavy,this._acMedium,this._acLight].findIndex(b=>!!Object.keys(b).find(b=>a===b));return 0===b?0:1===b?2:3===b?999:null};a.ac=a.ac.map(e=>{let f=0;const r=()=>{"number"!=typeof e&&(e._enchTotal=e._enchTotal||0,e._gearBonus=0,e._dexCap=999),e.from&&(e.from=e.from.map(a=>{a._&&(a=a._);const b=/@item (\+\d+)([^+\d}]+)/gi.exec(a);if(b){const[c,d,e,f]=b.map(a=>a.trim()),g=(f||"").split("|"),h=1<g.length?g.last():null;a=`{@item ${e} ${d}||${h||`${d} ${e}`}}`}const c=/@item ([^+\d]+)(\+\d+)\|([^|}]+)/gi.exec(a);if(c){const[b,f,g,h]=c,i=p(f);i&&(e._gearBonus+=i);const j=q(f);null!=j&&(e._dexCap=d(e._dexCap,j));const k=+g;return e._enchTotal+=k,{_:a,name:f.trim(),ench:k,source:h}}else{const b=/@item ([^|}]+)(\|[^|}]+)?(\|[^|}]+)?/gi.exec(a);if(b){const[c,f,g,h]=b,i={_:a,name:f};g&&(i.source=g),h&&(i.display=h);const j=p(f);j&&(e._gearBonus+=j,i._gearBonus=j);const k=q(f);return null!=k&&(e._dexCap=d(e._dexCap,k)),i}return{_:a,name:a}}}));const r=null==a.dexOld?null:(()=>e._gearBonus||0)()+d(Parser.getAbilityModNumber(a.dexOld),(()=>e._dexCap||999)())+10;let s=null==a.dexOld;const t=Parser.getAbilityModNumber(a.dex)-Parser.getAbilityModNumber(a.dexOld||a.dex),u=e.ac||e,v=u-(0===f?(()=>e._enchTotal||0)():0);"number"!=typeof e&&(e._miscOffset=e._miscOffset||(null==r?null:v-r));const w=this._crToAc(b),x=this._crToAc(c),y=null==r?v:r,z=this._getScaledToRatio(y,w,x);let A=z;const B=z-y,C=B-t,D=()=>(a.dexOld=a.dex,a.dex=this._calcNewAbility(a,"dex",Parser.getAbilityModNumber(a.dex)+C),s=!1,!0),E=()=>0<C?s?(D(),z):{ac:z,from:["natural armor"]}:0>C&&s?(D(),z):z,F=()=>!!(e.condition&&e.condition.toLowerCase().includes(this._acMageArmor))&&(s?(e.ac=z,D()):(e.ac=13+Parser.getAbilityModNumber(a.dex),!0)),G=()=>{const b=3;if(e.from){const c=e.from.filter(a=>g.find(b=>a._.includes(`@item ${b.tag}`)));if(c.length){if(1<c.length)throw new Error("AC contained multiple shields!");const d=null==a._shieldRequired?(()=>{const b=b=>{if(!a[b])return!1;for(const c of a[b]){if(c.name&&c.name.toLowerCase().includes("shield"))return!0;if(c.entries&&JSON.stringify(c.entries).match(/shield/i))return!0}};return a._shieldRequired=b("trait")||b("action")||b("reaction")||b("legendary")})():a._shieldRequired;a._shieldDropped=!1;const f=c[0]._,h=e.from.findIndex(a=>a===f);if(!f.endsWith("|shields}")){const b=g.find(a=>f.includes(a.tag));if(A-=b.mod,!d&&B<=-b.mod&&(e.from.splice(h,1),e.ac-=b.mod,a._shieldDropped=!0,e.ac===z))return!0}else if(A-=b,!d&&-3>=B&&(e.from.splice(h,1),e.ac-=b,a._shieldDropped=!0,e.ac===z))return!0}}return!1},H=()=>{const b=21,c=h.map(a=>a.tag),f=a=>14<=a&&a<=b,g=a=>a>b,j=a=>{const b=Object.keys(this._acHeavy).find(b=>this._acHeavy[b]===a);return b?`${b}|phb`:19===a?[`plate armor +1|dmg`,`splint armor +2|dmg`][RollerUtil.roll(1,this._rng)]:20===a?`plate armor +2|dmg`:21===a?`plate armor +3|dmg`:void 0};if(e.from)for(let b=0;b<e.from.length;++b){const h=l(c,e.from[b]._);if(h){if(f(A)){const a=15===A;return a&&A++,e.from[b]._=m(e.from[b]._,h,j(A)),e.ac=z+(a?1:0),!0}if(n()&&f(z)){const a=z+(15===z?1:0);return e.from[b]._=m(e.from[b]._,h,j(a)),e.ac=a,o(e),!0}if(g(A)){return e.from[b]._=m(e.from[b]._,h,j(21)),e.ac=21,!0}else{const[c,f]=k(this._acLight,h);return e.from[b]._=m(e.from[b]._,h,`half plate armor|phb`),e.ac=e.ac-(c+f)+15+d(2,Parser.getAbilityModNumber(a.dex)),!1}}}return!1},I=()=>{const b=i.map(a=>a.tag),c=(b,c)=>{const e=12+(s?-5:Parser.getAbilityModNumber(a.dex)),f=18+(s?2:d(2,Parser.getAbilityModNumber(a.dex)));return c?b<e?-1:b>f?1:0:b>=e&&b<=f},f=(b,c)=>{const e=a=>{switch(a){case 14:return[`scale mail|phb`,`breastplate|phb`][RollerUtil.roll(1,this._rng)];case 16:return[`half plate armor +1|dmg`,`breastplate +2|dmg`,`scale mail +2|dmg`][RollerUtil.roll(2,this._rng)];case 17:return`half plate armor +2|dmg`;case 18:return`half plate armor +3|dmg`;default:{const b=Object.keys(this._acMedium).find(b=>this._acMedium[b]===a);return`${b}|phb`}}};if(s){let f=c.ac,g=f+2,h=f-5;const i=()=>b>=h&&b<=g,j=()=>f+d(2,Parser.getAbilityModNumber(a.dex));for(let c=0;;){if(1e3<c)throw new Error(`Failed to find valid light armor!`);if(i())s=!1,null==a.dexOld&&(a.dexOld=a.dex),b>j()?a.dex+=2:a.dex-=2;else{if(b<h?f-=1:f+=1,12>f||18<f)throw Error("Should never occur!");g=f+2,h=f-5}if(j()===b)break;c++}return e(f)}else{const c=d(Parser.getAbilityModNumber(a.dex),2);return e(b-c)}};if(e.from)for(let g=0;g<e.from.length;++g){const h=l(b,e.from[g]._);if(h){const[b,i]=k(this._acMedium,h),j=b+i;return c(A)?(e.from[g]._=m(e.from[g]._,h,f(A,{tag:h,ac:j})),e.ac=z,!0):n()&&c(z)?(e.from[g]._=m(e.from[g]._,h,f(z,{tag:h,ac:j})),e.ac=z,o(e),!0):s&&-1===c(A,!0)?(e.from[g]._=m(e.from[g]._,h,`studded leather armor|phb`),e.ac=e.ac-j-d(2,Parser.getAbilityModNumber(a.dex))+12+Parser.getAbilityModNumber(a.dex),!1):(e.from[g]._=m(e.from[g]._,h,`ring mail|phb`),e.ac=e.ac-j-d(2,Parser.getAbilityModNumber(a.dex))+14,-1)}}return!1},J=()=>{const b=j.map(a=>a.tag),c=(b,c)=>{const d=11+(s?-5:Parser.getAbilityModNumber(a.dex)),e=15+(s?100:Parser.getAbilityModNumber(a.dex));return c?b<d?-1:b>e?1:0:b>=d&&b<=e},f=(b,c)=>{const d=a=>11===a?[`padded armor|phb`,`leather armor|phb`][RollerUtil.roll(1,this._rng)]:12===a?`studded leather armor|phb`:13===a?[`padded armor +1|dmg`,`leather armor +1|dmg`][RollerUtil.roll(1,this._rng)]:14===a?[`padded armor +2|dmg`,`leather armor +2|dmg`,`studded leather armor +1|dmg`][RollerUtil.roll(2,this._rng)]:15===a?`studded leather armor +2|dmg`:void 0;if(s){let e=c.ac,f=e-5;const g=()=>b>=f,h=()=>e+Parser.getAbilityModNumber(a.dex);for(let c=0;;){if(1e3<c)throw new Error(`Failed to find valid light armor!`);if(g())s=!1,null==a.dexOld&&(a.dexOld=a.dex),b>h()?a.dex+=2:a.dex-=2;else{if(b<f?e-=1:e+=1,11>e||15<e)throw Error("Should never occur!");f=e-5}if(h()===b)break;c++}return d(e)}else{const c=Parser.getAbilityModNumber(a.dex);return d(b-c)}};if(e.from)for(let g=0;g<e.from.length;++g){const h=l(b,e.from[g]._);if(h){const[b,i]=k(this._acLight,h),j=b+i;return c(A)?(e.from[g]._=m(e.from[g]._,h,f(A,{tag:h,ac:j})),e.ac=z,!0):n()&&c(z)?(e.from[g]._=m(e.from[g]._,h,f(z,{tag:h,ac:j})),e.ac=z,o(e),!0):s||-1!==c(A,!0)?(e.from[g]._=m(e.from[g]._,h,`chain shirt|phb`),e.ac=e.ac-j-Parser.getAbilityModNumber(a.dex)+13+d(2,Parser.getAbilityModNumber(a.dex)),-1):1===e.from.length?(e._droppedArmor=!0,-1):(e.from.splice(g,1),e.ac=e.ac-j+10,-1)}}return!1},K=()=>!!(e.from&&e.from.map(a=>a._).includes("natural armor"))&&(s?(e.ac=z,D()):(e.ac=z,!0));if(e.ac&&!e._droppedArmor){const a=[F,G,H,I,J,K];let b=0;for(let c=0;c<a.length;++c){if(b=a[c](),-1===b)return null;if(b)break}return b||(e.ac=z),e}return E()};let s=null;for(;null==s;){if(100<f)throw new Error(`Failed to calculate new AC! Input was:\n${JSON.stringify(e,null,"\t")}`);s=r(),f++}let t=!e._enchTotal;if(e.from&&(e._enchTotal&&e.from.forEach(a=>{if(!t)if(a.ench&&3>a.ench){const b=d(3-a.ench,e._enchTotal);e._enchTotal-=b,a.ench+=b,e.ac+=b,a._=`{@item ${a.name} +${a.ench}|dmg|+${a.ench} ${a.name}}`,0>=e._enchTotal&&(t=!0)}else if(s._gearBonus){const b=d(3,e._enchTotal);e._enchTotal-=b,a._=`{@item ${a.name} +${b}|dmg|+${b} ${a.name}}`,0>=e._enchTotal&&(t=!0)}}),e.from=e.from.map(a=>a._)),!t){const a=d(3,e._enchTotal);e._enchTotal-=a,e.ac+=a+1,(e.from=e.from||[]).unshift(`{@item leather armor +${a}|dmg|+${a} leather armor}`),0<e._enchTotal&&(e.ac+=e._enchTotal)}return null!=e._miscOffset&&(e.ac+=e._miscOffset),["_enchTotal","_gearBonus","_dexCap","_miscOffset"].forEach(a=>delete e[a]),s})},_interpAndTranslateToSpace(a,b,c){let[d,e]=b,[f,g]=c;const j=.1;d-=j,e+=j,f-=j,g+=j;const k=(a-d)/(e-d);return Math.round(k*(g-f)+f)},_getScaledToRatio(a,b,c){return Math.round(a*(c/b))},_adjustHp(a,b,c){var d=Math.ceil,e=Math.floor,f=Math.mean,g=Math.max;if(a.hp.special)return;const h=f(...this._crHpRanges[b]),i=this._crHpRanges[c],j=f(...i),k=this._getScaledToRatio(a.hp.average,h,j),l=(i[1]-i[0])/2,m=[e(k-l),d(k+l)],n=a.hp.formula.replace(/\s*/g,"");a.hp.average=e(g(1,k));const o=n.split(/([-+])/),p=/(\d+)d(\d+)/i.exec(o[0]),q=+p[2],r=(q+1)/2,s=+p[1],t=3===o.length?+`${o[1]}${o[2]}`:0,u=e(t/s);let v=s,w=(()=>{const a=this._crToEstimatedConModRange[c];return a[0]===a[1]?a[0]:this._interpAndTranslateToSpace(u,this._crToEstimatedConModRange[b],a)})();const x=(a=v,b=w)=>a*r+a*b,y=a=>a>=m[0]&&a<=m[1];for(let d=0;!y(x(v));){if(100<d)throw new Error(`Failed to find new HP! Current formula is: ${s}d${w}`);const a=()=>{let a=v,b=x(),c=!1;if(b>m[1]){for(;1<a;)if(a-=1,b-=r,y(x(a))){c=!0;break}}else for(;b<=m[1];)if(a+=1,b+=r,y(x(a))){c=!0;break}return!!c&&(v=a,!0)},b=()=>{w+=(1-2*(d%2))*(d+1)};if(a())break;b(),d++}a.hp.average=e(x(v));const z=v*w;if(a.hp.formula=`${v}d${q}${0==z?"":` ${0<=z?"+":""} ${z}`}`,w!==u){const b=this._calcNewAbility(a,"con",w);if(b!==a.con&&a.save&&a.save.con){const c=Parser.getAbilityModifier(b)-Parser.getAbilityModifier(a.con),d=+a.save.con+c;a.save.con=`${0<=d?"+":""}${d}`}a.con=b}},_getEnchantmentBonus(a){const b=/\+(\d+)/.exec(a);return b?+b[1]:0},_wepThrownFinesse:["dagger","dart"],_wepFinesse:["dagger","dart","rapier","scimitar","shortsword","whip"],_wepThrown:["handaxe","javelin","light hammer","spear","trident","net"],_getModBeingScaled(a,b,c,d,e){const f=()=>{d=d.toLowerCase(),e=e.replace(/{@atk ([A-Za-z,]+)}/gi,(a,b)=>Renderer.attackTagToFull(b)).toLowerCase();const a=e.includes("melee or ranged weapon attack:");if(a){const a=this._wepThrownFinesse.find(a=>e.includes(a));if(a)return"dex";const b=this._wepFinesse.find(a=>e.includes(a));if(b)return"dex";const c=this._wepThrown.find(a=>e.includes(a));return c?"str":null}const b=e.includes("melee weapon attack:");if(b){const a=this._wepFinesse.find(a=>e.includes(a));return a?"dex":"str"}const c=e.includes("ranged weapon attack:");if(c){const a=this._wepThrown.find(a=>e.includes(a));return a?"str":"dex"}};return c&&(a!==b||a!==c)?a===c?"str":b===c?"dex":null:f()},_adjustAtkBonusAndSaveDc(a,b,c,d,e){var f=Math.max;const g=+this._crToAtk(b),h=+this._crToAtk(c),i=Parser.getAbilityModNumber(a.str),j=Parser.getAbilityModNumber(a.dex),k=a=>a+(h-g),l=(b,c)=>{const f=null==c?0:this._getEnchantmentBonus(c);return b.replace(/{@hit ([-+]?\d+)}/g,(g,h)=>{const l=+h,m=l-(f+e),n=null==c?null:this._getModBeingScaled(i,j,m,c,b),o=l+(d-e)-f,p=k(o);if(o===p)return g;if(null!=n){const b=`_${n}TmpMods`;a[b]=a[b]||[],a[b].push(m+(p-e-(o-d)))}return`{@hit ${p+f}}`})},m=this._crToDc(b),n=this._crToDc(c),o=a=>a+(n-m),p=(b,c)=>b.replace(/DC (\d+)/g,(a,b)=>`{@dc ${b}}`).replace(/{@dc (\d+)}/g,(b,g)=>{const h=+g,i=h+d-e,j=f(10,o(i));if(h===j)return b;if(["int","wis","cha"].includes(c)){const b=`${c}Old`;if(null==a[b]){a[b]=a[c];const d=Parser.getAbilityModNumber(a[c]);a[c]=this._calcNewAbility(a,c,d+(j-i))}}return`DC ${j}`});a.spellcasting&&a.spellcasting.forEach(a=>{if(a.headerEntries){const b=JSON.stringify(a.headerEntries),c=l(p(b,a.ability));a.headerEntries=JSON.parse(c)}});const q=b=>{a[b]&&a[b].forEach(a=>{const b=JSON.stringify(a.entries),c=p(l(b,a.name));a.entries=JSON.parse(c)})};q("trait"),q("action"),q("reaction"),q("legendary"),q("variant");const r=b=>{const c=`_${b}TmpMods`;if(a[c]){const d=`_${b}TmpMod`;if(0===a[c].length)throw new Error("Should never occur!");else if(1<a[c].length){const b=a[c][0],e=a[c].find(a=>a!==b);null==e&&(a[d]=a[c][0])}else a[d]=a[c][0];delete a[c]}};r("str"),r("dex")},_adjustDpr(a,b,c){var d=Math.ceil,e=Math.floor,f=Math.mean,g=Math.min,h=Math.max;const i=this._crDprRanges[b],j=this._crDprRanges[c],k=f(...i),l=f(...j),m=a=>(0===b&&(a=g(a,.63)),this._getScaledToRatio(a,k,l)),n=a=>{a=a.replace(/\s*/g,"");const b=a.replace(/d(\d+)/gi,(...a)=>` * ${(+a[1]+1)/2}`);return MiscUtil.expEval(b)},o=(j[1]-j[0])/2;let p=!1,q=[];for(;!p;){q=[];const f=Parser.getAbilityModNumber(a.str),g=Parser.getAbilityModNumber(a.dex),i=a._strTmpMod||f,j=a._dexTmpMod||g,k=k=>{if(a[k]){let l=!0;return a[k].forEach((p,r)=>{const s=JSON.stringify(p.entries);let t=s.replace(RollerUtil.REGEX_DAMAGE_FLAT,(a,b,c,d)=>{const e=m(c);return`${b}${e}${d}`});const u=[],v=this._getEnchantmentBonus(p.name);return t=t.replace(RollerUtil.REGEX_DAMAGE_DICE,(k,q,r,t,w)=>{t=t.replace(/\s+/g,"");const x=n(t),y=m(x),z=[h(0,e(y-o)),d(h(1,y+o))],A=a=>a>=z[0]&&a<=z[1],[B,C]=t.split(/[-+]/),[D,E]=B.split("d").map(a=>+a),F=C?+C-v:null,G=this._getModBeingScaled(f,g,F,p.name,s),H="str"===G?i:"dex"===G?j:null;let I=D,J=E,K=(()=>"str"===G&&null!=a._strTmpMod?a._strTmpMod:"dex"===G&&null!=a._dexTmpMod?a._dexTmpMod:null==F?0-v:this._interpAndTranslateToSpace(F,this._crToEstimatedDamageMod[b],this._crToEstimatedDamageMod[c]))();const L=()=>{if(-5>K)throw new Error(`Ability modifier ${null==G?"":`(${G})`} was below -5 (${K})! Original dice expression was ${t}.`);if(null!=H&&K!==H){const b=`_${G}TmpMod`,c=`_maxDpr${G.uppercaseFirst()}`;let d=!0;if(null!=a[b]&&a[b]!==K)if(a[c]>=y)d=!1;else return a[b]=K,a[c]=y,l=!1,"";d&&(a[c]=h(a[c]||0,y),a[b]=K),u.push({ability:G,mod:K,adjustedDpr:y})}},M=(d=I,a=J,b=K)=>`${d}d${a}${0===b?"":` ${0<b?"+":""} ${b}`}`;for(let a=0;!A(n(M()));){if(100<a)throw new Error(`Failed to find new DPR! Current formula is: ${M()}`);const b=(a=J,b=K)=>{let c=D,d=n(M(c,a,b)),e=!1;if(y<d){for(;1<c&&d>=z[0];)if(c-=1,d-=(a+1)/2,A(n(M(c,a,b)))){e=!0;break}}else for(;d<=z[1];)if(c+=1,d+=(a+1)/2,A(n(M(c,a,b)))){e=!0;break}return!!e&&(I=c,!0)},c=()=>{if(4===E||20===E)return;let a=E,c=n(M(void 0,a)),d=!1;if(y<c){for(;4<a&&c>=z[0];)if(a=Renderer.dice.getPreviousDice(a),c=n(M(void 0,a)),A(n(M(D,a,K)))){d=!0;break}else if(d=b(a),d)break;}else for(;20>a&&c<=z[1];)if(a=Renderer.dice.getNextDice(a),c=n(M(void 0,a)),A(n(M(D,a,K)))){d=!0;break}else if(d=b(a),d)break;return!!d&&(J=a,!0)},d=()=>{K+=(1-2*(a%2))*(a+1)};if(b())break;if(c())break;d(),a++}L();const N=M(void 0,void 0,K+v),O=e(n(N));return 0>=O?`1 ${w.replace(/^[^\w]+/," ")}`:`${e(n(N))}${r}${N}${w}`}),!!l&&void(s!==t&&q.push({prop:k,idxProp:r,entriesStrOriginal:s,entriesStr:t,reqAbilAdjust:u}))}),l}return!0};k("trait")&&k("action")&&k("reaction")&&k("legendary")&&k("variant")&&(p=!0)}q.forEach(b=>{a[b.prop][b.idxProp].entries=JSON.parse(b.entriesStr)});const r=b=>{const c=`_${b}TmpMod`;null!=a[c]&&(a[`${b}Old`]=a[b],a[b]=this._calcNewAbility(a,b,a[c])),delete a[c]};r("str"),r("dex")},_handleUpdateAbilityScoresSkillsSaves(a){const b=a=>`${0<=a?"+":""}${a}`;["str","dex","int","wis","con"].forEach(c=>{const d=`${c}Old`;if(null!=a[d]){const e=Parser.getAbilityModNumber(a[c])-Parser.getAbilityModNumber(a[d]);if(a.save&&null!=a.save[c]){const d=+a.save[c]+e;a.save[c]=b(d)}a.skill&&Object.keys(a.skill).forEach(d=>{const f=Parser.skillToAbilityAbv(d);if(f===c){const c=+a.skill[d]+e;a.skill[d]=b(c)}}),"wis"===c&&null!=a.passive&&(a.passive+=e)}})},_spells:null,_pInitSpellCache(){return this._spells?Promise.resolve():(this._spells={},DataUtil.loadJSON(`${Renderer.get().baseUrl}data/spells/spells-phb.json`).then(a=>{this.__initSpellCache(a)}))},__initSpellCache(a){a.spell.forEach(a=>{a.classes.fromClassList.forEach(b=>{let c=this._spells[b.source]=this._spells[b.source]||{};const d=b.name.toLowerCase();c=c[d]=c[d]||{},c=c[a.level]=c[a.level]||{},c[a.name]=1})})},_adjustSpellcasting(a,b,c){var d=Math.ceil,e=Math.round,f=Math.min,g=Math.max;const h=(a,b)=>{if(a<2*b-1)return 0;return 1===b?1===a?2:2===a?3:4:2===b?3===a?2:3:3===b?5===a?2:3:4===b?7===a?1:8===a?2:3:5===b?9===a?1:18>a?2:3:6===b?19<=a?2:1:7===b?20===a?2:1:8===b?1:9===b?1:void 0};if(a.spellcasting){const i=this._crToCasterLevel(b),j=this._crToCasterLevel(c),k=this._adjustSpellcasting_isWarlock(a);let l=null,n=null;a.spellcasting.forEach(a=>{let b=null;if(a.headerEntries){const c=JSON.stringify(a.headerEntries);let d=!1;const e=c.replace(/(an?) (\d+)[A-Za-z]+-level/i,(...a)=>{const b=+a[2],c=g(1,f(20,this._getScaledToRatio(b,i,j)));return d=b!==c,d?(null==l&&(l=b),null==n&&(n=c),`${Parser.getArticle(c)} ${Parser.spLevelToFull(c)}-level`):a[0]}),h=/(bard|cleric|druid|paladin|ranger|sorcerer|warlock|wizard) spell(?:s)?/i.exec(e);if(h)b=h[1];else{const a=/(bard|cleric|druid|paladin|ranger|sorcerer|warlock|wizard)(?:'s)? spell list/i.exec(e);a&&(b=a[1])}d&&(a.headerEntries=JSON.parse(e))}let c=null;if(n&&(c=f(9,d(n/2)),/paladin|ranger|warlock/i.exec(b)&&(c=f(5,n))),a.spells&&null!=n){const d=a.spells,i=/warlock/i.exec(b)&&1===Object.values(d).filter(a=>a.slots&&a.lower).length;if(d[0]){const a=d[0].spells.length,c=this._casterLevelAndClassToCantrips(l,b),e=this._casterLevelAndClassToCantrips(n,b),g=this._getScaledToRatio(a,c,e);if(a<g){const c=Object.keys((this._spells[SRC_PHB][b.toLowerCase()]||{})[0]).map(a=>a.toLowerCase());if(c.length){const b=[],e=f(g-a,c.length);for(let a=0;a<e;++a){const a=RollerUtil.roll(c.length,this._rng);b.push(c[a]),c.splice(a,1)}d[0].spells=d[0].spells.concat(b.map(a=>`{@spell ${a}}`))}}else for(const a=this._protectedCantrips.map(a=>`@spell ${a}`);d[0].spells.length>g;){const b=d[0].spells.filterIndex(b=>!~a.findIndex(a=>b.includes(a)));if(b.length){const a=RollerUtil.roll(b.length,this._rng);d[0].spells.splice(a,1)}else d[0].spells.pop()}}if(i){const a=Object.keys(d).find(a=>d[a].lower);if(c===+a)return;if(0===c)return void Object.keys(d).filter(a=>"0"!==a).forEach(a=>delete d[a]);const b=this._adjustSpellcasting_getWarlockNumSpellsKnown(n),e=this._spells[SRC_PHB].warlock;let f=[];for(let a=1;a<c+1;++a)f=f.concat(Object.keys(e[a]).map(a=>a.toSpellCase()));const g=[];for(let a=0;a<b;++a){const a=RollerUtil.roll(f.length,this._rng);g.push(f[a]),f.splice(a,1)}Object.keys(d).filter(a=>"0"!==a).forEach(a=>delete d[a]);const h=this._adjustSpellcasting_getWarlockNumSpellSlots(c);d[c]={slots:h,lower:1,spells:[`A selection of ${1===c?`{@filter 1st-level warlock spells|spells|level=${1}|class=warlock}.`:`{@filter 1st- to ${Parser.spLevelToFull(c)}-level warlock spells|spells|level=${[...Array(c)].map((a,b)=>b+1).join(";")}|class=warlock}.`}  Examples include: ${g.sort(SortUtil.ascSortLower).map(a=>`{@spell ${a}}`).joinConjunct(", "," and ")}`]}}else{let a=1;for(let j=1;10>j;++j){const i=d[j],k=h(l,j),m=h(n,j);if(i){if(i.slots){const b=this._getScaledToRatio(i.slots,k,m);a=b/m,i.slots=b,0>=b&&delete d[j]}}else if(j<=c){const c=g(1,e(m*a));if(b&&(this._spells[SRC_PHB][b.toLowerCase()]||{})[j]){const a=[],e=Object.keys(this._spells[SRC_PHB][b.toLowerCase()][j]).map(a=>a.toSpellCase()),g=f(5,e.length);for(let b=0;b<g;++b){const b=RollerUtil.roll(e.length,this._rng);a.push(e[b]),e.splice(b,1)}d[j]={slots:c,spells:[`A selection of {@filter ${Parser.spLevelToFull(j)}-level ${b} spells|spells|level=${j}|class=${b}}. Examples include: ${a.sort(SortUtil.ascSortLower).map(a=>`{@spell ${a}}`).joinConjunct(", "," and ")}`]}}else d[j]={slots:c,spells:[`A selection of {@filter ${Parser.spLevelToFull(j)}-level spells|spells|level=${j}}`]}}else delete d[j]}}}}),a.spellcasting.forEach(a=>{if(k&&a.daily&&a.daily["1e"]){const b=this._adjustSpellcasting_getWarlockNumArcanum(n),c=a.daily["1e"].length;if(a.daily["1e"].length===b)return;if(0===b)return delete a.daily["1e"];if(c>b){const c=a.daily["1e"].map(a=>{const b=/{@spell ([^|}]+)(?:\|([^|}]+))?[|}]/.exec(a);if(b){const c=b[1].toLowerCase(),d=(b[2]||SRC_PHB).toLowerCase(),e=Object.keys(this._spells).find(a=>a.toLowerCase()===d);if(e){const b=Object.keys(this._spells[e].warlock||{}).find(a=>Object.keys((this._spells[e].warlock||{})[a]).some(a=>a.toLowerCase()===c));if(b)return{original:a,level:+b}}}return{original:a,level:null}});for(let a=9;5<a;--a){for(const d=c.map(b=>b.level===a?c.indexOf(b):-1).filter(a=>~a);d.length&&c.length>b;)c.splice(d.pop(),1);if(c.length===b)break}a.daily["1e"]=c.map(a=>a.original)}else{for(let d=5+c;d<5+b;++d){const b=Object.keys(this._spells[SRC_PHB].warlock[d]),c=RollerUtil.roll(b.length,this._rng);a.daily["1e"].push(`{@spell ${b[c].toSpellCase()}}`)}a.daily["1e"].sort(SortUtil.ascSortLower)}}})}},_adjustSpellcasting_isWarlock(a){if(a.spellcasting)return a.spellcasting.some(a=>a.headerEntries&&/warlock spells?|warlock('s)? spell list/i.test(JSON.stringify(a.headerEntries)))},_adjustSpellcasting_getWarlockNumSpellsKnown(a){return 9>=a?a+1:10+Math.ceil((a-10)/2)},_adjustSpellcasting_getWarlockNumSpellSlots(a){return 1===a?1:11>a?2:17>a?3:4},_adjustSpellcasting_getWarlockNumArcanum(a){return 11>a?0:13>a?1:15>a?2:17>a?3:4}};